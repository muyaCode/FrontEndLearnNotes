# è„šæ‰‹æ¶æ¶æ„è®¾è®¡å’Œæ¡†æ¶æ­å»ºå¼€å‘

é¡¹ç›®æºç ï¼š[imooc-lego/imooc-cli: æ…•è¯¾ç½‘å‰ç«¯ç»Ÿä¸€ç ”å‘è„šæ‰‹æ¶ (github.com)](https://github.com/imooc-lego/imooc-cli)

- è„šæ‰‹æ¶çš„å®ç°åŸç†
- Lerna åº“çš„å¸¸è§ç”¨æ³•
- æ¶æ„è®¾è®¡æŠ€å·§å’Œæ¶æ„å›¾ç»˜åˆ¶æ–¹æ³•

## ä¸»è¦å†…å®¹

- å­¦ä¹ å¦‚ä½•ä»¥æ¶æ„å¸ˆçš„è§’åº¦æ€è€ƒåŸºç¡€æ¶æ„é—®é¢˜
- ä¸“æ³¨å¤š Package é¡¹ç›®ç®¡ç†ç—›ç‚¹å’Œè§£å†³æ–¹æ¡ˆï¼ŒåŸºäº Lerna è„šæ‰‹æ¶æ¡†æ¶æ­å»º
- imooc-cli è„šæ‰‹æ¶éœ€æ±‚åˆ†æå’Œæ¶æ„è®¾è®¡ï¼Œæ¶æ„è®¾è®¡å›¾

### é™„èµ å†…å®¹

- è„šæ‰‹æ¶è°ƒè¯•æŠ€å·§
- Lerna æºç åˆ†æ
- Node çš„ module æ¨¡å—åˆ†æ yargs ä½¿ç”¨æ–¹æ³•
- å‰–æ Lerna æ¶æ„è®¾è®¡

### å­¦ä¹ æ–¹æ³•

æ¶æ„ä¸‰éƒ¨æ›²ï¼šæŒæ¡åŸç†-> ç‹¬ç«‹æ€è€ƒ-> æ€»ç»“åæ€

æ·±åº¦å‰–æä¼˜ç§€å¼€æºé¡¹ç›®ï¼Œç”±è¡¨åŠé‡Œï¼Œç”±æµ…å…¥æ·±

è§†è§’åˆ‡æ¢ï¼šå¤šåˆ‡æ¢åˆ°æ¶æ„å¸ˆè§†è§’ï¼Œä»å…¨å±€æ€è€ƒé—®é¢˜

ä¼˜ç§€çš„ç¨‹åºå‘˜ä¸æ­¢èƒ½å¤Ÿå®ç°åŠŸèƒ½ï¼Œæ›´èƒ½è¯»æ‡‚åˆ«äººçš„ä»£ç ï¼Œè¯»æ‡‚åˆ«äººçš„æƒ³æ³•

ä»çŸ¥åçš„å¼€æºé¡¹ç›®ä¸­æ±²å–å…»åˆ†ï¼Œä¸ºæˆ‘æ‰€ç”¨ï¼ŒåŠ©æˆ‘æˆé•¿

### å‰ç«¯ç ”å‘è„šæ‰‹æ¶ imooc-cli æ ¸å¿ƒåŠŸèƒ½æ¼”ç¤º

- å®‰è£… imooc-cli è„šæ‰‹æ¶ï¼š `npm i -g @imooc-cli/core`
- æŸ¥çœ‹è„šæ‰‹æ¶ç›¸å…³å†…å®¹ï¼š`imooc-cli`
- é€šè¿‡è„šæ‰‹æ¶æ–°å»ºé¡¹ç›®ï¼š`imooc-cli init`
- é¡¹ç›®å‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒï¼š `imooc-cli publish`
- é¡¹ç›®å‘å¸ƒåˆ°æ­£å¼ç¯å¢ƒï¼š`imooc-cli publish --prod`

## ç«™åœ¨å‰ç«¯ç ”å‘çš„è§†è§’ï¼Œåˆ†æå¼€å‘è„šæ‰‹æ¶çš„å¿…è¦æ€§

### ç ”å‘æ•ˆèƒ½

å¼€å‘é¡¹ç›®è„šæ‰‹æ¶çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼šæå‡å‰ç«¯ç ”å‘æ•ˆèƒ½

å¤§å‚ç ”å‘æ¶æ„å›¾ï¼š

![å¤§å‚ç ”å‘æ¶æ„å›¾](.\img\å¤§å‚ç ”å‘æ¶æ„å›¾.jpg)

**åˆ›å»ºé¡¹ç›® + é€šç”¨ä»£ç **ï¼šåŸ‹ç‚¹ã€HTTP è¯·æ±‚ã€å·¥å…·æ–¹æ³•ã€ç»„ä»¶åº“

**git æ“ä½œ**ï¼šåˆ›å»ºä»“åº“ã€ä»£ç å†²çªã€è¿œç¨‹ä»£ç åŒæ­¥ã€åˆ›å»ºç‰ˆæœ¬ã€å‘å¸ƒæ‰“ tag

**æ„å»º + å‘å¸ƒä¸Šçº¿**ï¼šä¾èµ–å®‰è£…å’Œæ„å»ºã€èµ„æºä¸Šä¼  CDNã€åŸŸåç»‘å®šã€æµ‹è¯•/æ­£å¼æœåŠ¡å™¨

### è„šæ‰‹æ¶æ ¸å¿ƒä»·å€¼

**å°†ç ”å‘è¿‡ç¨‹**

- è‡ªåŠ¨åŒ–ï¼šé¡¹ç›®é‡å¤ä»£ç æ‹·è´ã€`git` æ“ä½œã€å‘å¸ƒä¸Šçº¿æ“ä½œ
- æ ‡å‡†åŒ–ï¼šé¡¹ç›®åˆ›å»ºã€git flowã€å‘å¸ƒæµç¨‹ã€å›æ»šæµç¨‹
- æ•°æ®åŒ–ï¼šç ”å‘è¿‡ç¨‹ç³»ç»ŸåŒ–ã€æ•°æ®åŒ–ã€ä½¿å¾—ç ”å‘è¿‡ç¨‹å¯é‡åŒ–

### è„šæ‰‹æ¶å’Œè‡ªåŠ¨åŒ–æ„å»ºå·¥å…·çš„åŒºåˆ«

é—®é¢˜ï¼š`jenkins`ï¼Œ`travis` ç­‰è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·å·²ç»å¾ˆæˆç†Ÿäº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è‡ªç ”è„šæ‰‹æ¶ï¼Ÿ

- ä¸æ»¡è¶³éœ€æ±‚ï¼š`jenkins`ï¼Œ`travis` é€šå¸¸åœ¨ `git hooks` ä¸­è§¦å‘ï¼Œéœ€è¦åœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œæ— æ³•è¦†ç›–ç ”å‘äººå‘˜æœ¬åœ°çš„åŠŸèƒ½ï¼Œå¦‚ï¼šåˆ›å»ºé¡¹ç›®è‡ªåŠ¨åŒ–ï¼Œæœ¬åœ° `git` æ“ä½œè‡ªåŠ¨åŒ–ç­‰ã€‚
- å®šåˆ¶å¤æ‚ï¼š `jenkins`ï¼Œ`travis` å®šåˆ¶è¿‡ç¨‹éœ€è¦å¼€å‘æ’ä»¶ï¼Œå…¶è¿‡ç¨‹è¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦ä½¿ç”¨ `java` è¯­è¨€ï¼Œå¯¹å‰ç«¯åŒå­¦ä¸å¤ªå‹å¥½ã€‚

## ä»ä½¿ç”¨çš„è§’åº¦ç†è§£ä»€ä¹ˆæ˜¯è„šæ‰‹æ¶

è„šæ‰‹æ¶æœ¬è´¨æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„å®¢æˆ·ç«¯ï¼Œä»–é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œï¼Œæ¯”å¦‚ï¼š

```bash
vue create vue-test-app
```

ä¸Šé¢è¿™æ¡å‘½ä»¤ç”± **3** ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- **ä¸»å‘½ä»¤**ï¼š`vue`
- **command**ï¼š`create`
- **command çš„ param**ï¼š`vue-test-app`

å®ƒè¡¨ç¤ºåˆ›å»ºä¸€ä¸ª `vue` é¡¹ç›®ï¼Œé¡¹ç›®çš„åç§°ä¸º `vue-test-app`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„è„šæ‰‹æ¶å‘½ä»¤ï¼Œä½†å®é™…åœºæ™¯å¾€å¾€æ›´åŠ å¤æ‚ï¼Œæ¯”å¦‚ï¼š

å½“å‰ç›®å½•å·²ç»æœ‰æ–‡ä»¶äº†ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–å½“å‰ç›®å½•çš„æ–‡ä»¶ï¼Œå¼ºåˆ¶è¿›è¡Œå®‰è£… `vue` é¡¹ç›®ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥è¾“å…¥

```bash
vue create vue-test-app --force
```

è¿™é‡Œçš„ `--force` å«åš `option` ï¼Œç”¨æ¥è¾…åŠ©è„šæ‰‹æ¶ç¡®è®¤åœ¨ç‰¹å®šåœºæ™¯ä¸‹ç”¨æˆ·çš„é€‰æ‹©ï¼ˆå¯ä»¥ç†è§£ä¸ºé…ç½®ï¼‰ã€‚è¿˜æœ‰ä¸€ç§åœºæ™¯ï¼š

é€šè¿‡ `vue create` åˆ›å»ºé¡¹ç›®æ—¶ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œ `npm install` å¸®åŠ©ç”¨æˆ·å®‰è£…ä¾èµ–ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨æ·˜å®æºæ¥å®‰è£…ï¼Œå¯ä»¥è¾“å…¥å‘½ä»¤

```bash
vue create vue-test-app --force -r https://registry.npm.taobao.org
```

è¿™é‡Œçš„ `-r` ä¹Ÿå«åš `option`ï¼Œå®ƒä¸ `--force` ä¸åŒçš„æ˜¯å®ƒä½¿ç”¨ `-` ï¼Œå¹¶ä¸”ä½¿ç”¨ç®€å†™ï¼Œè¿™é‡Œçš„ `-r` ä¹Ÿå¯ä»¥æ›¿æ¢æˆ `--registry`ï¼Œè¾“å…¥ä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥çœ‹åˆ° `vue create` æ”¯æŒçš„æ‰€æœ‰ `options`ã€‚

```bash
vue create --helps
```

`-r` åé¢çš„ `https://registry.npm.taobao.org` æˆä¸º `option` çš„ `param` ï¼Œå…¶å® `--force` å¯ä»¥ç†è§£ä¸ºï¼š`--force true` ï¼Œç®€å†™ä¸º `--force` æˆ– `-f` ã€‚

### è„šæ‰‹æ¶çš„æ‰§è¡ŒåŸç†

![img](./img/è„šæ‰‹æ¶æ‰§è¡ŒåŸç†.png)

**è„šæ‰‹æ¶æ‰§è¡ŒåŸç†å¦‚ä¸‹**

- åœ¨ç»ˆç«¯è¾“å…¥`vue create project`
- ç»ˆç«¯è§£æå‡º `vue`
- åœ¨ç¯å¢ƒå˜é‡ä¸­é€šè¿‡ `which vue` æ‰¾åˆ° `vue` å‘½ä»¤, ç›®å½•æ‰€åœ¨ `/node/bin/vue`ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰§è¡Œçš„ `vue`ï¼Œå®é™…ä¸Šè¿è¡Œçš„æ˜¯`/node/bin/vue` çš„è¿™ä¸ª `vue`
- è¿™ä¸ª `vue` åªæ˜¯ä¸€ä¸ªé“¾æ¥ï¼Œç»ˆç«¯æ ¹æ® `vue` å‘½ä»¤é“¾æ¥åˆ°å®é™…æ–‡ä»¶ `/node/lib/node_modules/@vue/cli/bin/vue.js`
- ç»ˆç«¯åˆ©ç”¨ `node` æ‰§è¡Œ `vue.js`
- `vue.js` è§£æ `command/options` ä»¥åŠ `param`
- `vue.js` æ‰§è¡Œ `command`
- æ‰§è¡Œå®Œæ¯•ï¼Œé€€å‡ºæ‰§è¡Œ

### ä»åº”ç”¨è§’åº¦ï¼Œå¦‚ä½•å¼€å‘ä¸€ä¸ªè„šæ‰‹æ¶

**ä»¥ vue-cli ä¸ºä¾‹**

- å¼€å‘ä¸€ä¸ª `npm` é¡¹ç›®ï¼Œè¯¥é¡¹ç›®ä¸­åº”åŒ…å«ä¸€ä¸ª `bin/vue.js` æ–‡ä»¶ï¼Œå¹¶å°†è¿™ä¸ªé¡¹ç›®å‘å¸ƒåˆ° `npm`ï¼›
- å°†è¿™ä¸ªé¡¹ç›®å‘å¸ƒåˆ° `npm`
- å°† `npm` é¡¹ç›®ä¸Šçš„é¡¹ç›®å…¨å±€å®‰è£…åˆ° `node` çš„ `lib/node_modules`
- åœ¨ `node` çš„ `bin` ç›®å½•ä¸‹é…ç½® `vue` è½¯é“¾æ¥æŒ‡å‘ `lib/node_modules/@vue/cli/bin/vue.js`

è¿™æ ·æˆ‘ä»¬åœ¨æ‰§è¡Œ `vue` å‘½ä»¤çš„æ—¶å€™å°±å¯ä»¥æ‰¾åˆ° `vue.js` è¿›è¡Œç›¸å…³æ“ä½œã€‚

## è„šæ‰‹æ¶çš„å®ç°åŸç†é—®é¢˜

å¯ä»¥ä½¿ç”¨(Node.js)ã€Pythonã€Ruby ç­‰å„ç§è¯­è¨€ç¼–å†™ã€‚

æ‰§è¡Œæµç¨‹åŸç†å›¾ï¼š

![image-20240228220000651](./è„šæ‰‹æ¶æ¶æ„è®¾è®¡å’Œæ¡†æ¶æ­å»ºå¼€å‘.assets/image-20240228220000651.png)

è¿™é‡Œéœ€è¦ç†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µ

- ç¯å¢ƒå˜é‡(ç›¸å½“äºæ“ä½œç³»ç»Ÿçº§åˆ«çš„å…¨å±€å˜é‡)
- è½¯é“¾æ¥(ç›¸å½“äº Windows ç³»ç»Ÿçš„å¿«æ·æ–¹å¼)
- è¿™é‡Œ:vueã€whichã€envã€node æœ¬è´¨éƒ½æ˜¯è„šæ‰‹æ¶

è„šæ‰‹æ¶çš„æ‰§è¡ŒåŸç†å¦‚ä¸‹ï¼š

- åœ¨ç»ˆç«¯è¾“å…¥ï¼š`vue create vue-test-app`
- ç»ˆç«¯è§£æå‡º `vue`å‘½ä»¤
- ç»ˆç«¯åœ¨ç¯å¢ƒå˜é‡ä¸­æ‰¾åˆ° `vue` å‘½ä»¤ç»ˆç«¯
- æ ¹æ® `vue` å‘½ä»¤é“¾æ¥åˆ°å®é™…æ–‡ä»¶ vue.js ç»ˆç«¯åˆ©ç”¨ `node` æ‰§è¡Œ `vue.js`
- `vue.js` è§£æ command/options
- `vue.js` æ‰§è¡Œ command
- æ‰§è¡Œå®Œæ¯•ï¼Œé€€å‡ºæ‰§è¡Œ

### ä¸‰ä¸ªé—®é¢˜

å¦‚æœä½ èƒ½å›ç­”ä»¥ä¸‹ 3 ä¸ªé—®é¢˜ï¼Œå°±æŒæ¡äº†è„šæ‰‹æ¶çš„å®ç°åŸç†ï¼š

**1.ä¸ºä»€ä¹ˆå…¨å±€å®‰è£… @vue/cli åä¼šæ·»åŠ ä¸€ä¸ª vue çš„å‘½ä»¤å‘¢ï¼Ÿ**

```bash
npm install -g @vue/cli
```

è¿è¡Œ `vue` å‘½ä»¤æ—¶ï¼Œå®é™…èµ°çš„æ˜¯ `node/bin/vue` ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶åªæ˜¯ä¸€ä¸ªè½¯è¿æ¥ï¼ŒæŒ‡å‘`lib/node_modules/@vue/cli/bin/vue.js`ã€‚

å›åˆ°ä¸Šçº§ç›®å½• `lib/node_modules/@vue/cli`ï¼Œæ‰“å¼€ `package.json` æ–‡ä»¶ï¼Œé‡Œé¢çš„ `bin` å­—æ®µå®šä¹‰äº†è¿™æ ·çš„ç»‘å®šå…³ç³»ã€‚

```javascript
// lib/node_modules/@vue/cli/package.json
{
  "bin": {
    "vue": "bin/vue.js"
  },
}
```

æ€»ç»“ï¼šæ‰§è¡Œ `vue` å‘½ä»¤çš„æ—¶å€™ï¼Œå¯åŠ¨çš„æ˜¯ `bin/vue` è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶æŒ‡å‘`lib/node_modules/@vue/cli/bin/vue.js` ï¼Œæ‰€ä»¥æœ€ç»ˆå¯åŠ¨çš„æ˜¯ `lib/node_modules/@vue/cli/bin/vue.js`

ç­”ï¼šè¿™æ˜¯å› ä¸ºé€šè¿‡ which vue åæˆ‘ä»¬ä¼šçœ‹åˆ° vue æ‰€åœ¨ç›®å½•ï¼Œè€Œè¿™ä¸ª vue æ˜¯ä¸€ä¸ªè½¯é“¾æ¥ï¼ŒæŒ‡å‘çš„æ˜¯@vue/cliã€‚ç¡®å®šè¿™ä¸ª vue å‘½ä»¤åç§°çš„æ˜¯åœ¨`node/v12.16.1/lib/node_modules/@vue/cli`ç›®å½•ä¸‹ package.json ä¸­çš„ bin çš„é”®å€¼ã€‚

**2.å…¨å±€å®‰è£… @vue/cli çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

- 1.æŠŠ `@vue/cli` çš„åŒ…é€šè¿‡ `npm` å®‰è£…ä¸‹è½½åˆ° `node/lib/node_modules` è¿™ä¸ªç›®å½•ä¸‹ã€‚
- 2.è§£æ `package.json` æ–‡ä»¶ ï¼Œæ ¹æ®æ–‡ä»¶ä¸­çš„ `bin` å­—æ®µï¼Œåœ¨ `/node/bin` ç›®å½•ä¸‹åˆ›å»ºè½¯è¿æ¥ï¼Œè½¯è¿æ¥æŒ‡å‘ `bin` å­—æ®µä¸­è§„å®šçš„æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ `lib/node_modules/@vue/cli/bin/vue.js`ã€‚

ç­”ï¼š

1.æ‰§è¡Œ npm install -g @vue/cli çš„æ—¶å€™ï¼Œé¦–å…ˆ node ä¼šæŠŠæˆ‘ä»¬å½“å‰åŒ…ä¸‹è½½åˆ° node ä¸‹çš„ node_modules ä¸­å»ã€‚

2.ä¸‹è½½å®Œæˆåï¼Œä¼šåœ¨ä¸‹è½½å¥½çš„åŒ…ä¸­æŸ¥æ‰¾ package.json ä¸­æ˜¯å¦æœ‰ binï¼Œå¦‚æœæœ‰ï¼Œä¼šé€šè¿‡ package.json ä¸­çš„ bin ä¸­çš„é”®å»é…ç½®è½¯é“¾æ¥ã€‚

ä¸Šé¢ä¸¤ä¸ªé—®é¢˜å…¶å®é—®é¢˜äºŒåœ¨å‰ï¼Œé—®é¢˜ä¸€åœ¨åï¼Œä¸¤ä¸ªé—®é¢˜è¯´çš„æ˜¯ä¸€ä¸ªæµç¨‹çš„åŒå‘è§£é‡Šï¼Œç†è§£äº†é—®é¢˜äºŒï¼Œé—®é¢˜ä¸€å°±æ¸…æ¥šäº†ã€‚

**3.æ‰§è¡Œ `vue` å‘½ä»¤æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

- æ ¹æ® `which vue` è¿™æ¡æŒ‡ä»¤ï¼ˆåœ¨ç¯å¢ƒå˜é‡ä¸­æŸ¥æ‰¾ï¼‰ï¼Œæ‰¾åˆ° `vue` å‘½ä»¤æ‰€åœ¨æ–‡ä»¶
- è¿è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰§è¡Œ `vue` å’Œæ‰§è¡Œ `node/bin/vue` çš„ç»“æœæ˜¯ä¸€æ ·çš„
- æ ¹æ®è½¯è¿æ¥ï¼Œæ‰§è¡ŒçœŸå®çš„ `lib/node_modules/@vue/cli/bin/vue.js` æ–‡ä»¶

ç­”ï¼š

1.é¦–å…ˆæ‰§è¡Œ vue å‘½ä»¤ï¼Œä¸æ‰§è¡Œ which vue æ‰“å°å‡ºæ¥çš„åœ°å€ æ•ˆæœæ˜¯ç­‰ä»·çš„(å³æ‰§è¡Œçš„æ˜¯ which vue çš„é‚£ä¸ªè½¯è¿æ¥ï¼š/Users/test-cli/.nvm/versions/node/v12.16.1/bin/vue)ã€‚

2.è€Œè½¯è¿æ¥åˆæŒ‡å‘å®ƒçš„å®é™…æ–‡ä»¶å­˜åœ¨è·¯å¾„ï¼š(â€¦/lib/node_modules/@vue/cli/bin/vue.js)ã€‚

3.ä¸€ä¸ª test.js æ–‡ä»¶å¯ä»¥é€šè¿‡ node æ‰§è¡Œï¼Œä½†ä¸èƒ½å•ç‹¬æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸ºå®ƒæ²¡æœ‰å¯æ‰§è¡Œæƒé™ã€‚ â€”â€”â€”â€”æˆ‘ä»¬åœ¨`/Users/test-cli/Desktop`ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª test.js æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»™è¿™ä¸ª js æ–‡ä»¶ä¸€ä¸ªæ‰§è¡Œæƒé™ï¼š

chmod 777 test.js ï¼Œç„¶ååœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥ï¼š`./test.js`ä»ç„¶ä¸å¯ä»¥æ‰§è¡Œã€‚

è¿™æ˜¯å› ä¸º js æ–‡ä»¶éœ€è¦ä¸€ä¸ªè§£é‡Šå™¨æ¥è¿›è¡Œæ‰§è¡Œï¼Œè¿™ä¸ª node å°±æ˜¯ä¸€ä¸ªè§£é‡Šå™¨ã€‚(.py æ–‡ä»¶éœ€è¦ python è§£é‡Šå™¨æ‰§è¡Œï¼Œ.java æ–‡ä»¶éœ€è¦ java è§£é‡Šå™¨è¿›è¡Œæ‰§è¡Œ)ã€‚

**4.ä¸ºä»€ä¹ˆ `vue` æŒ‡å‘ä¸€ä¸ª `js` æ–‡ä»¶ï¼Œæˆ‘ä»¬å´å¯ä»¥ç›´æ¥é€šè¿‡ `vue` å‘½ä»¤å»æ‰§è¡Œå®ƒï¼Ÿ**

æŸ¥çœ‹ `lib/node_modules/@vue/cli/bin/vue.js` æ–‡ä»¶çš„æºç ï¼Œä¼šå‘ç°ç¬¬ä¸€è¡Œä»£ç æ˜¯è¿™æ ·çš„

```bash
#!/usr/bin/env node
```

å‘Šè¯‰æˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿï¼Œç›´æ¥è°ƒç”¨è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåˆ°ç¯å¢ƒå˜é‡ä¸­æŸ¥æ‰¾ node å‘½ä»¤æ‰§è¡Œã€‚ (/usr/bin/env æ˜¯æˆ‘ä»¬çš„ç¯å¢ƒå˜é‡)

ä½¿ç”¨`./test.js` å‘½ä»¤æ‰§è¡Œ js æ–‡ä»¶ï¼š`test.js`æ–‡ä»¶ä¸­ç¬¬ä¸€è¡ŒåŠ å…¥è¿™è¡Œä»£ç  `#!/usr/bin/env node` ï¼Œç„¶åå‘½ä»¤è¡Œç›´æ¥è¾“å…¥ ï¼š`./test.js` å³å¯æ‰§è¡Œè¿™ä¸ª js æ–‡ä»¶ã€‚

```bash
# å› ä¸ºè¿™å¥å‘½ä»¤ç­‰äºç›´æ¥æ‰§è¡Œnode å‘½ä»¤
/usr/bin/env node
```

å¦‚æœä¸æƒ³ç”¨ `./test.js` è¿™æ ·çš„æ–¹å¼æ‰§è¡Œ js æ–‡ä»¶ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡ä¸€ä¸ªåƒ`vue`å‘½ä»¤ï¼Œåˆ›å»ºä¸ª `test` å‘½ä»¤æ¥ æŒ‡å‘æ‰§è¡Œè¿™ä¸ª`test.js`æ–‡ä»¶ï¼Œè¯¥å¦‚ä½•åšå‘¢ï¼Ÿ

- ç¬¬ä¸€ç§æ–¹å¼ï¼Œæˆ‘ä»¬å»æ‰¾ç¯å¢ƒå˜é‡ï¼Œé€šè¿‡å‘½ä»¤ï¼š `echo $PATH`ï¼Œæ‰¾åˆ°ç¯å¢ƒå˜é‡
  - 1.åˆ›å»ºä¸€ä¸ªç¯å¢ƒå˜é‡ï¼š
    - 1.æ‰¾åˆ° node çš„ bin ç›®å½•ï¼š`cd /Users/admin/.nvm/versions/node/v12.16.1/bin`
    - 2.åˆ›å»ºç¯å¢ƒå˜é‡â€”â€”è½¯è¿æ¥ï¼š`ln -s test /Users/admin/Desktop/test.js`ï¼Œæ ¼å¼ï¼š`ln -s [ç›®å½•æ–‡ä»¶] [å˜é‡å]`
  - 2.è½¯è¿æ¥åˆ›å»ºå®Œæ¯•åï¼Œå°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ª test è½¯è¿æ¥ï¼Œæˆ‘ä»¬åœ¨ä»»ä½•ç›®å½•çš„å‘½ä»¤è¡Œæ‰§è¡Œ `test` å°±å¯ä»¥æ‰§è¡Œ`test.js`æ–‡ä»¶äº†ã€‚

æ‰©å±•ä¸€ä¸‹ï¼Œæœ‰çš„åŒå­¦å¯èƒ½ä¼šé—®ä¸‹é¢ä¸¤ç§å†™æ³•çš„åŒºåˆ«?

```bash
# ç¬¬ä¸€ç§æ˜¯åœ¨ç¯å¢ƒå˜é‡ä¸­æŸ¥æ‰¾ nodeï¼ˆå¯é çš„ï¼‰
#!/usr/bin/env node
# ç¬¬äºŒç§æ˜¯ç›´æ¥æ‰§è¡Œ/usr/bin/ç›®å½•ä¸‹çš„node
#!/usr/bin/node
```

### è„šæ‰‹æ¶åŸç†è¿›é˜¶

æŒæ¡ä¸ŠèŠ‚å†…å®¹åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å°è¯•å›ç­”ä»¥ä¸‹ 2 ä¸ªé—®é¢˜ï¼š

**5.ä¸ºä»€ä¹ˆè¯´è„šæ‰‹æ¶æœ¬è´¨æ˜¯æ“ä½œç³»ç»Ÿçš„å®¢æˆ·ç«¯ï¼Ÿå®ƒå’Œæˆ‘ä»¬åœ¨ PC ä¸Šå®‰è£…çš„åº”ç”¨/è½¯ä»¶æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

å› ä¸º `node` æœ¬èº«æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œåœ¨ `windows` ç³»ç»Ÿä¸‹ï¼Œå¯ä»¥çœ‹åˆ° `node` çš„å®‰è£…ç›®å½•ä¸­ï¼Œ`node` æ˜¯ä»¥ `node.exe` çš„å½¢å¼å‡ºç°çš„ã€‚

è€Œæˆ‘ä»¬ç¼–å†™çš„è„šæ‰‹æ¶æ–‡ä»¶ï¼Œå¦‚ `vue.js` åªæ˜¯ `node` è¿è¡Œæ—¶çš„ä¸€ä¸ªå‚æ•°ã€‚

```bash
node vue.js
```

ç­”ï¼šè„šæ‰‹æ¶æ‰§è¡Œèµ·æ¥çš„æœ¬è´¨æ˜¯é  node è¿™ä¸ªå‘½ä»¤ï¼Œnode æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿå®¢æˆ·ç«¯ï¼Œè€Œ test.js è¿™ä¸ªæ–‡ä»¶ä»…ä»…æ˜¯ä½œä¸ºä¸€ä¸ªå‚æ•°æ³¨å…¥åˆ° node å‘½ä»¤ä¸­ã€‚

node æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶(åœ¨ window æ“ä½œç³»ç»Ÿä¸­å¯ä»¥çœ‹åˆ° node çš„æ‰©å±•åä¸º.exe çš„)ã€‚

node å’Œ PC ä¸Šå®‰è£…çš„åº”ç”¨/è½¯ä»¶ æœ¬è´¨æ¥è¯´æ²¡æœ‰åŒºåˆ«ã€‚åŒºåˆ«ä»…ä»…æ˜¯å®‰è£…çš„åº”ç”¨è½¯ä»¶ä¼šæä¾›ä¸€ä¸ª GUIï¼Œè€Œ node å¹¶æ²¡æœ‰æä¾› GUIï¼ŒNode é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ‰§è¡Œ

**6.å¦‚ä½•ä¸º node è„šæ‰‹æ¶åˆ›å»ºåˆ«åï¼Ÿ**

è½¯è¿æ¥æ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œåªéœ€è®©åˆ«åæŒ‡å‘åŸæ¥çš„åå­—å³å¯ã€‚

æ–¹æ³•ä¸€ï¼šå³ä¸ºä¸Šæ–‡æåˆ°çš„åˆ›å»ºä¸€ä¸ªè½¯è¿æ¥ã€‚ æ¥ç€ï¼Œæˆ‘ä»¬å¸Œæœ›ç»§ç»­ä¸ºä¸Šæ–‡æåˆ°çš„ `test` è½¯è¿æ¥ç»§ç»­æ·»åŠ ä¸€ä¸ªåˆ«åï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¹ˆåš åœ¨ä¸Šæ–‡çš„ bin ç›®å½•ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤ `ln -s ./test test2` å³ è½¯è¿æ¥å¯ä»¥åµŒå¥—ã€‚

**æè¿°è„šæ‰‹æ¶å‘½ä»¤æ‰§è¡Œçš„å…¨è¿‡ç¨‹**

![img](./img/è„šæ‰‹æ¶æ‰§è¡Œçš„å…¨è¿‡ç¨‹.jpg)

è¿‡ç¨‹ï¼š

# è„šæ‰‹æ¶æ¡†æ¶æ­å»º

## 1.è„šæ‰‹æ¶å¼€å‘å…¥é—¨

1.åˆ›å»º `npm` é¡¹ç›®

2.åˆ›å»ºè„šæ‰‹æ¶å…¥å£æ–‡ä»¶ï¼Œæœ€ä¸Šæ–¹æ·»åŠ 

```bash
#!/usr/bin/env node
```

3.é…ç½® `package.json` æ–‡ä»¶ï¼Œæ·»åŠ  `bin` å±æ€§ï¼ŒæŒ‡å®šè„šæ‰‹æ¶åç§°å’Œå…¥å£æ–‡ä»¶åœ°å€ä¾‹å¦‚ vue çš„

```json
"bin": {
    "vue": "bin/vue.js"
}
```

4.ç¼–å†™è„šæ‰‹æ¶ä»£ç 

5.å°†è„šæ‰‹æ¶å‘å¸ƒåˆ° `npm`

6.å°±å¯ä»¥åœ¨ npm å®‰è£…è„šæ‰‹æ¶äº†

## 2.è„šæ‰‹æ¶ä½¿ç”¨æµç¨‹

ä»¥ @vue/cli è„šæ‰‹æ¶ä¸ºä¾‹

1.å®‰è£…è„šæ‰‹æ¶

```javascript
npm i -g @vue/cli
```

2.ä½¿ç”¨è„šæ‰‹æ¶

```javascript
vue create project
```

## 3.è„šæ‰‹æ¶å¼€å‘éš¾ç‚¹

- åˆ†åŒ…ï¼šå°†å¤æ‚çš„ç³»ç»Ÿæ‹†åˆ†æˆå¤šä¸ªæ¨¡å—

- å‘½ä»¤æ³¨å†Œï¼š

- ```bash
  vue create
  vue add
  vue invoke
  ```

- å‚æ•°è§£æï¼š

- ```bash
  vue command [options] <params>
  ```

  - options å…¨ç§°ï¼š`--version`ã€ `--help`
  - options ç®€å†™ï¼š`-v`ã€`-h`
  - å¸¦ params çš„ optionsï¼š`--path /Users/sam/Desktop/vue-test`

- å¸®åŠ©æ–‡æ¡£

  - global help
    - Usage
    - Options
    - Commands

  ç¤ºä¾‹ï¼š`vue`çš„å¸®åŠ©ä¿¡æ¯ï¼š

  ```bash
  ...
  ```

è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š

- å‘½ä»¤è¡Œäº¤äº’ï¼ˆæç¤ºå’Œé€‰æ‹©ï¼‰

- æ—¥å¿—æ‰“å°ï¼ˆæ‰“å°ä¿¡æ¯ï¼‰

- å‘½ä»¤è¡Œæ–‡å­—å˜è‰²

- ç½‘ç»œé€šä¿¡ï¼š`HTTP/WebSocket`

- æ–‡ä»¶å¤„ç†

- ç­‰ç­‰... ...

## 4.å¼€å‘ä¸€ä¸ªç®€å•çš„è„šæ‰‹æ¶

### test-cli è„šæ‰‹æ¶å¼€å‘

1.æ–°å»ºé¡¹ç›®æ–‡ä»¶å¤¹ `test-cli`

```bash
mkdir test-cli
```

2.è¿›å…¥åˆ° `test-cli` ï¼Œ- åˆå§‹åŒ– `npm` åŒ…ï¼Œé€šè¿‡ `code .` å¯ä»¥å¿«é€Ÿä½¿ç”¨ `vscode` æ‰“å¼€å½“å‰æ–‡ä»¶å¤¹ã€‚

```bash
# è¿›å…¥é¡¹ç›®æ–‡ä»¶å¤¹
cd test-cli
# åˆå§‹åŒ–é¡¹ç›®package.json
npm init -y
# ä½¿ç”¨VSCodeæ‰“å¼€å½“å‰é¡¹ç›®
code .
```

3.æ·»åŠ  `bin/index.js` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹

```javascript
#!/usr/bin/env node

console.log("ğŸš€ğŸš€~ è„šæ‰‹æ¶å¼€å‘ æµ‹è¯•");
```

4.ä¿®æ”¹ `package.json` æ–‡ä»¶ï¼Œæ·»åŠ  `bin` å±æ€§ï¼ŒæŒ‡å®šè„šæ‰‹æ¶åç§°å’Œå…¥å£æ–‡ä»¶åœ°å€

```json
// package.json
{
	"name": "test-cli-0174",
	"version": "1.0.0",
	"description": "",
	"bin": {
		"test-cli": "bin/index.js"
	},
	"main": "index.js",
	"scripts": {
		"test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
	},
	"keywords": [],
	"author": "",
	"license": "ISC"
}
```

5.å‘å¸ƒè„šæ‰‹æ¶åŒ…åˆ° `npm`

å‘å¸ƒ npm åŒ…çœ‹æ•™ç¨‹ï¼šğŸ‘‰ğŸ‘‰ [ä» 0 åˆ° 1 å‘å¸ƒå±äºè‡ªå·±çš„åº“åˆ° npm ](https://juejin.cn/post/6997182885769773063)

6.å…¨å±€å®‰è£…åˆšåˆšå‘å¸ƒçš„è„šæ‰‹æ¶

```bash
npm i -g test-cli
```

7.å®‰è£…è„šæ‰‹æ¶åï¼Œåœ¨å‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤

```bash
test-cli
```

ç»“æœä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š `ğŸš€ğŸš€~ è„šæ‰‹æ¶å¼€å‘ æµ‹è¯•`

8.çœ‹çœ‹ `test-cli` å‘½ä»¤çš„è½¯é“¾æ¥æŒ‡å‘

```bash
which test-cli
```

### è„šæ‰‹æ¶æœ¬åœ°è°ƒè¯•

**æ–¹å¼ä¸€**ï¼šå¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œç›´æ¥åœ¨ Desktop ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå³è°ƒè¯•æœ¬åœ°åŒ…ï¼š

```bash
# å…¨å±€å®‰è£…è‡ªå·±ä¸Šä¼ npmçš„è„šæ‰‹æ¶
npm install -g test-cli
# ç§»é™¤æœ¬åœ°å…¨å±€å®‰è£…çš„è„šæ‰‹æ¶åŒ…
npm remove -g test-cli
```

**æ–¹å¼äºŒ**ï¼šç›´æ¥åœ¨ test-cli é¡¹ç›®æ–‡ä»¶ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè½¯é“¾æŒ‡å‘çš„ node_modules æºæ–‡ä»¶æŒ‡å‘æœ¬åœ°åŒ…ï¼š

```bash
npm link
```

è¿›å…¥åˆ° `test-cli` ç›®å½•ä¸­

å…ˆå…¨å±€ç§»é™¤ä¹‹å‰é€šè¿‡ `npm` å®‰è£…çš„åŒ…ï¼Œç„¶åæ‰§è¡Œ `npm link`

```bash
npm remove test-cli -g
npm link
```

å°±ä¼šå®‰è£…æœ¬åœ°çš„è„šæ‰‹æ¶äº†

éšä¾¿ä¿®æ”¹æœ¬åœ°ä»£ç åï¼Œç„¶åå†é€šè¿‡å‘½ä»¤ `test-cli` å»å¯åŠ¨è„šæ‰‹æ¶

**æ–¹å¼ä¸‰**ï¼š**åˆ†åŒ…è°ƒè¯•**ï¼šå¦‚æœå·¥ç¨‹å¾ˆå¤æ‚éœ€è¦åˆ†åŒ…

1.æ–°å»ºä¸€ä¸ª `test-cli-lib` é¡¹ç›®ç›®å½•ï¼ŒåŒæ ·è¿›è¡Œåˆå§‹åŒ–ã€‚

```bash
# åˆå§‹åŒ–é¡¹ç›®
npm init -y
```

2.ç„¶åæ–°å»º `lib/index.js` æ–‡ä»¶ï¼Œå†™ä¸Šä¸€ä¸ªæ–¹æ³•ã€‚

```javascript
module.exports = {
	sum(a, b) {
		return a + b;
	},
};
```

3.ä¿®æ”¹ `test-cli-lib` æ ¹ç›®å½•çš„ `package.json` æ–‡ä»¶ä¸­çš„ `main` å±æ€§ï¼Œæ”¹æˆ

```javascript
"main": "lib/index.js",
```

4.è¿›å…¥ `test-cli-lib` ç›®å½• ï¼Œ æ‰§è¡Œ `npm link` ï¼ŒæŠŠè¿™ä¸ªåŒ…ä¹Ÿå®‰è£…åˆ°æœ¬åœ°ã€‚

5.è¿›å…¥ `test-cli` é¡¹ç›®ç›®å½•ï¼Œè½¯é“¾æ¥ `test-cli-lib`é¡¹ç›®

```bash
# é“¾æ¥
npm link test-cli-lib
# æŸ¥çœ‹é“¾æ¥æ˜¯å¦æˆåŠŸ
which test-cli

# æ‹“å±•ï¼šè§£é™¤é“¾æ¥
# npm unlink test-cli-lib
```

6.é“¾æ¥å®Œåç„¶åæ‰‹åŠ¨çš„ä¿®æ”¹ `package.json` æ–‡ä»¶ä¸­çš„ `dependencies` å±æ€§ï¼Œæ‰‹åŠ¨æŒ‡å®š`test-cli-lib`åŒ…çš„ç‰ˆæœ¬

```json
  "dependencies": {
    "test-cli-lib": "^1.0.0"
  }
```

7.å°±å¯ä»¥æŠŠè¿™ä¸ªåŒ…è¿æ¥èµ·æ¥äº†ï¼Œç„¶åå†ä¿®æ”¹ `test-cli` é¡¹ç›®ä»£ç ï¼š`test-cli/bin/index.js`

```javascript
// test-cli/bin/index.js
#!/usr/bin/env node

const lib = require("test-cli-lib")
console.log(lib);
console.log('ğŸš€ğŸš€~ æœ¬åœ°è„šæ‰‹æ¶å¼€å‘ æµ‹è¯•!!!!');
```

8.è¿è¡Œ `test-cli` å‘½ä»¤

å¯ä»¥æŠŠå‡½æ•°æ­£å¸¸çš„æ‰“å°å‡ºæ¥äº†

æ³¨æ„ï¼šå½“å¼€å‘å®Œæˆåéœ€è¦å‘å¸ƒåˆ° `npm` ä¸Šï¼Œç„¶åé€šè¿‡ `npm` å®‰è£…çš„æ—¶å€™ï¼Œéœ€è¦æ‰§è¡Œ

```bash
npm unlink  test-cli
npm unlink  test-cli-lib
npm remove -g test-cli
npm remove -g test-cli-lib
```

ç„¶åå†é€šè¿‡ `npm` å®‰è£…å°±è¡Œäº†

```bash
npm i -g test-cli
npm i -g test-cli-lib
```

### è„šæ‰‹æ¶æœ¬åœ°è°ƒè¯•æ ‡å‡†æµç¨‹æ€»ç»“

**é“¾æ¥æœ¬åœ°è„šæ‰‹æ¶**

```bash
cd your-cli-dir
npm link
```

**é“¾æ¥æœ¬åœ°åº“æ–‡ä»¶**

```bash
cd your-lib-dir
# é“¾æ¥æœ¬åœ°åº“æ–‡ä»¶
npm link
cd your-cli-dir
npm link your-lib-dir
```

**å–æ¶ˆé“¾æ¥æœ¬åœ°åº“æ–‡ä»¶**

```bash
cd your-lib-dir
# å–æ¶ˆé“¾æ¥æœ¬åœ°åº“æ–‡ä»¶
npm unlink

cd your-cli-dir
# linkå­˜åœ¨ï¼Œå–æ¶ˆé“¾æ¥
npm unlink your-lib-dir
# linkä¸å­˜åœ¨ï¼Œåˆ é™¤node_modules
rm -rf node_modules
# å®‰è£…è¿œç¨‹åº“æ–‡ä»¶
npm i -S your-lib-dir
```

**ç†è§£ npm link**

- `npm link`ï¼šå°†å½“å‰é¡¹ç›®é“¾æ¥åˆ° node å…¨å±€ node_modules ä¸­ä½œä¸ºä¸€ä¸ªåº“æ–‡ä»¶ï¼Œå¹¶è§£æ bin é…ç½®åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
- `npm link your-lib`ï¼šå°†å½“å‰é¡¹ç›®ä¸­ node_modules ä¸‹æŒ‡å®šçš„åº“æ–‡ä»¶é“¾æ¥åˆ° node å…¨å±€ node_modules ä¸‹çš„åº“æ–‡ä»¶

**ç†è§£ npm unlink**

- `npm unlink`ï¼šå°†å½“å‰é¡¹ç›®ä» node å…¨å±€ node_modules ä¸­ç§»é™¤
- `npm unlink your-lib`ï¼šå°†å½“å‰é¡¹ç›®ä¸­çš„åº“æ–‡ä»¶ä¾èµ–åˆ é™¤ã€‚

### è„šæ‰‹æ¶å‘½ä»¤æ³¨å†Œå’Œå‚æ•°è§£æ

process æ˜¯ node çš„å†…ç½®åº“ æˆ‘ä»¬åœ¨ index.js ä¸­å†™ä»£ç ï¼š `console.log(require('process'))` é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œ test-test init ä¼šçœ‹åˆ° process æœ‰è®¸è®¸å¤šå¤šä¸ªå±æ€§ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª argv å±æ€§ã€‚ é€šè¿‡åˆ†æè¿™ä¸ª argv å±æ€§ï¼Œæˆ‘ä»¬å°±çœ‹åˆ°äº† init è¿™ä¸ªå±æ€§ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ argv æ¥åˆ¤æ–­æ˜¯å¦è¾“å…¥äº† init è¿™ä¸ªå‘½ä»¤ã€‚

`test-cli` é¡¹ç›®ï¼Œ`/bin/index.js` æ–‡ä»¶

```javascript
#!/usr/bin/env node

const lib = require("imooc-test-lib");
// æ³¨å†Œä¸€ä¸ªå‘½ä»¤ï¼šimooc-test init
const argv = require("process").argv;
const command = argv[2];
// æˆªå–å‘½ä»¤å‚æ•°
const options = argv.slice(3);

if (options.length > 1) {
	let [option, param] = options;

	option = option.replace("--", "");

	if (command) {
		if (lib[command]) {
			lib[command]({ option, param });
		} else {
			console.log("æ— æ•ˆçš„å‘½ä»¤");
		}
	} else {
		console.log("è¯·è¾“å…¥å‘½ä»¤");
	}
}

// å®ç°å‚æ•°è§£æ --version å’Œ init --name
if (command.startswith("--") || command.startswith("-")) {
	const globalOption = command.replace(/--|-/g, "");
	console.log(globaloption);
	if (globalOption === "version" || globaloption === "V") {
		// è¾“å‡ºç‰ˆæœ¬å·
		console.log("1.0.0");
	}
}
```

`test-cli-lib` é¡¹ç›®ï¼Œ`/lib/index.js` æ–‡ä»¶

```js
module.exports = {
	sum(a, b) {
		return a + b;
	},
	mul(a, b) {
		return a * b;
	},
	init({ option, param }) {
		console.log("æ‰§è¡Œinitæµç¨‹", option, param);
	},
};
```

### è„šæ‰‹æ¶é¡¹ç›®å‘å¸ƒ

> npm publish é€šè¿‡åˆ¤æ–­ argv è¾“å…¥çš„å‚æ•°ï¼Œåœ¨ test-cli-lib ä¸­ä¸ test-cli ä¸­åŠ å…¥ç›¸å…³é€»è¾‘ å®ç° test-cli init ä¸ test-cli -V çš„è¾“å‡ºæ˜¾ç¤º ç„¶ååˆ†åˆ«å‘å¸ƒï¼Œremove æ‰æœ¬åœ°é“¾æ¥ã€‚

`test-cli-lib` é¡¹ç›®

```bash
# è§£é™¤è½¯è¿æ¥
npm unlink
# å‘å¸ƒï¼ˆå¦‚æœç‰ˆæœ¬å­˜åœ¨ä¾¿éœ€è¦åœ¨package.jsonä¸­å‡çº§versionç‰ˆæœ¬ï¼‰
npm publish
```

## åŸç”Ÿè„šæ‰‹æ¶å¼€å‘ç—›ç‚¹(ä¸ºä»€ä¹ˆéœ€è¦ Lerna)

ç—›ç‚¹ä¸€ï¼šé‡å¤æ“ä½œ

- å¤š Package æœ¬åœ° link
- å¤š Package ä¾èµ–å®‰è£…
- å¤š Package å•å…ƒæµ‹è¯•
- å¤š Package ä»£ç æäº¤
- å¤š Package ä»£ç å‘å¸ƒ

ç—›ç‚¹äºŒï¼šç‰ˆæœ¬ä¸€è‡´æ€§

- å‘å¸ƒæ—¶ç‰ˆæœ¬ä¸€è‡´æ€§
- å‘å¸ƒåç›¸äº’ä¾èµ–ç‰ˆæœ¬å‡çº§

> package è¶Šå¤šï¼Œç®¡ç†å¤æ‚åº¦è¶Šé«˜

## commander åŒ…

**ç”¨æ¥ç»™è‡ªå·±çš„è„šæ‰‹æ¶å®ç°å‘½ä»¤å‚æ•°çš„é€‰é¡¹è§£æ**

Commander è´Ÿè´£å°†å‚æ•°è§£æä¸ºé€‰é¡¹å’Œå‘½ä»¤å‚æ•°ï¼Œä¸ºé—®é¢˜æ˜¾ç¤ºä½¿ç”¨é”™è¯¯ï¼Œå¹¶å®ç°ä¸€ä¸ªæœ‰å¸®åŠ©çš„ç³»ç»Ÿã€‚

å®Œæ•´çš„ [node.js](http://nodejs.org/) å‘½ä»¤è¡Œè§£å†³æ–¹æ¡ˆã€‚

å¼€æºåœ°å€ï¼šhttps://github.com/tj/commander.js

npmï¼š[commander - npm (npmjs.com)](https://www.npmjs.com/package/commander)

ä¸­æ–‡æ–‡æ¡£ï¼š[commander.js/Readme_zh-CN.md](https://github.com/tj/commander.js/blob/HEAD/Readme_zh-CN.md)

## Lerna æºç è§£æ

Lerna å¼€æº GitHub åœ°å€ï¼š[lerna/lerna: :dragon: Lerna is a fast, modern build system for managing and publishing multiple JavaScript/TypeScript packages from the same repository. (github.com)](https://github.com/lerna/lerna)

Lerna å®˜ç½‘ï¼š[Documentation | Lerna](https://lerna.js.org/)

Lerna æ–‡æ¡£ï¼š[Getting Started | Lerna](https://lerna.js.org/docs/getting-started)

### Lerna çš„åŸºæœ¬æ¦‚å¿µç®€ä»‹

lerna æ˜¯ä¸€ä¸ªä¼˜åŒ–åŸºäº git+npm çš„å¤š package é¡¹ç›®çš„ç®¡ç†å·¥å…·ã€‚

å¯ä»¥è®©ä½ åœ¨ä¸»é¡¹ç›®ä¸‹ç®¡ç†å¤šä¸ªå­é¡¹ç›®ï¼Œä»è€Œè§£å†³äº†å¤šä¸ªåŒ…äº’ç›¸ä¾èµ–ï¼Œä¸”å‘å¸ƒæ—¶éœ€è¦æ‰‹åŠ¨ç»´æŠ¤å¤šä¸ªåŒ…çš„é—®é¢˜ï¼Œæ¯ä¸ª package éƒ½æœ‰è‡ªå·±çš„ä¾èµ–é¡¹ï¼ˆpackage.jsonï¼‰ï¼Œèƒ½å¤Ÿä½œä¸ºç‹¬ç«‹çš„ npm package å‘å¸ƒï¼Œåªæ˜¯æºç æ”¾åœ¨ä¸€èµ·ç»´æŠ¤ï¼Œå…¬å…±åŒ…å¯ä»¥æ”¾åœ¨æ ¹ç›®å½•ä¸­çš„ package.json ä¸­ç»´æŠ¤ã€‚

ç‰¹æ€§ï¼š

- 1ã€æ ¹æ® Git æäº¤ä¿¡æ¯ï¼Œè‡ªåŠ¨ç”Ÿæˆ changelog
- 2ã€æäº¤ä»£ç ï¼Œä»£ç æ£€æŸ¥ hook
- 3ã€éµå¾ª semver ç‰ˆæœ¬è§„èŒƒ

ä¼˜åŠ¿ï¼š

- å¤§å¹…å‡å°‘é‡å¤æ“ä½œ
- æå‡æ“ä½œçš„æ ‡å‡†åŒ–

> Lerna æ˜¯æ¶æ„ä¼˜åŒ–çš„äº§ç‰©ï¼Œå®ƒæ­ç¤ºäº†ä¸€ä¸ªæ¶æ„çœŸç†: é¡¹ç›®å¤æ‚åº¦æå‡åï¼Œå°±éœ€è¦å¯¹é¡¹ç›®è¿›è¡Œæ¶æ„ä¼˜åŒ–ã€‚æ¶æ„ä¼˜åŒ–çš„ä¸»è¦ç›®æ ‡å¾€å¾€éƒ½æ˜¯ä»¥æ•ˆèƒ½ä¸ºæ ¸å¿ƒ

```bash
ç›®å½•ç»“æ„
â”œâ”€â”€ lerna.json
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â”œâ”€â”€ package1
    â”‚   â””â”€â”€ package.json
    â”œâ”€â”€ package2
        â””â”€â”€ package.json
```

### Lerna èƒ½åšä»€ä¹ˆï¼Ÿ

Lerna ä¸¤ä¸ªåŸºæœ¬çš„çš„å‘½ä»¤æ˜¯ï¼š`lerna bootstrap` å’Œ `lerna publish`ã€‚

- `bootstrap` ä¼šå°†åº“ä¸­çš„ä¾èµ–è”ç³»èµ·æ¥ã€‚
- `publish` å°†å‘å¸ƒä»»ä½•æ›´æ–°çš„åŒ…ã€‚

### Lerna ä¸èƒ½åšä»€ä¹ˆï¼Ÿ

Lerna ä¸æ˜¯æ— æœåŠ¡å™¨ [monorepos](https://github.com/babel/babel/blob/master/doc/design/monorepo.md) çš„éƒ¨ç½²å·¥å…·ã€‚[Hoisting](https://github.com/lerna/lerna/blob/main/doc/hoist.md) å¯èƒ½ä¸ä¼ ç»Ÿçš„æ— æœåŠ¡å™¨ [monorepos](https://github.com/babel/babel/blob/master/doc/design/monorepo.md) éƒ¨ç½²æŠ€æœ¯ä¸å…¼å®¹ã€‚

#### ä½¿ç”¨ Lerna ç®¡ç†çš„æ¡ˆä¾‹

ä½¿ç”¨ Lerna ç®¡ç†çš„å¤§å‹é¡¹ç›®:

- babelï¼šhttps://github.com/babel/babel
- vus-cliï¼šhttps://github.com/vuejs/vue-cli
- create-react-appï¼šhttps://github.com/facebook/create-react-app

### Lerna å®ç°åŸç†

- é€šè¿‡ import-local ä¼˜å…ˆè°ƒç”¨æœ¬åœ° lerna å‘½ä»¤
- ç”¨è¿‡ Yargs ç”Ÿæˆè„šæ‰‹æ¶ï¼Œå…ˆæ³¨å†Œå…¨å±€å±æ€§ï¼Œå†æ³¨å†Œå‘½ä»¤ï¼Œæœ€åé€šè¿‡ parse æ–¹æ³•è§£æå‚æ•°
- lerna å‘½ä»¤æ³¨å†Œæ—¶éœ€è¦ä¼ å…¥ builder å’Œ handler ä¸¤ä¸ªæ–¹æ³•ï¼Œ builder æ–¹æ³•ç”¨äºæ³¨å†Œå‘½ä»¤ä¸“å±çš„ optionsï¼Œhandler ç”¨æ¥å¤„ç†å‘½ä»¤çš„ä¸šåŠ¡é€»è¾‘
- lerna é€šè¿‡é…ç½® npm æœ¬åœ°ä¾èµ–çš„æ–¹å¼è¿›è¡Œæœ¬åœ°å¼€å‘ï¼Œå…·ä½“å†™æ³•æ˜¯åœ¨ package.json çš„ä¾èµ–ä¸­å†™å…¥ï¼šfill:your-kicak-module-pathï¼Œåœ¨ lerna publish æ—¶ä¼šè‡ªåŠ¨å°†è¯¥è·¯å¾„æ›¿æ¢

### åŸºäº Lerna åˆ›å»ºé¡¹ç›®ç®¡ç†

#### å¸¸ç”¨å‘½ä»¤

```bash
# åˆå§‹åŒ– Lerna é¡¹ç›®
lerna init
# åˆ›å»º Package
lerna create @diao-cli/core packages
# å®‰è£…ä¾èµ–
lerna add mocha packages/core --dev
# åˆ é™¤ä¾èµ–
lerna clean
# å®‰è£…ä¾èµ–
lerna boorstaap
# æ‰§è¡Œå•å…ƒæµ‹è¯•
lerna run test
# æ‰§è¡Œç‰¹å®šåŒ…å•å…ƒæµ‹è¯•
lerna run test @diao-cli/core
# link é¡¹ç›®
lerna link
# å‘å¸ƒé¡¹ç›®
lerna publish
```

#### 1ã€å®‰è£…/åˆå§‹åŒ– lerna

```bash
npm i lerna -g
lerna init
```

lerna.json é…ç½®

```json
{
	"private": true,
	"packages": ["packages/*"],
	"command": {
		"publish": {
			// å¿½ç•¥ä¿®æ”¹æ–‡ä»¶
			"ignoreChanges": ["ignored-file", "*.md"],
			"message": "chore(release): publish"
		},
		"bootstrap": {
			"ignore": "component-*"
		}
	},
	"version": "1.0.3"
}
```

#### 2ã€æ–°å¢åŒ…

```bash
# åˆ›å»ºä¸€ä¸ªåŒ…ï¼ŒnameåŒ…åï¼Œloc ä½ç½®å¯é€‰
lerna create <name> [loc]
# æŸ¥çœ‹åŒ…
lerna list
```

#### 3ã€å®‰è£…ä¾èµ– bootstrap

åŒ…ä¹‹é—´å¯ä»¥å»ºç«‹é“¾æ¥ï¼Œå½“ä¿®æ”¹ A åŒ…çš„æºä»£ç æ—¶ï¼ŒB çš„ node_modules ä¸­å¼•ç”¨çš„ A åŒ…ä¹Ÿä¼šç›¸åº”ä¿®æ”¹

```bash
lerna bootstrap
# ç»™Aæ·»åŠ ä»¥ä¾èµ–B
lerna add A --scope=B
# è¿™æ¡å‘½ä»¤ä¼šç»™æ‰€æœ‰çš„packageå®‰è£…ä¾èµ–
lerna bootstarp
# å®‰è£…æŸä¸ªä¾èµ–åŒ…
lerna bootstrap --scope=package
# æå‡å…¬å…±åŒ…åˆ°æ ¹ç›®å½•
lerna bootstrap --hoist axios
# åˆ é™¤æ‰€æœ‰ä¾èµ–
lerna clean
# åˆ é™¤æŸä¸ªåŒ…çš„ä¾èµ–
lerna clean --scope=package
```

#### 4ã€è¿è¡Œ package

```bash
# æ‰€æœ‰åŒ…éƒ½ä¼šæ‰§è¡Œæ‰“åŒ…å‘½ä»¤
lerna run build
# è¿è¡ŒæŸä¸ªåŒ…ä¸­çš„scriptå‘½ä»¤
lerna run start --scope=package
```

#### 5ã€å‘å¸ƒç‰ˆæœ¬ publish

å½“æ‰§è¡Œ lerna publish åä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä»¥åŠæ¯ä¸ª packages åŒ…ä¸‹ï¼Œç”Ÿæˆ CHANGELOG.md

è¿™ä¸ªå‘½ä»¤ è¯†åˆ«å‡ºä¿®æ”¹çš„åŒ… --> åˆ›å»ºæ–°çš„ç‰ˆæœ¬å· --> ä¿®æ”¹ package.json --> æäº¤ä¿®æ”¹ æ‰“ä¸Šç‰ˆæœ¬çš„ tag --> æ¨é€åˆ° git ä¸Šã€‚

```bash
lerna publish
# å¿½ç•¥ä¿®æ”¹å¼ºåˆ¶ç”Ÿæˆç‰ˆæœ¬
lerna version --force-publish
```

åˆ›å»º changelog

```bash
# å®‰è£…changlogæ’ä»¶
npm i conventional-changelog-cli --save
# ä½¿ç”¨äº†è¿™ä¸ªé€‰é¡¹ï¼Œ lerna ä¼šæ”¶é›†æ—¥å¿—ï¼Œ è‡ªåŠ¨ç”Ÿæˆ CHANGELOG
lerna version --conventional-commits
```

### Lerna å¼€å‘è„šæ‰‹æ¶æµç¨‹

#### 1ã€è„šæ‰‹æ¶é¡¹ç›®åˆå§‹åŒ–

- 1.åˆå§‹åŒ– npm é¡¹ç›®
- 2.å®‰è£… lerna
- 3.lerna init åˆå§‹åŒ–é¡¹ç›®

#### 2ã€åˆ›å»º package

- 1.lerna create åˆ›å»º Pacakge
- 2.lerna add å®‰è£…ä¾èµ–
- 3.lerna link é“¾æ¥ä¾èµ–

#### 3ã€è„šæ‰‹æ¶å¼€å‘å’Œæµ‹è¯•

- lerna exec æ‰§è¡Œ shell è„šæœ¬
- lerna run æ‰§è¡Œ npm å‘½ä»¤
- lerna clean æ¸…ç©ºä¾èµ–
- lerna bootstrap é‡è£…ä¾èµ–

#### 4ã€è„šæ‰‹æ¶å‘å¸ƒä¸Šçº¿

- lerna yersion || bump version
- lerna changed æŸ¥çœ‹ä¸Šç‰ˆæœ¬ä»¥æ¥çš„æ‰€æœ‰å˜æ›´
- lerna diff æŸ¥çœ‹ diff
- lerna publish é¡¹ç›®å‘å¸ƒ

### ã€å®æˆ˜ã€‘åŸºäº lerna æ­å»ºè„šæ‰‹æ¶æ¡†æ¶

#### 1.é¡¹ç›®ç›®å½•æ­å»º

**æœ¬èŠ‚ä½¿ç”¨å‘½ä»¤ä¾æ¬¡å¦‚ä¸‹**

```bash
# 1.åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹
mkdir test-cli-dev
# 2.è¿›å…¥åˆ›å»ºå¥½çš„é¡¹ç›®æ–‡ä»¶å¤¹
cd test-cli-dev
# 3.åˆå§‹åŒ–é¡¹ç›®çš„package.json
npm init -y
# 4.å…¨å±€å®‰è£…lerna
npm i -g lerna
# 5.é¡¹ç›®ä¸­å®‰è£…lerna
npm i -S lerna


# 6.åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼šä½¿ç”¨lernaå‘½ä»¤åˆå§‹åŒ–é¡¹ç›®ï¼Œç”Ÿæˆlerna.jsoné…ç½®æ–‡ä»¶ï¼Œå’Œæ–°å»ºäº†ä¸€ä¸ªpackagesç›®å½•
lerna init
# 7.åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼šä½¿ç”¨lernaå‘½ä»¤ï¼Œåœ¨packagesç›®å½•ä¸‹åˆ›å»ºcoreæ ¸å¿ƒæ–‡ä»¶å¤¹ï¼Œç„¶åæœ‰é€‰æ‹©é…ç½®é€‰é¡¹
lerna create core
# 8.åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼šä½¿ç”¨lernaå‘½ä»¤ï¼Œåœ¨packagesç›®å½•ä¸‹åˆ›å»ºutilsåˆ›å»ºå·¥å…·æ–‡ä»¶å¤¹ï¼Œç„¶åæœ‰é€‰æ‹©é…ç½®é€‰é¡¹
lerna create utils
```

#### 2.Lerna æ ¸å¿ƒæ“ä½œ

æœ¬èŠ‚ä½¿ç”¨å‘½ä»¤ä¾æ¬¡å¦‚ä¸‹ï¼š

```bash
# åœ¨packagesç›®å½•ä¸‹æ‰€æœ‰åŒ…ä¸­å®‰è£…test-teståŒ…
lerna add test-cli
# åœ¨æŒ‡å®šåŒ…coreä¸­æ·»åŠ ä¾èµ–
lerna add test-cli packages/core
# æŒ‡å®šåŒ…æ·»åŠ ä¾èµ–
lerna add @test-cli/utils packages/core/
# æ¸…é™¤packagesç›®å½•ä¸‹çš„ä¾èµ–
lerna clean
# å°†åˆšæ¸…é™¤çš„æ‰€æœ‰ä¾èµ–ï¼Œé‡æ–°å®‰è£…ä¾èµ–ï¼Œå¹¶å®Œæˆè½¯è¿æ¥
lerna bootstrap
# å¼€å‘çš„ç‰ˆæœ¬äº’ç›¸å­˜åœ¨ä¾èµ–ï¼Œå¯ç”¨æ­¤å‘½ä»¤å®Œæˆ
lerna link

# è„šæ‰‹æ¶å¼€å‘å’Œæµ‹è¯•
lerna exec â€“ [â€¦args]

# åˆ é™¤packagesç›®å½•ä¸‹utilsçš„ã€ä¸Šä¸‹æ–‡ä¸ºpackagesç›®å½•ã€‘
lerna exec --scope @test-cli/utilsâ€“rm -rf node_modules
# åˆ é™¤packagesç›®å½•ä¸‹çš„æ‰€æœ‰node_modulesæ–‡ä»¶å¤¹
lerna exec â€“ rm -rf node_modules

# è„šæ‰‹æ¶æµ‹è¯•
lerna run test
# æ‰§è¡ŒcoreåŒ…package.jsonä¸­scriptæ ‡ç­¾çš„testå±æ€§
lerna run --scope @test-cli/core test
```

#### 3.Lerna å‘å¸ƒä¸Šçº¿æµç¨‹(lerna ä½¿ç”¨æ€»ç»“)

- `lerna init `ï¼šä¼šè‡ªåŠ¨å®Œæˆ git åˆå§‹åŒ–ï¼Œä½†ä¸ä¼šåˆ›å»º .gitignoreï¼Œè¿™ä¸ªå¿…é¡»è¦æ‰‹åŠ¨æ·»åŠ ï¼Œå¦åˆ™ä¼šå°† node_modules ç›®å½•éƒ½ä¸Šä¼ åˆ° git

- `lerna add`ï¼šç¬¬ä¸€ä¸ªå‚æ•°ï¼šæ·»åŠ  npm åŒ…å ç¬¬äºŒä¸ªå‚æ•°ï¼šæœ¬åœ° package çš„è·¯å¾„ï¼ˆå¦‚æœä¸åŠ ï¼Œåˆ™å…¨éƒ¨å®‰è£…ï¼‰ å¯é€‰å‚æ•°ï¼šâ€“devï¼šå°†ä¾èµ–å®‰è£…åˆ° devDependencies,ä¸åŠ æ—¶å®‰è£…åˆ° dependencies

- `lerna link`ï¼šå¦‚æœæœªå‘å¸ƒä¸Šçº¿ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ° package.json ä¸­å†æ‰§è¡Œã€‚

- `lerna clean`ï¼šåªä¼šåˆ é™¤ node_modules,ä¸ä¼šåˆ é™¤ package.json ä¸­çš„ä¾èµ–

- `lerna exec å’Œ lerna run`ï¼šâ€“scope å±æ€§åæ·»åŠ çš„æ˜¯åŒ…åï¼Œä¸æ˜¯ package çš„è·¯å¾„ï¼Œè¿™ç‚¹å’Œ lerna add ä¸åŒ

- `lerna changed`ï¼šæŸ¥çœ‹å“ªäº›æ”¹å˜å°†ä¼šè¢«å‘å¸ƒ

- `lerna diff`ï¼šæŸ¥çœ‹å˜æ›´çš„ä»£ç ç‰‡æ®µ

- `lerna version`ï¼šé€‰æ‹©å½“å‰é¡¹ç›®çš„ç‰ˆæœ¬å·

- `lerna publish`ï¼š

  - å‘å¸ƒæ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œ `git add package-lock.json`ï¼Œæ‰€ä»¥è¯¥æ–‡ä»¶ä¸èƒ½åŠ å…¥åˆ° `.gitignore` ä¸­å»ã€‚

  - å‘å¸ƒæ—¶å…ˆåˆ›å»ºè¿œç¨‹ä»“åº“ï¼Œä¸” push ä»£ç ã€‚

  - æ‰§è¡Œ `npm publish` ï¼Œä¹‹å‰å®Œæˆ npm å®˜ç½‘çš„ç™»å½•ï¼š `npm login`ï¼Œå¦åˆ™ä¼šå‘å¸ƒå¤±è´¥ï¼Œéœ€è¦ç™»å½•åï¼Œé‡æ–°ä¿®æ”¹å†å‘å¸ƒ

  - å¦‚æœå‘å¸ƒçš„åŒ…åä¸º @xxxx/yyy çš„æ ¼å¼ï¼Œéœ€è¦åœ¨ npmjs.org ä¸Šæ³¨å†Œ organization

  - å‘å¸ƒåˆ° npm group æ—¶é»˜è®¤ä¸º privateï¼Œ`package.json`ä¸­éœ€æ‰‹åŠ¨æ·»åŠ é…ç½®ï¼š

  - ```json
    "publishConfig": { "access": "public" }
    ```

å»ºè®®æ‰€æœ‰æ“ä½œå®Œæˆé—­ç¯ï¼Œæ‰æ¥ç€åç»­

### Lerna æºç è§£æ

> æºç ä»“åº“ï¼šhttps://github.com/lerna/lerna

#### ä¸ºä»€ä¹ˆè¦åšæºç è§£æ

- è‡ªæˆ‘æˆé•¿ã€æå‡ç¼–ç èƒ½åŠ›å’ŒæŠ€æœ¯æ·±åº¦çš„éœ€è¦
- ä¸ºæˆ‘æ‰€ç”¨ï¼Œåº”ç”¨åˆ°å®é™…å¼€å‘ï¼Œå®é™…äº§ç”Ÿæ•ˆç›Š
- å­¦ä¹ å€Ÿé‰´ï¼Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œç™»é«˜æœ›è¿œ

#### ä¸ºä»€ä¹ˆè¦åˆ†æ Lerna æºç 

- 3W+ star çš„æ˜æ˜Ÿé¡¹ç›®
- Lerna æ˜¯è„šæ‰‹æ¶ï¼Œå¯¹æˆ‘ä»¬å¼€å‘è„šæ‰‹æ¶æœ‰å€Ÿé‰´æ„ä¹‰
- Lerna é¡¹ç›®ä¸­è•´å«å¤§é‡çš„æœ€ä½³å®è·µï¼Œå€¼å¾—æ·±å…¥ç ”ç©¶å’Œå­¦ä¹ 

#### å­¦ä¹ ç›®æ ‡

- Lerna æºç ç»“æ„å’Œæ‰§è¡Œæµç¨‹åˆ†æ
- `import-local` æºç æ·±åº¦ç²¾è¯»

#### å­¦ä¹ æ”¶è·

- å¦‚ä½•å°†æºç åˆ†æå†™è¿›ç®€å†
- å­¦ä¹ æ˜æ˜Ÿé¡¹ç›®çš„æ¶æ„è®¾è®¡
- è·å¾—è„šæ‰‹æ¶æ‰§è¡Œæµç¨‹çš„ä¸€ç§å®ç°æ€è·¯
- è·å¾—è„šæ‰‹æ¶è°ƒè¯•æœ¬åœ°æºç çš„å¦ä¸€ç§æ–¹å¼
- Node.js åŠ è½½ node_modules æ¨¡å—çš„æµç¨‹ âœ¨âœ¨âœ¨âœ¨âœ¨
- å„ç§æ–‡ä»¶æ“ä½œç®—æ³•å’Œæœ€ä½³å®è·µ

#### 1.lerna æºç ç»“æ„åˆ†æå’Œè°ƒè¯•æŠ€å·§

å‡†å¤‡æºç ï¼š

- 1.å…‹éš†æˆ–ä¸‹è½½æºç ï¼šhttps://github.com/lerna/lerna
- 2.å®‰è£…æºç ä¾èµ–
- 3.VSCode æ‰“å¼€

æºç é˜…è¯»å‡†å¤‡å®Œæˆçš„æ ‡å‡†(åˆ’é‡ç‚¹)

- æ‰¾åˆ°å…¥å£æ–‡ä»¶
- èƒ½å¤Ÿæœ¬åœ°è°ƒè¯•

##### æºç ç»“æ„

å…¥å£æ–‡ä»¶ï¼š`lerna/packages/core/lerna/package.json`

```json
"bin": {
	"lerna": "dist/cli.js"
}
```

å…¥å£æ–‡ä»¶ä»£ç ï¼š`lerna\packages\lerna\src\cli.js`

```js
#!/usr/bin/env node

/* eslint-disable */

"use strict";

const importLocal = require("import-local");

if (importLocal(__filename)) {
	require("npmlog").info("cli", "using local version of lerna");
} else {
	require(".")(process.argv.slice(2));
}
```

**æºç  debug æ“ä½œæ­¥éª¤**ï¼š

- 1.github ä¸‹è½½ lerna æºç åˆ°æœ¬åœ°ä¸”å®‰è£…ä¾èµ–
- 2.ä½¿ç”¨ VSCode ç¼–è¾‘å™¨æ‰“å¼€æºç ï¼Œæ‰¾åˆ°å…¥å£æ–‡ä»¶ `lerna/packages/core/lerna/package.json` ä¸­çš„ bin å±æ€§ã€‚
- 3.VSCode æ·»åŠ è°ƒè¯•ï¼šåœ¨è¦è°ƒè¯•çš„ä»£ç æ‰“ä¸Šæ–­ç‚¹ï¼Œç„¶ååœ¨ VSCode çš„å›¾æ ‡æ ã€è¿è¡Œå’Œè°ƒè¯•ã€‘ä¸Šï¼Œé€‰æ‹© Node.js è°ƒè¯•ï¼Œå¼€å§‹è¿è¡Œå’Œè°ƒè¯•ã€‚

#### 2.Node æºç è°ƒè¯•è¿‡ç¨‹ä¸­å¿…ä¼šçš„å°æŠ€å·§

ã€è¿è¡Œå’Œè°ƒè¯•ã€‘çš„é¢æ¿ï¼š

å³ä¸Šè§’ä¸‰ä¸ªç‚¹çš„å›¾æ ‡ï¼Œå¯ä»¥è®¾ç½®æ˜¾ç¤ºä»€ä¹ˆå’Œä¸æ˜¾ç¤ºä»€ä¹ˆ

#### 3.lerna åˆå§‹åŒ–è¿‡ç¨‹æºç è¯¦ç»†åˆ†æ

é€šè¿‡å‰é¢åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå…¥å£æ–‡ä»¶ä¸ºï¼š`lerna\packages\lerna\src\cli.js` æ–‡ä»¶ï¼Œä»è¿™é‡Œå¼€å§‹çœ‹æºç ï¼š

```js
require(".")(process.argv.slice(2));
```

- `require('.')`ï¼šè¿™é‡Œçš„ `.` æ˜¯ç›¸å¯¹è·¯å¾„,ç›¸å½“äºæ˜¯ `require('./index.ts')`
- åˆ°è¿™è¡Œä»£ç åï¼Œå…ˆåŠ è½½ä¸è¯¥ `cli.js` åŒçº§åˆ«ç›®å½•ä¸‹çš„ `index.ts` æ–‡ä»¶ã€‚
- ç­‰æ–‡ä»¶åŠ è½½å®Œæ¯•åï¼Œå°†`process.argv.slice(2)`å‚æ•°ï¼Œ ä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™å…¥çš„å‚æ•°ï¼Œä¼ å…¥åˆ° `index.ts` æ–‡ä»¶ä¸­ `module.exports` å‡ºæ¥çš„æ–¹æ³• `main`

#### 4.ã€é«˜èƒ½çŸ¥è¯†ç‚¹ã€‘npm é¡¹ç›®æœ¬åœ°ä¾èµ–å¼•ç”¨æ–¹æ³•

å¼•ç”¨æœ¬åœ°åŒ…çš„æ–¹å¼å¯ä»¥ä½¿ç”¨ `file:æœ¬åœ°è·¯å¾„` çš„æ–¹å¼ï¼Œè¿™æ˜¯å› ä¸º `lerna publish` çš„æ—¶å€™å¯ä»¥åœ¨çº¿ä¸Šç¯å¢ƒæŠŠ `file:æœ¬åœ°è·¯å¾„` çš„æ–¹å¼æ”¹æˆå¼•ç”¨çº¿ä¸ŠåŒ…çš„æ–¹å¼ã€‚è¿™ç§æ–¹å¼å¯ä»¥å»é™¤ä¹‹å‰ä½¿ç”¨ `npm link` çš„æ–¹å¼ã€‚

ç†è§£äº†è¿™é‡Œæœ¬åœ°ä¾èµ–çš„ `file` å¼•ç”¨åï¼Œå›åˆ°ä¹‹å‰çš„ `lerna-publish` å‘å¸ƒæµç¨‹é¡¹ç›®ï¼Œå°†æœ¬åœ°å¼•ç”¨çš„`@cloudscope-cli/utils` æ”¹ä¸º `file` å¼•ç”¨ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼šåœ¨ `@cloudscope-cli/core` ä¸­ä½¿ç”¨ file æ–¹å¼å¼•ç”¨äº†æœ¬åœ°çš„ utils åŒ…åï¼Œéœ€è¦ npm install ä¸€ä¸‹ã€‚

package.json æœ¬åœ°ä¾èµ–å¼•ç”¨

```bash
"dependencies": {
    "@test-cli-dev/utils": "file:../utils"
}
```

#### 5.ä½¿ç”¨è„šæ‰‹æ¶æ¡†æ¶ yargs åº“ å…¥é—¨

yargs çš„ npm åœ°å€ï¼š[yargs - npm (npmjs.com)](https://www.npmjs.com/package/yargs)

å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š

```bash
# 1.åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹
mkdir test-cli-yargs
# 2.åˆå§‹åŒ–ç›®å½•
npm init -y
# 3.æ–°å»ºlib/index.jsæ–‡ä»¶
# 4.package.jsonæ–‡ä»¶æ·»åŠ :
"bin": { "lib/index.js" }
# 5.å®‰è£…yarns
npm install -S yarns
# 6.å®‰è£…dedent
npm install -S dedent
```

ç„¶åï¼Œå¼€å§‹ç¼–è¾‘ `index.js` æ–‡ä»¶ï¼Œè¿›è¡Œ yargs ç›¸å…³ç”¨æ³•çš„å­¦ä¹ ï¼š

#### 6.yargs åº“é«˜çº§ç”¨æ³•è®²è§£

å…³äº yargs çš„ command ç”¨æ³•ï¼Œæˆ‘ä»¬ä» npm çš„ yargs å®˜ç½‘ï¼š[yargs - npm (npmjs.com)](https://www.npmjs.com/package/yargs)ï¼Œçœ‹åˆ°ç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
#!/usr/bin/env node
const yargs = require("yargs/yargs");
const { hideBin } = require("yargs/helpers");

yargs(hideBin(process.argv))
	// å®šä¹‰è‡ªå·±çš„å‘½ä»¤
	.command(
		"serve [port]",
		"start the server",
		(yargs) => {
			return yargs.positional("port", {
				describe: "port to bind on",
				default: 5000,
			});
		},
		(argv) => {
			if (argv.verbose) console.info(`start server on :${argv.port}`);
			serve(argv.port);
		}
	)
	.option("verbose", {
		alias: "v",
		type: "boolean",
		description: "Run with verbose logging",
	})
	.parse();
```

é€šè¿‡ä»¥ä¸Šä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®šä¹‰ command çš„æ—¶å€™ï¼Œä¼ å…¥äº†å››ä¸ªå‚æ•°ï¼š

- `'serve [port]'`ï¼šcommand çš„æ ¼å¼ï¼Œport ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„ optionï¼Œç›¸å½“äº `test-cli serve`
- `'start the serve'`ï¼šå…³äºæ­¤ serve command å‘½ä»¤çš„è¡¥å……æè¿°
- ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º builder å‡½æ•°ï¼šåœ¨æ‰§è¡Œæ­¤ command å…·ä½“å‘½ä»¤ä¹‹å‰åšçš„åŠ¨ä½œï¼Œæ¯”å¦‚ä¸Šæ–‡ä¸º serve è¿™ä¸ªå‘½ä»¤å®šä¹‰äº†ä¸€ä¸ªå‚æ•° portï¼Œä¸”ç»™å®š port çš„é»˜è®¤å€¼ä¸º 5000
- ç¬¬å››ä¸ªå‚æ•°æˆ‘ä»¬å«åš handlerï¼šæ˜¯ç”¨æ¥å…·ä½“æ‰§è¡Œ command çš„ä¸€ä¸ªè¡Œä¸º

**é«˜çº§ç”¨æ³•**ï¼š`bin/yargs.js`

```js
const yargs = require("yargs/yargs");
const dedent = require("dedent");
// å¯¼å…¥é…ç½®
const pkg = require("../package.json");

const cli = yargs();
const argv = process.argv.slice(2);

const context = {
	// ä½¿ç”¨é…ç½®çš„ç‰ˆæœ¬
	imoocVersion: pkg.version,
};

cli
	.usage("Usage: $0 [command] <options>")
	.demandCommand(
		1,
		"A command is required. Pass --help to see all available commands and options."
	)
	.strict()
	.recommendCommands()
	.fail((err, msg) => {
		console.log(err);
	})
	.alias("h", "help")
	.alias("v", "version")
	.wrap(cli.terminalWidth())
	.epilogue(
		dedent`
      When a command fails, all logs are written to lerna-debug.log in the current working directory.

      For more information, find our manual at https://github.com/lerna/lerna
    `
	)
	.options({
		debug: {
			type: "boolean",
			describe: "Bootstrap debug mode",
			alias: "d",
		},
	})
	.option("registry", {
		type: "string",
		describe: "Define global registry",
		alias: "r",
	})
	.group(["debug"], "Dev Options:")
	.group(["registry"], "Extra Options:")
	.command(
		"init [name]",
		"Do init a project",
		(yargs) => {
			yargs.option("name", {
				type: "string",
				describe: "Name of a project",
				alias: "n",
			});
		},
		(argv) => {
			console.log(argv);
		}
	)
	.command({
		command: "list",
		aliases: ["ls", "la", "ll"],
		describe: "List local packages",
		builder: (yargs) => {},
		handler: (argv) => {
			const fs = require("fs"); // native module
			const dedent = require("dedent"); // cached local module
			const local = require("."); // relative path
			const utils = require("/Users/sam/Desktop/vue-test/imooc-test/bin/utils"); // absolute path
			const pkg = require("../../imooc-test-lib/package.json"); // load json
			const undefinedModule = require("./file"); // undefined module
		},
	})
	.parse(argv, context);
```

å…¶ä»–

```js
const yargs = require("yargs/yargs");
// ä¸€ä¸ªES6å­—ç¬¦ä¸²æ ‡ç­¾ï¼Œä»å¤šè¡Œå­—ç¬¦ä¸²ä¸­å»é™¤ç¼©è¿›ã€‚
const dedent = require("dedent");

const cli = yargs();
const argv = process.argv.slice(2);

// æ³¨å…¥é¢å¤–å‚æ•°
const context = {
	diaoVersion: "1.0.0",
};
cli
	// å¼€å¯ä¸¥æ ¼æ¨¡å¼ï¼Œè¾“å…¥æ— æ•ˆå‘½ä»¤ä¼šæŠ¥é”™æ— æ³•è¯†åˆ«å‘½ä»¤
	.strict()
	// åœ¨å¤´éƒ¨è¾“å‡ºä¸€æ®µä¿¡æ¯
	.usage("Usage: diao-cli [command] <options>")
	// è®¾ç½®éœ€è¦è¾“å…¥å‘½ä»¤çš„æœ€å°å€¼ï¼Œè¿™é‡Œè®¾ç½®æœ€å°‘è¾“å…¥ä¸€ä¸ªå‘½ä»¤ï¼Œå¦åˆ™åˆ™æŠ›å‡ºé”™è¯¯ä¿¡æ¯
	.demandCommand(
		1,
		"A command is required. Pass --help to see all available commands and options."
	)
	// å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å‘½ä»¤ï¼Œyargsæä¾›å…³äºç±»ä¼¼å‘½ä»¤çš„å»ºè®®
	.recommendCommands()
	// åœ¨æœ‰é”™è¯¯çš„æ—¶å€™æ‰§è¡Œï¼Œå¯ä»¥åœ¨è¿™é‡Œè‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯
	.fail((err, msg) => {
		console.error("err:", err);
	})
	// è®¾ç½® command çš„åˆ«å
	.alias("h", "help")
	.alias("v", "version")
	// è®¾ç½®å‘½ä»¤è¡Œè¾“å‡ºæ—¶å€™çš„å®½åº¦
	.wrap(cli.terminalWidth())
	// åœ¨å‘½ä»¤è¡Œæœ«å°¾æ‰“å°çš„æ¶ˆæ¯
	.epilogue(
		dedent`
    When a command fails, all logs are written to lerna-debug.log in the current working directory.

    For more information, find our manual at https://github.com/lerna/lerna
  `
	)
	// é…ç½®é¢å¤–é€‰é¡¹
	.options({
		debug: {
			type: "boolean",
			describe: "Bootstrap debug mode",
			alias: "d",
		},
	})
	// é…ç½®é¢å¤–é€‰é¡¹
	.option("registry", {
		type: "string",
		describe: "Define global registry",
		alias: "r",
	})
	// å¯¹é€‰é¡¹è¿›è¡Œåˆ†ç»„
	.group(["debug"], "Dev Options")
	.group(["registry"], "Extra Options")
	// æ³¨å†Œå‘½ä»¤
	.command(
		"init [name]",
		"Do init a project",
		(yargs) => {
			yargs.option("name", {
				type: "string",
				describe: "Name of a project",
				alias: "n",
			});
		},
		(argv) => {
			console.log(argv);
		}
	)
	// æ³¨å†Œå‘½ä»¤
	.command({
		command: "list",
		aliases: ["ls", "la", "ll"],
		describe: "List local packages",
		builder: (yargs) => {},
		handler: (argv) => {
			console.log(argv);
		},
	})
	// è§£æå‘½ä»¤è¾“å…¥å‚æ•°
	.parse(argv, context);
```

#### 7.lerna è„šæ‰‹æ¶åˆå§‹åŒ–è¿‡ç¨‹è¶…è¯¦ç»†è®²è§£

é€šè¿‡ yargs ä½¿ç”¨æ–¹æ³•ï¼Œåˆ†æ lerna è„šæ‰‹æ¶çš„åˆå§‹åŒ–è¿‡ç¨‹è®²è§£ã€‚

#### 8.lerna è„šæ‰‹æ¶ Command æ‰§è¡Œè¿‡ç¨‹è¯¦è§£

`class Command` ç±»æ–¹æ³•å’Œ `class ListCommand` ç±»æ–¹æ³•

#### 9.ã€å…³é”®çŸ¥è¯†å¤ä¹ ã€‘javascript äº‹ä»¶å¾ªç¯â€“EventLoop

- EventLoop ä¸­å­˜åœ¨ä¸¤ç§äº‹ä»¶ï¼š**å®ä»»åŠ¡(MacroTask)** å’Œ **å¾®ä»»åŠ¡(MicroTask)**
- JavaScript è„šæœ¬ä¸­åŠ å…¥åˆ°å®ä»»åŠ¡ä¸­å»
- å½“å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œä¼šå°†å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ä»»åŠ¡æ¸…ç©ºï¼Œæ¸…ç©ºä¹‹åå†å»æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ã€‚è¿™ç§å¾ªç¯å¾€å¤çš„æ‰§è¡Œæµç¨‹å°±ç§°ä¸ºäº‹ä»¶å¾ªç¯â€“EventLoopã€‚
- ç„¶åï¼šæˆ‘ä»¬åœ¨å®ä»»åŠ¡ä¸­åŠ å…¥ä¸€ä¸ª setTimeoutã€‚
- æ¥ç€ï¼Œæˆ‘ä»¬åœ¨å®ä»»åŠ¡é˜Ÿåˆ—ä¸­åŠ å…¥ä¸€ä¸ª Promise.then() , Promise.then()ä¸­çš„å†…å®¹ä¼šè¢«åŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ã€‚

```js

```

é¢˜ç›®æè¿°ï¼šé€šè¿‡å‰é¢ç« èŠ‚ï¼Œæˆ‘ä»¬äº†è§£åˆ° Lema æºç ä¸­åˆ©ç”¨äº† EventLoop æœºåˆ¶å°†è„šæ‰‹æ¶åˆå§‹åŒ–å’Œå‘½ä»Šæ‰§è¡Œé€»è¾‘è§£ï¼Œè¿™æ˜¯ EventLoop çš„ä¸€ä¸ªå…¸å‹åº”ç”¨ï¼Œç„¶è€Œ Nodejs çš„ EventLoop å’Œ Web çš„ EventLoop äº•ä¸ç›¸åŒï¼Œä½  D é“ä»–ä»¬ä¹‹é—´æœ‰äº›ç¾æ™¯å—?ä½ æ˜¯å¦åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨ Nodes çš„ setmmediate å’Œ process.nextTick æ³•å¦‚æœæœ‰ï¼Œé—åˆ†äº«ä½ åœ¨æ„Ÿäº›åœºæ™¯ä¸‹ä½¿ç”¨äº†è¿™äº›æ–¹æ³•ï¼Œå¹¶æŒ‡å‡ºä½ ä¸ºä»€ä¹ˆåœ¨è¿™ç§åœºæ™¯ä½¿ç”¨ï¼Œå®ƒä¼šå¸¦æ¥ä»€ä¹ˆå¥½å¤„?

å…³é”®æç‚¼:

1ã€Node.js äº‹ä»¶å¾ªç¯ï¼šhttp://nodejs.cn/learn/the-nodejs-event-loop

2ã€ä»€ä¹ˆæ˜¯ process.nextTickï¼šhttp://nodejs.cn/learn/understanding-process-nexttick

3ã€ä»€ä¹ˆæ˜¯ setlmmediateï¼šhttp://nodejs.cn/learn/understanding-setimmediate

4ã€Web å’Œ Nodejs äº‹ä»¶å¾ªç¯å¯¹æ¯”ï¼šhttp://www.ruanyifeng.com/blog/2014/10/event-oop.html

å›ç­”ï¼š

#### 10.import-local æ‰§è¡Œæµç¨‹æ·±åº¦åˆ†æ

åœ¨`cli.ts` ä¸­ï¼š`require("import-local");`

```js
#!/usr/bin/env node

"use strict";
/* eslint-disable import/no-dynamic-require, global-require */
const importLocal = require("import-local");
if (importLocal(__filename)) {
	require("npmlog").info("cli", "using local version of lerna");
} else {
	require(".")(process.argv.slice(2));
}
```

`import-local` çš„ä½œç”¨æ˜¯ï¼šå½“æˆ‘ä»¬çš„é¡¹ç›®å½“ä¸­æœ¬åœ°å­˜åœ¨ä¸€ä¸ªè„šæ‰‹æ¶å‘½ä»¤ï¼ŒåŒæ—¶å…¨å±€åœ¨ node å½“ä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ªè„šæ‰‹æ¶å‘½ä»¤çš„æ—¶å€™ï¼Œä¼˜å…ˆé€‰ç”¨æœ¬åœ°çš„ node_modules ä¸­çš„ç‰ˆæœ¬ã€‚

åœ¨æ‰§è¡Œä¸€ä¸ª node ä»£ç çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šå‘ node ä»£ç å½“ä¸­æ³¨å…¥ä¸€äº›å˜é‡ï¼š`__filename`ã€ `__dirname` ã€ `require`ã€ `module`ã€`exports`

é¦–å…ˆï¼Œæ‰§è¡Œ lerna å‘½ä»¤çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œ node å…¨å±€ä¸‹çš„ lernaï¼Œå³ `which lerna` æŒ‡å‘çš„ï¼š

è½¯è¿æ¥ï¼š/Users/test-cli/.nvm/versions/node/v12.16.1ï¼Œ

å®é™…æŒ‡å‘ï¼š/Users/test-cli/.nvm/versions/node/v12.16.1/lib/node_modules/lerna/cli.js`[PRATIC]`

é€šè¿‡ä¸Šé¢åˆ†ææˆ‘ä»¬çŸ¥é“äº†æ‰§è¡Œæµç¨‹ï¼Œç°åœ¨çš„é‡ç‚¹å°±æ˜¯çœ‹ä»£ç ä¸­çš„ `require('import-local')` ä¸­çš„æºç ã€‚

æˆ‘ä»¬è¿›å…¥åˆ° `import-local`æºç ä¸­ï¼š

```js
"use strict";
const path = require("path");
const resolveCwd = require("resolve-cwd");
const pkgDir = require("pkg-dir");
module.exports = (filename) => {
	const globalDir = pkgDir.sync(path.dirname(filename));
	const relativePath = path.relative(globalDir, filename);
	const pkg = require(path.join(globalDir, "package.json"));
	const localFile = resolveCwd.silent(path.join(pkg.name, relativePath));
	return localFile && path.relative(localFile, filename) !== ""
		? require(localFile)
		: null;
};
```

> `path.dirname(filename)`ï¼šè¿™å¥ä»£ç çš„æ„æ€æ˜¯è·å–åˆ°æ–‡ä»¶ filename çš„ä¸Šçº§ç›®å½•ã€‚

#### 11.pkg-dir æºç è§£æï¼ˆä¸€å¤§æ³¢ä¼˜ç§€çš„æ–‡ä»¶æ“ä½œåº“)

æœ¬èŠ‚åˆ†æä¸Šé¢ä»£ç ï¼Œå¯¹`import-local` æºç ç»†èŠ‚åˆ†æï¼Œæœ¬èŠ‚åˆ†æä»£ç æµç¨‹ä¸º globalDir æ˜¯å¦‚ä½•è·å¾—çš„ï¼š

> `const pkgDir = require('pkg-dir')` pkg-dirï¼šå­—é¢æ„æ€ä¸ºï¼Œè·å¾— package.json æ–‡ä»¶çš„ä¸Šçº§ç›®å½•

è¿›å…¥ pkg-dir æºç ï¼š

```js
"use strict";
const path = require("path");
const findUp = require("find-up");
module.exports = (cwd) =>
	findUp("package.json", { cwd }).then((fp) => (fp ? path.dirname(fp) : null));
module.exports.sync = (cwd) => {
	const fp = findUp.sync("package.json", { cwd });
	return fp ? path.dirname(fp) : null;
};
```

> åˆ†æ pkg-dir ä»£ç å¯çŸ¥ï¼špkg-dir è¿™ä¸ªåº“å‘æˆ‘ä»¬æš´éœ²äº†ä¸¤ä¸ªæ–¹æ³•ï¼šé»˜è®¤ cwd å’Œ sync æ–¹æ³•ï¼Œå…¶ä¸­ sync æ–¹æ³•ä¼šä»¥åŒæ­¥çš„æ–¹å¼æ‰§è¡Œã€‚ åŒæ—¶ï¼Œè¿™é‡Œåˆå¼•ç”¨ find-up è¿™ä¸ªåº“

```js
"use strict";
const path = require("path");
const locatePath = require("locate-path");
module.exports = (filename, opts = {}) => {
	const startDir = path.resolve(opts.cwd || "");
	const { root } = path.parse(startDir);
	const filenames = [].concat(filename);
	return new Promise((resolve) => {
		(function find(dir) {
			locatePath(filenames, { cwd: dir }).then((file) => {
				if (file) {
					resolve(path.join(dir, file));
				} else if (dir === root) {
					resolve(null);
				} else {
					find(path.dirname(dir));
				}
			});
		})(startDir);
	});
};
module.exports.sync = (filename, opts = {}) => {
	let dir = path.resolve(opts.cwd || "");
	const { root } = path.parse(dir);
	const filenames = [].concat(filename);
	// eslint-disable-next-line no-constant-condition
	while (true) {
		const file = locatePath.sync(filenames, { cwd: dir });
		if (file) {
			return path.join(dir, file);
		}
		if (dir === root) {
			return null;
		}
		dir = path.dirname(dir);
	}
};
```

> åŒç†ï¼Œfind-up è¿™ä¸ªåº“ä¹Ÿæ˜¯é»˜è®¤çš„ module.exports æ–¹æ³•ä¸åŒæ­¥è¿”å›çš„ sync æ–¹æ³•ã€‚ è¿™é‡Œæˆ‘ä»¬ç»§ç»­åˆ†æ find-up è¿™ä¸ªåº“çš„ sync æ–¹æ³•ï¼Œä¸€è¡Œä¸€è¡Œä»£ç è§£æï¼š

```js
let dir = path.resolve(opts.cwd || "");
```

> path.resolve æ˜¯æˆ‘ node å½“ä¸­ç»å¸¸ä½¿ç”¨çš„æ–¹æ³•ï¼Œå®ƒä¸»è¦ä½œç”¨æ˜¯æŠŠä¸¤ä¸ªç›¸å¯¹è·¯å¾„è¿›è¡Œç»“åˆã€‚ `path.resolve('/Users', '/test-cli')`ï¼Œè¿”å›çš„è·¯å¾„ä¸º /test-cli path.join('/Users','/test-cli'),è¿”å›çš„è·¯å¾„ä¸º /Users/test-cli è¿™é‡Œæœ‰ä¸ªæ³¨æ„ç‚¹æ˜¯ `path.resolve('.')` è¿”å›çš„æ˜¯å½“å‰è·¯å¾„ï¼Œè€Œ`path.join('.')`ï¼Œè¿”å›çš„å°±æ˜¯. ä¸ä¼šå¸®æˆ‘ä»¬åˆ¤å®šå½“å‰çš„ . ä¸ä¸Šçº§è·¯å¾„çš„å…³ç³»ã€‚

```js
const { root } = path.parse(dir);
```

> `path.parse("/Users/test-cli/Documents/imoocCourse/Webå‰ç«¯æ¶æ„å¸ˆ/lerna/core")` è¿”å›çš„ç»“æœä¸ºï¼š

```json
{
	"root": "/",
	"dir": "/Users/test-cli/Documents/imoocCourse/Webå‰ç«¯æ¶æ„å¸ˆ/lerna/core",
	"base": "lerna",
	"ext": "",
	"name": "lerna"
}
```

ä¾‹å­

```js
const filenames = [].concat(filename);
```

> é€šè¿‡åˆ†æä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬çŸ¥é“è¿™è¡Œä»£ç çš„ filename æŒ‡çš„æ˜¯ package.json,äºæ˜¯ filenames = ['package.json']

```js
while (true) {}
```

> è¿™é‡Œæ˜¯ä¸ªæ— é™å¾ªç¯ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯é€€å‡ºæ¡ä»¶

```js
const file = locatePath.sync(filenames, { cwd: dir });
```

> è¿™é‡Œåˆè°ƒç”¨äº†è¿™ä¸ª locatePath è¿™ä¸ªåº“çš„ sync æ–¹æ³•ï¼Œlocal-path è¿™ä¸ªåº“çš„ä½œç”¨æ˜¯ç£ç›˜ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ªè·¯å¾„ï¼Œå¦‚æœå­˜åœ¨ä¼šæŠŠç¬¬ä¸€ä¸ªæ–‡ä»¶è¿”å›ã€‚

```js
...
module.exports.sync = (iterable, options) => {
 options = Object.assign({
  cwd: process.cwd()
 }, options);
 for (const el of iterable) {
  if (pathExists.sync(path.resolve(options.cwd, el))) {
   return el;
  }
 }
};
```

> é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸Šé¢åˆç”¨åˆ°äº†ä¸€ä¸ªåº“ï¼špathExists(é€šè¿‡åå­—æˆ‘ä»¬æ˜¾è€Œæ˜“è§çš„çŸ¥é“ï¼Œè¿™ä¸ªåº“çš„ä½œç”¨æ˜¯åˆ¤æ–­ä¼ å…¥çš„ä¸€ä¸ªè·¯å¾„æ˜¯å¦å­˜åœ¨çš„)ï¼ŒpathExists è¿™ä¸ªåº“æºç ä¸è´´äº†ï¼Œä¸»è¦çš„ä¸€è¡Œä»£ç æ˜¯ï¼šfs.accessSync(fp),è¿™è¡Œä»£ç å°±æ˜¯åˆ¤æ–­æ˜¯å¦èƒ½åˆ°è¾¾ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæŠ¥é”™å°±ä¼šè¢« try catch æ•è·è¿”å› false

```js
if (file) {
	return path.join(dir, file);
}
```

> é€šè¿‡å‰é¢åˆ†æ `path.join(dir, file)` è¿”å›çš„å°±æ˜¯ /Users/test-cli/Documents/imoocCourse/Web å‰ç«¯æ¶æ„å¸ˆ/lerna/core/lerna/package.json

æœ€ç»ˆè·å¾— `globalDir`

#### 12.resolve-from æºç è§£æï¼ˆå½»åº•ææ‡‚ node_modules æ¨¡å—åŠ è½½é€»è¾‘ï¼‰

æˆ‘ä»¬å›åˆ° `import-local`æºç ï¼Œç»§ç»­çœ‹ï¼š

```js
const relativePath = path.relative(globalDir, filename);
```

> `demo: const relativePath = path.relative("/a/b/c", '/a/b/c/d.js');` relativePath è¿”å›å€¼ä¸º d.js

```js
const pkg = require(path.join(globalDir, "package.json"));
```

> è¿™é‡Œè·å¾— package.json è¿™ä¸ªæ–‡ä»¶

import-local æœ€å…³é”®çš„ä¸€éƒ¨åˆ†æ¥äº†ï¼š

```js
const localFile = resolveCwd.silent(path.join([pkg.name](http://pkg.name/), relativePath));
```

> resolveCwd çš„å«ä¹‰æ˜¯ç»™å‡ºä¸€ä¸ªåŒ…åå’Œä¸»è¿›å…¥æ–‡ä»¶åï¼Œå»æœ¬åœ°æ–‡ä»¶ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¿™æ ·çš„è·¯å¾„

ç„¶åæˆ‘ä»¬å°±è¿›å…¥ resolveCwd è¿™ä¸ªå¼•ç”¨åº“çš„æºç ï¼ŒæŸ¥çœ‹æ˜¯å¦‚ä½•å®ç°çš„(ä¼ å…¥çš„å‚æ•°ä¸º lerna/cli.js)

```js
"use strict";
const resolveFrom = require("resolve-from");

module.exports = (moduleId) => resolveFrom(process.cwd(), moduleId);
module.exports.silent = (moduleId) =>
	resolveFrom.silent(process.cwd(), moduleId);
```

è¿™é‡Œåˆå¼•ç”¨äº† resolve-from è¿™ä¸ªåº“çš„ silent é™é»˜æ–¹æ³•(æºç è§ä¸‹)ï¼š è¿™é‡Œéœ€è¦å¼•èµ·æ³¨æ„ä¸€ç‚¹çš„æ˜¯ resolve-from è¿™ä¸ªåº“ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ä¸Šé¢æåˆ°çš„ lerna/cli.js ä»¥åŠ process.cwd()è¿™ä¸ªå‚æ•°ï¼Œè¿™ä¸ª process.cwd çš„ä¼ å…¥å‚æ•°ä¸º Working directoryï¼š

```js
'use strict';
const path = require('path');
const Module = require('module');

const resolveFrom = (fromDir, moduleId, silent) => {
	if (typeof fromDir !== 'string') {
		throw new TypeError(`Expected `fromDir` to be of type `string`, got `${typeof fromDir}``);
	}

	if (typeof moduleId !== 'string') {
		throw new TypeError(`Expected `moduleId` to be of type `string`, got `${typeof moduleId}``);
	}

	fromDir = path.resolve(fromDir);
	const fromFile = path.join(fromDir, 'noop.js');

	const resolveFileName = () => Module._resolveFilename(moduleId, {
		id: fromFile,
		filename: fromFile,
		paths: Module._nodeModulePaths(fromDir)
	});

	if (silent) {
		try {
			return resolveFileName();
		} catch (err) {
			return null;
		}
	}

	return resolveFileName();
};

module.exports = (fromDir, moduleId) => resolveFrom(fromDir, moduleId);
module.exports.silent = (fromDir, moduleId) => resolveFrom(fromDir, moduleId, true);
```

åˆ†æä¸Šé¢ä»£ç ï¼Œæœ€å…³é”®çš„ä»£ç ä¸ºï¼š`Module._nodeModulePaths`æ˜¯è·¯å¾„

```js
const resolveFileName = () =>
	Module._resolveFilename(moduleId, {
		id: fromFile,
		filename: fromFile,
		paths: Module._nodeModulePaths(fromDir),
	});
```

> Moduleï¼šnode çš„å†…ç½®æ¨¡å—ï¼Œ(é€šå¸¸å¼€å‘è¿‡ç¨‹ä¸­æ˜¯ä¸éœ€è¦ä½¿ç”¨çš„)ï¼ŒModule ä¸­çš„ ä¸‹åˆ’çº¿(\_)æ–¹æ³•ï¼Œéƒ½ç§°ä¸ºå†…ç½®æ–¹æ³• `_resolveFilename` æ–¹æ³•ï¼Œæ˜¯æˆ‘ä»¬ node ä¸­ require æ–¹æ³•å®ç°çš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€ï¼Œå…³äº require æ–¹æ³•çš„å®ç°ï¼Œå‚è€ƒé˜®ä¸€å³°è€å¸ˆçš„è¿™ç¯‡æ–‡ç« ï¼š[require()æºç è§£è¯»](http://www.ruanyifeng.com/blog/2015/05/require.html) åˆ†æä¸Šé¢è¿™æ®µä»£ç ï¼Œ`Module._resolveFilename` çš„ä½œç”¨æ˜¯è§£ææ¨¡å—çš„çœŸå®è·¯å¾„ï¼Œè¿™ä¸ªæ–¹æ³•ä¼ è¿›å»ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª options æˆ‘ä»¬å‘ç°äº†ï¼š `Module._nodeModulesPaths(fromDir)`è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ç”Ÿæˆ node_modules çš„å¯èƒ½è·¯å¾„ã€‚ åœ¨å¯¹è¿™ä¸ªæ–¹æ³•æºç è¿›è¡Œå­¦ä¹ å‰ï¼Œæˆ‘ä»¬é¢„å…ˆä»è€å¸ˆé‚£äº†è§£åˆ°äº†è¿™ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š

ç„¶åæˆ‘ä»¬è¿›å…¥åˆ° `Module._nodeModulesPaths` æ–¹æ³•ä¸­ï¼š

```js
Module._nodeModulePaths = function (from) {
	// Guarantee that 'from' is absolute.
	from = path.resolve(from);
	// Return early not only to avoid unnecessary work, but to *avoid* returning
	// an array of two items for a root: [ '//node_modules', '/node_modules' ]
	if (from === "/") return ["/node_modules"];

	// note: this approach *only* works when the path is guaranteed
	// to be absolute.  Doing a fully-edge-case-correct path.split
	// that works on both Windows and Posix is non-trivial.
	const paths = [];
	for (let i = from.length - 1, p = 0, last = from.length; i >= 0; --i) {
		const code = from.charCodeAt(i);
		if (code === CHAR_FORWARD_SLASH) {
			if (p !== nmLen) paths.push(from.slice(0, last) + "/node_modules");
			last = i;
			p = 0;
		} else if (p !== -1) {
			if (nmChars[p] === code) {
				++p;
			} else {
				p = -1;
			}
		}
	}

	// Append /node_modules to handle root paths.
	paths.push("/node_modules");

	return paths;
};
```

> åˆ†æä»¥ä¸Šä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬çš„ from æ˜¯ï¼š/Users/test-cli/Documents/imoocCourse/Web å‰ç«¯æ¶æ„å¸ˆ/lerna ç„¶åé€šè¿‡ä¸Šé¢ç®—æ³•è®¡ç®—ï¼Œ
>
> æœ€åå¾—åˆ°çš„ç»“æœæ˜¯ï¼š
>
> [
>
> /Users/test-cli/Documents/imoocCourse/Web å‰ç«¯æ¶æ„å¸ˆ/lerna/node_modules,
>
> /Users/test-cli/Documents/imoocCourse/Web å‰ç«¯æ¶æ„å¸ˆ/node_modules,
>
> /Users/test-cli/Documents/imoocCourse/node_modules,
>
> /Users/test-cli/Documents/node_modules,
>
> /Users/test-cli/node_modules, /Users/node_modules, /node_modules
>
> ]

å°†è¿™ä¸ªæ•°ç»„è¿”å›åï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æ `Module._resolveFilename` è¿™ä¸ªæ–¹æ³•çš„æºç ï¼š åŒæ ·åœ¨å¯¹è¿™ä¸ªæ–¹æ³•æºç è¿›è¡Œå­¦ä¹ å‰ï¼Œæˆ‘ä»¬ä¹Ÿé¢„å…ˆä»è€å¸ˆé‚£äº†è§£åˆ°äº†è¿™ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š

#### 13.Node æ¨¡å—åŠ è½½æ ¸å¿ƒæ–¹æ³•\_resovleFileName æºç æ·±å…¥è§£æ

é¦–å…ˆï¼Œå…³äº `Module._resolveFileName` çš„æºç åˆ†æè¦æ›´ä¸ºå¤æ‚ï¼Œè¿™æ˜¯å› ä¸ºç®—æ³•éƒ¨åˆ†è¾ƒå¤šã€‚

`Module._resolveFilename` è¿™ä¸ªæ–¹æ³•çš„æºç ä¸ºå¦‚ä¸‹(ä»£ç é€»è¾‘æ·»åŠ æ³¨é‡Š)ï¼š

```js
Module._resolveFilename = function(request, parent, isMain, options) {
  if (NativeModule.canBeRequiredByUsers(request)) {  // åˆ¤æ–­æ˜¯å¦ä¸ºå¯åŠ è½½çš„å†…ç½®æ¨¡å—
    return request;
  }

  let paths;

  if (typeof options === 'object' && options !== null) {
      // æˆ‘ä»¬åœ¨è¿™ä¼ å…¥çš„optionsæ˜¯ undefinedï¼Œå› æ­¤ä¹‹é—´è·³è¿‡åˆ°elseä¸­---å³æ‰§è¡ŒModule._resolveLookupPaths(request, parent);
    if (ArrayIsArray(options.paths)) {
      const isRelative = request.startsWith('./') ||
          request.startsWith('../') ||
          ((isWindows && request.startsWith('.\')) ||
          request.startsWith('..\'));

      if (isRelative) {
        paths = options.paths;
      } else {
        const fakeParent = new Module('', null);

        paths = [];

        for (let i = 0; i < options.paths.length; i++) {
          const path = options.paths[i];
          fakeParent.paths = Module._nodeModulePaths(path);
          const lookupPaths = Module._resolveLookupPaths(request, fakeParent);

          for (let j = 0; j < lookupPaths.length; j++) {
            if (!paths.includes(lookupPaths[j]))
              paths.push(lookupPaths[j]);
          }
        }
      }
    } else if (options.paths === undefined) {
      paths = Module._resolveLookupPaths(request, parent);
    } else {
      throw new ERR_INVALID_OPT_VALUE('options.paths', options.paths);
    }
  } else {
    paths = Module._resolveLookupPaths(request, parent);  // ç„¶åå°±è¿›å…¥äº†_resolveLookPathsï¼Œè¿›è¡Œäº†pathsçš„ä¸€äº›åˆå¹¶ï¼Œæ‹¿åˆ°åˆå¹¶çš„æ•°ç»„
  }

  if (parent && parent.filename) {      // æˆ‘ä»¬è¿™é‡Œæ˜¯æœ‰filenameçš„
    const filename = trySelf(parent.filename, isMain, request);
    if (filename) {
      emitExperimentalWarning('Package name self resolution');
      const cacheKey = request + 'x00' +
          (paths.length === 1 ? paths[0] : paths.join('x00'));
      Module._pathCache[cacheKey] = filename;
      return filename;
    }
  }

  // Look up the filename first, since that's the cache key.
  // é‡ç‚¹
  const filename = Module._findPath(request, paths, isMain, false);  // å¦ä¸€éå¸¸æœ‰éš¾åº¦çš„æ–¹æ³•ï¼Œæºä»£ç è§ä¸‹é¢çš„ä¸‹é¢
  if (filename) return filename;
  const requireStack = [];
  for (let cursor = parent;
    cursor;
    cursor = cursor.parent) {
    requireStack.push(cursor.filename || cursor.id);
  }
  let message = `Cannot find module '${request}'`;
  if (requireStack.length > 0) {
    message = message + 'nRequire stack:n- ' + requireStack.join('n- ');
  }
  // eslint-disable-next-line no-restricted-syntax
  const err = new Error(message);
  err.code = 'MODULE_NOT_FOUND';
  err.requireStack = requireStack;
  throw err;
};
```

`Module._resolveLookupPaths` è¿™ä¸ªæ–¹æ³•çš„æºç ä¸ºå¦‚ä¸‹(ä»£ç é€»è¾‘æ·»åŠ æ³¨é‡Š)ï¼š ä¸»è¦åŠŸèƒ½å°±æ˜¯å°† paths å’Œç¯å¢ƒå˜é‡`node_modules`åˆå¹¶

```js
Module._resolveLookupPaths = function(request, parent) {
  if (NativeModule.canBeRequiredByUsers(request)) {   // å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºå†…ç½®æ¨¡å—
    debug('looking for %j in []', request);
    return null;
  }

  // Check for node modules paths.
  if (request.charAt(0) !== '.' ||
      (request.length > 1 &&
      request.charAt(1) !== '.' &&
      request.charAt(1) !== '/' &&
      (!isWindows || request.charAt(1) !== '\'))) {

    let paths = modulePaths;        // ç¯å¢ƒå˜é‡ä¸­å­˜å‚¨çš„ä¸€äº›node_modulesç›®å½•
    if (parent != null && parent.paths && parent.paths.length) {
      paths = parent.paths.concat(paths);    // ä¸ä¹‹å‰ä¼ è¿›æ¥çš„pathsè¿›è¡Œåˆå¹¶
    }

    debug('looking for %j in %j', request, paths);
    return paths.length > 0 ? paths : null;    // å°†åˆå¹¶çš„pathsè¿”å›
  }

  // In REPL, parent.filename is null.
  if (!parent || !parent.id || !parent.filename) {
    // Make require('./path/to/foo') work - normally the path is taken
    // from realpath(__filename) but in REPL there is no filename
    const mainPaths = ['.'];

    debug('looking for %j in %j', request, mainPaths);
    return mainPaths;
  }

  debug('RELATIVE: requested: %s from parent.id %s', request, parent.id);

  const parentDir = [path.dirname(parent.filename)];
  debug('looking for %j', parentDir);
  return parentDir;
};
```

`Module._findPath`è¦è§£å†³çš„é—®é¢˜æ˜¯åœ¨ paths ä¸­è§£ææ¨¡å—çš„çœŸå®è·¯å¾„ï¼Œ åŒæ ·åœ¨å¯¹è¿™ä¸ªæ–¹æ³•æºç è¿›è¡Œå­¦ä¹ å‰ï¼Œæˆ‘ä»¬ä¹Ÿé¢„å…ˆä»è€å¸ˆé‚£äº†è§£åˆ°äº†è¿™ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š

æºç å¦‚ä¸‹ï¼š

```js
Module._findPath = function(request, paths, isMain) {
  const absoluteRequest = path.isAbsolute(request);  //åˆ¤æ–­æ˜¯å¦ä¸ºç»å¯¹è·¯å¾„
  if (absoluteRequest) {
    paths = [''];
  } else if (!paths || paths.length === 0) {
    return false;
  }

  // é€šè¿‡ x00 ç”Ÿæˆä¸€å¤§æ®µçš„cacheKey
  const cacheKey = request + 'x00' +
                (paths.length === 1 ? paths[0] : paths.join('x00'));
  const entry = Module._pathCache[cacheKey];
  if (entry)
    return entry;

  let exts;
  // trailingSlashåˆ¤æ–­requestæ˜¯å¦å·² / ç»“å°¾çš„
  let trailingSlash = request.length > 0 &&
    request.charCodeAt(request.length - 1) === CHAR_FORWARD_SLASH;

  // è‹¥ä¸æ˜¯ä»¥ / ç»“å°¾ï¼Œ
  if (!trailingSlash) {
  // ä¼šä»¥æ­£åˆ™è¿›è¡ŒåŒ¹é…ï¼Œè¿™é‡Œçš„æ­£åˆ™åœ¨ä¸‹ä¸‹èŠ‚ä¸“é—¨å­¦ä¹ ï¼Œè¿™é‡Œæš‚æ—¶ç•¥è¿‡ï¼Œè¿™é‡Œçš„ç»“è®ºï¼šè¯¥æ­£åˆ™è¡¨ç¤ºçš„ç»“æœä¸º  æ˜¯å¦æ˜¯ä»¥"/..ã€/.ã€.. ã€ . "ç»“å°¾
    trailingSlash = /(?:^|/).?.$/.test(request);
  }

  // For each path
  for (let i = 0; i < paths.length; i++) {
    // Don't search further if path doesn't exist
    // ä¸€æ¬¡æ‹¿å‡ºpathsä¸­å­˜å‚¨çš„å€¼
    const curPath = paths[i];

    //stat(curPath)è¿”å›ç»“æœ 1æ˜¯æ–‡ä»¶å¤¹ï¼Œ0ä¸ºæ–‡ä»¶ï¼Œæˆ‘ä»¬è¿™é‡Œç¬¬ä¸€ä¸ªè¿”å›çš„æ˜¯æ–‡ä»¶å¤¹ 1ï¼Œå› æ­¤ï¼Œä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œ
    if (curPath && stat(curPath) < 1) continue;

    // è¿™é‡Œçš„æ„æ€å°±æ˜¯å°†æˆ‘ä»¬çš„curPathä¸requeståšä¸€ä¸ªç»“åˆ
    const basePath = resolveExports(curPath, request, absoluteRequest);
    let filename;

    // stat(basePath)çœ‹ä¸Šé¢åˆæˆçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸º0è¯´æ˜ä¸ºæ–‡ä»¶ä¸”æ–‡ä»¶å­˜åœ¨
    const rc = stat(basePath);

    // åˆ¤æ–­ç»“å°¾æ˜¯ä¸æ˜¯ä¸€ä¸ª /
    if (!trailingSlash) {

     // åˆ¤æ–­å½“å‰çš„basePathæ˜¯å¦ä¸ºä¸€ä¸ªæ–‡ä»¶
      if (rc === 0) {  // File.

     	// isMainæ˜¯å¦ä¼ å…¥
        if (!isMain) {

          // æ˜¯å¦é˜»æ­¢å»åšè¶…é“¾æ¥ï¼Œæ ¹æ®æˆ‘ä»¬çš„åˆ†æï¼Œè¿™é‡Œä¸æ˜¯ preserveSymlinksä¸ºfalse
          if (preserveSymlinks) {
            filename = path.resolve(basePath);
          } else {

            // toRealPathï¼šæˆ‘ä»¬çš„åˆ†æ basePathåœ¨è¿™é‡Œä¸ºè½¯è¿æ¥ï¼Œç„¶åé€šè¿‡æ­¤æ–¹æ³•ï¼Œæ‰¾åˆ°çœŸå®çš„æ–‡ä»¶è·¯å¾„ã€‚ç„¶åï¼Œæˆ‘ä»¬è¿›å…¥ä¸‹ä¸€èŠ‚ï¼Œçœ‹çœ‹è¿™ä¸ªtoRealPathæ˜¯å¦‚ä½•å®ç°çš„
            filename = toRealPath(basePath);
          }
        } else if (preserveSymlinksMain) {
          // For the main module, we use the preserveSymlinksMain flag instead
          // mainly for backward compatibility, as the preserveSymlinks flag
          // historically has not applied to the main module.  Most likely this
          // was intended to keep .bin/ binaries working, as following those
          // symlinks is usually required for the imports in the corresponding
          // files to resolve; that said, in some use cases following symlinks
          // causes bigger problems which is why the preserveSymlinksMain option
          // is needed.
          filename = path.resolve(basePath);
        } else {
          filename = toRealPath(basePath);
        }
      }

      if (!filename) {
        // Try it with each of the extensions
        if (exts === undefined)
          exts = ObjectKeys(Module._extensions);
        filename = tryExtensions(basePath, exts, isMain);
      }
    }

    if (!filename && rc === 1) {  // Directory.
      // try it with each of the extensions at "index"
      if (exts === undefined)
        exts = ObjectKeys(Module._extensions);
      filename = tryPackage(basePath, exts, isMain, request);
    }

    if (filename) {
      Module._pathCache[cacheKey] = filename;
      return filename;
    }
  }

  return false;
};
```

#### 14.fs æ¨¡å— toRealPath æºç æ·±å…¥è§£æ

æˆ‘ä»¬åˆ°`toRealPath`æ–¹æ³•åï¼Œä½¿ç”¨ node è°ƒè¯•å·¥å…·ï¼Œç‚¹å‡»ç»§ç»­ Step Into åˆ°è¯¥æ–¹æ³•ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
// é€šè¿‡ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“toRealPathçš„æ–¹æ³•å®ç°ï¼Œæ­£å¦‚ä¸Šé¢çš„é€»è¾‘å›¾æ˜¾ç¤ºçš„ï¼Œä½¿ç”¨çš„æ˜¯ fs.realpathSyncè¿™ä¸ªæ¨¡å—ã€‚
function toRealPath(requestPath) {
	// è¯¥æ–¹æ³•ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªè·¯å¾„åœ°å€ requestPathï¼Œä»¥åŠä¸€ä¸ªoptions
	// realpathCacheä¸ºä¸€ä¸ªchcheï¼Œè¡¨ç¤ºçš„æ˜¯å½“å‰å·²ç»åšè¿‡è·¯å¾„åˆ¤æ–­çš„æ‰€æœ‰è·¯å¾„ç¼“å­˜
	// ç»å¤§å¤šæ•°çš„keyå€¼ä¸valueå€¼æ˜¯ä¸€æ ·çš„ï¼Œå¹¶æ²¡æœ‰è½¯é“¾æ¥ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨å°‘é‡çš„æœ‰è½¯è¿æ¥çš„ï¼škeyä¸valueå€¼ä¸åŒ
	return fs.realpathSync(requestPath, {
		[internalFS.realpathCacheKey]: realpathCache,
	});
}
```

åŒæ ·çš„ï¼Œæˆ‘ä»¬åœ¨è¿›å» toRealPath è¿™ä¸ªæ–¹æ³•ï¼Œçœ‹åˆ° fs.realpathSync å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»è€å¸ˆå“ªé‡Œæœ‰æ‹¿åˆ°é€»è¾‘å›¾ï¼Œå¹¶æ ¹æ®å›¾è¿›è¡Œåˆ†æå­¦ä¹ è¯¥ä»£ç é‡Œé¢çš„é€»è¾‘ï¼š

ç„¶åæˆ‘ä»¬ç»§ç»­ Step Into åˆ° `fs.realpathSync` è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæºç å¦‚ä¸‹ï¼š

```js
// options ä¸ºSymbol
function realpathSync(p, options) {
	if (!options) options = emptyObj;
	else options = getOptions(options, emptyObj);
	p = toPathIfFileURL(p);

	// å¦‚æœä¸æ˜¯stringæ ¼å¼çš„ï¼Œè¿›è¡Œæ ¼å¼è½¬æ¢
	if (typeof p !== "string") {
		p += "";
	}

	// åˆ¤æ–­è¯¥è·¯å¾„æ˜¯å¦ä¸ºæœ‰æ•ˆè·¯å¾„
	validatePath(p);

	// pathModule ä¸æˆ‘ä»¬ç›´æ¥å¼•ç”¨çš„pathæ¨¡å—æ²¡æœ‰åŒºåˆ«ï¼šç›¸å¯¹è·¯å¾„è½¬ä¸ºç»å¯¹è·¯å¾„
	p = pathModule.resolve(p);

	// cacheä¸ºä¸€ä¸ªmapå¯¹è±¡
	const cache = options[realpathCacheKey];

	// æŸ¥æ‰¾ç¼“å­˜
	const maybeCachedResult = cache && cache.get(p);

	// æ˜¯å¦æŸ¥åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæŸ¥åˆ°ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰æŸ¥åˆ°ï¼Œç»§ç»­å‘å
	if (maybeCachedResult) {
		return maybeCachedResult;
	}

	// å®šä¹‰æ‰€æœ‰è½¯è¿æ¥çš„ç¼“å­˜ï¼ŒObjectCreate(null)åˆ›å»ºçš„å¯¹è±¡æ²¡æœ‰åŸå‹é“¾ï¼Œå¥½å¤„ä¸ºå®ƒæ˜¯ä¸€ä¸ªçº¯ç²¹çš„å¯¹è±¡ï¼ŒèŠ‚çº¦å†…å­˜ç©ºé—´
	const seenLinks = ObjectCreate(null);
	const knownHard = ObjectCreate(null);

	// å°†ä¼ å…¥çš„pathä¿å­˜ä¸‹æ¥ï¼Œåšäº†ä¸€ä¸ªç¼“å­˜ï¼Œè¿™é‡Œçš„pç›¸å½“äºç¼“å­˜ä¸­çš„key(è‹¥æ˜¯è½¯è¿æ¥ï¼Œåˆ™ä¸ºè½¯è¿æ¥è·¯å¾„)ï¼Œoriginalç›¸å½“äºvalue(å®é™…è·¯å¾„)ï¼Œè¿™ä¹ˆåšçš„åŸå› ä¸ºï¼šè¿™é‡Œçš„pæˆ‘ä»¬åé¢å¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜
	const original = p;

	// ç„¶åä¸‹é¢ä»£ç ï¼Œè¿›å…¥åˆ°ä¸Šå›¾æµç¨‹å›¾ä¸­çš„è·¯å¾„æ˜¯å¦å­˜åœ¨/è¿™ä¸ªæµç¨‹

	// Current character position in p
	let pos;
	// The partial path so far, including a trailing slash if any
	let current;
	// The partial path without a trailing slash (except when pointing at a root)
	let base;
	// The partial path scanned in the previous round, with slash
	let previous;

	// Skip over roots
	// æ‰¾åˆ°pä¸­çš„æ ¹è·¯å¾„
	current = base = splitRoot(p);
	pos = current.length;

	// On windows, check that the root exists. On unix there is no need.
	// è¿™é‡Œæ˜¯windowsç³»ç»Ÿçš„é€»è¾‘ï¼Œæˆ‘ä»¬æ˜¯macçš„ï¼Œæ‰€ä»¥å¯ä»¥å…ˆè·³è¿‡
	if (isWindows && !knownHard[base]) {
		const ctx = { path: base };
		binding.lstat(pathModule.toNamespacedPath(base), false, undefined, ctx);
		handleErrorFromBinding(ctx);
		knownHard[base] = true;
	}

	// Walk down the path, swapping out linked path parts for their real
	// values
	// NB: p.length changes.
	// ç„¶åå¼€å§‹å¾ªç¯ ç”±ä¸Šæ–‡å¾—çŸ¥ï¼Œæˆ‘ä»¬çš„posé•¿åº¦ä¸º1ï¼Œpçš„é•¿åº¦ä¸ºä¼ å…¥çš„pathçš„é•¿åº¦
	while (pos < p.length) {
		// find the next part
		// nextPartè¿™é‡Œè°ƒç”¨çš„å°±æ˜¯p.indexOf('/',pos),è¿™ä¸ªæ–¹æ³•ä¸¾ä¾‹å¦‚ä¸‹ï¼š
		// "/xxx/yyy".indexOf('/')  => 0  è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°çš„æ˜¯ç¬¬ä¸€ä¸ª"/"çš„ä½ç½®ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ‰¾ç¬¬äºŒä¸ª"/"ä½ç½®
		// "/xxx/yyy".indexOf('/',1) => 4,è¿™é‡Œçš„1æŒ‡çš„æ˜¯è·³è¿‡ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä»ç¬¬äºŒä¸ªå…ƒç´ å¼€å§‹å¯»æ‰¾
		const result = nextPart(p, pos);
		previous = current;
		if (result === -1) {
			const last = p.slice(pos);
			current += last;
			base = previous + last;
			pos = p.length;
		} else {
			current += p.slice(pos, result + 1);
			base = previous + p.slice(pos, result);
			pos = result + 1;
		}

		// åˆ¤æ–­ä¸€ä¸‹åœ¨caheä¸­æ˜¯å¦å­˜åœ¨
		// Continue if not a symlink, break if a pipe/socket
		if (knownHard[base] || (cache && cache.get(base) === base)) {
			// åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªfile
			if (isFileType(statValues, S_IFIFO) || isFileType(statValues, S_IFSOCK)) {
				break;
			}
			continue;
		}

		let resolvedLink;

		// åˆ¤æ–­æ˜¯ä¸æ˜¯è½¯é“¾æ¥ï¼Œä»ç¼“å­˜ä¸­å»æ‹¿
		const maybeCachedResolved = cache && cache.get(base);
		if (maybeCachedResolved) {
			resolvedLink = maybeCachedResolved;
		} else {
			// Use stats array directly to avoid creating an fs.Stats instance just
			// for our internal use.

			// æ²¡æœ‰æ‹¿åˆ°ï¼Œç„¶ååšå¤„ç†
			const baseLong = pathModule.toNamespacedPath(base);
			const ctx = { path: base };

			// statså¯ä»¥æ‰“å°å‡º æ–‡ä»¶åœ¨æ“ä½œç³»ç»Ÿä¸‹çš„å„ç§ä¿¡æ¯/ dev_t:æ–‡ä»¶çš„è®¾å¤‡ç¼–å· ino_t:æ–‡ä»¶åœ¨æ­¤è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†
			const stats = binding.lstat(baseLong, false, undefined, ctx);
			handleErrorFromBinding(ctx);

			// åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªè½¯è¿æ¥
			if (!isFileType(stats, S_IFLNK)) {
				// å¦‚æœä¸æ˜¯è½¯è¿æ¥ï¼Œå°†åˆ¤æ–­è¿‡çš„è·¯å¾„æ”¾å…¥åˆ° knowHardå½“ä¸­
				knownHard[base] = true;
				if (cache) cache.set(base, base);
				continue;
			}
			// åˆ¤æ–­åˆ°è¯¥è·¯å¾„æ˜¯ä¸€ä¸ªè½¯è¿æ¥ï¼Œç„¶åç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç 
			// Read the link if it wasn't read before
			// dev/ino always return 0 on windows, so skip the check.
			// linkTarget è½¯è¿æ¥å®é™…çš„è·¯å¾„åœ°å€
			let linkTarget = null;
			let id;

			// åˆ¤æ–­æ˜¯å¦ä¸ºwindowæ“ä½œç³»ç»Ÿ
			if (!isWindows) {
				// æ‹¿åˆ°statçš„0å·å…ƒç´ ï¼Œå³æˆ‘ä»¬ä¸Šé¢æ³¨é‡Šæåˆ°çš„æ–‡ä»¶è®¾å¤‡ç¼–å·
				const dev = stats[0].toString(32);
				// æ‹¿åˆ°statçš„7å·å…ƒç´ ï¼Œå³æˆ‘ä»¬ä¸Šé¢æ³¨é‡Šæåˆ°çš„æ–‡ä»¶å”¯ä¸€æ ‡è¯†

				// æ‹¿åˆ°è¿™ä¸¤ä¸ªæ˜¯æƒ³ç”Ÿæˆä¸€ä¸ªå”¯ä¸€é”®ï¼šè¿™ä¸ªæ–‡ä»¶åœ¨å½“ä¸‹PCç³»ç»Ÿä¸‹çš„å”¯ä¸€é”®
				const ino = stats[7].toString(32);
				id = `${dev}:${ino}`;

				// é€šè¿‡è¿™ä¸¤ä¸ªå”¯ä¸€é”®ç”Ÿæˆçš„å”¯ä¸€é”®ä½œä¸º seenLinksçš„å”¯ä¸€é”®
				// ä¸‹é¢ä»£ç ä¸ºåœ¨seenLinksä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰è¿™ä¸ªidï¼Œå¦‚æœæœ‰å°±ç›´æ¥æ‹¿å‡ºæ¥
				if (seenLinks[id]) {
					linkTarget = seenLinks[id];
				}
			}

			// æ²¡æœ‰è¿™ä¸ªè½¯è¿æ¥çš„å®é™…è·¯å¾„åœ°å€
			if (linkTarget === null) {
				const ctx = { path: base };
				binding.stat(baseLong, false, undefined, ctx);
				handleErrorFromBinding(ctx);
				// æ‹¿åˆ°è½¯è¿æ¥çš„å®é™…è·¯å¾„
				linkTarget = binding.readlink(baseLong, undefined, undefined, ctx);
				handleErrorFromBinding(ctx);
			}
			resolvedLink = pathModule.resolve(previous, linkTarget);

			if (cache) cache.set(base, resolvedLink);
			if (!isWindows) seenLinks[id] = linkTarget;
		}

		// Resolve the link, then start over
		// å°†pathçœŸå®è·¯å¾„é‡æ–°ç”Ÿæˆ
		p = pathModule.resolve(resolvedLink, p.slice(pos));

		// Skip over roots
		current = base = splitRoot(p);
		pos = current.length;

		// On windows, check that the root exists. On unix there is no need.
		if (isWindows && !knownHard[base]) {
			const ctx = { path: base };
			binding.lstat(pathModule.toNamespacedPath(base), false, undefined, ctx);
			handleErrorFromBinding(ctx);
			knownHard[base] = true;
		}
	}

	if (cache) cache.set(original, p);
	return encodeRealpathResult(p, options);
}
```

#### 15.é«˜éš¾åº¦çš„æ­£åˆ™è¡¨è¾¾å¼

```js
trailingSlash = /(?:^|/).?.$/.test(request);

console.log(/(?:^|/).?.$/.test('a')) --> false
console.log(/(?:^|/).?.$/.test('â€¦')) --> true
console.log(/(?:^|/).?.$/.test('/â€¦')) --> true console.log(/(?:^|/).?.$/.test('/Users')) --> false
```

#### 16.å¤§æ‹›ï¼šå¦‚ä½•å¿«é€Ÿæ‹¿åˆ°é¢è¯• "ä¸€è¡€"ï¼ˆé¢è¯•ç®€å†å¦‚ä½•å¢åŠ ä¿®æ”¹ï¼‰

##### ç®€å†ç®€ä»‹

> ç®€å†ä¸­ç®€ä»‹éƒ¨åˆ†è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒä½äºç®€å†çš„ç¬¬ä¸€å±ï¼Œæ˜¯é¢è¯•å®˜æœ€å®¹æ˜“å…³æ³¨çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨ç®€ä»‹éƒ¨åˆ†å……åˆ†çªå‡ºæˆ‘ä»¬çš„ä¸ªäººç‰¹é•¿å’Œä¼˜åŠ¿

##### è®¤çœŸå­¦å®Œæœ¬ç« å†…å®¹ååº”è¯¥æ€ä¹ˆä¿®æ”¹ç®€å†ï¼Ÿ

- ç†Ÿæ‚‰ yargs è„šæ‰‹æ¶å¼€å‘æ¡†æ¶
- ç†Ÿæ‚‰å¤š Package ç®¡ç†å·¥å…· lerna çš„ä½¿ç”¨æ–¹æ³•å’Œä½¿ç”¨åŸç†
- æ·±å…¥ç†è§£ Node.js æ¨¡å—è·¯å¾„è§£ææµç¨‹

**é¢è¯•å®˜é—®èµ·ç»†èŠ‚åå¦‚ä½•å›ç­”ï¼Ÿ**

- å¦‚ä½•é€šè¿‡ yargs å¼€å‘ä¸€ä¸ªè„šæ‰‹æ¶ï¼Ÿ

ç­”ï¼šæ¯”å¦‚ vue-cli çš„è„šæ‰‹æ¶åˆ›å»ºä¸ºï¼š`vue create myProjectName`

###### è„šæ‰‹æ¶çš„æ„æˆä¸€èˆ¬ç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š

> binï¼šä¸»å‘½ä»¤ï¼Œå®ƒæ˜¯åœ¨ packag.json ä¸­é…ç½®çš„ï¼Œé€šè¿‡ npm link è¿›è¡Œæœ¬åœ°å®‰è£…
>
> commandï¼šå‘½ä»¤
>
> optionsï¼šå‚æ•°(boolean/string/number)ï¼Œç„¶åéœ€è¦çš„ä¸€ç‚¹æ˜¯ä¸»å‘½ä»¤ bin çš„é…ç½®æŒ‡å‘çš„ä¸»æ–‡ä»¶ä¸­ï¼Œéœ€è¦åœ¨æ–‡ä»¶é¡¶éƒ¨åŠ ä¸Š `#!/usr/bin/env node`ï¼Œå°±æ˜¯è¯´åœ¨ç¯å¢ƒå˜é‡ä¸­æ‰¾åˆ° node å‘½ä»¤æ¥æ‰§è¡Œã€‚

###### è„šæ‰‹æ¶çš„åˆå§‹åŒ–æµç¨‹

- ç¬¬ä¸€æ­¥ï¼šé¦–å…ˆæ˜¯ç›´æ¥è°ƒç”¨ Yargs çš„æ„é€ å‡½æ•°ï¼Œç›´æ¥å»ç”Ÿæˆä¸€ä¸ªè„šæ‰‹æ¶ï¼š`Yargs();`
- ç¬¬äºŒæ­¥ï¼šä¼šè°ƒç”¨ä¸€ç³»åˆ—çš„ Yargs æä¾›çš„å¸¸ç”¨æ–¹æ³•ï¼Œå¯¹è„šæ‰‹æ¶åŠŸèƒ½è¿›è¡Œä¸€ä¸ªå¢å¼ºã€‚ æ¯”å¦‚
  - yargs.usageï¼šç”¨æ³•
  - yargs.optionsï¼šæ³¨å†Œä¸€äº›è„šæ‰‹æ¶å‚æ•°ç†Ÿæ‚‰
  - yargs.groupï¼šæ¥å¯¹è„šæ‰‹æ¶å‚æ•°ç†Ÿæ‚‰è¿›è¡Œåˆ†ç»„
  - yargs.failï¼šå¯¹è„šæ‰‹æ¶å¼‚å¸¸è¿›è¡Œç›‘å¬
  - yargs.elipogue()ï¼šåŒ…æ‹¬`yargs`å°¾éƒ¨ç»“è¯­çš„è®¾ç½®
  - yargs.wrap()ï¼šè„šæ‰‹æ¶çª—å£è®¾ç½®
  - yargs.decomandrecommedï¼šè‡³å°‘è¾“å…¥ä¸€ä¸ªå‚æ•°
  - yargs.recommedCommands()ï¼šæ¨èå‘½ä»¤çš„æç¤ºç­‰
  - Yargs.options
  - Yargs.option
  - Yargs.group
  - Yargs.demandCommand
  - Yargs.recommendCommands
  - Yargs.strict
  - Yargs.fail
  - Yargs.alias
  - Yargs.wrap
  - Yargs.epilogue
- ç¬¬ä¸‰æ­¥ï¼šè„šæ‰‹æ¶å‚æ•°è§£ææ–¹æ³•ï¼šéœ€è¦å¯¹è„šæ‰‹æ¶çš„å‚æ•°è¿›è¡Œä¸€äº›è§£æï¼š
  - `hideBin(process.argv)`ï¼šå…¶å®ä¹Ÿå°±æ˜¯ç›´æ¥å–å‡ºä»ç¬¬ä¸‰ä¸ªå¼€å§‹çš„å‚æ•°ï¼Œè°ƒç”¨çš„æ—¶å€™ç›´æ¥ yargs.argvï¼›
  - `yargs.parse(argv,options)`ï¼š
- ç¬¬å››æ­¥ï¼šå‘½ä»¤æ³¨å†Œæ–¹æ³•ï¼šå½“è„šæ‰‹æ¶çš„å‚æ•°è§£æå®Œæˆä¹‹åï¼Œæˆ‘ä»¬è¦è¿›è¡Œå‘½ä»¤æ³¨å†Œï¼š
  - `yargs.command()`ï¼š
  - command çš„æ³¨å†Œæ–¹å¼æœ‰ä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯ä¸€æ¬¡ä¼ å‚(command, describe, builder, handler)ï¼Œè¿˜æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡å±æ€§ä¸ç¬¬ä¸€ç§æ–¹å¼ä¼ å…¥çš„ç›¸åŒã€‚
    - Yargs.command(command, describe, builder, handler)
    - Yargs.command({ command, describe, builder, handler })

**lernaï¼šç†Ÿæ‚‰å¤š Package ç®¡ç†å·¥å…· lerna çš„ä½¿ç”¨æ–¹æ³•å’Œä½¿ç”¨åŸç†**

> ç­”ï¼šé¦–å…ˆ lerna æ˜¯åŸºäºä¸€ä¸ª git + npm çš„å¤š packageï¼Œä¹Ÿå°±æ˜¯å¤šåŒ…çš„é¡¹ç›®ç®¡ç†å·¥å…·ï¼Œåƒä¸€äº›å¼€æºçš„å¤§å‹åº“ï¼š`vue-vcli/create-react-app/babel` ç­‰éƒ½æ˜¯åŸºäº lerna è¿›è¡Œå¤šåŒ…ç®¡ç†çš„ã€‚

lerna çš„ä½œç”¨ï¼šé™ä½åŒ…çš„ç®¡ç†æ“ä½œæˆæœ¬ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚

- åƒåŒ…çš„å®‰è£…ã€ä¾èµ–çš„æ·»åŠ ã€ä¾èµ–çš„è§£é™¤ä»¥åŠåŒ…çš„å‘å¸ƒã€æ‰“æ ‡ç­¾ç­‰åŠŸèƒ½ã€‚

lerna çš„å®ç°åŸç†ï¼š

- 1.é¦–å…ˆå°±æ˜¯é€šè¿‡ `import-local` è¿™ä¸ªåº“ä¼˜å…ˆè°ƒç”¨ lerna çš„æœ¬åœ°å‘½ä»¤
- 2.ç„¶åé€šè¿‡ yargs ç”Ÿæˆä¸€ä¸ªè„šæ‰‹æ¶ã€ç”Ÿæˆè„šæ‰‹æ¶åç”Ÿæˆä¸€äº›å…¨å±€å‚æ•°ã€ç„¶åæ³¨å†Œå‘½ä»¤ï¼Œé€šè¿‡ yargs.parse æ–¹æ³•è¿›è¡Œå‚æ•°è§£æã€‚
- 3.éœ€è¦æ³¨æ„çš„æ˜¯ lerna çš„å‘½ä»¤æ³¨å†Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¼ å…¥ builder ä»¥åŠ handler ä¸¤ä¸ªæ–¹æ³•ï¼Œbuilder å‘½ä»¤ç”¨äºæ³¨å†Œå‘½ä»¤ä¸“å±çš„ optionsï¼Œè€Œ handelr ç”¨æ¥å¤„ç†å‘½ä»¤çš„ä¸šåŠ¡é€»è¾‘ã€‚
- 4.æœ‰ä¸€ç‚¹éå¸¸å€¼å¾—å­¦ä¹ çš„å†…å®¹å°±æ˜¯ lerna å®ƒæ˜¯é€šè¿‡é…ç½®æœ¬åœ°ä¾èµ–çš„æ–¹å¼è¿›è¡Œå¼€å‘çš„ï¼Œå…·ä½“å†™æ³•å°±æ˜¯åœ¨ package.json çš„ä¾èµ–å½“ä¸­é€šè¿‡ `file:ä½ çš„æœ¬åœ°åŒ…çš„åå­—`çš„æ ¼å¼ä¹¦å†™ï¼Œåœ¨ lerna publish çš„æ—¶å€™å†å°†è¯¥è·¯å¾„æ›¿æ¢ã€‚

**å¯¹ Node.js æ¨¡å—è·¯å¾„è§£ææµç¨‹çš„ä¸€ä¸ªç†è§£**

- ç¬¬ä¸€ï¼šé¦–å…ˆ Node.js æ¨¡å—çš„è·¯å¾„è§£ææ˜¯é€šè¿‡ `require.resolve()` æ–¹æ³•æ¥å®ç°çš„
- ç¬¬äºŒï¼š`require.resolve()` æ–¹æ³•å°±æ˜¯`Module._resolveFileName()`æ–¹æ³• å®ƒçš„ä½œç”¨å°±æ˜¯æˆ‘ä»¬ç»™å®šä¸€ä¸ªæ¨¡å—åç§°çš„æ—¶å€™ï¼ŒæŸ¥æ‰¾å¤„è¿™ä¸ªæ¨¡å—çš„çœŸå®è·¯å¾„ã€‚
- ç„¶åï¼Œä»–çš„æ ¸å¿ƒå®ç°åŸç†çš„æµç¨‹æœ‰ 3 ç‚¹ï¼š
  - 1.åœ¨æ‰§è¡Œæµç¨‹ä¸­åˆ¤æ–­å½“å‰è·¯å¾„æ˜¯å¦ä¸ºå†…ç½®æ¨¡å—ï¼Œè‹¥æ˜¯å†…ç½®æ¨¡å—ç›´æ¥è¿”å›
  - 2.è‹¥ä¸æ˜¯å†…ç½®æ¨¡å—ï¼Œå®ƒä¼šç»§ç»­è°ƒç”¨è‡ªèº«çš„ `Module._resolveLookupPaths()`æ–¹æ³•ç”Ÿæˆ node_modules çš„æ‰€æœ‰å¯èƒ½è·¯å¾„
  - 3.æœ€åå†é€šè¿‡ `Module._findPath()`å»æŸ¥è¯¢æ¨¡å—çš„çœŸå®è·¯å¾„ã€‚
- è¿™é‡Œå…³äº `Module._findPaths()`æ–¹æ³•çš„æ ¸å¿ƒå®ç°æµç¨‹æœ‰ 4 æ­¥ï¼š
  - 1.æŸ¥è¯¢ç¼“å­˜ï¼ˆå°† `request[æ¨¡å—åç§°]` å’Œ `paths[ä¸Šé¢è¿”å›çš„æ‰€æœ‰å¯ç”Ÿæˆçš„node_modulesè·¯å¾„]` é€šè¿‡ `x00` åˆå¹¶æˆ `cacheKey`ï¼‰
  - 2.ç¼“å­˜æŸ¥ä¸åˆ°ï¼Œå°±ä¼šéå† pathsï¼Œå°†æ¯ä¸€ä¸ª path ä¸ request ç»“åˆç»„æˆæ–‡ä»¶è·¯å¾„ basePath
  - 3.ç„¶ååˆ¤æ–­è¿™ä¸ª basePath è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ä¼šè°ƒç”¨ `fs.realPathSync()` æ–¹æ³•è·å–æ–‡ä»¶çš„çœŸå®è·¯å¾„ï¼Œä¸å­˜åœ¨å°±ä¼šç»§ç»­éå†ã€‚
  - 4.åŒæ—¶ï¼Œå°†æ–‡ä»¶çš„çœŸå®è·¯å¾„ç¼“å­˜åˆ° `Module._pathcache()` ä¸­ã€‚
- è¿™é‡Œå…³äº `fs.realPathsync()` æ–¹æ³•çš„æ ¸å¿ƒæµç¨‹æœ‰ 3 ç‚¹ï¼š
  - 1.ä»ç„¶æ˜¯æŸ¥è¯¢ç¼“å­˜ï¼Œç¼“å­˜çš„ key å°±æ˜¯æˆ‘ä»¬çš„ pathï¼Œå³ basePathï¼Œ
  - 2.å¦‚æœè¿™ä¸ª key æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šå°†è¿™ä¸ª key ä»å·¦åˆ°å³å¼€å§‹éå†ï¼Œé€šè¿‡ `/` è¿›è¡Œå¾ªç¯éå†ï¼Œæ‹†åˆ†è·¯å¾„ï¼Œç„¶ååˆ¤æ–­è¿™ä¸ªè·¯å¾„æ˜¯å¦ä¸ºè½¯é“¾æ¥ï¼Œå¦‚æœæ˜¯è½¯é“¾æ¥ï¼Œå°±å»æŸ¥è¯¢å®ƒçš„çœŸå®è·¯å¾„ï¼Œå¹¶ç”Ÿæˆæ–°çš„ path è·¯å¾„ï¼Œè¿™ä¸ªæ–°çš„ path è·¯å¾„ç»§ç»­ä¼ å…¥è¿™ä¸ªéå†å‡½æ•°ï¼Œç»§ç»­å¾€åéå†ï¼Œ(è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šéå†è¿‡ç¨‹ä¸­ç”Ÿæˆçš„å­è·¯å¾„ base ä¼šç¼“å­˜åœ¨ knowHard å’Œ ache ä¸­ï¼Œé¿å…é‡å¤æŸ¥è¯¢)ã€‚
  - 3.éå†å®Œæˆåï¼Œå°±ä¼šå¾—åˆ°æ¨¡å—çš„çœŸå®è·¯å¾„ï¼Œå¹¶ä¸”å°†åŸå§‹è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„è½¯è¿æ¥è·¯å¾„ä½œä¸º key å€¼ï¼Œå°†çœŸå®å€¼ä½œä¸º value å€¼ï¼Œä¿å­˜åœ¨ç¼“å­˜ä¸­

åœ¨ require ä¸­è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯ `require.resolve.paths()` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ç”¨äºè·å–æ‰€æœ‰ node_modules å¯èƒ½å­˜åœ¨çš„è·¯å¾„ï¼Œä»–çš„æ ¸å¿ƒå†…å®¹å°±æ˜¯`Module._resolveLookupPaths()`

`Module._resolveLookupPaths()` çš„å®ç°åŸç†æœ‰ 2 ç‚¹ï¼š

- ç¬¬ä¸€ç‚¹ï¼Œå¦‚æœæ˜¯ / è·¯å¾„ï¼Œå°±åœ¨åé¢åŠ å…¥ node_modules
- ç¬¬äºŒç‚¹ï¼Œå°†è·¯å¾„ä»åå¾€å‰éå†ï¼Œå¦‚æœæŸ¥è¯¢åˆ° `/` ï¼Œå°±æ‹†åˆ†è·¯å¾„ï¼Œåœ¨åé¢åŠ ä¸Š node_modulesï¼Œä¸€ç›´éå†åˆ°æŸ¥æ‰¾ä¸åˆ° `/` è·¯å¾„ï¼Œå°±ä¼šè¿”å›è¿™ä¸ª paths æ•°ç»„ã€‚

## è„šæ‰‹æ¶çš„æ ¸å¿ƒæµç¨‹å¼€å‘

### å°†æ”¶è·ä»€ä¹ˆ

- æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯æ–¹æ¡ˆè®¾è®¡å…¨è¿‡ç¨‹
- è„šæ‰‹æ¶æ‰§è¡Œæ ¸å¿ƒæµç¨‹å’Œ commander æ¡†æ¶
- å¦‚ä½•è®© Node é¡¹ç›®æ”¯æŒ ES Module

### ä¸»è¦å†…å®¹

- è„šæ‰‹æ¶éœ€æ±‚åˆ†æå’Œæ¶æ„è®¾è®¡
- è„šæ‰‹æ¶æ¨¡å—æ‹†åˆ†ç­–ç•¥å’Œ core æ¨¡å—æŠ€æœ¯æ–¹æ¡ˆ
- è„šæ‰‹æ¶æ‰§è¡Œå‡†å¤‡è¿‡ç¨‹å®ç°
- è„šæ‰‹æ¶å‘½ä»¤æ³¨å†Œå®ç°(åŸºäº commander)

### é™„èµ å†…å®¹

Node é¡¹ç›®å¦‚ä½•æ”¯æŒ ES Module

### å…³é”®è¯

- è„šæ‰‹æ¶-æŒæ¡è„šæ‰‹æ¶éœ€æ±‚åˆ†æå’Œæ¶æ„è®¾è®¡
- æ¶æ„è®¾è®¡-å›¾è§£æ¶æ„è®¾è®¡å›¾+ç»˜å›¾æŠ€å·§
- commander-è„šæ‰‹æ¶å¼€å‘æ¡†æ¶

### å­¦ä¹ æ–¹æ³•

- å­¦ä»¥è‡´ç”¨ï¼šå°†ä¸Šä¸€ç« ä¸­å­¦åˆ°çš„çŸ¥è¯†è¿›è¡Œå®é™…åº”ç”¨ (import-local/local dependencies /Promise chain ç­‰)
- åŠ¨æ‰‹å®è·µï¼šå¬å®Œè¯¾ç¨‹è®²è§£åä¸€å®šè¦åŠ¨æ‰‹ç”»å›¾ã€è·Ÿç€è€å¸ˆæŠŠä»£ç æ•²ä¸€éï¼Œæœ‰å¾ˆå¤šæŠ€æœ¯ç»†èŠ‚éœ€è¦åœ¨è‡ªå·±å¼€å‘è¿‡ç¨‹ä¸­å»æ„Ÿæ‚Ÿå’Œç†è§£

### æ³¨æ„äº‹é¡¹

- æœ¬ç« å‰åŠéƒ¨åˆ†åæ¶æ„è®¾è®¡ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¾ˆé‡è¦ï¼Œæ˜¯æ¶æ„å¸ˆçš„å·¥ä½œæ—¥å¸¸
- å¤§å‚æ¶æ„å¸ˆå¾ˆå¤šæ—¶å€™ä¸æ˜¯è¾¹å†™è¾¹æƒ³ï¼Œè€Œæ˜¯æŠŠæ•´ä½“å’Œå±€éƒ¨éƒ½æƒ³æ¸…æ¥šäº†å†å¼€å§‹
- åšæ³¨æ„åŸ¹å…»è‡ªå·±çš„æ€è€ƒèƒ½åŠ›ï¼Œå°†ä»£ç å®ç°ç»†èŠ‚çš„å†…å®¹æŠ½è±¡ï¼Œé€šè¿‡ç³»ç»Ÿè®ºçš„æ€æƒ³æ„å»ºå¤æ‚ç³»ç»Ÿ

### è°ˆä¸€è°ˆå¤§å‚æ€ä¹ˆåšé¡¹ç›®çš„

é¡¹ç›®è®¾è®¡é˜¶æ®µï¼š

- ä¸šåŠ¡ç—›ç‚¹ â€”â€” éœ€æ±‚â€”â€”åŸå‹â€”â€”ç›®æ ‡â€”â€”æŠ€æœ¯æ–¹æ¡ˆçš„è®¾è®¡ï¼š
  - æŠ€æœ¯çš„é€‰å‹
  - æŠ€æœ¯çš„æ¶æ„
  - API çš„å®šä¹‰
  - æŠ€æœ¯è°ƒç ”
  - è¯„ä¼°æŠ€æœ¯çš„é£é™©
- é¡¹ç›®ç«‹é¡¹
- é¡¹ç›®æ’æœŸè®¡åˆ’
- é¡¹ç›®å®æ–½ï¼šäº¤äº’è®¾è®¡äº¤ä»˜â€”â€”>å¼€å‘é˜¶æ®µ

é¡¹ç›®å¼€å‘é˜¶æ®µï¼š

é¡¹ç›®æµ‹è¯•é˜¶æ®µï¼š

é¡¹ç›®éªŒæ”¶é˜¶æ®µï¼š

é¡¹ç›®å‘å¸ƒä¸Šçº¿

![é¡¹ç›®è®¾è®¡é˜¶æ®µ](.\img\é¡¹ç›®è®¾è®¡é˜¶æ®µ.jpg)

![é¡¹ç›®å®æ–½é˜¶æ®µ](.\img\é¡¹ç›®å®æ–½é˜¶æ®µ.jpg)

### è„šæ‰‹æ¶éœ€æ±‚åˆ†æ

#### ç—›ç‚¹åˆ†æ

ä»è¿™å¼ å›¾çœ‹èµ·ï¼Œåˆ†æç ”å‘è¿‡ç¨‹çš„ç—›ç‚¹ï¼š

![å¤§å‚ç ”å‘æ¶æ„å›¾](.\img\å¤§å‚ç ”å‘æ¶æ„å›¾.jpg)

ç—›ç‚¹åˆ†æ:

- åˆ›å»ºé¡¹ç›®/ç»„ä»¶æ—¶ï¼Œå­˜åœ¨å¤§é‡é‡å¤ä»£ç æ‹·è´ï¼šå¿«é€Ÿå¤ç”¨å·²æœ‰æ²‰æ·€
- ååŒå¼€å‘æ—¶ï¼Œç”±äº git æ“ä½œä¸è§„èŒƒï¼Œå¯¼è‡´åˆ†æ”¯æ··ä¹±ï¼Œæ“ä½œè€—æ—¶ï¼šåˆ¶å®šæ ‡å‡†çš„ gt æ“ä½œè§„èŒƒå¹¶é›†æˆåˆ°è„šæ‰‹æ¶ã€‚
- å‘å¸ƒä¸Šçº¿è€—æ—¶ï¼Œè€Œä¸”å®¹æ˜“å‡ºç°å„ç§é”™è¯¯ï¼šåˆ¶å®šæ ‡å‡†çš„ä¸Šçº¿æµç¨‹å’Œè§„èŒƒå¹¶é›†æˆåˆ°è„šæ‰‹æ¶

### è„šæ‰‹æ¶éœ€æ±‚åˆ†æ

- é€šç”¨çš„ç ”å‘è„šæ‰‹æ¶
- é€šç”¨çš„é¡¹ç›®/ç»„ä»¶åˆ›å»ºèƒ½åŠ›
  - æ¨¡æ¿æ”¯æŒå®šåˆ¶ï¼Œå®šåˆ¶åèƒ½å¤Ÿå¿«é€Ÿç”Ÿæ•ˆ
  - æ¨¡æ¿æ”¯æŒå¿«é€Ÿæ¥å…¥ï¼Œæä½çš„æ¥å…¥æˆæœ¬
- é€šç”¨çš„é¡¹ç›®/ç»„ä»¶å‘å¸ƒèƒ½åŠ›
  - å‘å¸ƒè¿‡ç¨‹è‡ªåŠ¨å®Œæˆæ ‡å‡†çš„ git æ“ä½œ
  - å‘å¸ƒæˆåŠŸåè‡ªåŠ¨åˆ é™¤å¼€å‘åˆ†æ”¯å¹¶åˆ›å»º tag
  - å‘å¸ƒåè‡ªåŠ¨å®Œæˆäº‘æ„å»ºã€OSS ä¸Šä¼ ã€CDN ä¸Šä¼ ã€åŸŸåç»‘å®š
  - å‘å¸ƒè¿‡ç¨‹æ”¯æŒæµ‹è¯•/æ­£å¼ä¸¤ç§æ¨¡å¼

### å¤§å‚çš„ git æ“ä½œè§„èŒƒ

å¼€å‘çš„æ—¶å€™åœ¨ dev åˆ†æ”¯å¼€å‘ï¼Œä¸Šçº¿æ–°åˆ›å»ºä¸€ä¸ª release åˆ†æ”¯ï¼Œåˆ†æ”¯æ ¼å¼å¦‚ä¸‹ï¼š

- dev/0.01ï¼ˆä¸Šçº¿ä¹‹åå†åˆ é™¤è¿™ä¸ªåˆ†æ”¯ï¼Œç„¶åå†åŸºäºä¸Šä¸ªåˆ†æ”¯åˆ›å»ºæ–°åˆ†æ”¯ï¼Œåˆ›å»ºä¸€ä¸ª tagï¼Œå¹¶åŸºäºæ­¤åˆ†æ”¯ç»§ç»­å¼€å‘ï¼šdev/0.02ï¼‰
- release/0.0.1

### è„šæ‰‹æ¶æ¶æ„è®¾è®¡ + æ¶æ„å›¾

#### æ¶æ„è®¾è®¡

- è„šæ‰‹æ¶æ ¸å¿ƒæ¡†æ¶
  - æ‰§è¡Œå‡†å¤‡
  - å‘½ä»¤æ³¨å†Œ
  - å‘½ä»¤æ‰§è¡Œ
- æ ‡å‡† git æ“ä½œä½“ç³»
  - ä»“åº“åˆ›å»º
  - å¼€å‘æ¨¡å¼
    - ä»£ç ä»“åº“
      - GithHub
      - Gitee
  - å‘å¸ƒæ¨¡å¼
- åˆå§‹åŒ–ä½“ç³»
  - é¡¹ç›®åˆå§‹åŒ–
  - ç»„ä»¶åˆå§‹åŒ–
  - åˆå§‹åŒ–æ¨¡å¼
- å‘å¸ƒä½“ç³»
  - é¡¹ç›®å‘å¸ƒ
  - ç»„ä»¶å‘å¸ƒ
  - å‘å¸ƒæ¨¡å¼
- OPEN API
  - é¡¹ç›®/ç»„ä»¶æ¨¡æ¿
  - é™æ€èµ„æºæŸ¥è¯¢
  - é…ç½®ä¿¡æ¯
- WebSocket æœåŠ¡
  - äº‘æ„å»º
  - äº‘å‘å¸ƒ
  - å‘å¸ƒæ¨¡å¼

#### è‡ªå·±ç”»çš„æ¶æ„å›¾

#### ![è„šæ‰‹æ¶æ¶æ„å›¾](.\img\è„šæ‰‹æ¶æ¶æ„å›¾.jpg)è§†è§‰æ¶æ„å›¾

![è„šæ‰‹æ¶æ¶æ„å›¾è§†è§‰](.\img\è„šæ‰‹æ¶æ¶æ„å›¾è§†è§‰.jpg)

### è„šæ‰‹æ¶æ‹†åŒ…ç­–ç•¥

- æ ¸å¿ƒæµç¨‹ï¼šcore
- å‘½ä»¤ï¼šcommander
  - åˆå§‹åŒ–
  - å‘å¸ƒ
  - æ¸…é™¤ç¼“å­˜
  - ...
- æ¨¡å‹å±‚ï¼šmodels
  - Command å‘½ä»¤
  - Project é¡¹ç›®
  - Component ç»„ä»¶
  - Npm æ¨¡å—
  - Git ä»“åº“
- æ”¯æ’‘æ¨¡å—ï¼šutils
  - Git æ“ä½œ
  - äº‘æ„å»º 0
  - å·¥å…·æ–¹æ³•
  - API è¯·æ±‚
  - Git API

#### æ‹†åˆ†åŸåˆ™

æ ¹æ®æ¨¡å—çš„åŠŸèƒ½æ‹†åˆ†:

- æ ¸å¿ƒæ¨¡å—: core
- å‘½ä»¤æ¨¡å—: commands
- æ¨¡å‹æ¨¡å—: modeis
- å·¥å…·æ¨¡å—: utils

### core æ¨¡å—çš„æŠ€æœ¯æ–¹æ¡ˆ

#### å‘½ä»¤æ‰§è¡Œæµç¨‹

- å‡†å¤‡é˜¶æ®µ prepareï¼š
  - æ£€æŸ¥ç‰ˆæœ¬å·
  - æ£€æŸ¥ node ç‰ˆæœ¬
  - æ£€æŸ¥ root å¯åŠ¨
  - æ£€æŸ¥ç”¨æˆ·ä¸»ç›®å½•
  - æ£€æŸ¥å…¥å‚
  - æ£€æŸ¥ç¯å¢ƒå˜é‡
  - æ£€æŸ¥æ˜¯å¦ä¸ºæœ€æ–°ç‰ˆæœ¬
  - æç¤ºæ›´æ–°
- å‘½ä»¤æ³¨å†Œ registerCommandï¼š
  - æ³¨å†Œ init å‘½ä»¤
  - æ³¨å†Œ publish å‘½ä»¤
  - æ³¨å†Œ clean å‘½ä»¤
  - æ”¯æŒ debug
- å‘½ä»¤æ‰§è¡Œ execCommandï¼š

#### æ¶‰åŠæŠ€æœ¯ç‚¹

##### æ ¸å¿ƒåº“

- import-loca
- commander

##### å·¥å…·åº“

- npmlogï¼š[npmlog - npm (npmjs.com)](https://www.npmjs.com/package/npmlog)
- fs-extraï¼š[fs-extra - npm (npmjs.com)](https://www.npmjs.com/package/fs-extra)
- semverï¼š[semver - npm (npmjs.com)](https://www.npmjs.com/package/semver)
- colorsï¼šhttps://www.npmjs.com/package/colors
- userhome| untildifyï¼š
  - [userhome - npm (npmjs.com)](https://www.npmjs.com/package/userhome)
  - [untildify - npm (npmjs.com)](https://www.npmjs.com/package/untildify)
- dotenvï¼š[dotenv - npm (npmjs.com)](https://www.npmjs.com/package/dotenv)
- root-check | is-rootï¼š
  - [root-check - npm (npmjs.com)](https://www.npmjs.com/package/root-check)
  - [is-root - npm (npmjs.com)](https://www.npmjs.com/package/is-root)

### ä»£ç 

githubï¼š
