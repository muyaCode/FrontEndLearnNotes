# EggJs æ¡†æ¶

## EggJs ä»‹ç»

EggJs æ˜¯é˜¿é‡Œä¸ºä½¿ç”¨ Node.js & Koa æ„å»ºæ›´å¥½çš„ä¼ä¸šæ¡†æ¶å’Œåº”ç”¨ç¨‹åºè€Œè¯ç”Ÿ

Egg é€‰æ‹©äº† Koa ä½œä¸ºå…¶åŸºç¡€æ¡†æ¶ï¼Œåœ¨å®ƒçš„æ¨¡å‹åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥å¯¹å®ƒè¿›è¡Œäº†ä¸€äº›å¢å¼º

### Egg åœ¨é˜¿é‡Œ

![01-eggåœ¨é˜¿é‡Œ.png](./img/01-eggåœ¨é˜¿é‡Œ.png)

### Node åœ¨é˜¿é‡Œ

![02-Nodejsåœ¨é˜¿é‡Œ.png](./img/02-Nodejsåœ¨é˜¿é‡Œ.png)

### Egg ç‰¹æ€§

- æä¾›åŸºäº EggÂ [å®šåˆ¶ä¸Šå±‚æ¡†æ¶](https://www.eggjs.org/zh-CN/advanced/framework)çš„èƒ½åŠ›
- é«˜åº¦å¯æ‰©å±•çš„[æ’ä»¶æœºåˆ¶](https://www.eggjs.org/zh-CN/basics/plugin)
- å†…ç½®[å¤šè¿›ç¨‹ç®¡ç†](https://www.eggjs.org/zh-CN/advanced/cluster-client)
- **åŸºäº Â [Koa](http://koajs.com/)Â  å¼€å‘ï¼Œæ€§èƒ½ä¼˜å¼‚**
- æ¡†æ¶ç¨³å®šï¼Œæµ‹è¯•è¦†ç›–ç‡é«˜
- [æ¸è¿›å¼å¼€å‘](https://www.eggjs.org/zh-CN/intro/progressive)

### Egg ä¼˜åŠ¿

- 1.Express å’Œ Koa æ²¡æœ‰çº¦æŸå’Œè§„èŒƒ, ä¼šå¯¼è‡´å›¢é˜Ÿçš„æ²Ÿé€šæˆæœ¬å’Œé¡¹ç›®çš„ç»´æŠ¤æˆæœ¬å˜é«˜ï¼ŒEggJS æœ‰çº¦æŸå’Œè§„èŒƒ, ä¼šå¤§å¤§é™ä½å›¢é˜Ÿçš„æ²Ÿé€šæˆæœ¬å’Œé¡¹ç›®çš„ç»´æŠ¤æˆæœ¬

  - ä»€ä¹ˆæ˜¯æœ‰çº¦æŸå’Œè§„èŒƒ?

    å’Œ ESLint æ£€æŸ¥ JS ä»£ç ä¸€æ ·, æœ‰ä¸€å¥—æ ‡å‡†, å¿…é¡»ä¸¥æ ¼éµå®ˆè¿™å¥—æ ‡å‡† ,å¦åˆ™å°±ä¼šæŠ¥é”™

    <https://eggjs.org/zh-cn/basics/structure.html>

- 2.é˜¿é‡Œå†…éƒ¨å¤§é‡ä¼ä¸šçº§é¡¹ç›®ä½¿ç”¨ egg å¼€å‘, å®è·µå‡ºçœŸçŸ¥

- 3.Node ç¤¾åŒº 5 ä½å›½äººæ ¸å¿ƒè´¡çŒ®è€… 4 äººåœ¨é˜¿é‡Œ, æŠ€æœ¯æœ‰ä¿éšœ

- 4.é˜¿é‡Œå‰ç«¯å®‰å…¨ä¸“å®¶ï¼Œè´Ÿè´£ egg-security ç­‰ç±»åº“, å®‰å…¨æœ‰ä¿éšœ

### Egg å¼€å‘éµå¾ª MVC è§„èŒƒï¼Œä»€ä¹ˆæ˜¯ MVCï¼Ÿ

M(Model)ï¼šå¤„ç†åº”ç”¨ç¨‹åº'æ•°æ®é€»è¾‘'çš„éƒ¨åˆ†(service)

V(View)ï¼šå¤„ç†æ•°æ®æ˜¾ç¤ºçš„éƒ¨åˆ†(é™æ€/åŠ¨æ€ç½‘é¡µ)

C(Controller)ï¼šå¤„ç†åº”ç”¨ç¨‹åºä¸šåŠ¡é€»è¾‘, æ•°æ®å’Œé¡µé¢çš„æ¡¥æ¢(controller)

æ¨èé˜…è¯»: <https://github.com/atian25/blog/issues/18>

## EggJS ç›¸å…³ç½‘å€æ–‡æ¡£

EggJs å®˜ç½‘ï¼š<https://www.eggjs.org/zh-CN>

EggJs ä¸­æ–‡æ–‡æ¡£ï¼š<https://www.eggjs.org/zh-CN/intro/quickstart>

EggJs å¼€æº GitHub åœ°å€ï¼š<https://github.com/eggjs/egg>

## EggJS å®æˆ˜ ğŸ˜

å®æˆ˜å†™å®Œçš„ demoï¼š[muyaCode/egg-demo: egg é¡¹ç›®ç»ƒä¹  (github.com)](https://github.com/muyaCode/egg-demo)

---

çœ‹å¿«é€Ÿå…¥é—¨æ–‡æ¡£ï¼Œè„šæ‰‹æ¶åˆå§‹åŒ–é¡¹ç›®ï¼š[å¿«é€Ÿå…¥é—¨ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/intro/quickstart)

### 1.eggjs çš„é¡¹ç›®ç»“æ„

æ–‡æ¡£ï¼š[ç›®å½•ç»“æ„ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/structure)

é¡¹ç›®éœ€è¦æ ¹æ®å®˜æ–¹ç›®å½•ç»“æ„è§„èŒƒå¼€å‘ï¼Œå¦åˆ™ä¸èƒ½æ­£å¸¸è¿è¡Œ

---

### 2.é¡¹ç›®è¿è¡Œç¯å¢ƒé…ç½®

æ–‡æ¡£ï¼š[è¿è¡Œç¯å¢ƒ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/env)

---

### 3.é¡¹ç›®çš„å®‰å…¨ç­–ç•¥é…ç½®-config ç›®å½•

config é…ç½®-æ–‡æ¡£ï¼š[Config é…ç½® - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/config)

EggJS ç»™æˆ‘ä»¬æä¾›äº†å¤šç§é…ç½®æ–‡ä»¶, æ–¹ä¾¿æˆ‘ä»¬åœ¨ä¸åŒçš„é˜¶æ®µä¸­ä½¿ç”¨

- config.prod.js Â  Â  // åªæœ‰çº¿ä¸Šç¯å¢ƒä¼šåŠ è½½

- config.test.js Â  Â  // åªæœ‰æµ‹è¯•ç¯å¢ƒä¼šåŠ è½½

- config.local.js Â  Â  // åªæœ‰å¼€å‘ç¯å¢ƒä¼šåŠ è½½

- config.default.js Â  // æ‰€æœ‰ç¯å¢ƒéƒ½ä¼šåŠ è½½

å¦‚æœå‡ºç°åŒåçš„é…ç½®,ï¼Œåé¢ä¸‰ä¸ªé…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ä¼šè¦†ç›– default ä¸­çš„é…ç½®

---

#### å¦‚ä½•è®¾ç½®å½“å‰ç¯å¢ƒ?

```js
EGG_SERVER_ENV = xxx;
```

è¿è¡Œç¯å¢ƒ-é…ç½®æ–‡æ¡£ï¼š[è¿è¡Œç¯å¢ƒ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/env)

##### éœ€è¦é…åˆ`cross-env`ç¯å¢ƒå˜é‡åº“ä½¿ç”¨

package.json æ–‡ä»¶å†…é…ç½®ï¼š

`egg-scripts start --daemon` æ­¤å‘½ä»¤å¯ä»¥æŸ¥çœ‹åº”ç”¨éƒ¨ç½²æ–‡æ¡£ï¼š[åº”ç”¨éƒ¨ç½² - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/core/deployment)

```json
"scripts": {
    "dev": "cross-env EGG_SERVER_ENV=dev egg-bin dev",
    "prod": "cross-env EGG_SERVER_ENV=prod egg-scripts start --daemon",
    "stop": "egg-scripts stop"
  },
```

é…åˆä¸Šé¢çš„ config çš„å„ä¸ªé…ç½®æ–‡ä»¶ï¼Œè¾¾åˆ°ç¯å¢ƒå˜é‡é…ç½®çš„ä½œç”¨

---

å®‰å…¨é…ç½®-æ–‡æ¡£ï¼š[å®‰å…¨ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/core/security)

---

### 4.å†…ç½®åŸºç¡€å¯¹è±¡

æ–‡æ¡£ï¼š[æ¡†æ¶å†…ç½®åŸºç¡€å¯¹è±¡ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/objects)

### 5.é™æ€èµ„æºç›®å½•-app/public

æŠŠé™æ€èµ„æºæ”¾åœ¨`app/public`ç›®å½•ä¸‹ï¼Œä¼šè‡ªåŠ¨è§£æ

æµè§ˆå™¨è®¿é—®ï¼š`localhost:7001/public/login.html`

é¡¹ç›®å†…è®¿é—®ï¼š

### 6.åŠ¨æ€èµ„æºå¤„ç†-æ¨¡æ¿æ¸²æŸ“

æ¨¡æ¿æ¸²æŸ“æ–‡æ¡£ï¼š[View æ¨¡æ¿æ¸²æŸ“ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/core/view)

æˆ‘ä»¬è¿™é‡Œé€‰æ‹©ç”¨ ejs æ¸²æŸ“æ¨¡æ¿æ’ä»¶

#### 1.å®‰è£…`egg-view-ejs`æ’ä»¶

```bash
npm i egg-view-ejs --save --legacy-peer-deps

# --legacy-peer-depsï¼šè§£å†³å®‰è£…æŠ¥é”™â†“ï¼Œæ’ä»¶ä¸å…¼å®¹
# npm ERR! code ERESOLVE
# npm ERR! ERESOLVE could not resolve
```

#### 2.åœ¨ config ç›®å½•ä¸‹æ–°å»º plugin.js-å†™å…¥é…ç½®

```js
exports.ejs = { enable: true, package: "egg-view-ejs" };
```

#### 3.åœ¨ config.default.js ä¸­æ–°å¢å¦‚ä¸‹é…ç½®

```js
view: { mapping: { '.html': 'ejs' } },
```

#### 4.åœ¨ app ç›®å½•ä¸­æ–°å»º view ç›®å½•, å°†åŠ¨æ€ç½‘é¡µæ”¾åˆ°è¿™ä¸ªç›®å½•ä¸­

æ–‡ä»¶ï¼šapp/view/index.html

```html
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>åŠ¨æ€ç½‘é¡µ</title>
	</head>
	<body>
		<h1>æˆ‘æ˜¯åŠ¨æ€ç½‘é¡µ</h1>
		<h2><%=msg%></h2>
	</body>
</html>
```

#### 5.åœ¨æ§åˆ¶å™¨ä¸­é€šè¿‡ä¸Šä¸‹æ–‡ render æ–¹æ³•æ¸²æŸ“

æ§åˆ¶å™¨ä¸­æ·»åŠ æ–°æ–¹æ³•ï¼šapp/controller/home.js

```js
// æ¨¡æ¿æ¸²æŸ“
async getHome() {
  await this.ctx.render('index', { msg: 'ejsæ¨¡æ¿æ¸²æŸ“' });
}
```

åœ¨è·¯ç”±ä¸­ä½¿ç”¨æ§åˆ¶å™¨æ–¹æ³•æ¸²æŸ“é¡µé¢

```js
// ejsæ¨¡æ¿æ¸²æŸ“å¼•æ“é¡µé¢
router.get("/home", controller.home.getHome);
```

---

### 7.æ•°æ®åº“æ“ä½œå’Œç½‘ç»œæ•°æ®å¤„ç†-æœåŠ¡ï¼ˆServiceï¼‰

Service æ–‡æ¡£ï¼š[æœåŠ¡ï¼ˆServiceï¼‰ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/service)

#### 1.é¡¹ç›®æ–°å»º app/service ç›®å½•

ç›®å½•ä¸‹æ–°å»ºä¸æ§åˆ¶å™¨åŒåçš„æœåŠ¡æ–¹æ³•æ¨¡å— js

`app/service/home.js`

```js
// app/service/home.js
const Service = require("egg").Service;

class HomeService extends Service {
	async findNews() {
		// å‘é€getä¸å¸¦å‚æ•°çš„è¯·æ±‚
		// let response = await this.ctx.curl('http://127.0.0.1:3000/getUser');
		// å‘é€getå¸¦å‚æ•°çš„è¯·æ±‚
		// let response = await this.ctx.curl('http://127.0.0.1:3000/getUser2?name=it666&age=66');
		// å‘é€postä¸å¸¦å‚æ•°çš„è¯·æ±‚
		// let response = await this.ctx.curl('http://127.0.0.1:3000/getNews', {
		//     method: 'post'
		// });
		// å‘é€postå¸¦å‚æ•°çš„è¯·æ±‚
		const response = await this.ctx.curl("http://localhost:3000/getNews2", {
			method: "post",
			data: {
				name: "lnj",
				age: 33,
			},
		});
		const data = JSON.parse(response.data);
		console.log("HomeService", data);
		return data;
	}
}

module.exports = HomeService;
```

#### 2.ä½¿ç”¨ service çš„æ•°æ®è¯·æ±‚å¤„ç†çš„æœåŠ¡æ–¹æ³•

æ§åˆ¶å™¨ä¸­æ–°æ·»åŠ æ–¹æ³•ï¼šapp/controller/home.js

```js
async getNews(){
  let data = await this.ctx.service.home.findNews();
  this.ctx.body = data;
}
```

åœ¨è·¯ç”±ä¸­ä½¿ç”¨æ–¹æ³•ï¼šapp/router.js

```js
// æ•°æ®å¤„ç†
router.get("/news", controller.home.getNews);
```

#### service æ³¨æ„ç‚¹

1. service ç›®å½•å¿…é¡»æ”¾åœ¨ app ç›®å½•ä¸­

2. service ç›®å½•æ”¯æŒå¤šçº§ç›®å½•, å¦‚æœæ˜¯å¤šçº§ç›®å½•, é‚£ä¹ˆåœ¨è°ƒç”¨çš„æ—¶å€™å¯ä»¥ä½¿ç”¨é“¾å¼è°ƒç”¨

   1. `this.ctx.service.abc.def.text.xxx();`

3. service ä¸­çš„ js æ–‡ä»¶, å¦‚æœæ˜¯ä»¥\_æˆ–è€…é¦–å­—æ¯éƒ½æ˜¯å¤§å†™, é‚£ä¹ˆåœ¨è°ƒç”¨çš„æ—¶å€™å¿…é¡»è½¬æ¢æˆé©¼å³°å‘½å

   1. `get_user.js --- getUser`

   2. `GetUser.js --- getUser`

---

### 8.å¤„ç† Cookie å’Œ Session

æ–‡æ¡£ï¼š[Cookie ä¸ Session - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/core/cookie-and-session)

---

### 9.å¤„ç†æ—¥å¿—

æ–‡æ¡£ï¼š[æ—¥å¿— - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/core/logger)

---

### 10.å®šæ—¶ä»»åŠ¡

æ–‡æ¡£ï¼š[å®šæ—¶ä»»åŠ¡ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/schedule)

#### EggJS å®šæ—¶ä»»åŠ¡(è®¡åˆ’ä»»åŠ¡)?

è™½ç„¶æˆ‘ä»¬é€šè¿‡æ¡†æ¶å¼€å‘çš„ Web æœåŠ¡å™¨æ˜¯è¯·æ±‚å“åº”æ¨¡å‹çš„ï¼Œä½†æ˜¯ä»ç„¶è¿˜ä¼šæœ‰è®¸å¤šåœºæ™¯éœ€è¦æ‰§è¡Œä¸€äº›å®šæ—¶ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š

- å®šæ—¶è¿›è¡Œæ–‡ä»¶åˆ‡å‰²ã€ä¸´æ—¶æ–‡ä»¶åˆ é™¤ã€‚

- å®šæ—¶ä¸ŠæŠ¥åº”ç”¨çŠ¶æ€ã€‚(ä¾‹å¦‚ç›‘æ§ç³»ç»Ÿ, æ—¶æ—¶ç›‘æ§ç³»ç»Ÿæœ‰æ²¡æœ‰é—®é¢˜, å…¸å‹ä¾‹å­ MongoDB/Redis é›†ç¾¤é€‰ä¸¾)

- å®šæ—¶ä»è¿œç¨‹æ¥å£æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚

Egg æ¡†æ¶æä¾›äº†ä¸€å¥—æœºåˆ¶æ¥è®©å®šæ—¶ä»»åŠ¡çš„ç¼–å†™å’Œç»´æŠ¤æ›´åŠ ä¼˜é›…

##### 1.å®šä¹‰å®šæ—¶ä»»åŠ¡

æ–°å»ºæ–‡ä»¶ï¼š`app/schedule/updateMessage.js`

```js
const Subscription = require("egg").Subscription;

class UpdateCache extends Subscription {
	// é€šè¿‡ schedule å±æ€§æ¥è®¾ç½®å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œé—´éš”ç­‰é…ç½®
	static get schedule() {
		return {
			interval: "3s", // é—´éš”3ç§’æ‰§è¡Œä¸€æ¬¡
			type: "all", //  allè¡¨ç¤ºå½“å‰æœåŠ¡å™¨ä¸Šæ‰€æœ‰ç›¸åŒçš„Nodeè¿›ç¨‹éƒ½æ‰§è¡Œ
		};
	}

	// subscribe æ˜¯çœŸæ­£å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶è¢«è¿è¡Œçš„å‡½æ•°
	async subscribe() {
		let response = await this.ctx.curl("http://127.0.0.1:3000/getMsg");
		let data = new Buffer(response.data).toString();
		console.log(data);
	}
}

module.exports = UpdateCache;
```

æ¥ä¸‹æ¥`npm run dev`è¿è¡Œå½“å‰ egg é¡¹ç›®ï¼Œå®šæ—¶ä»»åŠ¡ä¾¿ä¼šå®šæ—¶æ‰§è¡Œå®šæ—¶ä»»åŠ¡`subscribe`æ–¹æ³•

##### 2.å®šæ—¶ä»»åŠ¡æ¸²æŸ“åˆ°å½“å‰é¡¹ç›®çš„æ¨¡æ¿å¼•æ“

æ§åˆ¶å™¨ä¸­æ·»åŠ æ–¹æ³•ï¼š

```js
// å®šæ—¶ä»»åŠ¡æ¸²æŸ“æ–¹æ³•
async test() {
  await this.ctx.render('index', { msg: this.ctx.app.msg });
}
```

æ·»åŠ è·¯ç”±ï¼š

```js
// å®šæ—¶ä»»åŠ¡è·¯ç”±
router.get("/test", controller.home.test);
```

##### 3.å¯åŠ¨è‡ªå®šä¹‰

æ–‡æ¡£ï¼š[å¯åŠ¨è‡ªå®šä¹‰ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/app-start)

###### 1.é¡¹ç›®æ ¹ç›®å½•æ–°å»ºæ–‡ä»¶ï¼šapp.js

```js
// app.js
class AppBootHook {
	constructor(app) {
		this.app = app;
	}
	// è¿™ä¸ªæ–¹æ³•ä¼šåœ¨EggJSç¨‹åºå¯åŠ¨å®Œæ¯•ä¹‹åæ‰§è¡Œ
	async serverDidReady() {
		// æ³¨æ„ç‚¹: è¿™é‡Œä¼ é€’çš„ä¸æ˜¯æ–¹æ³•åç§°, è€Œæ˜¯éœ€è¦è¢«æ‰§è¡Œçš„é‚£ä¸ªå®šæ—¶ä»»åŠ¡æ–‡ä»¶çš„åç§°
		await this.app.runSchedule("updateMessage");
	}
}

module.exports = AppBootHook;
```

ç„¶å`npm run dev`è¿è¡Œå½“å‰ egg é¡¹ç›®

---

### 11.Egg æ¡†æ¶æ‰©å±•

åœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥ä½¿ç”¨å·²æœ‰çš„æ‰©å±• API æ¥æ–¹ä¾¿å¼€å‘ï¼Œä¹Ÿå¯ä»¥å¯¹ä»¥ä¸Šå¯¹è±¡è¿›è¡Œè‡ªå®šä¹‰æ‰©å±•ï¼Œè¿›ä¸€æ­¥åŠ å¼ºæ¡†æ¶çš„åŠŸèƒ½

æ–‡æ¡£ï¼š[æ¡†æ¶æ‰©å±• - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/extend)

---

### 12.Egg ä¸­é—´ä»¶

æ–‡æ¡£ï¼š[ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/middleware)

app/middleware ç›®å½•

---

### 13.Egg æ“ä½œæ•°æ®åº“

MySQLï¼š[MySQL - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/tutorials/mysql)

Sequelizeï¼š[Sequelize - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/tutorials/sequelize)

---

### 14.CSRF å®‰å…¨é˜²èŒƒ

æ–‡æ¡£ï¼š[å®‰å…¨ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/core/security#%E5%AE%89%E5%85%A8%E5%A8%81%E8%83%81-csrf-%E7%9A%84%E9%98%B2%E8%8C%83)

è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»

---

### 15.æ•°æ®æ ¡éªŒ

ä½¿ç”¨`egg-validate`åº“ï¼Œnpm æ–‡æ¡£ï¼š[egg-validate - npm (npmjs.com)](https://www.npmjs.com/package/egg-validate)

åœ¨`controller`æ§åˆ¶å™¨å±‚æ ¡éªŒå‰ç«¯ä¼ è¿‡æ¥çš„è¡¨å•æ•°æ®ï¼š[æ§åˆ¶å™¨ï¼ˆControllerï¼‰ - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/controller)

---

### 16.ç»Ÿä¸€æ¥å£è¿”å›ç›¸åº”æ ¼å¼é…ç½®

æ¡†æ¶æ‰©å±•æ–‡æ¡£ï¼š[æ¡†æ¶æ‰©å±• - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/extend)

å¯¹ context è¿›è¡Œæ‰©å±•ï¼š[æ¡†æ¶æ‰©å±•#context - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/basics/extend#context)

#### 1.æ–°å»º`app/extend`ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼šapp/extend/context.js

```js
module.exports = {
	// è¯·æ±‚æˆåŠŸè¿”å›
	success(data, code = 200, msg = "æˆåŠŸ") {
		// this å°±æ˜¯ ctx å¯¹è±¡ï¼Œåœ¨å…¶ä¸­å¯ä»¥è°ƒç”¨ ctx ä¸Šçš„å…¶ä»–æ–¹æ³•ï¼Œæˆ–è®¿é—®å±æ€§
		this.body = {
			code: code,
			msg: msg,
			data: data,
		};
	},
	// è¯·æ±‚é”™è¯¯
	error(code = 500, msg = "é”™è¯¯") {
		// this å°±æ˜¯ ctx å¯¹è±¡ï¼Œåœ¨å…¶ä¸­å¯ä»¥è°ƒç”¨ ctx ä¸Šçš„å…¶ä»–æ–¹æ³•ï¼Œæˆ–è®¿é—®å±æ€§
		this.body = {
			code: code,
			msg: msg,
		};
	},
};
```

#### 2.å®šä¹‰è¯·æ±‚æˆåŠŸå’Œé”™è¯¯çš„çŠ¶æ€ç ï¼šapp\extend\helper.js

```js
module.exports = {
	errorCode: {
		// æˆåŠŸçŠ¶æ€ç 
		200: "è¯·æ±‚æˆåŠŸã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼ŒæœåŠ¡å™¨è¿”å›ç›¸å…³æ•°æ®",
		201: "èµ„æºåˆ›å»ºæˆåŠŸã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨æä¾›æ•°æ®ï¼ŒæœåŠ¡å™¨åˆ›å»ºèµ„æº",
		202: "è¯·æ±‚è¢«æ¥æ”¶ã€‚ä½†å¤„ç†å°šæœªå®Œæˆ",
		204: "å®¢æˆ·ç«¯å‘ŠçŸ¥æœåŠ¡å™¨åˆ é™¤ä¸€ä¸ªèµ„æºï¼ŒæœåŠ¡å™¨ç§»é™¤å®ƒ",
		206: "è¯·æ±‚æˆåŠŸã€‚ä½†æ˜¯åªæœ‰éƒ¨åˆ†å›åº”",
		// é”™è¯¯çŠ¶æ€ç 
		400: "è¯·æ±‚æ— æ•ˆã€‚æ•°æ®ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•",
		401: "è¯·æ±‚æ²¡æœ‰æƒé™ã€‚ç¼ºå°‘API tokenï¼Œæ— æ•ˆæˆ–è€…è¶…æ—¶",
		403: "ç”¨æˆ·å¾—åˆ°æˆæƒï¼Œä½†æ˜¯è®¿é—®æ˜¯è¢«ç¦æ­¢çš„ã€‚",
		404: "å‘å‡ºçš„è¯·æ±‚é’ˆå¯¹çš„æ˜¯ä¸å­˜åœ¨çš„è®°å½•ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è¿›è¡Œæ“ä½œã€‚",
		406: "è¯·æ±‚å¤±è´¥ã€‚è¯·æ±‚å¤´éƒ¨ä¸ä¸€è‡´ï¼Œè¯·é‡è¯•",
		410: "è¯·æ±‚çš„èµ„æºè¢«æ°¸ä¹…åˆ é™¤ï¼Œä¸”ä¸ä¼šå†å¾—åˆ°çš„ã€‚",
		422: "è¯·æ±‚å¤±è´¥ã€‚è¯·éªŒè¯å‚æ•°",
		// æœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç 
		500: "æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ã€‚",
		502: "ç½‘å…³é”™è¯¯",
		503: "æœåŠ¡ä¸å¯ç”¨ï¼ŒæœåŠ¡å™¨æš‚æ—¶è¿‡è½½æˆ–ç»´æŠ¤ã€‚",
		504: "ç½‘å…³è¶…æ—¶",
	},
};
```

#### 3.è¿”å›è¯·æ±‚çŠ¶æ€

æ§åˆ¶å™¨æ–¹æ³•ä¸­è¿”å›é”™è¯¯çŠ¶æ€ç ä¿¡æ¯ç¤ºä¾‹ï¼š

```js
ctx.success(res);
```

```js
// æŠ›å‡ºçš„é”™è¯¯ä¼šåœ¨cathå†…æ•è·
try{}cath(e){ctx.error(400, ctx.helper.errorCode[400]);}
```

---

### 17.ç”¨æˆ·å¯†ç åŠ å¯†å·¥å…·æ–¹æ³•

ä½¿ç”¨`crypto`åº“ï¼Œå†™ md5 åŠ å¯†æ–¹æ³•ï¼šapp\extend\helper.js

```js
const crypto = require("crypto");
module.exports = {
	errorCode: {
		// æˆåŠŸçŠ¶æ€ç 
		200: "è¯·æ±‚æˆåŠŸã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼ŒæœåŠ¡å™¨è¿”å›ç›¸å…³æ•°æ®",
		201: "èµ„æºåˆ›å»ºæˆåŠŸã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨æä¾›æ•°æ®ï¼ŒæœåŠ¡å™¨åˆ›å»ºèµ„æº",
		202: "è¯·æ±‚è¢«æ¥æ”¶ã€‚ä½†å¤„ç†å°šæœªå®Œæˆ",
		204: "å®¢æˆ·ç«¯å‘ŠçŸ¥æœåŠ¡å™¨åˆ é™¤ä¸€ä¸ªèµ„æºï¼ŒæœåŠ¡å™¨ç§»é™¤å®ƒ",
		206: "è¯·æ±‚æˆåŠŸã€‚ä½†æ˜¯åªæœ‰éƒ¨åˆ†å›åº”",
		// é”™è¯¯çŠ¶æ€ç 
		400: "è¯·æ±‚æ— æ•ˆã€‚æ•°æ®ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•",
		401: "è¯·æ±‚æ²¡æœ‰æƒé™ã€‚ç¼ºå°‘API tokenï¼Œæ— æ•ˆæˆ–è€…è¶…æ—¶",
		403: "ç”¨æˆ·å¾—åˆ°æˆæƒï¼Œä½†æ˜¯è®¿é—®æ˜¯è¢«ç¦æ­¢çš„ã€‚",
		404: "å‘å‡ºçš„è¯·æ±‚é’ˆå¯¹çš„æ˜¯ä¸å­˜åœ¨çš„è®°å½•ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è¿›è¡Œæ“ä½œã€‚",
		406: "è¯·æ±‚å¤±è´¥ã€‚è¯·æ±‚å¤´éƒ¨ä¸ä¸€è‡´ï¼Œè¯·é‡è¯•",
		410: "è¯·æ±‚çš„èµ„æºè¢«æ°¸ä¹…åˆ é™¤ï¼Œä¸”ä¸ä¼šå†å¾—åˆ°çš„ã€‚",
		422: "è¯·æ±‚å¤±è´¥ã€‚è¯·éªŒè¯å‚æ•°",
		// æœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç 
		500: "æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ã€‚",
		502: "ç½‘å…³é”™è¯¯",
		503: "æœåŠ¡ä¸å¯ç”¨ï¼ŒæœåŠ¡å™¨æš‚æ—¶è¿‡è½½æˆ–ç»´æŠ¤ã€‚",
		504: "ç½‘å…³è¶…æ—¶",
	},
	// md5åŠ å¯†æ–¹æ³•
	_md5(password) {
		// 1.æŒ‡å®šåŠ å¯†æ–¹å¼
		const md5 = crypto.createHash("md5");
		// 2.æŒ‡å®šéœ€è¦åŠ å¯†çš„å†…å®¹å’ŒåŠ å¯†ä¹‹åè¾“å‡ºçš„æ ¼å¼
		const hash = md5
			.update(password) // æŒ‡å®šéœ€è¦åŠ å¯†çš„å†…å®¹
			.digest("hex"); // æŒ‡å®šåŠ å¯†ä¹‹åè¾“å‡ºçš„æ ¼å¼
		return hash;
	},
	// ç”¨æˆ·å¯†ç åŠ å¯†å·¥å…·æ–¹æ³•
	generatePwd(password) {
		password = password + this.config.keys;
		let hash = this._md5(password);
		return hash;
	},
};
```

service ä¸­è°ƒç”¨æ–¹æ³•ï¼š

```js
// è°ƒç”¨ç”¨æˆ·å¯†ç åŠ å¯†æ–¹æ³•
this.ctx.helper.generatePwd(password);
```

---

### 18.é˜²æ­¢é‡å¤æ³¨å†Œ

æ–¹å¼ 1ï¼šæ•°æ®åº“æ’å…¥è¯­å¥ä½¿ç”¨ï¼šUNIQUE

æ–¹å¼ 2ï¼šæ’å…¥æ•°æ®å‰å…ˆæŸ¥è¯¢æ˜¯å¦å·²ç»æœ‰è¿™ä¸ªç”¨æˆ·æˆ–è€…ç›¸åŒæ•°æ®

æŠ›å‡ºå¼‚å¸¸ï¼šthrow new Error('å½“å‰ç”¨æˆ·å·²å­˜åœ¨')

ctx è¿™è¾¹ä¼šæ•è·å¼‚å¸¸ï¼šctx.error(400, e.message);

---

### 19.å®ç°ç™»å½•

#### 1.å‰ç«¯ç™»å½•åï¼Œåç«¯éœ€è¦è¿”å›æ•°æ®

#### 2.å®ç°ç™»å½•ä¿å­˜çŠ¶æ€ï¼šä½¿ç”¨`egg-redis`åº“+`egg-session-redis`åº“ï¼Œè¿æ¥ redisï¼Œä¿å­˜ç™»å½•çš„ session

egg-redis çš„ npm æ–‡æ¡£ï¼š[egg-redis - npm (npmjs.com)](https://www.npmjs.com/package/egg-redis)

egg-session-redis çš„ npm æ–‡æ¡£ï¼š[egg-session-redis - npm (npmjs.com)](https://www.npmjs.com/package/egg-session-redis)

#### 3.é…ç½®æ’ä»¶

`config\plugin.js`ä¸­ä½¿ç”¨ï¼š

```js{17-20}
'use strict';

/** @type Egg.EggPlugin */
module.exports = {
    ajv : {
        enable: true,
        package: 'egg-ajv',
    },
    sequelize : {
        enable: true,
        package: 'egg-sequelize',
    },
    sessionRedis : {
        enable: true,
        package: 'egg-session-redis',
    },
    redis : {
        enable: true,
        package: 'egg-redis',
    }
};
```

#### 4.æ•°æ®åº“çš„è¿æ¥é…ç½®ï¼Œéƒ½æ˜¯åœ¨`config\config.default.js`æ–‡ä»¶å†…

```js{32-39}
'use strict';

/**
 * @param {Egg.EggAppInfo} appInfo app info
 */
module.exports = appInfo => {
  /**
   * built-in config
   * @type {Egg.EggAppConfig}
   **/
  const config = exports = {};

  // use for cookie sign key, should change to your own and keep security
  config.keys = appInfo.name + '_1592213709118_461';

  // add your middleware config here
  config.middleware = [];

  config.ajv = {
    keyword: 'schema',  // to indicate the namespace and path of schemas, default as 'schema'
    allErrors: true,    // required for custom error message
    jsonPointers: true,  // required for custom error message
  };
  config.sequelize = {
      dialect: 'mysql',
      host: '127.0.0.1',
      port: 3306,
      user: 'root',
      password: 'root',
      database: 'demo',
  };
  config.redis = {
      client: {
          port: 6379,          // Redis port
          host: '127.0.0.1',   // Redis host
          password: '',
          db: 0,
      },
  };
  // add your user config here
  const userConfig = {
    // myAppName: 'egg',
  };

  return {
    ...config,
    ...userConfig,
  };
};
```

#### 5.å‰ç«¯ç™»å½•åä¼ é€’è¿‡æ¥å‚æ•°ï¼Œ`egg-session-redis`åº“ä¼šæ³¨å…¥ä¸Šä¸‹æ–‡å±æ€§ï¼šctx.session.user

æŠŠ ctx.session.user ä¿å­˜ç™»å½•çš„ç”¨æˆ·

```js
ctx.session.user = å‰ç«¯ç™»å½•åï¼Œåç«¯æŸ¥è¯¢åˆ°çš„ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯
```

---

### 20.Egg é¡¹ç›®æµ‹è¯•ï¼šå•å…ƒæµ‹è¯•

#### å•å…ƒæµ‹è¯•

æ–‡æ¡£ï¼š[å•å…ƒæµ‹è¯• - Egg (eggjs.org)](https://www.eggjs.org/zh-CN/core/unittest)

##### 1.ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•?

å•å…ƒæµ‹è¯•æ˜¯æŒ‡å¯¹è½¯ä»¶ä¸­çš„æœ€å°å¯æµ‹è¯•å•å…ƒè¿›è¡Œæ£€æŸ¥å’ŒéªŒè¯

##### 2.ä»€ä¹ˆæ˜¯æœ€å°å¯æµ‹è¯•å•å…ƒ?

ä¸€ä¸ªå‡½æ•°, ä¸€ä¸ªç±», ä¸€ä¸ªæ–‡ä»¶, è¿™äº›éƒ½å¯ä»¥ç§°ä¹‹ä¸ºæœ€å°å¯æµ‹è¯•å•å…ƒ

å…·ä½“éœ€è¦æ ¹æ®å®é™…æƒ…å†µå»åˆ¤å®šå…¶å…·ä½“å«ä¹‰, ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä»¥å‡½æ•°ä½œä¸ºæœ€å°å•å…ƒå³å¯

##### 3.å•å…ƒæµ‹è¯•æœ‰ä»€ä¹ˆç”¨?

- ä¿è¯ä»£ç çš„æ­£ç¡®æ€§

- ä¿å­˜ç¨‹åºçš„ç¨³å®šæ€§

- å¢å¼ºè‡ªä¿¡å¿ƒ

- å…¬å¸é¢†å¯¼è¦æ±‚(çº¢ç»¿ç¯)

##### 4.åœ¨ EggJS ä¸­å¦‚ä½•è¿›è¡Œå•å…ƒæµ‹è¯•

###### 4.1 EggJS ä½¿ç”¨ Mocha æµ‹è¯•æ¡†æ¶å’Œ power-assert æ–­è¨€åº“æ¥è¿›è¡Œå•å…ƒæµ‹è¯•

- Mochaï¼š<https://mochajs.org/>

- ä½œç”¨ : æä¾›äº†ç¼–å†™æµ‹è¯•ä»£ç çš„æ–¹æ³•

- power-assert: <https://github.com/power-assert-js/power-assert>

- ä½œç”¨ : åˆ¤æ–­æµ‹è¯•ç»“æœæ˜¯å¦æ­£ç¡®

###### 4.2 EggJS è¿˜æŠ½å–äº†ä¸€ä¸ªå«åš egg-mock çš„è¾…åŠ©æ¨¡å—, é…åˆ Mocha å’Œ power-assert è¿›è¡Œæµ‹è¯•

- egg-mock: Â  Â  <https://www.npmjs.com/package/egg-mock>

- ä½œç”¨ : å¸®åŠ©æˆ‘ä»¬èƒ½å¤Ÿåœ¨å•å…ƒæµ‹è¯•ä¸­æ¨¡æ‹Ÿ app, context, cookie, session, ç½‘ç»œè¯·æ±‚ç­‰

###### 4.3 EggJS è§„å®šäº†æµ‹è¯•æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„å’Œæ–‡ä»¶åç§°

```bash
# æµ‹è¯•æ–‡ä»¶çš„ç›®å½•ç»“æ„å’Œæ–‡ä»¶åç§° å’Œ è¢«æµ‹è¯•æ–‡ä»¶çš„ç›®å½•ç»“æ„å’Œåç§°å¿…é¡»ä¸€æ ·
# æµ‹è¯•æ–‡ä»¶çš„æ–‡ä»¶åç§°å¢åŠ .teståç¼€
test
    app
    â”œâ”€â”€â”€â”€
       â”œâ”€â”€ controller
       â”‚   â””â”€â”€ home.test.js
       â”œâ”€â”€ hello.test.js
       â””â”€â”€ service
           â””â”€â”€ user.test.js
```

###### 4.4 egg é¡¹ç›®è¿è¡Œæµ‹è¯•æ–‡ä»¶

EggJS è§„å®šæˆ‘ä»¬ä½¿ç”¨ egg-bin test æ¥è¿è¡Œæˆ‘ä»¬ç¼–å†™çš„æµ‹è¯•æ–‡ä»¶

```bash
egg-bin test
```

---

#### æµ‹è¯•åº“æ¨¡æ¿å’Œæµ‹è¯•çš„ç”Ÿå‘½å‘¨æœŸ

```js
"use strict";
/*
app   :æœåŠ¡ç«¯å®ä¾‹å¯¹è±¡
mock  :eggæä¾›ç»™æˆ‘ä»¬çš„è¾…åŠ©æ¨¡å—å¯¹è±¡
assert:æ–­è¨€åº“å¯¹è±¡
* */
const { app, mock, assert } = require("egg-mock/bootstrap");
/*
åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ä¸€ä¸ªdescribeå‡½æ•°å°±æ˜¯ä¸€ç»„ç›¸å…³çš„æµ‹è¯•
ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦æŠŠä¸€ç»„ç›¸å…³çš„æµ‹è¯•å†™åˆ°ä¸€ä¸ªdescribeå‡½æ•°ä¸­
ç¬¬ä¸€ä¸ªå‚æ•°: è¿™ç»„æµ‹è¯•çš„åç§°
ç¬¬äºŒä¸ªå‚æ•°: ç¼–å†™è¿™ç»„æµ‹è¯•å…·ä½“ä»£ç çš„åœ°æ–¹
* */
describe("test/app/controller/user.test.js", () => {
	/*
  åœ¨ä¸€ä¸ªdescribeæ–¹æ³•ä¸­çš„ä¸€ä¸ªitå°±æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹
  ä¸€ä¸ªitå¯ä»¥ç”¨æ¥æµ‹è¯•ä¸€ä¸ªæ–¹æ³•(å‡½æ•°)
  ç¬¬ä¸€ä¸ªå‚æ•°: ç»™å½“å‰çš„è¿™ä¸ªæµ‹è¯•å–çš„åç§°
  ç¬¬äºŒä¸ªå‚æ•°: ç¼–å†™å…·ä½“æµ‹è¯•ä»£ç çš„å‡½æ•°
  * */
	// it('should assert', () => {
	//
	// });
	/*
  Mochaæµ‹è¯•åº“çš„ç”Ÿå‘½å‘¨æœŸé’©å­
  å•ä¸ªæµ‹è¯•ç”¨ä¾‹çš„
  before -> beforeEach -> it -> afterEach -> after
  å¤šä¸ªæµ‹è¯•ç”¨ä¾‹
  before -> beforeEach -> it -> afterEach -> beforeEach -> it -> afterEach -> after
  before ->
  beforeEach -> it -> afterEach
  beforeEach -> it -> afterEach
  beforeEach -> it -> afterEach
  -> after

  ç”Ÿå‘½å‘¨æœŸé’©å­çš„ä½œç”¨:
  æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œä¹‹å‰å»ç”³è¯·ä¸€äº›èµ„æº
  æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œä¹‹åå»é‡Šæ”¾ç”³è¯·çš„èµ„æº
  ä¾‹å¦‚: æˆ‘ä»¬éœ€è¦æµ‹è¯•æ•°æ®åº“, é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ä¹‹å‰å¾€æ•°æ®åº“ä¸­æ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®
        ç„¶ååœ¨æµ‹è¯•å®Œæˆä¹‹ååˆ é™¤è¿™äº›æµ‹è¯•æ•°æ®
  * */
	before(() => {
		console.log("before");
	});
	beforeEach(() => {
		console.log("beforeEach");
	});
	it("å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹", () => {
		console.log("it");
	});
	it("å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹", () => {
		console.log("it");
	});
	it("å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹", () => {
		console.log("it");
	});
	afterEach(() => {
		console.log("afterEach");
	});
	after(() => {
		console.log("after");
	});
});
```

---

#### åŒæ­¥æµ‹è¯•å’Œå¼‚æ­¥æµ‹è¯•

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/controller/user.test.js", () => {
	/*
  Mocha: åŒæ­¥æµ‹è¯•å’Œå¼‚æ­¥æµ‹è¯•
  * */
	it("åŒæ­¥æµ‹è¯•", () => {
		// console.log('it');
		// æ¨¡æ‹Ÿäº†ä¸€ä¸ªä¸Šä¸‹æ–‡
		let ctx = app.mockContext({
			session: { name: "lnj" },
		});
		// å¸Œæœ›ä¸Šä¸‹æ–‡ä¸­æœ‰session, å¹¶ä¸”ä¿å­˜äº†name, å¹¶ä¸”nameæ˜¯lnj
		// ä»¥ä¸‹ä»£ç çš„å«ä¹‰: æ–­å®šä¸Šä¸‹æ–‡ä¸­æœ‰session, sessionä¸­æœ‰name,nameå–å€¼æ˜¯lnj
		assert(ctx.session.name === "lnj");
	});
	it("å¼‚æ­¥æµ‹è¯•-promise", () => {
		return app.httpRequest().get("/public/login.html").expect(200);
	});
	it("å¼‚æ­¥æµ‹è¯•-callback", (done) => {
		app.httpRequest().get("/public/login.html").expect(200, done);
	});
	it("å¼‚æ­¥æµ‹è¯•-async+await", async () => {
		await app.httpRequest().get("/public/login.html").expect(200);
	});
});
```

---

#### æµ‹è¯•æ§åˆ¶å™¨

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/controller/user.test.js", () => {
	it("æµ‹è¯•æ³¨å†Œ-æˆåŠŸ", async () => {
		app.mockCsrf();
		let user = { username: "123@qq.com", password: "abc123", gender: "ç”·" };
		let response = await app
			.httpRequest()
			.post("/api/user/register")
			.send(user);
		assert(response.body.code === 200);
	});
	it("æµ‹è¯•æ³¨å†Œ-ç”¨æˆ·åä¸ç¬¦åˆé¢„æœŸ", async () => {
		app.mockCsrf();
		let user = { username: "jonathan", password: "abc123", gender: "ç”·" };
		let response = await app
			.httpRequest()
			.post("/api/user/register")
			.send(user);
		assert(response.body.code === 400);
	});
	it("æµ‹è¯•æ³¨å†Œ-å¯†ç ä¸ç¬¦åˆé¢„æœŸ", async () => {
		app.mockCsrf();
		let user = { username: "234@qq.com", password: "123", gender: "ç”·" };
		let response = await app
			.httpRequest()
			.post("/api/user/register")
			.send(user);
		assert(response.body.code === 400);
	});
	// æµ‹è¯•å®Œæˆæ‰§è¡Œ
	after(async () => {
		await app.model.User.destroy({ truncate: true, force: true });
	});
});
```

---

#### æµ‹è¯• Service

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/service/user.test.js", () => {
	it("æµ‹è¯•åˆ›å»ºç”¨æˆ·-æˆåŠŸ", async () => {
		// æµ‹è¯•åˆ›å»ºæˆåŠŸ
		let ctx = app.mockContext();
		let user = { username: "123@qq.com", password: "abc123", gender: "ç”·" };
		let res = await ctx.service.user.createUser(user);
		assert(res.username === "123@qq.com");

		// æµ‹è¯•ç”¨æˆ·åé‡å¤æƒ…å†µ
		try {
			await ctx.service.user.createUser(user);
		} catch (e) {
			assert(e);
		}
	});
	after(async () => {
		await app.model.User.destroy({ truncate: true, force: true });
	});
});
```

---

#### æµ‹è¯• Application

è¢«æµ‹è¯•æ–‡ä»¶ï¼šapp/extend/application.js

```js
let cache = {};
module.exports = {
	set(key, value) {
		cache[key] = value;
	},
	get(key) {
		return cache[key];
	},
};
```

æµ‹è¯•æ–‡ä»¶ï¼štest\app\extend\application.test.js

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/extend/application.test.js", () => {
	it("æµ‹è¯•application", async () => {
		app.set("name", "it666.com");
		assert(app.get("name") === "it666.com");
	});
});
```

---

#### æµ‹è¯• Context

è¢«æµ‹è¯•æ–‡ä»¶ï¼šapp\extend\context.js

```js
module.exports = {
	success(data, code = 200, msg = "æˆåŠŸ") {
		// this å°±æ˜¯ ctx å¯¹è±¡ï¼Œåœ¨å…¶ä¸­å¯ä»¥è°ƒç”¨ ctx ä¸Šçš„å…¶ä»–æ–¹æ³•ï¼Œæˆ–è®¿é—®å±æ€§
		this.body = {
			code: code,
			msg: msg,
			data: data,
		};
	},
	error(code = 500, msg = "é”™è¯¯") {
		// this å°±æ˜¯ ctx å¯¹è±¡ï¼Œåœ¨å…¶ä¸­å¯ä»¥è°ƒç”¨ ctx ä¸Šçš„å…¶ä»–æ–¹æ³•ï¼Œæˆ–è®¿é—®å±æ€§
		this.body = {
			code: code,
			msg: msg,
		};
	},
};
```

æµ‹è¯•æ–‡ä»¶ï¼štest\app\extend\context.test.js

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/extend/context.test.js", () => {
	it("æµ‹è¯•context", async () => {
		let ctx = app.mockContext();
		ctx.error();
		assert(ctx.body.code === 500);
		assert(ctx.body.msg === "é”™è¯¯");
	});
});
```

---

#### æµ‹è¯• Request

è¢«æµ‹è¯•æ–‡ä»¶ï¼šapp\extend\request.js

```js
module.exports = {
	isChrome() {
		let userAgent = this.get("user-agent").toLowerCase();
		return userAgent.includes("chrome");
	},
};
```

è¢«æµ‹è¯•æ–‡ä»¶ï¼štest\app\extend\request.test.js

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/extend/request.test.js", () => {
	it("æµ‹è¯•request", async () => {
		let ctx = app.mockContext({
			headers: {
				// 'user-agent':'Chrome'
				"user-agent": "Mozilla",
			},
		});
		// assert(ctx.request.isChrome() === true);
		assert(ctx.request.isChrome() === false);
	});
});
```

---

#### æµ‹è¯• Response

è¢«æµ‹è¯•æ–‡ä»¶ï¼šapp\extend\response.js

```js
module.exports = {
	isSuccess() {
		return this.status === 200;
	},
};
```

è¢«æµ‹è¯•æ–‡ä»¶ï¼štest\app\extend\response.test.js

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/extend/request.test.js", () => {
	it("æµ‹è¯•response", async () => {
		let ctx = app.mockContext();
		assert(ctx.response.isSuccess() === true);
	});
});
```

---

#### æµ‹è¯• Helper

è¢«æµ‹è¯•æ–‡ä»¶ï¼šapp\extend\helper.js

```js
const crypto = require("crypto");
module.exports = {
	errorCode: {
		// æˆåŠŸçŠ¶æ€ç 
		200: "è¯·æ±‚æˆåŠŸã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼ŒæœåŠ¡å™¨è¿”å›ç›¸å…³æ•°æ®",
		201: "èµ„æºåˆ›å»ºæˆåŠŸã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨æä¾›æ•°æ®ï¼ŒæœåŠ¡å™¨åˆ›å»ºèµ„æº",
		202: "è¯·æ±‚è¢«æ¥æ”¶ã€‚ä½†å¤„ç†å°šæœªå®Œæˆ",
		204: "å®¢æˆ·ç«¯å‘ŠçŸ¥æœåŠ¡å™¨åˆ é™¤ä¸€ä¸ªèµ„æºï¼ŒæœåŠ¡å™¨ç§»é™¤å®ƒ",
		206: "è¯·æ±‚æˆåŠŸã€‚ä½†æ˜¯åªæœ‰éƒ¨åˆ†å›åº”",
		// é”™è¯¯çŠ¶æ€ç 
		400: "è¯·æ±‚æ— æ•ˆã€‚æ•°æ®ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•",
		401: "è¯·æ±‚æ²¡æœ‰æƒé™ã€‚ç¼ºå°‘API tokenï¼Œæ— æ•ˆæˆ–è€…è¶…æ—¶",
		403: "ç”¨æˆ·å¾—åˆ°æˆæƒï¼Œä½†æ˜¯è®¿é—®æ˜¯è¢«ç¦æ­¢çš„ã€‚",
		404: "å‘å‡ºçš„è¯·æ±‚é’ˆå¯¹çš„æ˜¯ä¸å­˜åœ¨çš„è®°å½•ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è¿›è¡Œæ“ä½œã€‚",
		406: "è¯·æ±‚å¤±è´¥ã€‚è¯·æ±‚å¤´éƒ¨ä¸ä¸€è‡´ï¼Œè¯·é‡è¯•",
		410: "è¯·æ±‚çš„èµ„æºè¢«æ°¸ä¹…åˆ é™¤ï¼Œä¸”ä¸ä¼šå†å¾—åˆ°çš„ã€‚",
		422: "è¯·æ±‚å¤±è´¥ã€‚è¯·éªŒè¯å‚æ•°",
		// æœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç 
		500: "æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ã€‚",
		502: "ç½‘å…³é”™è¯¯",
		503: "æœåŠ¡ä¸å¯ç”¨ï¼ŒæœåŠ¡å™¨æš‚æ—¶è¿‡è½½æˆ–ç»´æŠ¤ã€‚",
		504: "ç½‘å…³è¶…æ—¶",
	},
	_md5(password) {
		// 1.æŒ‡å®šåŠ å¯†æ–¹å¼
		const md5 = crypto.createHash("md5");
		// 2.æŒ‡å®šéœ€è¦åŠ å¯†çš„å†…å®¹å’ŒåŠ å¯†ä¹‹åè¾“å‡ºçš„æ ¼å¼
		const hash = md5
			.update(password) // æŒ‡å®šéœ€è¦åŠ å¯†çš„å†…å®¹
			.digest("hex"); // æŒ‡å®šåŠ å¯†ä¹‹åè¾“å‡ºçš„æ ¼å¼
		return hash;
	},
	generatePwd(password) {
		password = password + this.config.keys;
		let hash = this._md5(password);
		return hash;
	},
};
```

è¢«æµ‹è¯•æ–‡ä»¶ï¼štest\app\extend\helper.test.js

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/extend/helper.test.js", () => {
	it("æµ‹è¯•helper", async () => {
		let ctx = app.mockContext();
		assert(ctx.helper.generatePwd("123") !== "123");
	});
});
```

---

#### æµ‹è¯• schedule

è¢«æµ‹è¯•æ–‡ä»¶ï¼Œå®šæ—¶ä»»åŠ¡ï¼šapp\schedule\updateMessage.js

```js
// å®šæ—¶ä»»åŠ¡
const Subscription = require("egg").Subscription;

let count = 1;
class UpdateCache extends Subscription {
	// é€šè¿‡ schedule å±æ€§æ¥è®¾ç½®å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œé—´éš”ç­‰é…ç½®
	static get schedule() {
		return {
			interval: "10s", // é—´éš”3ç§’æ‰§è¡Œä¸€æ¬¡
			type: "all", //  allè¡¨ç¤ºå½“å‰æœåŠ¡å™¨ä¸Šæ‰€æœ‰ç›¸åŒçš„Nodeè¿›ç¨‹éƒ½æ‰§è¡Œ
		};
	}

	// subscribe æ˜¯çœŸæ­£å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶è¢«è¿è¡Œçš„å‡½æ•°
	async subscribe() {
		this.ctx.app.msg = `lnj+${count++}`; // lnj+1 lnj+2
	}
}

module.exports = UpdateCache;
```

è¢«æµ‹è¯•æ–‡ä»¶ï¼štest\app\schedule\updateMessage.test.js

```js
"use strict";
const { app, mock, assert } = require("egg-mock/bootstrap");

describe("test/app/schedule/updateMessage.test.js", () => {
	it("æµ‹è¯•updateMessage", async () => {
		await app.runSchedule("updateMessage");
		assert(app.msg === "lnj+1");
		await app.runSchedule("updateMessage");
		assert(app.msg === "lnj+2");
	});
});
```

---

#### æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ

1.æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå‘½ä»¤ï¼špackage.json çš„"script"å†…çš„å‘½ä»¤ï¼š"cov": "egg-bin cov",

2.è¿è¡Œå‘½ä»¤ï¼š`npm run cov`

3.ç­‰å¾…ç”Ÿæˆï¼Œä¼šåœ¨é¡¹ç›®ç”Ÿæˆ`coverage`ç›®å½•ï¼ŒæŠŠ`coverage`ç›®å½•ä¸‹çš„`lcov-report`ç›®å½•å†…çš„ index.html æ‰“å¼€

4.æ‰“å¼€åå°±æ˜¯çœ‹è§å„ç§æµ‹è¯•æŠ¥å‘Š

## egg-bag-framework

[éƒ½åšå‰ç«¯å¼€å‘äº†ï¼Œæ¥å£è‡ªå·±è¿˜ä¸ä¼šå†™å˜›ï¼ŸğŸ’˜ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7321943946308976680)
