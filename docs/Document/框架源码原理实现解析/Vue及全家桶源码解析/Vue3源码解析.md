# Vue3 æºç è§£æ

[çœ‹ä¸æ‡‚æ¥æ‰“æˆ‘ï¼Œvue3å¦‚ä½•å°†templateç¼–è¯‘æˆrenderå‡½æ•° (qq.com)](https://mp.weixin.qq.com/s/OM_xBi2xci4Wh2ebCT_G1A)

[æ¨è 7 ä¸ª Vue2ã€Vue3 æºç è§£å¯†åˆ†æçš„å¼€æºé¡¹ç›® ğŸ‘ Â· Issue #35 Â· FrontEndGitHub/FrontEndGitHub](https://github.com/FrontEndGitHub/FrontEndGitHub/issues/35)

[Vue3æºç è§£æ (diy4869.github.io)](https://diy4869.github.io/vue-next-analysis/page/flow.html)

[Vue3 çš„å“åº”å¼å’Œä»¥å‰æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŒProxy æ— æ•Œï¼Ÿï¼ˆæºç çº§è¯¦è§£ï¼‰ (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247483711&idx=1&sn=e4c59cd3a742ba8384c05b6d1fb520b7&chksm=eb043946dc73b0501fc5d848f3cd330e1d9386afa27578d349cd918212f7e36de9bf7767f97a&token=431470234&lang=zh_CN#rd)

[ä»é›¶å¸¦ä½ æ‰‹æŠŠæ‰‹å®ç°Vue3å“åº”å¼åŸç†-ä¸Šï¼ˆéç©å…·ï¼‰ (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247483736&idx=1&sn=7ffba2b40fa0ddacd1ad0a34c4afad7d&chksm=eb043921dc73b037b637f83a9344f9ffb40f0c514cce6cb2de609093d20860c436cd4d307db8&token=431470234&lang=zh_CN#rd)

[ä»é›¶å¸¦ä½ æ‰‹æŠŠæ‰‹å®ç°Vue3å“åº”å¼åŸç†-ä¸‹ï¼ˆMapå’ŒSetçš„å¤„ç†ï¼‰ (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247483747&idx=1&sn=735d86b80e363112c9b5244e66697e3f&chksm=eb04391adc73b00c6e0a9b7187119b2c3ffe78d18ca281a789179717313bab6a7b83e49b8df3&token=431470234&lang=zh_CN#rd)

[æ·±åº¦è§£æï¼šVue3å¦‚ä½•å·§å¦™çš„å®ç°å¼ºå¤§çš„computed - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844904053638447117)

[æˆ‘ä» 17w star çš„ Vuejs ä¸­å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247489895&idx=1&sn=97e78fa4108bad3251479f507123ff9d&chksm=eb04211edc73a80844e8c5deafb2004fbadef1f6c3dfccf52cfccdd27ddff7982cce3b7a9db1&token=431470234&lang=zh_CN#rd)

[ç²¾è¯»ã€ŠVue3 DOM diff æœ€é•¿ä¸Šå‡å­åºåˆ—ã€‹ (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247496892&idx=2&sn=9be67aca74fe684442a344f5da352101&chksm=eb07ccc5dc7045d38bf49a5f3e4585dd6216cd466299561fcea1557fb22df60c35e2d7053b13&token=431470234&lang=zh_CN#rd)

[ä» Vue3 æºç ä¸­é‚£äº›å®ç”¨çš„åŸºç¡€å·¥å…·å‡½æ•°ä¸­ï¼Œæˆ‘å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247500294&idx=2&sn=dcc6ee708f6bd78ae90a714701b06ee8&chksm=eb07fa7fdc707369eb540d5fd9c289db22dddbfc97540f976246c8244a8fdd1fd66e81e96440&token=431470234&lang=zh_CN#rd)

[è®© Vue.js 3.2 åˆ›å»ºèŠ‚ç‚¹æå‡ 200% é€Ÿåº¦çš„ç§˜å¯† (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247500914&idx=2&sn=93316e4e43c204c55b109b9286671c72&chksm=eb07fc0bdc70751d0226e689ac4a6827d9984936f8cdc316a8e60cb34e957e51a2b40a50bc60&token=431470234&lang=zh_CN#rd)

[è€å¤–æŒ¥æ‰‹ç™¾è¡Œä»£ç ï¼ŒVue.js 3.2 å“åº”å¼æ€§èƒ½æš´å¢ (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247500773&idx=2&sn=5a73cf931cbf0f2abd5a59e5dcebb5ae&chksm=eb07fb9cdc70728a26d00690f3ebc7a963316e07892ed88f90ee896d24f4e6efee381c279d72&token=431470234&lang=zh_CN#rd)

[mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247497462&idx=2&sn=807dae4d0f4716db0fb5784be416efeb&chksm=eb07ce8fdc7047993109478c692d3ede64de269b131e75c9338c3acf389a8883cc67bdfc7ddf&token=431470234&lang=zh_CN#rd](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247497462&idx=2&sn=807dae4d0f4716db0fb5784be416efeb&chksm=eb07ce8fdc7047993109478c692d3ede64de269b131e75c9338c3acf389a8883cc67bdfc7ddf&token=431470234&lang=zh_CN#rd)

[å­—èŠ‚ä¸€é¢ï¼Œé¢è¯•å®˜é—®æˆ‘Vue3æºç ï¼Œæˆ‘è¯´â€¦â€¦ - æ˜é‡‘ (é˜¿å´”cxr)](https://juejin.cn/post/7070809037398343717)



[ç§‹æ‹›è§£å†³æ–¹æ¡ˆï¼šæ·±å…¥ Vue3 æºç ï¼Œå¸¦ä½ å½»åº•æ‰“é€š Vue3 æºç é¢è¯• - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7277511894666559488)



[é¢è¯•å®˜ï¼šVue3å“åº”å¼ç³»ç»Ÿéƒ½ä¸ä¼šå†™ï¼Œè¿˜æ•¢è¯´ç²¾é€šï¼Ÿ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7090328834318270494)



[é¢è¯•å®˜ï¼šè¯´ä¸€è¯´ vue3 çš„å¿«é€Ÿ diff ç®—æ³•ï¼ˆä¸€ï¼‰ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7265995969689665595)

[é¢è¯•å®˜ï¼šè¯´ä¸€è¯´ vue3 çš„å¿«é€Ÿ diff ç®—æ³•ï¼ˆäºŒï¼‰ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7266368395787747382)

[Vue3 ç¼–è¯‘åŸç†ç›´é€šè½¦ğŸ’¥â€”â€”parser ç¯‡ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7277490240171491340)

[Vue3 ç¼–è¯‘åŸç†ç›´é€šè½¦ğŸ’¥â€”â€”transform ç¯‡ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7280436247745642515)

[Vue3 ç¼–è¯‘åŸç†ç›´é€šè½¦ğŸ’¥â€”â€” generate ç¯‡ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7282666872217255947)

[vue3 æé€Ÿå°å·§æ€ğŸš€ï¼Œå€¼å¾—ä¸€æçš„ç¼–è¯‘ä¼˜åŒ–ï¼ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7300174977167949858)

[Vue3 å“åº”å¼åªçŸ¥é“ Proxyï¼Ÿå¿«æ¥å­¦ç‚¹æ–°æŠ€å·§ï¼ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7314135212355141643)

## ç»„ä»¶åº“æºç è§£æ

[æ·±å…¥è§£æ Vue 3 ç»„ä»¶åº“ element-plus æ¶æ„æºç  (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI3NTM5NDgzOA==&mid=2247489991&idx=1&sn=6dd5a9891b2fce9a7f15402c9e07d86a&chksm=eb0421bedc73a8a848b9c9e8101f1e7fc1bf39a3a12a26586bdaea46360dc8183ef515b4d3d8&token=431470234&lang=zh_CN#rd)

[è¯¦è§£ä¸‰ç§ Diff ç®—æ³•ï¼ˆæºç +å›¾ï¼‰ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7125695841897021454)

## Vue3 è®¾è®¡æ€æƒ³

Vue3.0 æ›´æ³¨é‡æ¨¡å—ä¸Šçš„æ‹†åˆ†ï¼Œåœ¨ 2.0 ä¸­æ— æ³•å•ç‹¬ä½¿ç”¨éƒ¨åˆ†æ¨¡å—ã€‚éœ€è¦å¼•å…¥å®Œæ•´çš„ Vuejs(ä¾‹å¦‚åªæƒ³ä½¿ç”¨ä½¿ç”¨å“åº”å¼éƒ¨åˆ†ï¼Œä½†æ˜¯éœ€è¦å¼•å…¥å®Œæ•´çš„ Vuejs)ï¼Œ Vue3 ä¸­çš„æ¨¡å—ä¹‹é—´è€¦åˆåº¦ä½ï¼Œæ¨¡å—å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ã€‚**æ‹†åˆ†æ¨¡å—**

- `Vue3`å°†å¾ˆå¤šåŠŸèƒ½éƒ½è®¾è®¡æˆäº†å•ç‹¬çš„æ¨¡å—ï¼Œæ¯”å¦‚å¯ä»¥ç›´æ¥`import { ref, reactive } from 'vue'`ä½¿ç”¨å“åº”å¼çš„æ–¹æ³•ï¼Œæ¨¡å—é—´è€¦åˆåº¦ä½ï¼Œå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ï¼›è€Œ`Vue2`æ²¡åŠæ³•å•ç‹¬ä½¿ç”¨éƒ¨åˆ†æ¨¡å—ï¼Œå°±ç®—åªç”¨åˆ°äº†å“åº”å¼çš„éƒ¨åˆ†ï¼Œä¹Ÿåªèƒ½å¼•å…¥å®Œæ•´çš„`Vuejs`ã€‚

Vue2 ä¸­å¾ˆå¤šæ–¹æ³•æŒ‚è½½åˆ°äº†å®ä¾‹ä¸­å¯¼è‡´æ²¡æœ‰ä½¿ç”¨ä¹Ÿä¼šè¢«æ‰“åŒ…(è¿˜æœ‰å¾ˆå¤šç»„ä»¶ä¹Ÿæ˜¯ä¸€æ ·)ã€‚é€šè¿‡æ„å»ºå·¥å…· Tree-shaking æœºåˆ¶å®ç°æŒ‰éœ€å¼•å…¥ï¼Œå‡å°‘ç”¨æˆ·æ‰“åŒ…åä½“ç§¯ã€‚**é‡å†™ API**

- `Vue2`å¾ˆå¤šçš„æ–¹æ³•ï¼Œéƒ½æ˜¯ç›´æ¥æŒ‚è½½åˆ°`vm`ä¹Ÿå°±æ˜¯å®ä¾‹ä¸Šäº†ï¼Œå¯¼è‡´æ²¡ä½¿ç”¨çš„è¿™äº›æ–¹æ³•ï¼Œä¹Ÿä¼šè¢«æ‰“åŒ…è¿›æœ€ç»ˆçš„æ‰“åŒ…æ–‡ä»¶ä¸­ï¼›`Vue3`ä¸­çš„åŠŸèƒ½ï¼Œå› ä¸ºè¿›è¡Œäº†æ¨¡å—æ‹†åˆ†ï¼Œéƒ½æ˜¯å‡½æ•°å¼`API`ï¼Œæ‰€ä»¥æ‰“åŒ…çš„æ—¶å€™åˆ©ç”¨`Tree-shaking`æœºåˆ¶ï¼Œåšåˆ°äº†æŒ‰éœ€å¼•å…¥ï¼Œæœ‰æ•ˆçš„å‡å°‘æ‰“åŒ…çš„ä½“ç§¯ã€‚

Vue3 å…è®¸è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Œæ‰©å±•èƒ½åŠ›å¼ºã€‚ä¸ä¼šå‘ç”Ÿä»¥å‰çš„äº‹æƒ…ï¼Œæ”¹å†™ Vue æºç æ”¹é€ æ¸²æŸ“æ–¹å¼ã€‚**æ‰©å±•æ›´æ–¹ä¾¿**

- `Vue3`å¯ä»¥è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Œå¢å¼ºäº†æ‰©å±•èƒ½åŠ›ï¼Œæš´éœ²äº†å¾ˆå¤šçš„æ–¹æ³•ï¼Œå¯ä»¥è¿›è¡Œè‡ªå®šä¹‰é€»è¾‘ï¼›è€Œåœ¨ä¸€äº›è·¨å¹³å°çš„æ¡†æ¶ä¸­æ¯”å¦‚å°ç¨‹åºï¼Œå¦‚æœæƒ³ä½¿ç”¨`Vue2`ä½œä¸ºæŠ€æœ¯æ ˆï¼Œåˆ™éœ€è¦åœ¨`Vue2`çš„æºç åŸºç¡€ä¸Šï¼Œæ”¹åŠ¨æºç çš„é€»è¾‘ï¼Œæ‰èƒ½è¿›è¡Œæ‰“åŒ…ï¼Œè¿™ç›¸å½“äºç ´åäº†æºç ï¼Œéšç€æ›´æ–°ä¹Ÿä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚

ä¾ç„¶ä¿ç•™ Vue2 çš„ç‰¹è‰²

### Vue3 æ€§èƒ½æå‡

- æ‰“åŒ…å¤§å°å‡å°‘ 41%
- åˆæ¬¡æ¸²æŸ“å¿« 55%, æ›´æ–°æ¸²æŸ“å¿« 133%
- å†…å­˜å‡å°‘ 54%
- **ä½¿ç”¨ Proxy ä»£æ›¿ defineProperty å®ç°æ•°æ®å“åº”å¼**
- **é‡å†™è™šæ‹Ÿ DOM çš„å®ç°å’Œ Tree-Shaking**

### Vue2 å’Œ Vue3 å“åº”å¼åŸç†æœ‰å•¥ä¸åŒï¼Ÿ

ç­”ï¼šVue2 ç”¨çš„æ˜¯ Object.definePropertyï¼ŒVue3 ç”¨çš„æ˜¯ Proxyã€‚

#### vue2 çš„å“åº”å¼

- æ ¸å¿ƒ:
  - å¯¹è±¡: é€šè¿‡ defineProperty å¯¹å¯¹è±¡çš„å·²æœ‰å±æ€§å€¼çš„è¯»å–å’Œä¿®æ”¹è¿›è¡ŒåŠ«æŒ(ç›‘è§†/æ‹¦æˆª)
  - æ•°ç»„: é€šè¿‡é‡å†™æ•°ç»„æ›´æ–°æ•°ç»„ä¸€ç³»åˆ—æ›´æ–°å…ƒç´ çš„æ–¹æ³•æ¥å®ç°å…ƒç´ ä¿®æ”¹çš„åŠ«æŒ

```js
Object.defineProperty(data, "count", {
	get() {},
	set() {},
});
```

- é—®é¢˜
  - å¯¹è±¡ç›´æ¥æ–°æ·»åŠ çš„å±æ€§æˆ–åˆ é™¤å·²æœ‰å±æ€§, ç•Œé¢ä¸ä¼šè‡ªåŠ¨æ›´æ–°
  - ç›´æ¥é€šè¿‡ä¸‹æ ‡æ›¿æ¢å…ƒç´ æˆ–æ›´æ–° length, ç•Œé¢ä¸ä¼šè‡ªåŠ¨æ›´æ–° arr[1] = {}

#### Vue3 çš„å“åº”å¼

##### æ ¸å¿ƒ:

- é€šè¿‡ Proxy(ä»£ç†): æ‹¦æˆªå¯¹ data ä»»æ„å±æ€§çš„ä»»æ„(13 ç§)æ“ä½œ, åŒ…æ‹¬å±æ€§å€¼çš„è¯»å†™, å±æ€§çš„æ·»åŠ , å±æ€§çš„åˆ é™¤ç­‰...
- é€šè¿‡ Reflect(åå°„): åŠ¨æ€å¯¹è¢«ä»£ç†å¯¹è±¡çš„ç›¸åº”å±æ€§è¿›è¡Œç‰¹å®šçš„æ“ä½œ
- æ–‡æ¡£:
  - Proxy æ–‡æ¡£ï¼š<https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy>
  - Reflect æ–‡æ¡£ï¼š<https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect>

```js
new Proxy(data, {
	// æ‹¦æˆªè¯»å–å±æ€§å€¼
	get(target, prop) {
		return Reflect.get(target, prop);
	},
	// æ‹¦æˆªè®¾ç½®å±æ€§å€¼æˆ–æ·»åŠ æ–°å±æ€§
	set(target, prop, value) {
		return Reflect.set(target, prop, value);
	},
	// æ‹¦æˆªåˆ é™¤å±æ€§
	deleteProperty(target, prop) {
		return Reflect.deleteProperty(target, prop);
	},
});

proxy.name = "tom";
```

```html
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Proxy ä¸ Reflect</title>
	</head>
	<body>
		<script>
			const user = {
				name: "John",
				age: 12,
			};

			/* 
    proxyUseræ˜¯ä»£ç†å¯¹è±¡, useræ˜¯è¢«ä»£ç†å¯¹è±¡
    åé¢æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡æ¥æ“ä½œè¢«ä»£ç†å¯¹è±¡å†…éƒ¨å±æ€§
    */
			const proxyUser = new Proxy(user, {
				get(target, prop) {
					console.log("åŠ«æŒget()", prop);
					return Reflect.get(target, prop);
				},

				set(target, prop, val) {
					console.log("åŠ«æŒset()", prop, val);
					return Reflect.set(target, prop, val); // (2)
				},

				deleteProperty(target, prop) {
					console.log("åŠ«æŒdeleteå±æ€§", prop);
					return Reflect.deleteProperty(target, prop);
				},
			});
			// è¯»å–å±æ€§å€¼
			console.log(proxyUser === user);
			console.log(proxyUser.name, proxyUser.age);
			// è®¾ç½®å±æ€§å€¼
			proxyUser.name = "bob";
			proxyUser.age = 13;
			console.log(user);
			// æ·»åŠ å±æ€§
			proxyUser.sex = "ç”·";
			console.log(user);
			// åˆ é™¤å±æ€§
			delete proxyUser.sex;
			console.log(user);
		</script>
	</body>
</html>
```

## æ­å»º Vue3 æºç çš„å¼€å‘ç¯å¢ƒ

### è§£æ vue3 æºç æµç¨‹

- 1.çŸ¥é“`Vue3`çš„åŠŸèƒ½åŸç†
- 2.æ‰‹å†™å®ç°ä¸€ä¸ªç®€ç‰ˆçš„`Vue3`
- 3.æœ€åæˆ‘ä»¬å†å»è°ƒè¯• vue3 æºç çš„è¿è¡Œ

### å…ˆæ­å»ºä¸€ä¸ªå¼€å‘ç¯å¢ƒ

æˆ‘ä»¬è¦ä½¿ç”¨`Monorepo`çš„æ–¹å¼æ¥æ­å»ºæ•´ä¸ªé¡¹ç›®ï¼Œé‚£ä»€ä¹ˆæ˜¯`Monorepo`å‘¢ï¼Ÿ

`Monorepo`æ˜¯ç›®å‰å¾ˆå¤šå¤§å‹å¼€æºé¡¹ç›®ï¼Œç®¡ç†ä»£ç çš„ä¸€ä¸ªæ–¹å¼ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ª`git`é¡¹ç›®ä»“åº“ä¸­ç®¡ç†å¤šä¸ªæ¨¡å—æˆ–è€…å·¥å…·åŒ…ã€‚

`Vue3`çš„æºç å°±æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œå°†æ¨¡å—æ‹†åˆ†åˆ°`package`ç›®å½•ä¸­ï¼Œé‚£ä¹ˆå¥½å¤„å°±æ˜¯ï¼š

- ä¸€ä¸ªä»“åº“å¯ç»´æŠ¤å¤šä¸ªæ¨¡å—æˆ–å·¥å…·åŒ…ï¼Œä¸ç”¨åˆ°å¤„æ‰¾å„è‡ªçš„ä»“åº“ã€‚
- æ–¹ä¾¿æ¯ä¸ªæ¨¡å—çš„ç‰ˆæœ¬ç®¡ç†å’Œä¾èµ–ç®¡ç†ï¼Œæ¨¡å—ä¹‹é—´çš„å¼•ç”¨å’Œè°ƒç”¨å˜çš„ååˆ†æ–¹ä¾¿ã€‚

## Vue3 æºç ç›®å½•

Vue3 å¼€æºåœ°å€ï¼š<https://www.github.com/vuejs/core>

ä¸Šæ–‡è¯´åˆ°`Vue3`é‡‡ç”¨çš„æ˜¯`Monorepo`è¿™ç§æ–¹å¼ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦å¤§è‡´å†™ä¸€ä¸‹`Vue3`ä¸­åŒ…å«çš„å„ç§åŒ…ï¼Œå°±èƒ½å®ç°ä¸€ä¸ªç®€å•ç‰ˆæœ¬çš„`Vue3`äº†ã€‚

Vue3 æºç ç›®å½•ï¼š

```bash
changelogs/ # åŒ…å«äº†é¡¹ç›®çš„å˜æ›´æ—¥å¿—ï¼Œè®°å½•äº†æ¯ä¸ªç‰ˆæœ¬çš„æ›´æ–°å†…å®¹å’Œä¿®å¤çš„é—®é¢˜ã€‚
script/ # å­˜æ”¾æ„å»ºè„šæœ¬å’Œå…¶ä»–ä¸å¼€å‘æµç¨‹ç›¸å…³çš„è„šæœ¬ï¼Œå¦‚lintingã€æµ‹è¯•å’Œå‘å¸ƒè„šæœ¬ã€‚

packages/ # å­˜æ”¾äº†Vue3æ ¸å¿ƒçš„å„ç§åŒ…å’Œæ¨¡å—ï¼Œä¾‹å¦‚ç¼–è¯‘å™¨ã€å“åº”æ€§ç³»ç»Ÿã€è¿è¡Œæ—¶å’ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ç­‰ã€‚
â”œâ”€â”€ compiler-core # ç¼–è¯‘æ—¶æ ¸å¿ƒåŒ…ï¼Œæä¾›ä¸å¹³å°æ— å…³çš„ç¼–è¯‘åŠŸèƒ½
â”œâ”€â”€ compiler-dom # ç¼–è¯‘æ—¶é’ˆå¯¹æµè§ˆå™¨DOMçš„å®ç°
â”œâ”€â”€ compiler-sfc # ç¼–è¯‘æ—¶SFCï¼ˆå•æ–‡ä»¶ç»„ä»¶ï¼‰çš„å®ç°
â”œâ”€â”€ compiler-ssr # ç¼–è¯‘æ—¶æœåŠ¡ç«¯æ¸²æŸ“çš„å®ç°
â”œâ”€â”€ dts-built-test #
â”œâ”€â”€ dts-test # ä¸TypeScriptå£°æ˜æ–‡ä»¶çš„ç”Ÿæˆå’Œæµ‹è¯•æœ‰å…³ã€‚
â”œâ”€â”€ reactivity # åŒ…å«Composition APIã€å“åº”å¼ç³»ç»Ÿç­‰çš„å®ç°
â”œâ”€â”€ runtime-core # æä¾›ä¸å¹³å°æ— å…³çš„è¿è¡Œæ—¶æ ¸å¿ƒä»£ç 
â”œâ”€â”€ runtime-dom # é’ˆå¯¹æµè§ˆå™¨DOMçš„è¿è¡Œæ—¶å®ç°
â”œâ”€â”€ runtime-test # è¿è¡Œæ—¶æµ‹è¯•å·¥å…·
â”œâ”€â”€ server-renderer # æœåŠ¡ç«¯æ¸²æŸ“å™¨
â”œâ”€â”€ sfc-playground # å•æ–‡ä»¶ç»„ä»¶ï¼ˆSingle File Componentsï¼‰çš„å®éªŒåœºï¼Œç”¨äºVueç»„ä»¶çš„å¼€å‘å’Œæµ‹è¯•ã€‚
â”œâ”€â”€ shared # Vueå†…éƒ¨ä½¿ç”¨çš„å…±äº«å·¥å…·ä»£ç 
â”œâ”€â”€ template-explorer # æ¨¡æ¿æ¢ç´¢å™¨ï¼Œç”¨äºå­¦ä¹ å’Œå®éªŒVueçš„æ¨¡æ¿è¯­æ³•ã€‚
â”œâ”€â”€ vue # Vue.jsæ¡†æ¶çš„æ ¸å¿ƒä»£ç ã€‚
â””â”€â”€ vue-compat # æ˜¯ä¸€ä¸ªå…¼å®¹æ€§æ„å»ºï¼Œæä¾›å¯é…ç½®çš„Vue 2å…¼å®¹è¡Œä¸ºï¼Œç”¨äºå¸®åŠ©ä»Vue 2è¿ç§»åˆ°Vue 3ã€‚

    # æ¯ä¸ªå­åŒ…ä¸‹ä¸€å±‚çš„æ–‡ä»¶é€šå¸¸åŒ…æ‹¬srcæ–‡ä»¶å¤¹ã€__tests__æ–‡ä»¶å¤¹ï¼ˆåŒ…å«æµ‹è¯•ä»£ç ï¼‰ã€ä»¥åŠpackage.jsonæ–‡ä»¶ï¼ˆå®šä¹‰åŒ…çš„ä¾èµ–å’Œé…ç½®ï¼‰ã€‚ä¾‹å¦‚ï¼Œcompiler-coreæ–‡ä»¶å¤¹ä¸‹å¯èƒ½ä¼šåŒ…å«ï¼š
    compiler-core
    â”œâ”€â”€ src # æºä»£ç 
    â”œâ”€â”€ __tests__ # æµ‹è¯•ä»£ç 
    â””â”€â”€ package.json # åŒ…é…ç½®æ–‡ä»¶
```

## å‚è€ƒ vue3 çš„æºç ç›®å½•ï¼Œæ­å»ºæ‰‹å†™ Vue3 é¡¹ç›®

æˆ‘ä»¬ä½¿ç”¨`pnpm`è¿™ä¸ªå·¥å…·ï¼Œæ¥æ­å»º`Monorepo`ç¯å¢ƒã€‚

`mkdir vue3-source-code`æ¥åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œä½¿ç”¨`pnpm init -y`å‘½ä»¤ï¼Œåˆå§‹åŒ–`package.json`æ–‡ä»¶ã€‚ä¹‹åæˆ‘ä»¬åˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„ç›®å½•ç»“æ„ï¼š

```bash
vue3-source-code
|â€”â€” packages æ–‡ä»¶å¤¹ // å­˜æ”¾ Vue3 ç›¸å…³çš„æ‰€æœ‰åŒ…
|â€”â€” reactivity æ–‡ä»¶å¤¹ // å“åº”å¼åŸç†çš„åŒ…
|â€”â€” src
|â€”â€” index.ts // å…¥å£æ–‡ä»¶ä»£ç 
|â€”â€” shared æ–‡ä»¶å¤¹ // å­˜æ”¾ä¸€äº›å…¬å…±æ–¹æ³•çš„åŒ…
|â€”â€” src
|â€”â€” index.ts // å…¥å£æ–‡ä»¶ä»£ç 
|â€”â€” scripts æ–‡ä»¶å¤¹ // å­˜æ”¾æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€äº›è„šæœ¬
|â€”â€” .npmrc // npm é…ç½®æ–‡ä»¶
|â€”â€” package.json
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¼€å§‹å®Œå–„é…ç½®é¡¹å’Œä¸€äº›è°ƒè¯•ä»£ç ï¼Œè®©é¡¹ç›®èƒ½å¤Ÿè·‘çš„é€šï¼š åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œä½¿ç”¨`tsc --init`å‘½ä»¤ï¼Œæ¥åˆå§‹åŒ–`tsconfig.json`æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…è¿‡`tsc`ï¼Œéœ€è¦å…ˆå…¨å±€æ‰§è¡Œ`npm install typescript -g`å‘½ä»¤ã€‚

æˆ‘ä»¬ç›´æ¥æŠŠä»¥ä¸‹é…ç½®å¡«å†™åœ¨`tsconfig.json`æ–‡ä»¶ä¸­ã€‚

```javascript
// ts.config.jsonæ–‡ä»¶
{
  "compilerOptions": {
    "outDir": "dist", // è¾“å‡ºçš„ç›®å½•
    "sourceMap": true, // å¯ç”¨sourcemap
    "target": "es2016", // ç›®æ ‡è¯­æ³•
    "module": "esnext", // æ¨¡å—æ ¼å¼ä¸ºesm
    "moduleResolution": "node", // æ¨¡å—è§£ææ–¹å¼
    "strict": false, // ä¸¥æ ¼æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨any
    "resolveJsonModule": true, // è§£æjsonæ¨¡å—
    "esModuleInterop": true, // å…è®¸é€šè¿‡es6è¯­æ³•å¼•å…¥commonjsæ¨¡å—
    "jsx": "preserve", // jsx ä¸è½¬ä¹‰
    "lib": ["esnext", "dom"], // æ”¯æŒçš„ç±»åº“ esnextåŠdom
    "baseUrl": "./",
    "paths": {
      "@vue/*": ["packages/*/src"]
    }
  }
}
```

å¿ƒç»†çš„æœ‹å‹å¯èƒ½å‘ç°ï¼Œæœ€åä¸¤ä¸ªé…ç½®é¡¹æ²¡æœ‰æ³¨é‡Šï¼Œæˆ‘ä»¬ä¸€ä¼šå†æ¥è§£é‡Šè¿™ä¸¤ä¸ªé…ç½®é¡¹çš„ä½œç”¨ã€‚

```javascript
// .npmrcæ–‡ä»¶
shamefully-hoist = true
```

è¿™ä¸ªé…ç½®é¡¹éå¸¸æœ‰æ„æ€ï¼Œæˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹è¿™ä¸ªé…ç½®é¡¹æ˜¯å•¥æ„æ€ï¼Ÿ

`npm`åœ¨å®‰è£…ä¾èµ–æ—¶å€™çš„ç‰¹å¾ï¼š**ä¼šå°†ä¾æ‹å¹³åœ¨ node_modules æ–‡ä»¶å¤¹ä¸­**ï¼Œè€Œ`pnpm`åœ¨å®‰è£…ä¾èµ–ä¹‹åï¼Œåˆ™ä¸ä¼šå°†ä¾èµ–æ‹å¹³åœ¨`node_modules`æ–‡ä»¶å¤¹ä¸­ã€‚

ä¸¾ä¸ªæ —å­ ğŸŒ°ï¼Œåœ¨ä¸€ä¸ªç©ºç™½é¡¹ç›®ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†`npm install webpack`å‘½ä»¤ï¼Œé‚£ä¹ˆå½“ä½ æ‰“å¼€`node_modules`æ–‡ä»¶å¤¹çš„æ—¶å€™ï¼Œä¼šå‘ç°å®‰è£…äº†ä¸€å¤§å †ä¾èµ–ï¼Œæ­¤æ—¶æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨`require('express')`ï¼Œå‘ç°ä¾æ—§ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºåœ¨å®‰è£…`webpack`çš„æ—¶å€™ï¼Œä¹Ÿç”¨åˆ°äº†`express`è¿™ä¸ªä¾èµ–ï¼Œè€Œä¸”éƒ½æ‹å¹³åœ¨`node_modules`æ–‡ä»¶å¤¹ä¸‹äº†ï¼Œæ‰€ä»¥åœ¨é¡¹ç›®ä¸­`require('express')`æ˜¯èƒ½å¤Ÿæ‰¾åˆ°ï¼Œè€Œä¸”ä¸ä¼šæŠ¥é”™çš„ï¼›

ä½†æœæˆ‘ä»¬ä½¿ç”¨`pnpm install webpack`çš„è¯ï¼Œæ­¤æ—¶å†æ‰“å¼€`node_modules`æ–‡ä»¶ï¼Œä¼šå‘ç°å°‘äº†å¾ˆå¤šä¸œè¥¿ï¼Œè§‚å¯Ÿç›®å½•ç»“æ„ä¼šå‘ç°ï¼Œå…¶å®ä¾èµ–éƒ½è¢«æ”¾åœ¨äº†`.pnpm`è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼Œæ­¤æ—¶å¦‚æœæˆ‘ä»¬ç›´æ¥`require('express')`ï¼Œåˆ™å°±ä¼šæŠ¥é”™ï¼Œå› ä¸º`node_modules`ç›®å½•ä¸‹ï¼Œæ ¹æœ¬ä¸å­˜åœ¨`express`æ¨¡å—ã€‚é‚£ä¹ˆï¼Œåœ¨`.npmrc`æ–‡ä»¶ä¸­åŠ å…¥äº†`shamefully-hoist = true`è¿™ä¸ªé…ç½®é¡¹ï¼Œå°±èƒ½å¤Ÿå°†`.pnpm`ä¸­çš„ä¾èµ–ï¼Œæ‹å¹³åœ¨`node_modules`æ–‡ä»¶å¤¹ä¸­ï¼Œè¾¾åˆ°çš„æ•ˆæœå°±å’Œ`npm`å¾ˆç±»ä¼¼äº†ã€‚

æ¥ä¸‹æ¥`cd`è¿›å…¥`shared`ç›®å½•ï¼Œä½¿ç”¨`pnpm init -y`å‘½ä»¤åˆå§‹åŒ–ï¼Œå¹¶å°†`package.json`æ–‡ä»¶ä¸­é…ç½®é¡¹æ”¹ä¸º`"name": "@vue/shared" ......`ã€‚

```javascript
// shared/src/index.ts æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªåˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„çš„æ–¹æ³•ï¼Œå¹¶å°†å…¶å¯¼å‡º
export const isArray = (value) => {
	return Array.isArray(value);
};
```

åŒæ ·çš„æ–¹æ³•ï¼Œ`cd`è¿›å…¥`reactivity`ç›®å½•ä¸‹ï¼Œä½¿ç”¨`pnpm init -y`å‘½ä»¤åˆå§‹åŒ–ï¼Œå¹¶å°†`package.json`æ–‡ä»¶ä¸­é…ç½®é¡¹æ”¹ä¸º`"name": "@vue/reactivity" ......`ã€‚

æ¥ä¸‹æ¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨`reactivity/src/index.ts`æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨`shared`åŒ…ä¸­æš´éœ²å‡ºæ¥çš„é‚£ä¸ª`isArray`æ–¹æ³•ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•å¼•å…¥å‘¢ï¼Ÿ

é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯æˆ‘ç›´æ¥`import { isArray } from '../../shared/src/index.ts'`ä¸å°±å®Œäº†ä¹ˆï¼Œç›¸å¯¹è·¯å¾„ä¸€æŠŠæ¢­ï¼Œä¹çœ‹ä¸€çœ¼æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯ç¨å¾®ä¸€æƒ³ï¼Œåƒ`sharedï¼Œreactivity`è¿™ç§åŒ…ï¼Œæœ€åå‘å¸ƒå¯æ˜¯è¦æ‰“åŒ…å®Œåï¼Œå•ç‹¬å‘å¸ƒåˆ°`npm`ä¸Šè¾¹çš„ï¼Œè¿™æ—¶å€™ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé‚£è‚¯å®šå°±ä¸å¤ªåˆé€‚äº†å§ã€‚æœ‰æœ‹å‹åˆä¼šè¯´äº†ï¼Œé‚£ç›´æ¥ç”¨`import { isArray } from '@vue/shared'`æ¥å¯¼å…¥ä¸å°±å¥½äº†ä¹ˆï¼Ÿ

æ²¡é”™ï¼Œä½†æ˜¯å¦‚æœä¸è¿›è¡Œä»»ä½•é…ç½®ï¼Œè¿™ç§å†™æ³•æ˜¯å»å“ªé‡Œæ‰¾`@vue/shared`çš„è¿™ä¸ªåŒ…å‘¢ï¼Ÿ`node_modules`ç›®å½•ä¸­ï¼Œé‚£`node_modules`ç›®å½•ä¸­æ²¡æœ‰è¿™ä¸ª`shared`åŒ…å•Šï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿèªæ˜çš„æœ‹å‹å·²ç»è¿˜è®°å¾—ï¼Œä¸Šæ–‡æˆ‘ä»¬åœ¨é…ç½®`tsconfig.json`æ–‡ä»¶çš„æ—¶å€™ï¼ŒåŸ‹ä¸‹äº†ä¸€ä¸ªä¼ç¬”ã€‚æ²¡é”™ï¼Œå°±æ˜¯æœ€åä¸¤ä¸ªé…ç½®é¡¹ã€‚

```json
"baseUrl": "./",
"paths": {
  "@vue/*": ["packages/*/src"]
 }
```

é¦–å…ˆï¼Œ`baseUrl`å¯ä»¥å°†æ ¹è·¯å¾„å®šä½åœ¨å½“é¡¹ç›®çš„æ ¹ç›®å½•ã€‚

å…¶æ¬¡`paths`å¯ä»¥è‡ªå®šä¹‰å¯»æ‰¾åŒ…çš„è·¯å¾„ï¼Œæ¯”å¦‚ä¸Šè¾¹é…ç½®çš„æ„æ€å°±æ˜¯ï¼Œåªè¦`import`äº†ä»¥`@vue/*`å¼€å¤´çš„åŒ…ï¼Œé‚£ä¹ˆå°±ä¼šå»`packagesæ–‡ä»¶å¤¹ä¸‹çš„*/src`ç›®å½•ä¸‹å¯»æ‰¾ã€‚æ‰€ä»¥åŠ ä¸Šäº†è¿™ä¸ªé…ç½®é¡¹ï¼Œæˆ‘ä»¬åœ¨`reactiviey/src/index.ts`æ–‡ä»¶ä¸­ï¼Œå°±å¯ä»¥æ­£å¸¸çš„å¯¼å…¥`shared`æ¨¡å—äº†ã€‚

```javascript
// reactiviey/src/index.ts
import { isArray } from "@vue/shared";

console.log(isArray([1, 2, 3]));

export { isArray };
```

`pnpm-workspace.yaml`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å…ˆå¡«å†™å¦‚ä¸‹å†…å®¹ï¼Œä»£è¡¨`packages`æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰çš„ç›®å½•ï¼Œéƒ½å½“åšåŒ…æ¥ç®¡ç†ã€‚

```bash
packages:
- 'packages/*'
```

è‡³æ­¤ï¼Œä¸€ä¸ªç®€å•çš„`Monorepo`ç¯å¢ƒå°±å·²ç»æ­å»ºå¥½äº†ã€‚

## ç¼–å†™è„šæœ¬è¿›è¡Œå¼€å‘ç¯å¢ƒæ‰“åŒ…

å¯¹äºå¼€å‘ç¯å¢ƒï¼Œæˆ‘ä»¬ä½¿ç”¨`esbuild`åŒ…è¿›è¡Œæ‰“åŒ…ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘ä»¬ä½¿ç”¨`rollup`è¿›è¡Œæ‰“åŒ…ã€‚

é¦–å…ˆåœ¨é¡¹ç›®æ ¹ç›®å½•å…ˆå®‰è£…åŒ…`pnpm intall esbuild -D -w`ï¼Œä¹‹æ‰€ä»¥åŠ ä¸Š`-w`æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©ä¾èµ–æˆåŠŸå®‰è£…åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œä¸ç„¶å°±ä¼šæŠ¥é”™ã€‚

æˆ‘ä»¬å…ˆæŠŠå…¥å£å†™æˆå›ºå®šä¸º`reactivity/src/index.ts`ã€‚å…·ä½“çš„é…ç½®ï¼Œå¯ä»¥æŸ¥çœ‹`esbuild`çš„å®˜æ–¹æ–‡æ¡£ï¼Œä¸‹è¾¹å°±ç›´æ¥å†™ä¸Šéœ€è¦çš„é…ç½®é¡¹ï¼Œå¹¶ç®€å•åšä¸‹æ³¨é‡Šè§£é‡Šã€‚

```javascript
// scripts/dev.js æ–‡ä»¶
const { context } = require("esbuild");
const path = require("path");

const target = "reactivity";

context({
	// æ‰“åŒ…å…¥å£
	entryPoints: [path.resolve(__dirname, `../packages/${target}/src/index.ts`)],
	outfile: path.resolve(__dirname, `../packages/${target}/dist/${target}.js`),
	bundle: true, // æŠŠé‡Œæ–‡ä»¶ä¸­çš„ä¾èµ–ä¹ŸåŒæ—¶æ‰“åŒ…è¿›æ¥
	sourcemap: true, // ç”Ÿæˆsourcemapï¼Œå¯ä»¥è°ƒè¯•
	format: "esm", // æ‰“åŒ…å‡ºæ¥çš„æ˜¯esmæ¨¡å—
	platform: "browser",
}).then((ctx) => {
	// ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œåªè¦å‘ç”Ÿäº†æ”¹åŠ¨ï¼Œå°±é‡æ–°æ‰“åŒ…ç¼–è¯‘ç»“æœ
	ctx.watch().then(() => {
		console.log("watching~~~");
	});
});
```

åœ¨`package.json`æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªå‘½ä»¤ï¼Œè¿›è¡Œæ‰“åŒ…ã€‚

```javascript
// package.json
"scripts": {
  "dev": "node scripts/dev.js"
}
```

ä¹‹åï¼Œæ‰§è¡Œ`npm run dev`å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨`reactivity`æ–‡ä»¶å¤¹ä¸‹ï¼Œç”Ÿæˆäº†`reactivity.js`å’Œ`reactivity.js.map`ä¸¤ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬æ‰“å¼€`reactivity.js`æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ‰“åŒ…ç»“æœä¸ºï¼š

```javascript
// packages/shared/src/index.ts
var isArray = (value) => {
	return Array.isArray(value);
};

// packages/reactivity/src/index.ts
console.log(isArray([1, 2, 3]));
export { isArray };
//# sourceMappingURL=reactivity.js.map
```

é‚£ä¹ˆæ­¤æ—¶`js`æ–‡ä»¶å°±å·²ç»è¢«æˆåŠŸçš„æ‰“åŒ…äº†ï¼Œåœ¨`dist`ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æ–°å»ºä¸ª`index.html`æ–‡ä»¶ï¼Œçœ‹çœ‹åˆšæ‰æ‰“åŒ…çš„ç»“æœï¼Œèƒ½ä¸èƒ½åœ¨é¡µé¢ä¸Šç”¨ï¼š

```html
<!-- reactivity/dist/index.html -->
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
	</head>
	<body>
		<script type="module">
			import { isArray } from "./reactivity.js";
			console.log("index.htmlæ–‡ä»¶ä¸­æµ‹è¯•ä»£ç ï¼š", isArray([2, 3, 4]));
		</script>
	</body>
</html>
```

ç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯ï¼Œ`<script>`æ ‡ç­¾è¦åŠ ä¸Š`type="module"`ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡`esModule`çš„æ–¹å¼è¿›è¡Œå¯¼å…¥å¯¼å‡ºçš„ã€‚

æ­¤æ—¶æˆ‘ä»¬è¦å¯åŠ¨ä¸€ä¸ªæœ¬åœ°æœåŠ¡å™¨ï¼Œæ¥æŸ¥çœ‹`index.html`æ–‡ä»¶ï¼Œè¿™é‡Œæ–¹å¼å¾ˆå¤šï¼Œæˆ‘æ¨èä½¿ç”¨ä¸€æ¡å‘½ä»¤ï¼Œèƒ½å¤Ÿç›´æ¥å¯åŠ¨ä¸€ä¸ªæœ¬åœ°æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä¸éœ€è¦å®‰è£…ä»»ä½•ä¸œè¥¿ã€‚

æˆ‘ä»¬`cd`è¿›å…¥åˆ°`reactivity`ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ`npx serve dist`å‘½ä»¤ï¼ˆè¦ä¿è¯ npm ç‰ˆæœ¬ â‰¥5.2 æ‰èƒ½å¤Ÿä½¿ç”¨ npxï¼‰ï¼Œè¿™å¥—å‘½ä»¤å°±æ˜¯å°† dist æ–‡ä»¶å¤¹ä½œä¸ºæœåŠ¡å™¨æ ¹ç›®å½•ï¼Œç„¶åå°†`index.html`æ–‡ä»¶é»˜è®¤ä½œä¸ºä¸»æ–‡ä»¶å…¥å£è¿›è¡Œå±•ç¤ºï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œå¯ä»¥çœ‹åˆ°é»˜è®¤çš„ç«¯å£æ˜¯ 3000ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€`localhost:3000`ï¼Œæ‰“å¼€æ§åˆ¶å°ï¼Œå¯ä»¥å‘ç°è¾“å‡ºäº† 2 è¡Œä»£ç ï¼Œä¸€ä¸ªæ˜¯`reactivity.js`æ–‡ä»¶ä¸­è¾“å‡ºçš„ï¼Œä¸€ä¸ªæ˜¯`index.html`æ–‡ä»¶ä¸­ï¼Œå¯¼å…¥è¿›æ¥è¾“å‡ºçš„ã€‚

## æ‰‹å†™ Vue3 ç»„åˆ API

### 1) shallowReactive ä¸ reactive

```js
const reactiveHandler = {
	get(target, key) {
		if (key === "_is_reactive") return true;

		return Reflect.get(target, key);
	},

	set(target, key, value) {
		const result = Reflect.set(target, key, value);
		console.log("æ•°æ®å·²æ›´æ–°, å»æ›´æ–°ç•Œé¢");
		return result;
	},

	deleteProperty(target, key) {
		const result = Reflect.deleteProperty(target, key);
		console.log("æ•°æ®å·²åˆ é™¤, å»æ›´æ–°ç•Œé¢");
		return result;
	},
};

/* 
è‡ªå®šä¹‰shallowReactive
*/
function shallowReactive(obj) {
	return new Proxy(obj, reactiveHandler);
}

/* 
è‡ªå®šä¹‰reactive
*/
function reactive(target) {
	if (target && typeof target === "object") {
		if (target instanceof Array) {
			// æ•°ç»„
			target.forEach((item, index) => {
				target[index] = reactive(item);
			});
		} else {
			// å¯¹è±¡
			Object.keys(target).forEach((key) => {
				target[key] = reactive(target[key]);
			});
		}

		const proxy = new Proxy(target, reactiveHandler);
		return proxy;
	}

	return target;
}

/* æµ‹è¯•è‡ªå®šä¹‰shallowReactive */
const proxy = shallowReactive({
	a: {
		b: 3,
	},
});

proxy.a = { b: 4 }; // åŠ«æŒåˆ°äº†
proxy.a.b = 5; // æ²¡æœ‰åŠ«æŒåˆ°

/* æµ‹è¯•è‡ªå®šä¹‰reactive */
const obj = {
	a: "abc",
	b: [{ x: 1 }],
	c: { x: [11] },
};

const proxy = reactive(obj);
console.log(proxy);
proxy.b[0].x += 1;
proxy.c.x[0] += 1;
```

### 2ï¼‰shallowRef ä¸ ref

```js
/*
è‡ªå®šä¹‰shallowRef
*/
function shallowRef(target) {
	const result = {
		_value: target, // ç”¨æ¥ä¿å­˜æ•°æ®çš„å†…éƒ¨å±æ€§
		_is_ref: true, // ç”¨æ¥æ ‡è¯†æ˜¯refå¯¹è±¡
		get value() {
			return this._value;
		},
		set value(val) {
			this._value = val;
			console.log("set value æ•°æ®å·²æ›´æ–°, å»æ›´æ–°ç•Œé¢");
		},
	};

	return result;
}

/* 
è‡ªå®šä¹‰ref
*/
function ref(target) {
	if (target && typeof target === "object") {
		target = reactive(target);
	}

	const result = {
		_value: target, // ç”¨æ¥ä¿å­˜æ•°æ®çš„å†…éƒ¨å±æ€§
		_is_ref: true, // ç”¨æ¥æ ‡è¯†æ˜¯refå¯¹è±¡
		get value() {
			return this._value;
		},
		set value(val) {
			this._value = val;
			console.log("set value æ•°æ®å·²æ›´æ–°, å»æ›´æ–°ç•Œé¢");
		},
	};

	return result;
}

/* æµ‹è¯•è‡ªå®šä¹‰shallowRef */
const ref3 = shallowRef({
	a: "abc",
});
ref3.value = "xxx";
ref3.value.a = "yyy";

/* æµ‹è¯•è‡ªå®šä¹‰ref */
const ref1 = ref(0);
const ref2 = ref({
	a: "abc",
	b: [{ x: 1 }],
	c: { x: [11] },
});
ref1.value++;
ref2.value.b[0].x++;
console.log(ref1, ref2);
```

### 3) shallowReadonly ä¸ readonly

```js
const readonlyHandler = {
	get(target, key) {
		if (key === "_is_readonly") return true;

		return Reflect.get(target, key);
	},

	set() {
		console.warn("åªè¯»çš„, ä¸èƒ½ä¿®æ”¹");
		return true;
	},

	deleteProperty() {
		console.warn("åªè¯»çš„, ä¸èƒ½åˆ é™¤");
		return true;
	},
};

/* 
è‡ªå®šä¹‰shallowReadonly
*/
function shallowReadonly(obj) {
	return new Proxy(obj, readonlyHandler);
}

/* 
è‡ªå®šä¹‰readonly
*/
function readonly(target) {
	if (target && typeof target === "object") {
		if (target instanceof Array) {
			// æ•°ç»„
			target.forEach((item, index) => {
				target[index] = readonly(item);
			});
		} else {
			// å¯¹è±¡
			Object.keys(target).forEach((key) => {
				target[key] = readonly(target[key]);
			});
		}
		const proxy = new Proxy(target, readonlyHandler);

		return proxy;
	}

	return target;
}

/* æµ‹è¯•è‡ªå®šä¹‰readonly */
/* æµ‹è¯•è‡ªå®šä¹‰shallowReadonly */
const objReadOnly = readonly({
	a: {
		b: 1,
	},
});
const objReadOnly2 = shallowReadonly({
	a: {
		b: 1,
	},
});

objReadOnly.a = 1;
objReadOnly.a.b = 2;
objReadOnly2.a = 1;
objReadOnly2.a.b = 2;
```

### 4) isRef, isReactive ä¸ isReadonly

```js
/* 
åˆ¤æ–­æ˜¯å¦æ˜¯refå¯¹è±¡
*/
function isRef(obj) {
	return obj && obj._is_ref;
}

/* 
åˆ¤æ–­æ˜¯å¦æ˜¯reactiveå¯¹è±¡
*/
function isReactive(obj) {
	return obj && obj._is_reactive;
}

/* 
åˆ¤æ–­æ˜¯å¦æ˜¯readonlyå¯¹è±¡
*/
function isReadonly(obj) {
	return obj && obj._is_readonly;
}

/* 
æ˜¯å¦æ˜¯reactiveæˆ–readonlyäº§ç”Ÿçš„ä»£ç†å¯¹è±¡
*/
function isProxy(obj) {
	return isReactive(obj) || isReadonly(obj);
}

/* æµ‹è¯•åˆ¤æ–­å‡½æ•° */
console.log(isReactive(reactive({})));
console.log(isRef(ref({})));
console.log(isReadonly(readonly({})));
console.log(isProxy(reactive({})));
console.log(isProxy(readonly({})));
```

## Vue3 å“åº”å¼åŸç†

### `Vue3`çš„å“åº”å¼åŸç†

#### Vue2 å’Œ Vue3 çš„å¯¹æ¯”

è¿™é‡Œæˆ‘ä»¬ä¸å¾—ä¸å…ˆæåŠä¸€ä¸‹`Vue2`çš„å“åº”å¼åŸç†ï¼Œè¯´å¥ç°å®çš„è¯ï¼Œé¢è¯•çš„æ—¶å€™ï¼Œè‚¯å®šä¼šä¸€èµ·é—®çš„ï¼Œé‚£ä¹ˆå¦‚æœèƒ½å¤Ÿå°†ä¸¤è€…ç»“åˆåœ¨ä¸€èµ·ï¼Œè¿›è¡Œæœ‰æ¡ç†çš„å¯¹æ¯”åˆ†æå›ç­”ï¼Œé‚£ä¹ˆç»å¯¹æ˜¯ä¸€ä¸ªäº®çœ¼çš„åŠ åˆ†é¡¹ã€‚

#### å“åº”å¼åŸç†å¯¹æ¯”

**`Vue2`ä¸è¶³ï¼š**

- åœ¨ä½¿ç”¨`Vue2`çš„æ—¶å€™ï¼Œè¿›è¡Œæ•°æ®åŠ«æŒä½¿ç”¨çš„æ˜¯`Object.defineproperty`ï¼Œéœ€è¦å¯¹æˆ‘ä»¬`data`ä¸­å®šä¹‰çš„æ‰€æœ‰å±æ€§è¿›è¡Œé‡å†™ï¼Œä»è€Œæ·»åŠ `getter`å’Œ`setter`ï¼Œæ­£æ˜¯å› ä¸ºäº†è¿™ä¸€æ­¥ï¼Œæ‰€ä»¥å¯¼è‡´ï¼Œå¦‚æœ`data`ä¸­å®šä¹‰çš„å±æ€§è¿‡å¤šï¼Œæ€§èƒ½å°±ä¼šå˜å·®ã€‚
- åœ¨å†™é¡¹ç›®çš„æ—¶å€™ï¼Œæœ‰çš„æ—¶å€™ä¼šç¢°åˆ°éœ€è¦æ–°å¢æˆ–åˆ é™¤å±æ€§çš„æ“ä½œï¼Œé‚£ä¹ˆç›´æ¥æ–°å¢/åˆ é™¤ï¼Œå°±æ— æ³•ç›‘æ§å˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ä¸€äº›`api`æ¯”å¦‚`$set`ï¼Œ`$delete`è¿›è¡Œå®ç°ï¼Œå…¶å®åŸç†ä¸Šè¿˜æ˜¯ä½¿ç”¨äº†`Object.defineproperty`è¿›è¡Œäº†æ•°æ®åŠ«æŒã€‚
- é’ˆå¯¹æ•°ç»„çš„å¤„ç†ï¼Œæ²¡æœ‰ä½¿ç”¨`Object.defineproperty`è¿›è¡Œæ•°æ®åŠ«æŒï¼Œå› ä¸ºå¦‚æœç»™ä¸€ä¸ªå¾ˆé•¿çš„æ•°ç»„çš„æ¯ä¸€é¡¹ï¼Œéƒ½æ·»åŠ `getter`å’Œ`setter`ï¼Œé‚£å¤šæ¥å‡ ä¸ªæ•°ç»„ï¼Œå°±å´©æ‰äº†ï¼Œè€Œä¸”æ—¥å¸¸å¼€å‘ä¸­æˆ‘ä»¬é€šè¿‡æ•°ç»„ç´¢å¼•è¿›è¡Œä¿®æ”¹æ•°ç»„çš„æ“ä½œæ¯”è¾ƒå°‘ã€‚æ‰€ä»¥`Vue2`çš„æ–¹å¼å°±æ˜¯é‡‡ç”¨é‡å†™äº†ä¸€äº›å¸¸ç”¨çš„æ•°ç»„æ–¹æ³•æ¯”å¦‚`unshift,shift,push,pop,splice,sort,reverse`è¿™ä¸ƒä¸ªæ–¹æ³•ï¼Œæ¥è§£å†³æ•°ç»„æ•°æ®å“åº”å¼çš„é—®é¢˜ã€‚

**`Vue3`æ”¹è¿›ï¼š**

- `Vue3`ä½¿ç”¨äº†`Proxy`æ¥å®ç°äº†å“åº”å¼æ•°æ®å˜åŒ–ï¼Œä»è€Œä»æ ¹æœ¬ä¸Šè§£å†³äº†ä¸Šè¿°é—®é¢˜ï¼Œé€»è¾‘ä¹Ÿç®€åŒ–äº†å¥½å¤šã€‚

#### å†™æ³•åŒºåˆ«å¯¹æ¯”

- åœ¨`Vue2`ä¸­ä½¿ç”¨çš„æ˜¯`OptionsAPI`ï¼Œæˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œå¦‚æœé¡µé¢æ¯”è¾ƒå¤æ‚ï¼Œé‚£ä¹ˆå¯èƒ½å°±ä¼šåœ¨`data`ä¸­å®šä¹‰å¾ˆå¤šå±æ€§ï¼Œ`methods`ä¸­å®šä¹‰å¾ˆå¤šæ–¹æ³•ï¼Œé‚£ä¹ˆç›¸å…³çš„é€»è¾‘å°±ä¸åœ¨åŒä¸€å—åœ°æ–¹ï¼Œæˆ‘ä»¬åœ¨æ‰¾ä»£ç çš„æ—¶å€™ï¼Œå°±å¯èƒ½æ¯”è¾ƒç´¯ï¼Œé¼ æ ‡æ»šè½®æˆ–è€…è§¦æ‘¸æ¿æ¥å›ä¸Šä¸‹ç¿»æ‰¾ã€‚`Vue3`ä½¿ç”¨äº†`CompositionAPI`ï¼Œå¯ä»¥æŠŠæŸä¸€å—é€»è¾‘ï¼Œå•ç‹¬å†™åœ¨ä¸€èµ·ï¼Œè§£å†³äº†è¿™ç§åå¤æ¨ªè·³çš„é—®é¢˜ã€‚
- `Vue2`ä¸­æ‰€æœ‰çš„å±æ€§éƒ½æ˜¯é€šè¿‡`this`æ¥è¿›è¡Œè®¿é—®çš„ï¼Œ`this`çš„æŒ‡å‘ä¸€ç›´æ˜¯`JS`ä¸­å¾ˆæ¶å¿ƒçš„é—®é¢˜ï¼Œä¸€ä¸å°å¿ƒå°±æä¸æ¸…`this`çš„æŒ‡å‘ï¼Œä»£ç å°±ä¼šå‡ºé—®é¢˜ã€‚`Vue3`ç›´æ¥å¹²æ‰äº†`this`ã€‚
- `Vue2`ä¸­ï¼Œå¾ˆå¤šæ²¡æœ‰ä½¿ç”¨çš„æ–¹æ³•æˆ–è€…å±æ€§ï¼Œéƒ½ä¼šè¢«æ‰“åŒ…ï¼Œå¹¶ä¸”å…¨å±€çš„`API`éƒ½å¯ä»¥åœ¨`Vue`å¯¹è±¡ä¸Šè®¿é—®åˆ°ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨`Computed`ä¸­ï¼Œå®šä¹‰äº† 3 ä¸ªå€¼ï¼Œä½†æ˜¯é¡µé¢ä¸­åªç”¨åˆ°äº† 1 ä¸ªï¼Œé‚£ä¹ˆä¾æ—§ä¼šæŠŠè¿™ 3 ä¸ª`Computed`å€¼å…¨éƒ¨éƒ½æ‰“åŒ…ã€‚`Vue3`ä½¿ç”¨çš„`CompositionAPI`ï¼Œå¯¹`tree-shaking`éå¸¸å‹å¥½ï¼Œä»£ç å‹ç¼©åçš„ä½“ç§¯ä¹Ÿå°±æ›´å°ã€‚
- `Vue2`ä¸­çš„`mixins`å¯ä»¥å®ç°ç›¸åŒé€»è¾‘å¤ç”¨ï¼ŒæŠ½ç¦»åˆ°ä¸€ä¸ª`mixin`æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯ä¼šæœ‰æ•°æ®æ¥æºä¸æ˜ç¡®çš„é—®é¢˜ï¼Œå‘½åä¸Šä¹Ÿä¼šäº§ç”Ÿå†²çªã€‚è€Œ`Vue3`ä½¿ç”¨`CompositionAPI`ï¼Œæå–å…¬å…±é€»è¾‘å¯ä»¥æŠ½æˆå•ç‹¬çš„`hooks`ï¼Œéå¸¸æ–¹ä¾¿ï¼Œé¿å…äº†ä¹‹å‰çš„é—®é¢˜ã€‚

> å½“ç„¶ï¼Œåœ¨ç®€å•çš„é¡µé¢ä¸­ï¼Œæˆ‘ä»¬ä¾æ—§å¯ä»¥ä½¿ç”¨`OptionsAPI`ï¼Œå°±æ˜¯`Vue2`çš„å†™æ³•ã€‚`CompositionAPI`åœ¨å¼€å‘æ¯”è¾ƒå¤æ‚çš„é¡µé¢ä¸­ï¼Œä¹¦å†™èµ·æ¥æ˜¾å¾—éå¸¸æ–¹ä¾¿ã€‚æˆ‘ä»¬æœ¬ç¯‡æ–‡ç« è¦å­¦ä¹ çš„å°±æ˜¯`Vue3`ä¸­çš„`reactivity`æ¨¡å—ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¨¡å—ä¸­åŒ…å«äº†å¾ˆå¤šæˆ‘ä»¬ä½¿ç”¨çš„`API`ï¼Œæ¯”å¦‚`computed,reactive,ref,effect`ç­‰ã€‚

### `reactive`å’Œ`effect`æ–¹æ³•çš„å®ç°

#### `reactivity`æ¨¡å—çš„åŸºæœ¬ä½¿ç”¨

æˆ‘ä»¬å…ˆç®€å•çš„çœ‹ä¸‹ï¼Œè¿™ä¸ªæ¨¡å—çš„ä½¿ç”¨æ–¹æ³•ï¼Œç„¶åå†æ¥ä¸€æ­¥ä¸€æ­¥ï¼Œç®€å•å®ç°é‡Œè¾¹çš„æ–¹æ³•ã€‚æ‰“å¼€ä¸Šç¯‡æ–‡ç« åˆ›å»ºå¥½çš„é¡¹ç›®ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œæˆ‘ä»¬æ‰§è¡Œ`pnpm install vue -w`ï¼Œå…ˆç”¨ä¸€ä¸‹`Vue3`å®˜æ–¹æä¾›çš„æ–¹æ³•ï¼Œçœ‹çœ‹æ˜¯å•¥æ•ˆæœã€‚

å®‰è£…ä¾èµ–å¥½åï¼Œæˆ‘ä»¬é€šè¿‡`node_modules`æ–‡ä»¶å¤¹æ‰¾åˆ°`@vue/reactivity/dist/reactivity.esm-browser.js`è¿™ä¸ªæ–‡ä»¶ï¼Œé€šè¿‡æ–‡ä»¶åå­—æˆ‘ä»¬å°±èƒ½çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªæ˜¯`esModule`å¯ä»¥æ”¾åœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„ã€‚

æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶ä¸€ä»½ï¼Œç›´æ¥æ”¾åœ¨æˆ‘ä»¬è‡ªå·±`reactivity/dist`ç›®å½•ä¸‹ï¼Œç„¶åä¿®æ”¹`reactivity/dist/index.html`çš„ä»£ç å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
	</head>

	<body>
		<div id="app"></div>
		<script type="module">
			import { effect, reactive } from "./reactivity.esm-browser.js";
			const state = reactive({ name: "å¼ ä¸‰", age: 18 });
			effect(() => {
				app.innerHTML = state.name + ": " + state.age;
			});
			setTimeout(() => {
				state.name = "æå››";
			}, 2000);
		</script>
	</body>
</html>
```

æˆ‘ä»¬è¿™é‡Œä»‹ç»ä¸Šè¿°ä»£ç ä¸­çš„ä¸¤ä¸ª`API`ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„`reactive`ï¼Œæ²¡é”™ï¼Œåœ¨é¡¹ç›®ä¸­å¦‚æœæƒ³å®šä¹‰ä¸€ä¸ªå“åº”å¼å¯¹è±¡çš„è¯ï¼Œå°±æŠŠå¯¹è±¡ä¼ è¿›`reactive`ä¸­å°±å¥½äº†ã€‚

é‚£ä¹ˆ`effect`åˆæ˜¯å•¥å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬åªæ˜¯å†™ä¸šåŠ¡ï¼Œå…¶å®å¾ˆéš¾ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œä½†`effect`ç¡®æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•ï¼ˆåˆå«å‰¯ä½œç”¨å‡½æ•°ï¼‰ï¼Œæ‰§è¡Œ`effect`å°±ä¼šæ¸²æŸ“é¡µé¢ï¼Œæ‰€ä»¥æ¸²æŸ“é¡µé¢çš„æ ¸å¿ƒç¦»ä¸å¼€`effect`æ–¹æ³•ã€‚

> ä¸€å¥è¯ï¼Œ`reactive`æ–¹æ³•ä¼šå°†å¯¹è±¡å˜æˆ`proxy`å¯¹è±¡ï¼Œ`effect`ä¸­ä½¿ç”¨`reactive`å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œç­‰ä¹‹å`reactive`å¯¹è±¡ä¸­çš„å±æ€§å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼šé‡æ–°æ‰§è¡Œ`effect`å‡½æ•°ã€‚

æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œä¸Šè¾¹çš„ä»£ç ï¼Œä¼šå‘ç°è¿‡äº† 2 ç§’åï¼Œæˆ‘ä»¬åªæ˜¯å°†`state.name`èµ‹å€¼æˆäº†æå››ï¼Œä½†æ˜¯é¡µé¢ä¹Ÿé‡æ–°è¢«æ¸²æŸ“äº†ï¼Œåå­—ä»å¼ ä¸‰å˜æˆäº†æå››ã€‚ç­‰çœ‹å®Œæœ¬ç¯‡æ–‡ç« çš„ä»£ç åï¼Œå¯ä»¥å›è¿‡å¤´æ¥å†æ¥ç†è§£ä¸Šè¾¹çš„é‚£å¥è¯ã€‚

æœ‰äººå¯èƒ½æœ‰äº›ç–‘é—®äº†ï¼Œ`reactive`æˆ‘åœ¨é¡¹ç›®ä¸­ç¡®å®æœ‰ç”¨åˆ°è¿‡ï¼Œä½†æ˜¯è¿™ä¸ª`effect`æ–¹æ³•ï¼Œåœ¨é¡¹ç›®ä¸­æ ¹æœ¬æ²¡ç”¨åˆ°è¿‡å•Šï¼Œç”šè‡³å¬éƒ½æ²¡å¬è¯´è¿‡ï¼Œæ²¡é”™ï¼Œ`effect`æ–¹æ³•æ˜¯åº•å±‚æ–¹æ³•ï¼Œé¡¹ç›®ä¸­ç”¨ä¸åˆ°éå¸¸æ­£å¸¸ï¼Œä½†æ˜¯`watch`ï¼Œ`watchEffect`æ€»è¯¥ç”¨è¿‡å§ï¼Ÿå˜¿å˜¿ï¼Œæ²¡é”™ï¼Œéƒ½æ˜¯åŸºäº`effect`è¿›è¡Œäº†å°è£…ä»è€Œå®ç°çš„ï¼Œåˆ«æ€¥ï¼Œæˆ‘ä»¬åœ¨ä¸‹è¾¹çš„æ–‡ç« ä¸­ä¼šå¨“å¨“é“æ¥ã€‚

#### å¼€å§‹å®ç°`reactivity`æ¨¡å—ä¸­çš„æ–¹æ³•

##### ç¼–å†™`reactive`æ–¹æ³•

é¦–å…ˆæˆ‘ä»¬åœ¨`shared`ä¸­æ·»åŠ ä¸€ä¸ªæ–°æ–¹æ³•ï¼š

```javascript
// ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡
export const isObject = (value) => {
	return value != null && typeof value === "object";
};
```

ä¹‹åï¼Œæˆ‘ä»¬åœ¨`reactivity/src`ç›®å½•ä¸‹ï¼Œæ–°å»º`reactive.ts`æ–‡ä»¶ï¼Œç”¨æ¥å†™`reactive`çš„ä¸»é€»è¾‘ï¼š

```javascript
import { isObject } from "@vue/shared";
const mutableHandlers = {
	get(target, key, receiver) {
		return Reflect.get(target, key, receiver);
	},
	set(target, key, value, receiver) {
		Reflect.set(target, key, value, receiver);
		// ä¸¥æ ¼æ¨¡å¼ä¸‹å¦‚æœä¸è¿”å›trueå°±ä¼šæŠ¥é”™
		return true;
	},
};
export function reactive(target) {
	// å…ˆåˆ¤æ–­targetæ˜¯ä¸æ˜¯ä¸ªå¯¹è±¡ï¼Œreactiveåªèƒ½å¤„ç†å¯¹è±¡ç±»å‹çš„æ•°æ®
	if (!isObject(target)) return;
	const proxy = new Proxy(target, mutableHandlers);
	return proxy;
}
```

æˆ‘ä»¬ç”¨æœ€ç®€å•çš„ä»£ç ï¼Œå†™äº†`reactive`çš„æ ¸å¿ƒé€»è¾‘ï¼Œä»ä»£ç ä¸­ä¹Ÿçœ‹åˆ°ï¼Œ`reactive`ä¸­åªèƒ½å¤„ç†å¯¹è±¡ç±»å‹çš„æ•°æ®ã€‚è¿˜æœ‰ä¸€ç‚¹ï¼Œç»†å¿ƒçš„æœ‹å‹å¯èƒ½ä¼šå‘ç°ï¼Œåœ¨`get`å’Œ`set`ä¸­ï¼Œä½¿ç”¨äº†`Reflect`çš„`get`ï¼Œ`set`æ–¹æ³•ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨`target[key]`å‘¢ï¼Œæ•ˆæœä¸æ˜¯ä¸€æ ·çš„ä¹ˆï¼Ÿçœ‹èµ·æ¥æ˜¯è¿™æ ·ï¼Œä½†æ˜¯åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œå°±èƒ½çœ‹åˆ°æ˜æ˜¾çš„é—®é¢˜ã€‚æˆ‘ä»¬å…ˆä¸¾ä¸ªä¾‹å­ï¼š

```javascript
let obj = {
  name: 'zhangsan',
  get nickName{
    return 'nickNameï¼š' + this.name
  }
}

let proxyObj = new Proxy(obj, {
  get(target, key, receiver) {
    console.log('æ”¶é›†ä¾èµ–ï¼š', key)
    return target[key]
  }
})

// è¿›è¡Œå–å€¼æ“ä½œ
console.log(proxyObj.nickName)
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ä»£ç†ï¼Œå¦‚æœæˆ‘ä»¬åœ¨é¡µé¢ä¸­ï¼Œä½¿ç”¨äº†`proxyObj.nickName`è¿™ä¸ªå–å€¼ä»£ç ï¼Œé‚£ä¹ˆæ ¹æ®ç›¸åº”é€»è¾‘ï¼Œæ‰§è¡Œä»£ç æ‰“å°çš„ç»“æœå°±æ˜¯ï¼š

```bash
æ”¶é›†ä¾èµ–ï¼š nickName
nickNameï¼šzhangsan
```

é‚£ä¹ˆå¾ˆæ˜æ˜¾çš„é—®é¢˜å°±æ˜¯ï¼Œ`obj`ä¸­çš„`name`å±æ€§ï¼Œæ²¡æœ‰è¢«ä¾èµ–æ”¶é›†ï¼Œé‚£ä¹ˆå¦‚æœåœ¨åç»­æ“ä½œä¸­ï¼Œæˆ‘ä»¬å¯¹`proxyObj.name = 'xxxxxx'`è¿›è¡Œèµ‹å€¼äº†ï¼Œå› ä¸ºæ²¡æœ‰è¢«ä¾èµ–æ”¶é›†åˆ°ï¼Œæ‰€ä»¥è™½ç„¶æ•°æ®å˜åŒ–äº†ï¼Œä½†æ˜¯é¡µé¢è§†å›¾å´å¹¶æ²¡æœ‰åŒæ­¥å‘ç”Ÿå˜åŒ–ã€‚

è¯´åˆ°åº•è¿˜æ˜¯å› ä¸º`this`æŒ‡å‘çš„åŸå› ï¼Œå½“å‰`this`æŒ‡å‘äº†`obj`ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›è¿™ä¸ª`this`æŒ‡å‘è¢«ä»£ç†åçš„`proxyObj`ï¼Œè¿™æ ·æ‰èƒ½å¤Ÿå°†`name`å±æ€§ä¹Ÿæ”¶é›†åˆ°ï¼Œé‚£ä¹ˆæ‰€ä»¥ï¼Œæˆ‘ä»¬æ­¤æ—¶åº”è¯¥ä½¿ç”¨`Reflect`ï¼Œæ¥ä½¿`this`æ­£ç¡®çš„æŒ‡å‘è¢«ä»£ç†åçš„`proxyObj`å±æ€§ã€‚

```javascript
let obj = {
	name: "zhangsan",
	get nickName() {
		return "nickNameï¼š" + this.name;
	},
};

let proxyObj = new Proxy(obj, {
	get(target, key, receiver) {
		console.log("æ”¶é›†ä¾èµ–ï¼š", key);
		return Reflect.get(target, key, receiver);
	},
});

// è¿›è¡Œå–å€¼æ“ä½œ
console.log(proxyObj.nickName);
```

ç»è¿‡æ­¤ç•ªä¿®æ”¹ï¼Œæˆ‘ä»¬å†æ‰§è¡Œä»£ç ï¼Œä¼šå‘ç°ï¼Œè¯¶`name`å±æ€§ä¹Ÿè¢«æˆåŠŸçš„è¿›è¡Œä¾èµ–æ”¶é›†äº†ï¼Œè¾¾åˆ°äº†æˆ‘ä»¬çš„é¢„æœŸ.è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œè¦ä½¿ç”¨`Reflect`çš„åŸå› å•¦ã€‚

```bash
æ”¶é›†ä¾èµ–ï¼š nickName
æ”¶é›†ä¾èµ–ï¼š name
nickNameï¼šzhangsan
```

ç»è¿‡è¿™ä¸ªå°æ’æ›²ï¼Œæˆ‘ä»¬å›åˆ°`reactive`ä»£ç ä¸­ã€‚è™½ç„¶æ ¸å¿ƒé€»è¾‘å†™å¥½äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¦è€ƒè™‘ä¸€äº›å°é—®é¢˜ï¼Œæ¯”å¦‚åœ¨ä¸‹æ–¹ä»£ç ä¸­ï¼Œå¦‚æœç”¨`Vue3`å®˜æ–¹æºç æ¥æ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚æœå¯¹äºåŒä¸€ä¸ªå¯¹è±¡è¿›è¡Œå¤šæ¬¡ä»£ç†ï¼Œéƒ½åº”è¯¥è¿”å›åŒä¸€ä¸ªä»£ç†ï¼Œç»“æœä¸º`true`ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬ç›®å‰çš„ä»£ç ä¸­ï¼Œæ²¡æœ‰è¿‡è¿™ä¸ªåˆ¤æ–­ï¼Œåªè¦åœ¨`reactive`ä¸­ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå°±è¿›è¡Œ`new Proxy()`ç”Ÿæˆä¸€ä¸ªæ–°çš„ä»£ç†ï¼Œæ‰€ä»¥ç»“æœä¸º`false`ï¼Œè¿™æ ·è‚¯å®šæ˜¯ä¸åˆç†çš„ã€‚

```javascript
import { reactive } from "vue";
const obj = { name: "zhangsan" };
let proxy1 = reactive(obj);
let proxy2 = reactive(obj);
console.log(proxy1 === proxy2);
```

é‚£ä¹ˆåº”è¯¥å¦‚ä½•åšåˆ°å¦‚æœä¼ å…¥åŒä¸€ä¸ªå¯¹è±¡ï¼Œå°±è¿”å›ç›¸åŒçš„ä»£ç†ç»“æœå‘¢ï¼Ÿå…¶å®æƒ³ä¸€æƒ³å¤§è‡´çš„æ€è·¯å°±æœ‰äº†ï¼Œæ²¡é”™ï¼Œéœ€è¦æœ‰ä¸ªç¼“å­˜è¡¨ï¼Œæ¥è®°å½•æ¯æ¬¡ä¼ å…¥çš„å¯¹è±¡æ˜¯ä¸æ˜¯é‡å¤äº†ï¼Œå¦‚æœé‡å¤ï¼Œå°±è¿”å›å·²ç»å­˜åœ¨çš„ä»£ç†å¯¹è±¡ã€‚

é‚£åº”è¯¥ç”¨ä»€ä¹ˆç¼“å­˜å‘¢ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯ç”¨`WeekMap`ï¼Œå¥½å¤„å°±æ˜¯å®ƒçš„`key`èƒ½å­˜æ”¾`object`ç±»å‹çš„æ•°æ®ï¼Œè€Œä¸”ä¸å­˜åœ¨åƒåœ¾å›æ”¶çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥è¡¥å……å®Œæ•´é€»è¾‘å§!

```javascript
import { isObject } from "@vue/shared";
// 1.æˆ‘ä»¬åˆ©ç”¨WeakMapï¼Œæ¥å®šä¹‰ä¸€ä¸ªç¼“å­˜è¡¨
const reactiveMap = new WeakMap();
const mutableHandlers = {
	get(target, key, receiver) {
		return Reflect.get(target, key, receiver);
	},
	set(target, key, value, receiver) {
		Reflect.set(target, key, value, receiver);
		// ä¸¥æ ¼æ¨¡å¼ä¸‹å¦‚æœä¸è¿”å›trueå°±ä¼šæŠ¥é”™
		return true;
	},
};

export function reactive(target) {
	// å…ˆåˆ¤æ–­targetæ˜¯ä¸æ˜¯ä¸ªå¯¹è±¡ï¼Œreactiveåªèƒ½å¤„ç†å¯¹è±¡ç±»å‹çš„æ•°æ®
	if (!isObject(target)) return;
	// 2.å…ˆä»ç¼“å­˜è¡¨ä¸­è¯»å–ä»£ç†ç»“æœï¼Œå¦‚æœèƒ½æ‰¾åˆ°ï¼Œå°±ç›´æ¥è¿”å›
	const existingProxy = reactiveMap.get(target);
	if (existingProxy) return existingProxy;
	// æ²¡æœ‰ç¼“å­˜è¿‡å°±æ­£å¸¸new Proxy()
	const proxy = new Proxy(target, mutableHandlers);
	// ä»£ç†åï¼Œåœ¨ç¼“å­˜è¡¨ä¸­ç¼“å­˜ç»“æœ
	reactiveMap.set(target, proxy);
	return proxy;
}
```

è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å†å¼•å…¥è‡ªå·±çš„`reactive`ï¼Œæ‰§è¡Œåˆšæ‰é‚£æ®µæµ‹è¯•ä»£ç ï¼Œå‘ç°`console.log(proxy1 === proxy2)`è¿”å›çš„å°±æ˜¯`true`ã€‚è¿™ä¸ªé—®é¢˜è§£å†³äº†ï¼Œä½†æ˜¯æ–°çš„é—®é¢˜åˆæ¥äº†ï¼Œè¿˜æ˜¯å›åˆ°åˆšæ‰é‚£ä¸ªæµ‹è¯•ä»£ç ï¼Œè¿™æ¬¡å°†ä»£ç†åçš„å¯¹è±¡ï¼Œå†æ¬¡ä¼ å…¥åˆ°`reactive`ä¸­ã€‚

åœ¨æºç ä¸­è¿”å›çš„ç»“æœä¾æ—§æ˜¯`true`ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œå› ä¸ºä¼ å…¥è¢«ä»£ç†åçš„å¯¹è±¡ï¼Œåˆæ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¼šå†æ¬¡è¢«ä»£ç†ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ€ä¹ˆæ‰èƒ½å¤Ÿåˆ¤æ–­è¿™ç§æƒ…å†µå‘¢ï¼Ÿ

```javascript
import { reactive } from "vue";
const obj = { name: "zhangsan" };
let proxy1 = reactive(obj);
let proxy2 = reactive(proxy1);
console.log(proxy1 === proxy2);
```

å¾ˆå¤šäººç¬¬ä¸€ååº”å°±æ˜¯æˆ‘åˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯ä¸æ˜¯`proxy`ä¸å°±å®Œäº‹äº†ï¼Œé¦–å…ˆï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„åŠæ³•ï¼Œåˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯ä¸€ä¸ª`proxy`ä»£ç†åçš„å¯¹è±¡ï¼Œå…¶æ¬¡ï¼Œå¦‚æœç”¨æˆ·è‡ªå·±`new Proxy()`ç”Ÿæˆäº†ä¸€ä¸ªä»£ç†çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå‡­å•¥ä¸è®©äººå®¶ä¼ å…¥`reactive`ä¸­å‘¢ï¼Ÿä¹‹æ‰€ä»¥è¦åšä¸Šæ–‡å’Œç°åœ¨è¿™ä¸¤ç‚¹ä¼˜åŒ–ï¼Œæ˜¯å› ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼Œæˆ–åŒä¸€ä¸ªå¯¹è±¡ç»è¿‡ä»£ç†åçš„ç»“æœï¼Œå¤šæ¬¡ä¼ å…¥`reactive`ä¸­åä¸ä¼šè¢«å†æ¬¡è¿›è¡Œä»£ç†ï¼Œæé«˜äº†æ•ˆç‡ã€‚

è¿™é‡Œï¼Œæ–°ç‰ˆæœ¬çš„`Vue3`é‡‡ç”¨äº†ä¸€ä¸ªæ¯”è¾ƒå·§å¦™çš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€æ¬¡çœ‹å¯èƒ½ä¼šæœ‰äº›ç»•ï¼Œæ‰€ä»¥æœ€å¥½å¤šçœ‹å‡ éä»£ç ï¼Œæˆ–åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œæ–­ç‚¹è°ƒè¯•ã€‚

```javascript
import { isObject } from '@vue/shared'

const reactiveMap = new WeakMap();
const enum ReactiveFlags {
  IS_REACTIVE = '__v_isReactive'
}

const mutableHandlers =  {
  get(target, key, receiver) {
    // 2.åœ¨ç»è¿‡getåŠ«æŒåï¼Œå¦‚æœè®¿é—®åˆ°çš„keyå°±æ˜¯ReactiveFlags.IS_REACTIVEï¼Œå°±è¯´æ˜è¢«ä»£ç†çš„å¯¹è±¡ï¼Œåˆè¢«ä¼ è¿›æ¥äº†ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›true
    if (key === ReactiveFlags.IS_REACTIVE) return true
    return Reflect.get(target, key, receiver)
  },
  set(target, key, value, receiver) {
    Reflect.set(target, key ,value, receiver)
    // ä¸¥æ ¼æ¨¡å¼ä¸‹å¦‚æœä¸è¿”å›trueå°±ä¼šæŠ¥é”™
    return true
  }
}

export function reactive(target) {
  // å…ˆåˆ¤æ–­targetæ˜¯ä¸æ˜¯ä¸ªå¯¹è±¡ï¼Œreactiveåªèƒ½å¤„ç†å¯¹è±¡ç±»å‹çš„æ•°æ®
  if (!isObject(target)) return
  // å¦‚æœèƒ½å¤Ÿä»ä»ç¼“å­˜ä¸­è¯»å–ï¼Œåˆ™ç›´æ¥è¿”å›
  const existingProxy = reactiveMap.get(target)
  if(existingProxy) return existingProxy
  // 1.å¦‚æœè¢«ä»£ç†åçš„å¯¹è±¡ï¼Œåˆè¢«ä¼ å…¥è¿›æ¥äº†ï¼Œé‚£ä¹ˆåº”è¯¥å°†è¿™ä¸ªè¢«ä»£ç†çš„å¯¹è±¡ç›´æ¥è¿”å›ï¼Œè€Œä¸æ˜¯å†ä»£ç†ä¸€æ¬¡
  if (target[ReactiveFlags.IS_REACTIVE]) return target
  // æ²¡æœ‰ç¼“å­˜è¿‡ï¼Œå°±ä½¿ç”¨proxyè¿›è¡Œä»£ç†
  const proxy = new Proxy(target, mutableHandlers)
  // ç¼“å­˜proxyç»“æœ
  reactiveMap.set(target, proxy)
  return proxy
}
```

å…¶å®å°±æ˜¯å¢åŠ äº†ä¸€ä¸ªå¸¸é‡æšä¸¾å€¼ï¼Œé‚£ä¹ˆåœ¨`Vue3`å†…éƒ¨ï¼Œè¿™äº›å¸¸é‡éƒ½æ˜¯ä»¥`__v`å¼€å¤´çš„ï¼Œ`IS_REACTIVE`è¿™ä¸ªå¸¸é‡å°±ä»£è¡¨ç€æ˜¯å¦æ˜¯ä¸€ä¸ªå·²ç»è¢«ä»£ç†çš„`reactive`å¯¹è±¡ã€‚æ–°å¢çš„ä»£ç éå¸¸ç®€æ´ï¼Œæˆ‘ä»¬ç®€å•è¿‡ä¸€éæ•´ä½“çš„æµç¨‹ã€‚

é¦–å…ˆï¼Œå½“ä¸€ä¸ªæ™®é€šå¯¹è±¡ç¬¬ä¸€æ¬¡è¢«ä¼ å…¥è¿›`reactive`ä¸­çš„æ—¶å€™ï¼Œ`target[ReactiveFlags.IS_REACTIVE]`è‚¯å®šæ˜¯`undefined`ï¼Œè¿™ä¸ªæ¯«æ— ç–‘é—®ï¼Œè¿”å›çš„å€¼æˆ‘ä»¬ç§°ä¸º`proxy1`ã€‚

æ³¨æ„é‡ç‚¹æ¥äº†ï¼Œå½“æˆ‘ä»¬å†æ¬¡å°†`proxy1`ä¼ å…¥åˆ°`reactive`ä¸­çš„æ—¶å€™ï¼Œå› ä¸º`proxy1`å·²ç»æ˜¯ä¸€ä¸ª**è¢«ä»£ç†çš„å¯¹è±¡**äº†ï¼Œæ‰€ä»¥åœ¨ç»è¿‡`if(target[ReactiveFlags.IS_REACTIVE]) return target`è¿™è¡Œä»£ç çš„æ—¶å€™ï¼Œå› ä¸º`target[ReactiveFlags.IS_REACTIVE]`æ˜¯ä¸€ä¸ªå–å€¼æ“ä½œï¼Œæ‰€ä»¥å°±ä¼šå‘½ä¸­`get`ä¸­çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯å‘½ä¸­è¿™è¡Œä»£ç `if (key === ReactiveFlags.IS_REACTIVE) return true`ï¼Œè¿”å›äº†`true`ï¼Œå› ä¸ºè¿”å›äº†`true`ï¼Œæ‰€ä»¥æ ¹æ®åè¾¹çš„é€»è¾‘ï¼Œå°±ç›´æ¥`return target`ï¼Œå°†`proxy1`è‡ªå·±ç›´æ¥è¿”å›äº†ã€‚

å¥½å¥½å“å‘³ä¸€ä¸‹è¿™æ®µé€»è¾‘ï¼Œéå¸¸çš„å·§å¦™ã€‚åˆ°è¿™é‡Œï¼Œ`reactive`çš„æ ¸å¿ƒå†…å®¹æˆ‘ä»¬å·²ç»å®Œæˆäº†ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ–¹æ³•ï¼Œå’Œç»†èŠ‚ï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸å†å¤šè¯´ï¼Œä¹‹ååˆ†ææºç çš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°å†å»è®²è§£åˆ†æã€‚

### ç¼–å†™`effect`æ–¹æ³•

reactivity/src/effect.ts æ–‡ä»¶ï¼š

```javascript
// 2.ç¼–å†™ReactiveEffectç±»
class ReactiveEffect {
  constructor(public fn) { }
  run() {
    // æ‰§è¡Œä¼ å…¥çš„å‡½æ•°
    return this.fn()
  }
}

// 1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”å¼effectå¯¼å‡ºï¼Œå¹¶ä¸”è®©effecté¦–å…ˆé»˜è®¤æ‰§è¡Œ
export function effect(fn) {
  const _effect = new ReactiveEffect(fn)
  _effect.run()
}
```

é‚£ä¹ˆï¼Œ`effect`çš„æœ€åŸºæœ¬æ¶å­ï¼Œå°±æ­èµ·æ¥äº†ã€‚æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„æ­¥éª¤ï¼Œ`effect`æ˜¯æ€ä¹ˆå’Œ`reactive`å»ºç«‹èµ·è”ç³»ï¼Œäº§ç”Ÿå…³è”çš„å‘¢ï¼Ÿ

æ¢å¥è¯è®²ï¼Œå½“æˆ‘ä»¬å®šä¹‰çš„`reactive`å˜é‡ä¸­çš„å€¼å‘ç”Ÿå˜åŒ–äº†ï¼Œæ˜¯æ€ä¹ˆæ‰§è¡Œç›¸åº”`effect`çš„å‡½æ•°å‘¢ï¼Ÿ

æœ‰äº›æœ‹å‹è‡ªç„¶è€Œç„¶å°±æƒ³åˆ°äº†ä¾èµ–æ”¶é›†ã€è§¦å‘æ›´æ–°è¿™ä¸¤ä¸ªè¯ï¼Œåˆ«æ€¥ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥åˆ†æï¼Œå…¶å®å»ºç«‹è”ç³»ç”¨åˆ°äº†ä¸€ä¸ªå¾ˆå·§å¦™çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯å¯¼å‡ºä¸€ä¸ªå˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±ä»£è¡¨ç€`effect`çš„å®ä¾‹ï¼Œä»`reactive`æ¨¡å—ä¸­å†å¯¼å…¥è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºå»ºç«‹èµ·äº†è”ç³»ï¼Œæˆ‘ä»¬çœ‹å…·ä½“ä»£ç ï¼š

reactivity/src/effect.ts æ–‡ä»¶

```javascript
// 3ã€å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect
export let activeEffect = undefined
// 2.ç¼–å†™ReactiveEffectç±»
class ReactiveEffect {
  constructor(public fn) { }
  run() {
    // 4.è®¾ç½®æ­£åœ¨è¿è¡Œçš„æ˜¯å½“å‰effect
    activeEffect = this
    // æ‰§è¡Œä¼ å…¥çš„å‡½æ•°
    return this.fn()
  }
}

// 1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”å¼effectå¯¼å‡ºï¼Œå¹¶ä¸”è®©effecté¦–å…ˆé»˜è®¤æ‰§è¡Œ
export function effect(fn) {
  const _effect = new ReactiveEffect(fn)
  _effect.run()
}
```

æ²¡é”™ï¼Œå°±æ˜¯è¿™ä¸¤è¡Œç®€å•çš„ä»£ç ï¼Œå…¶å®å°±è§£é‡Šäº†ä¾èµ–æ”¶é›†ï¼Œæ˜¯æ€ä¹ˆæ”¶é›†çš„ã€‚æˆ‘ä»¬å¯ä»¥å…ˆåœ¨`reactive`æ¨¡å—ä¸­å¯¼å…¥è¿™ä¸ªå˜é‡ï¼Œç®€å•çš„è°ƒè¯•çœ‹ä¸‹ç»“æœï¼š

reactivity/src/reactive.ts

```javascript
import { activeEffect } from './effect'
// å‰é¢çš„ä»£ç çœç•¥

get() {
  // å‰é¢çš„ä»£ç çœç•¥

  console.log(activeEffect)

  // åé¢çš„ä»£ç çœç•¥
}
// åé¢çš„ä»£ç çœç•¥
```

å¤šä½™çš„ä»£ç ä¸å†™äº†ï¼Œä¸ºäº†æ¸…æ™°ï¼Œæˆ‘ä»¬åªå†™è°ƒè¯•ä»£ç ã€‚åˆ·æ–°é¡µé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œ`effect`æ–¹æ³•ä¸­ä¼ å…¥çš„å‡½æ•°æ—¶ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å‡½æ•°ä¸­ä½¿ç”¨åˆ°äº†`reactive`å®šä¹‰çš„å˜é‡ï¼Œæ‰€ä»¥å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°`activeEffect`è¢«æˆåŠŸçš„æ‰“å°äº†å‡ºæ¥ï¼Œè‡³æ­¤ï¼Œ`effect`å’Œ`reactive`ä¹‹é—´æˆåŠŸå»ºç«‹äº†è”ç³»ã€‚åç»­æ‰€æœ‰çš„ä»£ç éƒ½æ˜¯å»ºç«‹åœ¨è¿™æ¡ä¹‹ä¸Šçš„ã€‚

æœ‰èªæ˜çš„å°ä¼™ä¼´å¯èƒ½æœ‰ç–‘é—®äº†ï¼Œé‚£å¦‚æœæˆ‘ä»¬åœ¨`index.html`ä¸­ï¼Œè°ƒç”¨äº† 2 æ¬¡æˆ–å¤šæ¬¡`effect`å‡½æ•°ï¼ŒæŒ‰ç°åœ¨çš„ä»£ç ä¸å°±æœ‰é—®é¢˜äº†ä¹ˆï¼Œå› ä¸º`run`äº†å¤šæ¬¡ä¹‹åï¼Œæˆ–è€…åœ¨`effect`å¤–éƒ¨åˆæ”¹å˜äº†`reactive`å®šä¹‰å˜é‡çš„å€¼ï¼Œé‚£`activeEffect`ä¸å°±ä¹±å¥—äº†ä¹ˆï¼Ÿæ²¡é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯ï¼Œæ¯æ¬¡æ‰§è¡Œ`effect`æ–¹æ³•çš„æ—¶å€™ï¼Œ`activeEffect`éƒ½ä¸ºå½“å‰çš„`effect`ï¼Œè§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å†æ·»åŠ å‡ è¡Œä»£ç ï¼š

reactivity/src/effect.ts æ–‡ä»¶

```javascript
// 3ã€å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect
export let activeEffect = undefined
// 2.ç¼–å†™ReactiveEffectç±»
class ReactiveEffect {
  constructor(public fn) { }
  run() {
    try {
      // 4.è®¾ç½®æ­£åœ¨è¿è¡Œçš„æ˜¯å½“å‰effect
      activeEffect = this
      // æ‰§è¡Œä¼ å…¥çš„å‡½æ•°
      return this.fn()
    } finally {
      // 5.åœ¨æ‰§è¡Œå®Œä¼ å…¥çš„å‡½æ•°åï¼Œå°†activeEffectç½®ç©ºï¼Œè¿™æ ·åšè¿˜æœ‰ä¸ªå¥½å¤„å°±æ˜¯ï¼Œå¦‚æœåœ¨effectæ–¹æ³•å¤–éƒ¨ä½¿ç”¨
      // äº†reactiveå®šä¹‰çš„å˜é‡ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«ç›‘å¬åˆ°ï¼Œå› ä¸ºæ­¤æ—¶activeEffectå·²ç»è¢«ç½®ä¸ºnulläº†
      activeEffect = null
    }
  }
}
// 1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”å¼effectå¯¼å‡ºï¼Œå¹¶ä¸”è®©effecté¦–å…ˆé»˜è®¤æ‰§è¡Œ
export function effect(fn) {
  const _effect = new ReactiveEffect(fn)
  _effect.run()
}
```

æˆ‘ä»¬ç»§ç»­ï¼Œé‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œå¦‚æœæŒ‰ç…§ç°åœ¨æˆ‘ä»¬çš„`effect`ä¸­çš„ä»£ç ï¼Œå¦‚æœåœ¨ä½¿ç”¨`effect`æ–¹æ³•çš„æ—¶å€™ï¼Œè¿›è¡Œäº†åµŒå¥—è°ƒç”¨ï¼Œé‚£`activeEffect`å°±ä¼šå‡º`bug`äº†ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬æ”¹å˜ä¸€ä¸‹`index.html`ä¸­çš„ä»£ç ï¼Œç„¶åç¨åŠ åˆ†æã€‚

```html
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
	</head>

	<body>
		<div id="app"></div>
		<script type="module">
			import { effect, reactive } from "./reactivity.esm-browser.js";
			const state = reactive({ name: "å¼ ä¸‰", age: 18 });
			effect(() => {
				app.innerHTML = state.name + ": " + state.age;
				effect(() => {
					app.innerHTML = state.name;
				});
				app.innerHTML = state.age;
			});
		</script>
	</body>
</html>
```

æˆ‘ä»¬ä»”ç»†åˆ†æä¸‹åµŒå¥—éƒ¨åˆ†çš„ä»£ç ï¼š

å½“è°ƒç”¨å¤–éƒ¨çš„`effect`æ–¹æ³•æ—¶ï¼Œ`activeEffect`ä¸ºå¤–éƒ¨çš„`effect`ï¼Œæˆ‘ä»¬è¿™é‡Œç®€ç§°`outer effect`ï¼Œç´§æ¥ç€ï¼Œåˆè°ƒç”¨äº†å†…éƒ¨çš„`effect`æ–¹æ³•ï¼Œé‚£ä¹ˆæŒ‰ç…§æˆ‘ä»¬ç°æœ‰çš„`effect`é€»è¾‘ï¼Œæ­¤æ—¶`activeEffect`åˆä¼šå˜ä¸ºå†…éƒ¨çš„`effect`ï¼Œæˆ‘ä»¬ç®€ç§°`inner effect`ï¼Œæ³¨æ„ï¼Œæ­¤æ—¶æˆ‘ä»¬å†…éƒ¨çš„`effect`æ‰§è¡Œå®Œæ¯•åï¼ŒæŒ‰ç…§ç°æœ‰é€»è¾‘ï¼Œ`activeEffect`ä¼šæ¸…ç©ºå˜ä¸º`null`ï¼Œä½†æ˜¯æ­¤æ—¶å¤–éƒ¨çš„`effect`å¹¶æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œè¿˜å‰©ä¸€å¥`app.innerHTML = state.age`ä»£ç æ²¡æœ‰æ‰§è¡Œï¼Œæ²¡é”™ï¼Œè¿™å°±æœ‰é—®é¢˜äº†ï¼Œå½“å‰çš„`activeEffect`å› ä¸ºè¢«æ¸…ç©ºé‡ç½®ä¸º`null`äº†ï¼Œæ‰€ä»¥å½“å¯¹`state.age`è¿›è¡Œå–å€¼çš„æ—¶å€™ï¼Œ`effect`å’Œ`reactive`ä¹‹é—´çš„è”ç³»å°±æ–­äº†ï¼ˆæ²¡æœ‰è¢«ä¾èµ–æ”¶é›†ï¼‰ï¼Œè€Œæƒ³æ­£ç¡®å»ºç«‹è”ç³»ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„`activeEffect`å°±åº”è¯¥æ˜¯`outer effect`ï¼Œæ€ä¹ˆå»åšå‘¢ï¼Ÿè¿™ç§åµŒå¥—çš„å…³ç³»ï¼Œæ˜¯ä¸æ˜¯å¾ˆåƒæ ‘å½¢ç»“æ„ï¼Ÿæ ‘å‹ç»“æ„çš„ç‰¹ç‚¹å°±æ˜¯æœ‰çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦æ ‡è®°çˆ¶å­å…³ç³»å³å¯ï¼š

reactivity/src/effect.ts æ–‡ä»¶

```javascript
// 3ã€å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect
export let activeEffect = undefined
// 2.ç¼–å†™ReactiveEffectç±»
class ReactiveEffect {
  // 6.è®¾ç½®ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„æ ‡è¯†
  parent = undefined
  constructor(public fn) { }
  run() {
    try {
      // 4.è®¾ç½®æ­£åœ¨è¿è¡Œçš„æ˜¯å½“å‰effect
      activeEffect = this
      // æ‰§è¡Œä¼ å…¥çš„å‡½æ•°
      return this.fn()
    } finally {
      // 5. 6.åˆå¹¶æˆä¸‹æ–¹ä»£ç 
      activeEffect = this.parent // æ‰§è¡Œå®Œå½“å‰effectä¹‹åï¼Œè¿˜åŸactiveEffectä¸ºå½“å‰effectçš„çˆ¶èŠ‚ç‚¹
      this.parent = undefined // é‡ç½®çˆ¶èŠ‚ç‚¹æ ‡è®°
    }
  }
}
// 1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”å¼effectå¯¼å‡ºï¼Œå¹¶ä¸”è®©effecté¦–å…ˆé»˜è®¤æ‰§è¡Œ
export function effect(fn) {
  const _effect = new ReactiveEffect(fn)
  _effect.run()
}
```

è¿™ä¸‹ï¼ŒæŒ‰ç…§ä¸Šè¾¹çš„é€»è¾‘ï¼Œæˆ‘ä»¬å†åˆ†æä¸‹åµŒå¥—é€»è¾‘ï¼Œå°±èƒ½è·‘çš„é€šäº†ï¼Œæ‰€ä»¥å±æ€§å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥åœ¨`reactive`ä¸­çš„`get`ä¸­è¢«ç›‘å¬åˆ°ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å†™ä¹‹å‰å¸¸æåˆ°çš„ä¾èµ–æ”¶é›†å’Œè§¦å‘æ›´æ–°äº†ã€‚

æˆ‘ä»¬å‘ç°ï¼Œ`reactive`å’Œ`effect`æ–¹æ³•ï¼Œå…¶å®æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œå³ä¸€ä¸ª`reactive`ä¸­çš„å±æ€§ï¼Œå¯ä»¥åœ¨å¤šä¸ª`effect`æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œè€Œä¸€ä¸ª`effect`æ–¹æ³•ä¸­ï¼Œåˆå¯ä»¥ä½¿ç”¨å¤šä¸ª`reactive`ä¸­çš„å±æ€§ã€‚

> æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹‹å‰å¸¸è¯´çš„ä¾èµ–æ”¶é›†ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªåå«`track`çš„æ–¹æ³•ï¼Œåœ¨`get`ä¸­æ”¶é›†æ¯ä¸ªå“åº”å¼å±æ€§å¯¹åº”çš„`effect`æ–¹æ³•ï¼Œè®©è¿™ä¸ªå±æ€§å’Œ`effect`äº§ç”Ÿå…³è”ï¼›è€Œè§¦å‘æ›´æ–°ï¼Œåˆ™æ˜¯ä½¿ç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„`trigger`æ–¹æ³•ï¼Œåœ¨`set`ä¸­è§¦å‘æ›´æ–°çš„é€»è¾‘ï¼Œæ‰§è¡Œæ¯ä¸ªå“åº”å¼å±æ€§æ‰€å¯¹åº”çš„`effect`æ–¹æ³•ã€‚

é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆåœ¨`reactive`æ–‡ä»¶ä¸­ï¼Œå¯¼å…¥å¹¶ä¸”è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œä¹‹åï¼Œæˆ‘ä»¬å†å»`effect`æ–‡ä»¶ä¸­å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š

reactivity/src/reactive.ts æ–‡ä»¶

```javascript
import { track, trigger } from "./effect";
// å‰é¢çš„ä»£ç çœç•¥
const mutableHandlers = {
	get(target, key, receiver) {
		if (key === ReactiveFlags.IS_REACTIVE) return true;
		const res = Reflect.get(target, key, receiver);
		// 1. è¿›è¡Œä¾èµ–æ”¶é›†é€»è¾‘
		track(target, key);
		return res;
	},
	set(target, key, value, receiver) {
		let oldValue = target[key];
		Reflect.set(target, key, value, receiver);
		// 2.æ–°æ—§å€¼ä¸ä¸€æ ·çš„æ—¶å€™ï¼Œè§¦å‘æ›´æ–°é€»è¾‘
		if (oldValue !== value) {
			trigger(target, key, value, oldValue);
		}
		return true;
	},
};
// åé¢çš„ä»£ç çœç•¥
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨`effect`ä¸­å†å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š

reactivity/src/effect.ts æ–‡ä»¶

```javascript
// 3ã€å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect
export let activeEffect = undefined
// 2.ç¼–å†™ReactiveEffectç±»
class ReactiveEffect {
  // 6.è®¾ç½®ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„æ ‡è¯†
  parent = undefined
  // å®šä¹‰ä¸€ä¸ªä¾èµ–æ•°ç»„ï¼Œä¿å­˜ç€ä¸€ä¸ªeffectå¯¹åº”äº†å“ªäº›ä¾èµ–
  deps = []
  constructor(public fn) { }
  run() {
    try {
      // 4.è®¾ç½®æ­£åœ¨è¿è¡Œçš„æ˜¯å½“å‰effect
      activeEffect = this
      // æ‰§è¡Œä¼ å…¥çš„å‡½æ•°
      return this.fn()
    } finally {
      // 5. 6.åˆå¹¶æˆä¸‹æ–¹ä»£ç 
      activeEffect = this.parent // æ‰§è¡Œå®Œå½“å‰effectä¹‹åï¼Œè¿˜åŸactiveEffectä¸ºå½“å‰effectçš„çˆ¶èŠ‚ç‚¹
      this.parent = undefined // é‡ç½®çˆ¶èŠ‚ç‚¹æ ‡è®°
    }
  }
}
// 1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”å¼effectå¯¼å‡ºï¼Œå¹¶ä¸”è®©effecté¦–å…ˆé»˜è®¤æ‰§è¡Œ
export function effect(fn) {
  const _effect = new ReactiveEffect(fn)
  _effect.run()
}

// 7. å®ç°ä¾èµ–æ”¶é›†çš„é€»è¾‘
// è®°å½•ä¾èµ–å…³ç³»
const targetMap = new WeakMap()
export function track(target, key) {
  // åªæœ‰åœ¨effectæ–¹æ³•ä¸­æ”¹å˜äº†reactiveå¯¹è±¡ï¼Œæ‰ä¼šè¢«è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå› ä¸ºæ­¤æ—¶activeEffectä¸æ˜¯undefined
  if (activeEffect) {
    // é¦–å…ˆåœ¨targetMapä¸­è·å–target
    let depsMap = targetMap.get(target)
    // å¦‚æœæ²¡æœ‰ï¼Œå°±æ–°å»ºä¸€ä¸ªæ˜ å°„è¡¨ï¼Œè¿™é‡Œä½¿ç”¨Mapæ˜¯å› ä¸ºä¹‹åçš„keyå¯èƒ½æ˜¯å­—ç¬¦ä¸²
    if (!depsMap) {
      targetMap.set(target, (depsMap = new Map()))
    }
    // å¦‚æœæœ‰æ˜ å°„è¡¨ï¼Œå°±æŸ¥æ‰¾æœ‰æ²¡æœ‰å½“å‰çš„å±æ€§
    let dep = depsMap.get(key)
    // å¦‚æœæ²¡æœ‰è¿™ä¸ªå±æ€§ï¼Œå°±ä½¿ç”¨Setæ·»åŠ ä¸€ä¸ªé›†åˆ
    if (!dep) {
      depsMap.set(key, (dep = new Set()))
    }
    // åˆ¤æ–­å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå†å»æ·»åŠ 
    let shouldTrack = !dep.has(activeEffect)
    if (shouldTrack) {
      // åœ¨åŒä¸€ä¸ªeffectä¸­ï¼Œå¦‚æœå¤šæ¬¡ä½¿ç”¨åŒä¸€å±æ€§ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å¤šæ¬¡è¿›è¡Œä¾èµ–æ”¶é›†
      dep.add(activeEffect)
      activeEffect.deps.push(dep) // åœ¨effectä¸­è®°å½•æ‰€æœ‰ä¾èµ–ï¼Œåç»­ä¾¿äºæ¸…ç†ï¼ˆå¤šå¯¹å¤šè”ç³»å»ºç«‹ï¼‰
    }
  }
}

// 8. å®ç°è§¦å‘æ›´æ–°
export function trigger(target, key, newValue, oldValue) {
  // é€šè¿‡å¯¹è±¡æ‰¾åˆ°å¯¹åº”å±æ€§ï¼Œè®©è¿™ä¸ªå±æ€§å¯¹åº”çš„effecté‡æ–°æ‰§è¡Œ
  const depsMap = targetMap.get(target) // è·å–å¯¹åº”çš„æ˜ å°„è¡¨
  if (!depsMap) return
  const dep = depsMap.get(key) // å±æ€§å¯¹åº”çš„æ‰€æœ‰effecté›†åˆï¼Œæ˜¯ä¸ªset
  dep && dep.forEach(effect => {
    // æ‰§è¡Œæ¯ä¸ªeffectä¸­çš„runæ–¹æ³•ï¼›æ­£åœ¨æ‰§è¡Œçš„effectï¼Œä¸è¦å¤šæ¬¡æ‰§è¡Œï¼Œé˜²æ­¢æ­»å¾ªç¯
    if (effect !== activeEffect) effect.run()
  })
}
```

é‚£ä¹ˆæ³¨æ„ï¼Œæ­¤æ—¶çš„æ•°æ®ç»“æ„ï¼Œå¾ˆå¯èƒ½ä¼šè®©äººå¾ˆæ™•ä¹ï¼Œæˆ‘ä»¬ç¨ä½œè§£é‡Šï¼š

```bash
# è¿™é‡Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰“åŒ…ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥æ”¾è¿›ä»£ç å—é‡Œ
æ­¤æ—¶çš„ `targetMap` å¤§è‡´ä¸Šåº”è¯¥æ˜¯é•¿è¿™ä¸ªæ ·å­çš„ï¼ˆæ³¨æ„ï¼Œkey æ˜¯å¯¹è±¡ï¼‰ï¼š`{{name: 'xxx', age: xxx}: {'name': [dep]}}`ï¼Œä¹Ÿå°±æ˜¯ `weakMap : map : set` è¿™ç§ç»“æ„ã€‚

`targetMap`çš„`key`æ˜¯æ•´ä¸ªå¯¹è±¡ï¼Œ`value`æ˜¯ä¸€ä¸ª`map`ç»“æ„ï¼Œ`map` ç»“æ„çš„ `key` æ˜¯å±æ€§ï¼Œ`value`æ˜¯ `set` ç»“æ„ï¼Œå­˜å‚¨å’Œå±æ€§å¯¹åº”çš„ä¸€ä¸ªä¸ª `effect`ï¼Œå¦‚æœè¿˜æ˜¯ä¸æ¸…æ¥šï¼Œé‚£ä¹ˆå¯ä»¥å°† `targetMap` æ‰“å°åœ¨æ§åˆ¶å°ä¸­ã€‚

å…³äºç¬¬ 8 æ­¥éª¤ `trigger` ä¸­ï¼Œåœ¨å¾ªç¯è°ƒç”¨ `effect.run` æ–¹æ³•å‰ï¼Œä¼šæœ‰ä¸€ä¸ªé˜²æ­¢æ­»å¾ªç¯çš„åˆ¤æ–­ï¼Œè¿™æ˜¯å•¥æ„æ€å‘¢ï¼Ÿ
```

å¦‚æœåœ¨ `index.html` ä¸­ï¼Œè¿™æ ·è°ƒç”¨`effect`æ–¹æ³•çš„è¯ï¼š

```javascript
effect(() => {
	// æ¯æ¬¡ä¿®æ”¹state.nameéƒ½æ˜¯æ–°çš„éšæœºæ•°
	state.name = Math.random();
	app.innerHTML = state.name + ":" + state.age;
});
```

å¾ˆæ˜æ˜¾ï¼Œä¸Šè¿°ä»£ç å°±å˜æˆäº†æ­»å¾ªç¯ï¼Œå› ä¸ºå½“`state.name`çš„å€¼å‘ç”Ÿå˜åŒ–åï¼Œå°±ä¼šè§¦å‘æ›´æ–°ï¼Œåˆæ‰§è¡Œäº†`effect`æ–¹æ³•ï¼Œè€Œåœ¨æ‰§è¡Œ`effect`æ–¹æ³•çš„æ—¶å€™ï¼Œåˆå› ä¸ºé‡æ–°æ”¹å˜äº†`state.name`çš„å€¼ï¼Œæ‰€ä»¥å°±åˆä¼šè§¦å‘`effect`æ–¹æ³•ï¼Œå°±æˆäº†æ— çº¿é€’å½’çš„æ­»å¾ªç¯ä»£ç ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿™è¾¹è¦åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œè¡¨æ˜å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„`effect`å¦‚æœå’Œ`activeEffect`ä¸ç›¸åŒçš„æ—¶å€™ï¼Œæ‰å»æ‰§è¡Œï¼Œè¿™æ ·ï¼Œå°±ä¸ä¼šé€ æˆè‡ªå·±è°ƒç”¨è‡ªå·±ï¼Œæ­»å¾ªç¯çš„ç»“æœã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ä»£ç ä¾æ—§æœ‰äº›å°é—®é¢˜å¯ä»¥ä¼˜åŒ–ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„åœºæ™¯ï¼Œæ”¹å˜`index.html`ä¸­çš„ä»£ç ï¼š

```html
<script>
	// å‰é¢çš„ä»£ç çœç•¥

	const state = reactive({ name: "å¼ ä¸‰", age: 18, flag: true });
	effect(() => {
		console.log("é¡µé¢åˆ·æ–°");
		app.innerHTML = state.flag ? state.name : state.age;
	});
	setTimeout(() => {
		state.flag = false;
		setTimeout(() => {
			console.log("nameè¢«ä¿®æ”¹äº†");
			state.name = "æå››";
		});
	}, 1000);
</script>
```

æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œè¿™ä¸ªä»£ç ï¼Œä¼šå‘ç°é¡µé¢è¿‡äº† 1 ç§’ï¼Œå˜ä¸ºäº† 18ï¼Œæ§åˆ¶å°çš„ç»“æœå´æ‰“å°äº† 4 è¡Œï¼Œé¡ºåºæ˜¯ï¼š

```bash
é¡µé¢åˆ·æ–°
// 1ç§’å
é¡µé¢åˆ·æ–°
// åˆè¿‡äº†1ç§’å
nameè¢«ä¿®æ”¹äº†
é¡µé¢åˆ·æ–°
```

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ`name`è¢«ä¿®æ”¹åï¼Œä¸åº”è¯¥åˆè§¦å‘ä¸€æ¬¡é¡µé¢åˆ·æ–°çš„é€»è¾‘ï¼Œå› ä¸ºæ­¤æ—¶`flag`å·²ç»å˜ä¸ºäº†`false`ï¼ŒæŒ‰ç†æ¥è¯´ä¾èµ–æ”¶é›†åº”è¯¥åªæ”¶é›†`flag`å’Œ`age`ï¼Œæ‰€ä»¥å½“æ”¹å˜`name`çš„æ—¶å€™ï¼Œä¸ä¼šè§¦å‘æ›´æ–°ã€‚

æˆ‘ä»¬å†æ¢³ç†ä¸‹å½“å‰ä»£ç ï¼Œä¾èµ–æ”¶é›†å’Œè§¦å‘æ›´æ–°çš„æµç¨‹ï¼šä¸€å¼€å§‹`effect`ä¼šç›´æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¼šç›´æ¥è¾“å‡º`é¡µé¢åˆ·æ–°`ï¼Œæ­¤æ—¶ä¾èµ–æ”¶é›†çš„å±æ€§æœ‰`flag`å’Œ`name`ï¼Œè¿‡äº† 1 ç§’é’Ÿï¼Œ`flag`æ”¹ä¸ºäº†`false`ï¼Œæ‰€ä»¥åˆä¼šè§¦å‘é¡µé¢æ›´æ–°ï¼Œæ­¤æ—¶ä¾èµ–æ”¶é›†çš„æ˜¯`flag`å’Œ`age`ï¼ˆæ³¨æ„ï¼Œ`name`çš„ä¾èµ–æ”¶é›†ä¾æ—§å­˜åœ¨ï¼Œæ²¡æœ‰è¢«æ¸…ç†æ‰ï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™ï¼‰ï¼Œåˆè¿‡äº† 1 ç§’é’Ÿï¼Œæ‰“å°äº†`name`è¢«ä¿®æ”¹äº†ï¼Œä½†æ˜¯å› ä¸ºæ­¤æ—¶`name`çš„ä¾èµ–æ”¶é›†ä¾æ—§å­˜åœ¨ï¼Œåœ¨æ”¹äº†`name`çš„å€¼åï¼Œä¾æ—§è§¦å‘äº†`effect`å‡½æ•°ï¼Œæ‰€ä»¥ç´§æ¥ç€å°±æ‰“å°äº†`é¡µé¢åˆ·æ–°`ã€‚

çœ‹åˆ°è¿™ï¼Œæ˜¯ä¸æ˜¯å°±çŸ¥é“é—®é¢˜æ‰€åœ¨å’Œæ€ä¹ˆå»è§£å†³å‘¢ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯åœ¨è¿›è¡Œä¸‹æ¬¡ä¾èµ–æ”¶é›†ä¹‹å‰ï¼Œè¦æŠŠä¹‹å‰çš„ä¾èµ–æ”¶é›†å…ˆè¿›è¡Œæ¸…ç©ºï¼Œè¿™æ ·ï¼Œå°±ä¸ä¼šå­˜åœ¨ä¸Šè¾¹è¿™ç§ï¼Œæ˜æ˜æ²¡æœ‰æ”¶é›†`name`çš„ä¾èµ–ï¼Œä½†æ˜¯å½“æ”¹å˜`name`çš„å€¼åï¼Œé¡µé¢ä¾æ—§è§¦å‘æ›´æ–°çš„æƒ…å†µäº†ã€‚

```javascript
// reactivity/src/effect.ts æ–‡ä»¶

// 3. å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect
export let activeEffect = undefined
// 9-1. å£°æ˜æ¸…ç†effectçš„ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨æ¯æ¬¡ä¾èµ–æ”¶é›†å‰è¿›è¡Œè°ƒç”¨
function cleanupEffect(effect) {
  const { deps } = effect; // æ¸…ç†effect
  for (let i = 0; i < deps.length; i++) {
    deps[i].delete(effect);
  }
  effect.deps.length = 0;
}
// 2.ç¼–å†™ReactiveEffectç±»
class ReactiveEffect {
  // 6.è®¾ç½®ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„æ ‡è¯†
  parent = undefined
  // å®šä¹‰ä¸€ä¸ªä¾èµ–æ•°ç»„ï¼Œä¿å­˜ç€ä¸€ä¸ªeffectå¯¹åº”äº†å“ªäº›ä¾èµ–
  deps = []
  constructor(public fn) { }
  run() {
    try {
      // 4.è®¾ç½®æ­£åœ¨è¿è¡Œçš„æ˜¯å½“å‰effect
      activeEffect = this
      // 9-2. æ¸…ç†ä¸Šä¸€æ¬¡ä¾èµ–æ”¶é›†
      cleanupEffect(this)
      // æ‰§è¡Œä¼ å…¥çš„å‡½æ•°
      return this.fn()
    } finally {
      // 5. 6.åˆå¹¶æˆä¸‹æ–¹ä»£ç 
      activeEffect = this.parent // æ‰§è¡Œå®Œå½“å‰effectä¹‹åï¼Œè¿˜åŸactiveEffectä¸ºå½“å‰effectçš„çˆ¶èŠ‚ç‚¹
      this.parent = undefined // é‡ç½®çˆ¶èŠ‚ç‚¹æ ‡è®°
    }
  }
}
// 1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”å¼effectå¯¼å‡ºï¼Œå¹¶ä¸”è®©effecté¦–å…ˆé»˜è®¤æ‰§è¡Œ
export function effect(fn) {
  const _effect = new ReactiveEffect(fn)
  _effect.run()
}

// 7. å®ç°ä¾èµ–æ”¶é›†çš„é€»è¾‘
// è®°å½•ä¾èµ–å…³ç³»
const targetMap = new WeakMap()
export function track(target, key) {
  // åªæœ‰åœ¨effectæ–¹æ³•ä¸­æ”¹å˜äº†reactiveå¯¹è±¡ï¼Œæ‰ä¼šè¢«è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå› ä¸ºæ­¤æ—¶activeEffectä¸æ˜¯undefined
  if (activeEffect) {
    // é¦–å…ˆåœ¨targetMapä¸­è·å–target
    let depsMap = targetMap.get(target)
    // å¦‚æœæ²¡æœ‰ï¼Œå°±æ–°å»ºä¸€ä¸ªæ˜ å°„è¡¨ï¼Œè¿™é‡Œä½¿ç”¨Mapæ˜¯å› ä¸ºä¹‹åçš„keyå¯èƒ½æ˜¯å­—ç¬¦ä¸²
    if (!depsMap) {
      targetMap.set(target, (depsMap = new Map()))
    }
    // å¦‚æœæœ‰æ˜ å°„è¡¨ï¼Œå°±æŸ¥æ‰¾æœ‰æ²¡æœ‰å½“å‰çš„å±æ€§
    let dep = depsMap.get(key)
    // å¦‚æœæ²¡æœ‰è¿™ä¸ªå±æ€§ï¼Œå°±ä½¿ç”¨Setæ·»åŠ ä¸€ä¸ªé›†åˆ
    if (!dep) {
      depsMap.set(key, (dep = new Set()))
    }
    // åˆ¤æ–­å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå†å»æ·»åŠ 
    let shouldTrack = !dep.has(activeEffect)
    if (shouldTrack) {
      // åœ¨åŒä¸€ä¸ªeffectä¸­ï¼Œå¦‚æœå¤šæ¬¡ä½¿ç”¨åŒä¸€å±æ€§ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å¤šæ¬¡è¿›è¡Œä¾èµ–æ”¶é›†
      dep.add(activeEffect)
      activeEffect.deps.push(dep) // åœ¨effectä¸­è®°å½•æ‰€æœ‰ä¾èµ–ï¼Œåç»­ä¾¿äºæ¸…ç†ï¼ˆå¤šå¯¹å¤šè”ç³»å»ºç«‹ï¼‰
    }
  }
}

// 8. å®ç°è§¦å‘æ›´æ–°
export function trigger(target, key, newValue, oldValue) {
  // é€šè¿‡å¯¹è±¡æ‰¾åˆ°å¯¹åº”å±æ€§ï¼Œè®©è¿™ä¸ªå±æ€§å¯¹åº”çš„effecté‡æ–°æ‰§è¡Œ
  const depsMap = targetMap.get(target) // è·å–å¯¹åº”çš„æ˜ å°„è¡¨
  if (!depsMap) return
  const dep = depsMap.get(key) // å±æ€§å¯¹åº”çš„æ‰€æœ‰effecté›†åˆï¼Œæ˜¯ä¸ªset
  // 9-3 è¿›è¡Œä¸€æ¬¡æ‹·è´ï¼Œé˜²æ­¢è‡ªå·±åˆ é™¤å…ƒç´ çš„åŒæ—¶ï¼Œè‡ªå·±æ·»åŠ ï¼Œé€ æˆæ­»å¾ªç¯
  const effects = [...dep]
  effects && effects.forEach(effect => {
    // æ‰§è¡Œæ¯ä¸ªeffectä¸­çš„runæ–¹æ³•ï¼›æ­£åœ¨æ‰§è¡Œçš„effectï¼Œä¸è¦å¤šæ¬¡æ‰§è¡Œï¼Œé˜²æ­¢æ­»å¾ªç¯
    if (effect !== activeEffect) effect.run()
  })
}
```

æˆ‘ä»¬çœ‹`9-1`æ­¥éª¤ï¼Œé‚£ä¹ˆè¿™æ­¥å°±æ˜¯ç”¨åˆ°äº†æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„`deps = []`è¿™ä¸ªå­˜æ”¾å½“å‰`activeEffect`å¯¹åº”äº†å“ªäº›ä¾èµ–ï¼ˆ`set`ç»“æ„ï¼‰ã€‚

æ‰¾åˆ°åæ¸…ç†æ‰æ‰€æœ‰çš„`effect`ï¼Œå†è¿›è¡Œä¸‹ä¸€æ¬¡çš„ä¾èµ–æ”¶é›†ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆç±»ä¼¼äº"ç¼“å­˜"çš„é—®é¢˜ã€‚

é‚£ä¹ˆåœ¨`9-3`æ­¥éª¤ï¼Œä¸ºä»€ä¹ˆè¦è¿›è¡Œä¸€æ¬¡æ‹·è´å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼ŒåŒæ—¶å¯¹`effect`è¿›è¡Œäº†æ·»åŠ å’Œåˆ é™¤æ“ä½œï¼Œåˆšåˆ å®Œå…ƒç´ ï¼Œå°±åˆæ·»åŠ äº†æ–°å…ƒç´ ï¼Œé‚£å²‚ä¸æ˜¯å¾ªç¯å°±æˆäº†æ­»å¾ªç¯ï¼Œä¸€ç›´è·³ä¸å‡ºæ¥äº†ä¹ˆï¼Œæ‰€ä»¥ï¼Œè§£å†³çš„æ–¹æ³•å°±æ˜¯è¿›è¡Œä¸€æ¬¡æ‹·è´ï¼Œåˆ é™¤å’Œè¿è¡Œåˆ†å¼€è¿›è¡Œï¼Œå°±ä¸ä¼šæœ‰æ­»å¾ªç¯çš„é—®é¢˜äº†ã€‚

ç»è¿‡æˆ‘ä»¬ä¸€æ­¥æ­¥çš„å®Œå–„ï¼Œé‚£ä¹ˆ`effect`çš„ä»£ç å°±é€æ¸æ¥è¿‘å°¾å£°äº†ã€‚æˆ‘ä»¬åŠ æŠŠåŠ²ï¼Œç»§ç»­æ¥!

é‚£ä¹ˆæœ‰ä¸€ç§å¾ˆå¸¸è§çš„åœºæ™¯ï¼Œå½“æˆ‘ä»¬ä»£ç†çš„å¯¹è±¡ï¼Œå†…éƒ¨åˆæœ‰å¾ˆå¤šå¯¹è±¡ï¼Œé‚£è¿™äº›å¯¹è±¡å°±ä¸ä¼šè¢«ä»£ç†ï¼Œæ¯”å¦‚ï¼š

```javascript
const obj = reactive({
	name: "å¼ ä¸‰",
	info: {
		age: 18,
		sex: "ç”·",
	},
});
```

é‚£ä¹ˆè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦è¿›è¡Œé€’å½’ä»£ç†ï¼Œæ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨`reactive.ts`æ–‡ä»¶ä¸­`get`æœ€åæ·»åŠ å‡ è¡Œä»£ç å³å¯ï¼š

```javascript
get(target, key, receiver) {
  // å‰é¢çš„ä»£ç çœç•¥

  if (key === ReactiveFlags.IS_REACTIVE) return true
  const res = Reflect.get(target, key, receiver)
  track(target, key)
  // åˆ¤æ–­å¦‚æœresæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™è¿›è¡Œé€’å½’ä»£ç†
  if(isObject(res)){
      return reactive(res);
  }
  return res
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬å¢åŠ å®ä¾‹çš„ 2 ä¸ªæ–¹æ³•ã€‚å¯¹äº`effect`æ–¹æ³•ï¼Œå…¶å®æ˜¯æœ‰ä¸€ä¸ªè¿”å›å€¼çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹¿åˆ°è¿™è¿”å›å€¼ï¼Œé€šè¿‡è°ƒç”¨é‡Œè¾¹çš„æ–¹æ³•ï¼Œå¯ä»¥æ‰‹åŠ¨è¿›è¡Œæ‰§è¡Œ`effect`ä¸­çš„`run`æ–¹æ³•ï¼Œå’Œåœæ­¢ä¾èµ–æ”¶é›†çš„`stop`æ–¹æ³•ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥å®ç°æ‹¿åˆ°è¿”å›å€¼è¿›è¡Œæ‰‹åŠ¨è°ƒç”¨ï¼ˆç±»ä¼¼äº`Vue`ä¸­çš„`forceUpdate`ï¼Œå¯ä»¥å¼ºåˆ¶åˆ·æ–°ç»„ä»¶ï¼‰ï¼Œå…¶å®åŸç†éå¸¸ç®€å•ï¼Œå°±æŠŠ`new ReactiveEffect(fn)`è¿™ä¸ªç»“æœï¼Œå½“æˆè¿”å›å€¼ä¸å°±å¥½äº†ä¹ˆï¼Œæ²¡é”™ï¼Œä¸è¿‡æœ‰äº›ç»†èŠ‚ï¼Œæˆ‘ä»¬é€šè¿‡å®Œå–„`effect.ts`æ–‡ä»¶æ¥ç»§ç»­çœ‹ï¼š

```javascript
// reactivity/src/effect.ts æ–‡ä»¶

// 3. å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect
export let activeEffect = undefined
// 9-1. å£°æ˜æ¸…ç†effectçš„ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨æ¯æ¬¡ä¾èµ–æ”¶é›†å‰è¿›è¡Œè°ƒç”¨
function cleanupEffect(effect) {
  const { deps } = effect; // æ¸…ç†effect
  for (let i = 0; i < deps.length; i++) {
    deps[i].delete(effect);
  }
  effect.deps.length = 0;
}
// 2.ç¼–å†™ReactiveEffectç±»
class ReactiveEffect {
  // 6.è®¾ç½®ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„æ ‡è¯†
  parent = undefined
  // å®šä¹‰ä¸€ä¸ªä¾èµ–æ•°ç»„ï¼Œä¿å­˜ç€ä¸€ä¸ªeffectå¯¹åº”äº†å“ªäº›ä¾èµ–
  deps = []
  // 11-1. è¡¨ç¤ºå½“å‰å¤„äºæ¿€æ´»æ€ï¼Œè¦è¿›è¡Œä¾èµ–æ”¶é›†
  active = true
  constructor(public fn) { }
  run() {
    // 11-3. å¤±æ´»æ€é»˜è®¤è°ƒç”¨runçš„æ—¶å€™ï¼Œåªæ˜¯é‡æ–°æ‰§è¡Œä¼ å…¥çš„å‡½æ•°ï¼Œå¹¶ä¸ä¼šå‘ç”Ÿä¾èµ–æ”¶é›†
    if (!this.active) {
      return this.fn()
    }
    try {
      // 4.è®¾ç½®æ­£åœ¨è¿è¡Œçš„æ˜¯å½“å‰effect
      activeEffect = this
      // 9-2. æ¸…ç†ä¸Šä¸€æ¬¡ä¾èµ–æ”¶é›†
      cleanupEffect(this)
      // æ‰§è¡Œä¼ å…¥çš„å‡½æ•°
      return this.fn()
    } finally {
      // 5. 6.åˆå¹¶æˆä¸‹æ–¹ä»£ç 
      activeEffect = this.parent // æ‰§è¡Œå®Œå½“å‰effectä¹‹åï¼Œè¿˜åŸactiveEffectä¸ºå½“å‰effectçš„çˆ¶èŠ‚ç‚¹
      this.parent = undefined // é‡ç½®çˆ¶èŠ‚ç‚¹æ ‡è®°
    }
  }
  // 11-2. å£°æ˜stopæ–¹æ³•
  stop() {
    if (this.active) {
      // å¤±æ´»å°±åœæ­¢ä¾èµ–æ”¶é›†
      this.active = false
      cleanupEffect(this)
    }
  }
}
// 1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”å¼effectå¯¼å‡ºï¼Œå¹¶ä¸”è®©effecté¦–å…ˆé»˜è®¤æ‰§è¡Œ
export function effect(fn) {
  const _effect = new ReactiveEffect(fn)
  _effect.run()
  // 10. ç»™effectæ·»åŠ ä¸€ä¸ªè¿”å›å€¼ï¼Œé€šè¿‡è¿™ä¸ªè¿”å›å€¼å¯ä»¥è°ƒç”¨_effectå®ä¾‹ä¸­çš„stopå’Œrunç­‰æ–¹æ³•
  const runner = _effect.run.bind(_effect)
  runner.effect = _effect
  return runner
}

// 7. å®ç°ä¾èµ–æ”¶é›†çš„é€»è¾‘
// è®°å½•ä¾èµ–å…³ç³»
const targetMap = new WeakMap()
export function track(target, key) {
  // åªæœ‰åœ¨effectæ–¹æ³•ä¸­æ”¹å˜äº†reactiveå¯¹è±¡ï¼Œæ‰ä¼šè¢«è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå› ä¸ºæ­¤æ—¶activeEffectä¸æ˜¯undefined
  if (activeEffect) {
    // é¦–å…ˆåœ¨targetMapä¸­è·å–target
    let depsMap = targetMap.get(target)
    // å¦‚æœæ²¡æœ‰ï¼Œå°±æ–°å»ºä¸€ä¸ªæ˜ å°„è¡¨ï¼Œè¿™é‡Œä½¿ç”¨Mapæ˜¯å› ä¸ºä¹‹åçš„keyå¯èƒ½æ˜¯å­—ç¬¦ä¸²
    if (!depsMap) {
      targetMap.set(target, (depsMap = new Map()))
    }
    // å¦‚æœæœ‰æ˜ å°„è¡¨ï¼Œå°±æŸ¥æ‰¾æœ‰æ²¡æœ‰å½“å‰çš„å±æ€§
    let dep = depsMap.get(key)
    // å¦‚æœæ²¡æœ‰è¿™ä¸ªå±æ€§ï¼Œå°±ä½¿ç”¨Setæ·»åŠ ä¸€ä¸ªé›†åˆ
    if (!dep) {
      depsMap.set(key, (dep = new Set()))
    }
    // åˆ¤æ–­å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå†å»æ·»åŠ 
    let shouldTrack = !dep.has(activeEffect)
    if (shouldTrack) {
      // åœ¨åŒä¸€ä¸ªeffectä¸­ï¼Œå¦‚æœå¤šæ¬¡ä½¿ç”¨åŒä¸€å±æ€§ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å¤šæ¬¡è¿›è¡Œä¾èµ–æ”¶é›†
      dep.add(activeEffect)
      activeEffect.deps.push(dep) // åœ¨effectä¸­è®°å½•æ‰€æœ‰ä¾èµ–ï¼Œåç»­ä¾¿äºæ¸…ç†ï¼ˆå¤šå¯¹å¤šè”ç³»å»ºç«‹ï¼‰
    }
  }
}

// 8. å®ç°è§¦å‘æ›´æ–°
export function trigger(target, key, newValue, oldValue) {
  // é€šè¿‡å¯¹è±¡æ‰¾åˆ°å¯¹åº”å±æ€§ï¼Œè®©è¿™ä¸ªå±æ€§å¯¹åº”çš„effecté‡æ–°æ‰§è¡Œ
  const depsMap = targetMap.get(target) // è·å–å¯¹åº”çš„æ˜ å°„è¡¨
  if (!depsMap) return
  const dep = depsMap.get(key) // å±æ€§å¯¹åº”çš„æ‰€æœ‰effecté›†åˆï¼Œæ˜¯ä¸ªset
  // 9-3 è¿›è¡Œä¸€æ¬¡æ‹·è´ï¼Œé˜²æ­¢è‡ªå·±åˆ é™¤å…ƒç´ çš„åŒæ—¶ï¼Œè‡ªå·±æ·»åŠ ï¼Œé€ æˆæ­»å¾ªç¯
  const effects = [...dep]
  effects && effects.forEach(effect => {
    // æ‰§è¡Œæ¯ä¸ªeffectä¸­çš„runæ–¹æ³•ï¼›æ­£åœ¨æ‰§è¡Œçš„effectï¼Œä¸è¦å¤šæ¬¡æ‰§è¡Œï¼Œé˜²æ­¢æ­»å¾ªç¯
    if (effect !== activeEffect) effect.run()
  })
}
```

æˆ‘ä»¬ç›´æ¥çœ‹`æ­¥éª¤10`ï¼Œè¿™æ ·å†™çš„å¥½å¤„å°±æ˜¯`const runner = effect(() => { console.log('é¡µé¢åˆ·æ–°') app.innerHTML = state.name })`ï¼Œåœ¨é€šè¿‡ä¸Šè¿°æ–¹å¼æ‹¿åˆ°äº†è¿”å›å€¼`runner`åï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ`runner()`æ–¹æ³•ï¼Œæˆ–`runner.effect.run()`æ–¹æ³•ï¼Œè¿›è¡Œæ‰‹åŠ¨åˆ·æ–°é¡µé¢ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹`index.html`æ–‡ä»¶ï¼Œæ¥å°è¯•ç”¨ä¸‹è¿™ä¸ªåŠŸèƒ½ï¼Œä¸ç„¶åªè¯´æ¦‚å¿µï¼Œæ²¡æœ‰åœºæ™¯ï¼Œå¾ˆéš¾ç†è§£ã€‚

```html
<script>
	import { effect, reactive } from "./reactivity.js";
	const state = reactive({ name: "å¼ ä¸‰", age: 18, flag: true });
	let a = "æå››";
	const runner = effect(() => {
		app.innerHTML = state.name + a;
	});
	setTimeout(() => {
		a = "ç‹äº”";
		runner();
	}, 1000);
</script>
```

é€šè¿‡ä¸Šè¾¹çš„ä»£ç ï¼Œæˆ‘ä»¬æ‰§è¡Œåå‘ç°ï¼Œé¡µé¢åœ¨ 1 ç§’é’Ÿåï¼Œè¿˜æ˜¯å‘ç”Ÿäº†æ”¹å˜ï¼Œè™½ç„¶æˆ‘ä»¬åªæ˜¯åœ¨å®šæ—¶å™¨é‡Œè¾¹æ”¹äº†å˜é‡`a`çš„å€¼ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬è¿›è¡Œäº†æ‰‹åŠ¨è§¦å‘`effect.run()`æ–¹æ³•ï¼Œæ‰€ä»¥é¡µé¢è¿˜æ˜¯ä¼šæ›´æ–°çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­çœ‹ä»€ä¹ˆå«åšåœæ­¢ä¾èµ–æ”¶é›†ã€‚

çœ‹æ­¥éª¤`11-1~11-3`ï¼Œéå¸¸æ˜ç¡®ï¼Œå¦‚æœè°ƒç”¨äº†`stop`æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šåœæ­¢æ‰€æœ‰çš„ä¾èµ–æ”¶é›†ï¼Œå¹¶ä¸”å°±ç®—ä¹‹åè¿›è¡Œäº†æ‰‹åŠ¨è°ƒç”¨`runner.run()`æ–¹æ³•ï¼Œå› ä¸ºæ­¥éª¤`11-3`ï¼Œæ‰€ä»¥ä¹Ÿåªæ˜¯ä¼šå†æ¬¡è°ƒç”¨`effect`ä¸­ä¼ å…¥çš„å‡½æ•°ï¼Œå¹¶ä¸ä¼šè¿›è¡Œä¾èµ–æ”¶é›†å’Œè§¦å‘æ›´æ–°ã€‚

åˆ°è¿™é‡Œï¼Œ`effect`å°±æ¥è¿‘å°¾å£°äº†ï¼Œé‚£ä¹ˆä¸ºäº†å’Œä¸‹ç¯‡æ–‡ç« è¿›è¡Œæ¥è½¨ï¼Œæˆ‘ä»¬å†è®²æœ€åçš„ä¸€ä¸ªä¼˜åŒ–ç‚¹ã€‚ä¸Šæ–‡æåˆ°äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ`runner()æˆ–runner.effect.run()`æ–¹æ³•è¿›è¡Œé¡µé¢çš„å¼ºåˆ¶æ›´æ–°ï¼Œä½†æ˜¯è¿™ä¸ª`runner`æ–¹æ³•ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯å†™åœ¨`effect`æ–¹æ³•ä¹‹å¤–çš„åœ°æ–¹ï¼Œèƒ½ä¸èƒ½æƒ³ä¸ªåŠæ³•ï¼Œå°†è¿™ä¸ªé€»è¾‘æ”¾åœ¨`effect`æ–¹æ³•ä¸­å‘¢ï¼Ÿæˆ‘ä»¬å¯¹`index.html`ç¨åŠ æ”¹é€ ï¼Œç„¶åæ ¹æ®æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ç»“æ„ï¼Œæ¥åå‘æ¨æ–­ä»£ç åº”è¯¥å¦‚ä½•å†™ï¼Œæˆ‘ä»¬æƒ³è¦çš„ç»“æœæ˜¯è¿™æ ·ï¼š

```html
<script>
	import { effect, reactive } from "./reactivity.js";
	const state = reactive({ name: "å¼ ä¸‰", age: 18 });
	const runner = effect(
		() => {
			app.innerHTML = state.name;
			console.log("æˆ‘æ‰§è¡Œå•¦");
		},
		{
			scheduler: () => {
				setTimeout(() => {
					console.log("é¡µé¢é‡æ–°åˆ·æ–°äº†");
					runner();
				}, 1000);
			},
		}
	);
	setTimeout(() => {
		state.name = "ç‹äº”";
		console.log("åå­—æ”¹å˜äº†");
	}, 1000);
</script>
```

æˆ‘ä»¬ç»™`effect`æ–¹æ³•ï¼Œæä¾›ç¬¬äºŒä¸ªå‚æ•°ï¼Œå‚æ•°ä¸­æœ‰ä¸€ä¸ª`scheduler`å±æ€§ï¼Œè¿™ä¸ªå±æ€§å°±å¯¹åº”ç€æˆ‘ä»¬åˆšæ‰å®šæ—¶å™¨ä¸­çš„é€»è¾‘ã€‚

æˆ‘ä»¬æœŸæœ›çš„ç»“æœæ˜¯ï¼Œè¿‡äº† 1 ç§’é’Ÿï¼Œ`state.name = 'ç‹äº”'`å‘ç”Ÿæ”¹å˜åï¼Œè§¦å‘çš„æ˜¯æˆ‘ä»¬`effect`æ–¹æ³•ä¸­ç¬¬äºŒä¸ªå‚æ•°ä¸­çš„`scheduler`å¯¹åº”çš„é€»è¾‘ï¼Œè€Œä¸æ˜¯`effect`æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå›è°ƒé€»è¾‘ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†å½“ä¾èµ–å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œè‡ªå·±çš„é€»è¾‘ã€‚æƒ³è¦çš„æ•ˆæœå¾ˆæ˜ç¡®äº†ï¼Œé‚£æˆ‘ä»¬æ¥å®Œå–„ä¸‹é€»è¾‘å§ï¼

```javascript
// reactivity/src/effect.ts æ–‡ä»¶

// 3. å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect
export let activeEffect = undefined
// 9-1. å£°æ˜æ¸…ç†effectçš„ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨æ¯æ¬¡ä¾èµ–æ”¶é›†å‰è¿›è¡Œè°ƒç”¨
function cleanupEffect(effect) {
  const { deps } = effect; // æ¸…ç†effect
  for (let i = 0; i < deps.length; i++) {
    deps[i].delete(effect);
  }
  effect.deps.length = 0;
}
// 2.ç¼–å†™ReactiveEffectç±»
class ReactiveEffect {
  // 6.è®¾ç½®ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„æ ‡è¯†
  parent = undefined
  // å®šä¹‰ä¸€ä¸ªä¾èµ–æ•°ç»„ï¼Œä¿å­˜ç€ä¸€ä¸ªeffectå¯¹åº”äº†å“ªäº›ä¾èµ–
  deps = []
  // 11-1. è¡¨ç¤ºå½“å‰å¤„äºæ¿€æ´»æ€ï¼Œè¦è¿›è¡Œä¾èµ–æ”¶é›†
  active = true
  // 12-2. å°†scheduleræŒ‚è½½effectå®ä¾‹ä¸Š
  constructor(public fn, public scheduler) { }
  run() {
    // 11-3. å¤±æ´»æ€é»˜è®¤è°ƒç”¨runçš„æ—¶å€™ï¼Œåªæ˜¯é‡æ–°æ‰§è¡Œä¼ å…¥çš„å‡½æ•°ï¼Œå¹¶ä¸ä¼šå‘ç”Ÿä¾èµ–æ”¶é›†
    if (!this.active) {
      return this.fn()
    }
    try {
      // 4.è®¾ç½®æ­£åœ¨è¿è¡Œçš„æ˜¯å½“å‰effect
      activeEffect = this
      // 9-2. æ¸…ç†ä¸Šä¸€æ¬¡ä¾èµ–æ”¶é›†
      cleanupEffect(this)
      // æ‰§è¡Œä¼ å…¥çš„å‡½æ•°
      return this.fn()
    } finally {
      // 5. 6.åˆå¹¶æˆä¸‹æ–¹ä»£ç 
      activeEffect = this.parent // æ‰§è¡Œå®Œå½“å‰effectä¹‹åï¼Œè¿˜åŸactiveEffectä¸ºå½“å‰effectçš„çˆ¶èŠ‚ç‚¹
      this.parent = undefined // é‡ç½®çˆ¶èŠ‚ç‚¹æ ‡è®°
    }
  }
  // 11-2. å£°æ˜stopæ–¹æ³•
  stop() {
    if (this.active) {
      // å¤±æ´»å°±åœæ­¢ä¾èµ–æ”¶é›†
      this.active = false
      cleanupEffect(this)
    }
  }
}
// 1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“åº”å¼effectå¯¼å‡ºï¼Œå¹¶ä¸”è®©effecté¦–å…ˆé»˜è®¤æ‰§è¡Œ
export function effect(fn, options: any = {}) {
  // 12-1. æ·»åŠ options.schedulerçš„ä¼ å‚
  const _effect = new ReactiveEffect(fn, options.scheduler)
  _effect.run()
  // 10. ç»™effectæ·»åŠ ä¸€ä¸ªè¿”å›å€¼ï¼Œé€šè¿‡è¿™ä¸ªè¿”å›å€¼å¯ä»¥è°ƒç”¨_effectå®ä¾‹ä¸­çš„stopå’Œrunç­‰æ–¹æ³•
  const runner = _effect.run.bind(_effect)
  runner.effect = _effect
  return runner
}

// 7. å®ç°ä¾èµ–æ”¶é›†çš„é€»è¾‘
// è®°å½•ä¾èµ–å…³ç³»
const targetMap = new WeakMap()
export function track(target, key) {
  // åªæœ‰åœ¨effectæ–¹æ³•ä¸­æ”¹å˜äº†reactiveå¯¹è±¡ï¼Œæ‰ä¼šè¢«è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå› ä¸ºæ­¤æ—¶activeEffectä¸æ˜¯undefined
  if (activeEffect) {
    // é¦–å…ˆåœ¨targetMapä¸­è·å–target
    let depsMap = targetMap.get(target)
    // å¦‚æœæ²¡æœ‰ï¼Œå°±æ–°å»ºä¸€ä¸ªæ˜ å°„è¡¨ï¼Œè¿™é‡Œä½¿ç”¨Mapæ˜¯å› ä¸ºä¹‹åçš„keyå¯èƒ½æ˜¯å­—ç¬¦ä¸²
    if (!depsMap) {
      targetMap.set(target, (depsMap = new Map()))
    }
    // å¦‚æœæœ‰æ˜ å°„è¡¨ï¼Œå°±æŸ¥æ‰¾æœ‰æ²¡æœ‰å½“å‰çš„å±æ€§
    let dep = depsMap.get(key)
    // å¦‚æœæ²¡æœ‰è¿™ä¸ªå±æ€§ï¼Œå°±ä½¿ç”¨Setæ·»åŠ ä¸€ä¸ªé›†åˆ
    if (!dep) {
      depsMap.set(key, (dep = new Set()))
    }
    // åˆ¤æ–­å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå†å»æ·»åŠ 
    let shouldTrack = !dep.has(activeEffect)
    if (shouldTrack) {
      // åœ¨åŒä¸€ä¸ªeffectä¸­ï¼Œå¦‚æœå¤šæ¬¡ä½¿ç”¨åŒä¸€å±æ€§ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å¤šæ¬¡è¿›è¡Œä¾èµ–æ”¶é›†
      dep.add(activeEffect)
      activeEffect.deps.push(dep) // åœ¨effectä¸­è®°å½•æ‰€æœ‰ä¾èµ–ï¼Œåç»­ä¾¿äºæ¸…ç†ï¼ˆå¤šå¯¹å¤šè”ç³»å»ºç«‹ï¼‰
    }
  }
}

// 8. å®ç°è§¦å‘æ›´æ–°
export function trigger(target, key, newValue, oldValue) {
  // é€šè¿‡å¯¹è±¡æ‰¾åˆ°å¯¹åº”å±æ€§ï¼Œè®©è¿™ä¸ªå±æ€§å¯¹åº”çš„effecté‡æ–°æ‰§è¡Œ
  const depsMap = targetMap.get(target) // è·å–å¯¹åº”çš„æ˜ å°„è¡¨
  if (!depsMap) return
  const dep = depsMap.get(key) // å±æ€§å¯¹åº”çš„æ‰€æœ‰effecté›†åˆï¼Œæ˜¯ä¸ªset
  // 9-3 è¿›è¡Œä¸€æ¬¡æ‹·è´ï¼Œé˜²æ­¢è‡ªå·±åˆ é™¤å…ƒç´ çš„åŒæ—¶ï¼Œè‡ªå·±æ·»åŠ ï¼Œé€ æˆæ­»å¾ªç¯
  const effects = [...dep]
  effects && effects.forEach(effect => {
    // æ‰§è¡Œæ¯ä¸ªeffectä¸­çš„runæ–¹æ³•ï¼›æ­£åœ¨æ‰§è¡Œçš„effectï¼Œä¸è¦å¤šæ¬¡æ‰§è¡Œï¼Œé˜²æ­¢æ­»å¾ªç¯
    if (effect !== activeEffect) {
      // 12-3. å¦‚æœç”¨æˆ·ä¼ å…¥äº†schedulerï¼Œé‚£ä¹ˆå°±æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰é€»è¾‘ï¼Œå¦åˆ™è¿˜æ˜¯æ‰§è¡Œruné€»è¾‘
      if(effect.scheduler) {
        effect.scheduler()
      }else {
        effect.run()
      }
    }
  })
}
```

é€šè¿‡`12-1~12-3`çš„è¿™ä¸‰ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬ä¸éš¾ç†è§£ï¼Œåªéœ€è¦åœ¨`trigger`æ–¹æ³•ä¸­ï¼Œä¹Ÿå°±æ˜¯è§¦å‘çš„æ—¶å€™é€šè¿‡åˆ¤æ–­æ˜¯å¦ä¼ å…¥äº†`options.scheduler`å±æ€§ï¼Œæ¥æ‰§è¡Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„`scheduler`å‡½æ•°é€»è¾‘æˆ–è€…æ˜¯æ‰§è¡Œé»˜è®¤çš„`effect.run`æ–¹æ³•ã€‚åˆ°æ­¤ï¼Œæˆ‘ä»¬çš„`effect.ts`æ–‡ä»¶å¯ä»¥è¯´æ˜¯æš‚æ—¶å†™å®Œäº†ã€‚

ä»¥ä¸Šï¼Œæˆ‘ä»¬åŸºæœ¬äº†è§£äº†å“åº”å¼çš„æ ¸å¿ƒ`reactive`å’Œ`effect`

### `computed`ã€`watch` å’Œ `ref`æ–¹æ³•çš„å®ç°

#### `watch`çš„å®ç°

æˆ‘ä»¬å…ˆåœ¨`reactive.ts`å’Œ`/shared/src/index.ts`ä¸­å®Œå–„ä¸¤ä¸ªå·¥å…·æ–¹æ³•ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨å®ç°`watch`æ—¶è¿›è¡Œå¯¼å…¥è°ƒç”¨ã€‚

```javascript
// reactive.tsæ–‡ä»¶
// åˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯ä¸æ˜¯ä¸€ä¸ªå“åº”å¼çš„å€¼
export function isReactive(value) {
	return !!(value && value[ReactiveFlags.IS_REACTIVE]);
}
// shared/src/index.ts æ–‡ä»¶
// åˆ¤æ–­ä¼ å…¥çš„å€¼ï¼Œæ˜¯ä¸æ˜¯ä¸€ä¸ªå‡½æ•°
export const isFunction = (value) => {
	return value && typeof value === "function";
};
```

ç„¶ååœ¨`/reactivity/src`ç›®å½•ä¸‹æ–°å»º`apiWatch.ts`æ–‡ä»¶ï¼Œæ¥å†™`watch`çš„ä¸»é€»è¾‘ã€‚é¦–å…ˆæˆ‘ä»¬ç®€å•å›é¡¾ä¸‹`Vue3`ä¸­`watch`çš„å¸¸è§ç”¨æ³•ï¼š

```javascript
const state = reactive({ name: "å¼ ä¸‰", age: 18 });
// ç”¨æ³•1ï¼š
watch(
	() => state.name,
	(newV, oldV) => {
		console.log(newV, oldV);
	}
);
// ç”¨æ³•2ï¼š
watch(state, (newV, oldV) => {
	console.log(newV, oldV);
});
```

é‚£ä¹ˆåœ¨ç”¨åˆ°`watch`çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼ˆå¦‚ç”¨æ³• 1ï¼‰æ¥ç›‘å¬æŸä¸ªå±æ€§çš„å˜åŒ–ï¼Œæœ‰æœ‹å‹å¯èƒ½ä¼šé—®ï¼Œä¸ºå•¥è¦å†™æˆä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ç›´æ¥æŠŠç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥`state.name`ä¸è¡Œä¹ˆï¼Ÿé†’é†’ï¼Œå¿«é†’é†’ï¼åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­`state.name`å°±æ˜¯ä¸ªå®šæ­»çš„å€¼`å¼ ä¸‰`ï¼Œç›‘å¬å¸¸é‡ï¼Œè‚¯å®šæ˜¯ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„å•Šï¼›

åŒæ ·ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¿˜å¯ä»¥ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼ˆå¦‚æ–¹æ³• 2ï¼‰ä½†æ˜¯è¿™ç§æœ‰å‡ ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬ä¸æ¨èï¼Œæ¯”å¦‚å½“ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯å¯¹è±¡ï¼Œå®é™…ä¸Š`watch`ç›‘å¬çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼Œæ‰€ä»¥ï¼Œæ— æ³•åŒºåˆ†`newV`å’Œ`oldV`ï¼Œå¼•ç”¨çš„åœ°å€æ˜¯ä¸€ç›´ä¸å˜çš„ï¼Œæ‰€ä»¥æ‰“å°çš„ç»“æœä¼šå‘ç°ï¼Œè¿™ä¿©å€¼æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯æœ€æ–°çš„å€¼ã€‚è¿˜æœ‰ä¸ªå°é—®é¢˜å°±æ˜¯ï¼Œè™½ç„¶ä½ ä¼ å…¥å‚æ•°çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯åœ¨`watch`æ–¹æ³•çš„å†…éƒ¨ï¼Œä¾æ—§æ˜¯éå†äº†è¿™ä¸ªå¯¹è±¡æ‰€æœ‰çš„`key`ï¼Œå¹¶ä¸”è¿›è¡Œå–å€¼æ“ä½œï¼ˆä¸ºçš„æ˜¯è§¦å‘ä¾èµ–æ”¶é›†ï¼‰ã€‚æ‰€ä»¥ä¼šå¯¹æ€§èƒ½æœ‰æ‰€æŸè€—ï¼Œä¸è¿‡æœ‰æ—¶å€™ä¸ºäº†æ–¹ä¾¿ï¼Œè¿˜æ˜¯å¯ä»¥è¿™ä¹ˆå»å¹²çš„ï¼ˆåæ­£å†…éƒ¨é’ˆå¯¹è¿™ç§æƒ…å†µåšäº†å¤„ç†ï¼Œä»£ç å†™çš„çˆ½å°±è¡Œäº†ï¼Œç®¡ä»–å‘¢ï¼‰ã€‚

æˆ‘ä»¬æ¥ä¸‹æ¥å®ç°`watch`çš„é€»è¾‘ï¼š

```typescript
// /reactivity/src/apiWatch.ts æ–‡ä»¶
import { isReactive } from "./reactive";
import { isFunction, isObject } from "@vue/shared";
import { ReactiveEffect } from "./effect";

function traverse(value, seen = new Set()) {
	if (!isObject(value)) {
		return value;
	}
	if (seen.has(value)) {
		return value;
	}
	seen.add(value);
	for (const key in value) {
		if (value.hasOwnProperty(key)) {
			// å°±æ˜¯å•çº¯çš„å–äº†ä¸‹å€¼ï¼Œæ¯”å¦‚state.nameï¼Œä¸ºäº†è§¦å‘reactiveå¯¹è±¡ä¸­å±æ€§çš„getter
			traverse(value[key], seen);
		}
	}
	return value;
}
// 1. é¦–å…ˆå¯¼å‡ºwatchæ–¹æ³•
export function watch(source, cb, { immediate } = {} as any) {
	// 2. åˆ†ä¸¤ç§æƒ…å†µåˆ¤æ–­ï¼Œsourceæ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡å’Œsourceæ˜¯ä¸€ä¸ªå‡½æ•°
	// è¿™ä¸ªgetterå°±ç›¸å½“äºæ˜¯effectä¸­çš„å›è°ƒå‡½æ•°
	let getter;
	if (isReactive(source)) {
		// 3. å¦‚æœsourceæ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œåº”è¯¥å¯¹sourceé€’å½’è¿›è¡Œå–å€¼
		getter = () => traverse(source);
	} else if (isFunction(source)) {
		getter = source;
	}
	let oldValue;
	// 6. å½“è§¦å‘æ›´æ–°çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å±æ€§æ”¹å˜çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œè¿™ä¸ªjobæ–¹æ³•
	const job = () => {
		const newValue = effect.run();
		cb(newValue, oldValue);
		oldValue = newValue;
	};
	// 4. å½“newçš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œgetteræ–¹æ³•ï¼Œå¼€å§‹è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œæ•°æ®å˜åŒ–åï¼Œä¼šæ‰§è¡Œcbçš„å›è°ƒæ–¹æ³•
	const effect = new ReactiveEffect(getter, job);
	// éœ€è¦ç«‹å³æ‰§è¡Œï¼Œé‚£ä¹ˆå°±å…ˆæ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
	if (immediate) {
		job();
	}
	// 5. å°†ç«‹å³æ‰§è¡Œçš„effect.run()çš„ç»“æœä½œä¸ºoldValue
	oldValue = effect.run();
}
```

é¦–ç‰ˆä»£ç å°±ç®—æ˜¯å®Œæˆäº†ï¼Œä»£ç è™½ç„¶ä¸å¤šï¼Œä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ‹†åˆ†æ¯ä¸ªæ­¥éª¤ï¼Œæ¥è¿›è¡Œä¸€ä¸€è®²è§£ã€‚

- æ­¥éª¤ 1ï¼šå¾ˆå¥½ç†è§£ï¼Œå¯¼å‡ºçš„`watch`ï¼Œæ”¾å…¥ä¼ å‚ï¼Œè¿™é‡Œç¬¬ä¸‰ä¸ªå‚æ•°`options`æˆ‘ä»¬åªå®ç°`immediate`çš„åŠŸèƒ½ï¼›
- æ­¥éª¤ 2ï¼šå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ï¼Œå¯¹äºä¼ å…¥çš„`source`ï¼Œéœ€è¦è¿›è¡Œç±»å‹åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°çš„è¯ï¼Œé‚£å°±è®©`getter`èµ‹å€¼ä¸ºè¿™ä¸ªå‡½æ•°ï¼›å¦‚æœæ˜¯å¯¹è±¡çš„è¯ï¼Œé‚£å°±ç”¨å‡½æ•°åŒ…ä¸€å±‚ã€‚
- æ­¥éª¤ 3ï¼šä½†æ˜¯å•ç‹¬åŒ…ä¸€å±‚ï¼Œå¹¶ä¸ä¼šè§¦å‘ä¾èµ–æ”¶é›†ï¼Œæ‰€ä»¥å°±éœ€è¦å¯¹è¿™ä¸ªå“åº”å¼å¯¹è±¡`source`è¿›è¡Œéå†ï¼Œç„¶åå¯¹æ¯ä¸ª`key`è¿›è¡Œå–å€¼ï¼Œä»è€Œè§¦å‘ä¾èµ–æ”¶é›†ï¼›ä»£ç çœ‹ä¸Šå»çš„æ•ˆæœå°±æ˜¯ï¼Œåªæ˜¯å–äº†ä¸‹å€¼ï¼Œå®é™…æ²¡æœ‰è¿›è¡Œå…¶ä»–ä»»ä½•æ“ä½œã€‚ä¸ºä»€ä¹ˆè¦åŒ…è£…æˆä¸€ä¸ªå‡½æ•°å‘¢ï¼Ÿåˆ«æ€¥ï¼Œçœ‹åˆ°ç¬¬ 4 æ­¥å°±æ˜ç™½äº†ã€‚
- æ­¥éª¤ 4ï¼šè¿™æ­¥æ˜¯ä¸æ˜¯éå¸¸ç†Ÿï¼Ÿæ²¡é”™ï¼Œåœ¨ä¸Šç¯‡å†™`effect`åŸç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±æ˜¯é€šè¿‡ `new ReactiveEffect(fn, options.scheduler)`è¿›è¡Œç”Ÿæˆçš„ï¼Œæ‰€ä»¥ï¼Œæ­¤æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬æŠŠ`getter`å½“æˆç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œä¼ å‚ï¼ŒæŠŠ`job`å½“æˆç¬¬äºŒä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯å½“å“åº”å¼å¯¹è±¡çš„å±æ€§å‘ç”Ÿå˜åŒ–æ—¶å€™ï¼Œå°±ä¼šä¸»åŠ¨æ¥è°ƒç”¨`job`æ–¹æ³•ï¼Œå¦‚æœå¿˜äº†ï¼Œå¯ä»¥å†å»å¤ä¹ ä¸‹ä¸Šç¯‡æ–‡ç« ã€‚
- æ­¥éª¤ 5ï¼š`new`å®Œåï¼Œå¾—åˆ°çš„`effect`ï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œä¸€æ¬¡`effect.run`æ–¹æ³•ï¼Œå°±èƒ½æ‹¿åˆ°æœ€å¼€å§‹çš„è¿”å›å€¼ï¼Œè®°ä¸º`oldValue`ã€‚
- æ­¥éª¤ 6ï¼šå°±æ˜¯æ­¥éª¤ 4 ä¸­éœ€è¦ä¼ å…¥çš„`job`æ–¹æ³•ï¼Œå½“å“åº”å¼å¯¹è±¡çš„å±æ€§ï¼Œå‘ç”Ÿå˜åŒ–ï¼Œæ‰ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨å…¶ä¸­è°ƒç”¨`cb`ï¼Œå¹¶ä¸”ä¼ å…¥`oldValue`å’Œ`newValue`ï¼Œå¤§åŠŸå‘Šæˆã€‚

æ˜¯ä¸æ˜¯å‘ç°ï¼Œå½“æˆ‘ä»¬ç†è§£äº†`effect`æ–¹æ³•åŸç†ä¹‹åï¼Œå†å»å†™`watch`çš„å®ç°ï¼Œå°±å˜å¾—éå¸¸ç®€å•äº†å‘¢ï¼Ÿæ‰€ä»¥è¯´å˜›`effect`æ˜¯åº•å±‚æ–¹æ³•ï¼Œå¾ˆå¤šæ–¹æ³•éƒ½æ˜¯åŸºäºå®ƒè¿›è¡Œå°è£…çš„ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†ä»‹ç»ä¸€ä¸ª`Vue3`ä¸­`watch`æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œæ‰€è°“æ–°åŠŸèƒ½ï¼Œä¸æ˜¯æ— ç¼˜æ— æ•…å°±å‡ºæ¥çš„ï¼Œä¸€å®šæ˜¯ä¸ºäº†è§£å†³ç›¸å…³çš„åœºæ™¯ï¼Œæ‰€ä»¥æ‰ä¼šæå‡ºçš„æ–°åŠŸèƒ½ï¼Œæˆ‘ä»¬æ”¹åŠ¨ä¸‹`index.html`ä¸­çš„ç¤ºä¾‹ä»£ç ï¼Œå…ˆçœ‹çœ‹å¦‚ä¸‹åœºæ™¯ï¼Œè¯¥ç”¨ä»€ä¹ˆæ–¹æ³•æ¥è§£å†³ï¼š

```html
<script>
	const state = reactive({ name: "å¼ ä¸‰", age: 18 });
	let timmer = 4000;
	function getData(data) {
		return new Promise((resolve, reject) => {
			setTimeout(() => {
				resolve(data);
			}, (timmer -= 1000));
		});
	}
	watch(
		() => state.age,
		async (newV, oldV) => {
			const result = await getData(newV);
			console.log(result);
			app.innerHTML = result;
		}
	);
	// æˆ‘ä»¬è¿™é‡Œç›´æ¥æ”¹å˜å“åº”å¼å¯¹è±¡å±æ€§ï¼Œæ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥
	state.age = 20;
	state.age = 30;
	state.age = 40;
</script>
```

æˆ‘ä»¬æ¥ç®€å•è¯´ä¸€ä¸‹ä¸Šè¾¹ä»£ç çš„å«ä¹‰ï¼Œè®¾æƒ³ä¸€ä¸‹é¡µé¢é‡Œæœ‰ä¸ªè¾“å…¥æ¡†ï¼Œæ¯æ¬¡è¾“å…¥å†…å®¹ï¼Œéƒ½ä¼šå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬è¿™è¾¹æ¨¡æ‹Ÿç”¨æˆ·æ”¹å˜äº† 3 æ¬¡å€¼ï¼Œæ‰€ä»¥ä¸€å…±å‘é€äº† 3 æ¬¡è¯·æ±‚ï¼›ç¬¬ä¸€ä¸ªè¯·æ±‚å†æ—¶ 4 ç§’é’Ÿèƒ½æ‹¿åˆ°è¿”å›ç»“æœï¼Œç¬¬äºŒä¸ªè¯·æ±‚å†æ—¶ 3 ç§’èƒ½æ‹¿åˆ°ç»“æœï¼Œç¬¬ä¸‰ä¸ªè¯·æ±‚å†æ—¶ 2 ç§’èƒ½æ‹¿åˆ°ç»“æœï¼Œé‚£ä¹ˆæˆ‘ä»¬æœŸæœ›çš„é¡µé¢æ˜¾ç¤ºå†…å®¹ï¼Œæ˜¯ä»¥æœ€åä¸€æ¬¡è¾“å…¥çš„ç»“æœä¸ºå‡†ï¼Œå³é¡µé¢ä¸Šæ˜¾ç¤ºçš„æ˜¯`state.age = 40`çš„ç»“æœã€‚ä½†æ˜¯æ ¹æ®æˆ‘ä»¬ç°åœ¨çš„é€»è¾‘ï¼Œä¼šå‘ç°ï¼Œé¡µé¢ä¸Šè¿‡ 2 ç§’åç¡®å®æ˜¾ç¤ºçš„æ˜¯`state.age = 40`çš„ç»“æœï¼Œä½†æ˜¯åˆè¿‡äº† 1 ç§’é’Ÿï¼Œ`state.age = 30`è¿™ä¸ªè¯·æ±‚çš„ç»“æœåˆè¢«æ˜¾ç¤ºåˆ°é¡µé¢ä¸Šï¼Œåˆè¿‡äº† 1 ç§’`state.age = 20`çš„ç»“æœæœ€ç»ˆæ˜¾ç¤ºåœ¨äº†é¡µé¢ä¸Šï¼Œé‚£æ˜¾ç„¶ä¸åˆç†ï¼Œæˆ‘ä»¬çš„è¾“å…¥æ¡†ä¸­ï¼Œæœ€åæ˜æ˜æ˜¯`40`ï¼Œä½†æ˜¯é¡µé¢æ˜¾ç¤ºçš„ç»“æœå´æ˜¯`20`çš„è¯·æ±‚ç»“æœã€‚

æ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶éœ€è¦æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç¬¬ä¸€ååº”å°±æ˜¯ï¼Œèƒ½ä¸èƒ½åœ¨æ¯æ¬¡è§¦å‘æ–°è¯·æ±‚çš„æ—¶å€™ï¼Œå±è”½ä¸Šæ¬¡è¯·æ±‚çš„ç»“æœå‘¢?(æ³¨æ„ï¼Œè¯·æ±‚å·²ç»å‘é€äº†ï¼Œä¸èƒ½å–æ¶ˆ)ï¼Œè¿™æ ·ï¼Œå°±èƒ½ä¿è¯å°±ç®—ä¹‹å‰çš„è¯·æ±‚ï¼Œè¿‡äº†å¾ˆä¹…æ‰æ‹¿åˆ°è¿”å›å€¼ï¼Œä¹Ÿä¸ä¼šè¦†ç›–æœ€æ–°çš„ç»“æœã€‚é‚£æˆ‘ä»¬æ¥åœ¨å½“å‰ä»£ç ä¸­ï¼Œä¿®æ”¹ä¸‹å§!

```html
<script>
	const state = reactive({ name: "å¼ ä¸‰", age: 18 });
	let timmer = 4000;
	// 1. æ–°å»ºæ•°ç»„ï¼Œç”¨äºå­˜æ”¾ä¸Šä¸€æ¬¡è¯·æ±‚éœ€è¦çš„æ–¹æ³•
	let arr = [];
	function getData(data) {
		return new Promise((resolve, reject) => {
			setTimeout(() => {
				resolve(data);
			}, (timmer -= 1000));
		});
	}
	watch(
		() => state.age,
		async (newV, oldV) => {
			let fn;
			// 2. æ¯æ¬¡å‘é€è¯·æ±‚å‰ï¼Œåˆ©ç”¨é—­åŒ…ï¼Œå°†ä¸Šæ¬¡çš„ç»“æœflagæ”¹ä¸ºfalseï¼Œä»è€Œå±è”½ç»“æœ
			while (arr.length) {
				fn = arr.shift();
				fn();
			}
			// 3. æ–°å»ºä¸€ä¸ªæ ‡è¯†ï¼Œä¸ºtrueæ‰æ”¹å˜app.innerHTMLçš„å†…å®¹
			let flag = true;
			// 4. å°†flag = falseçš„å‡½æ•°ï¼Œå­˜åœ¨arræ•°ç»„ä¸­ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¯·æ±‚å‰è¿›è¡Œè°ƒç”¨
			arr.push(function () {
				flag = false;
			});
			const result = await getData(newV);
			console.log(result);
			flag && (app.innerHTML = result);
		}
	);
	// æˆ‘ä»¬è¿™é‡Œç›´æ¥æ”¹å˜å“åº”å¼å¯¹è±¡å±æ€§ï¼Œæ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥
	state.age = 20;
	state.age = 30;
	state.age = 40;
</script>
```

ä¹‹åï¼Œæˆ‘ä»¬åœ¨é¡µé¢ä¸Šå†æ¬¡æ‰“å°ç»“æœï¼Œå‘ç°ï¼Œé¡µé¢ä¸Šå§‹ç»ˆæ˜¾ç¤ºçš„æ˜¯ 40ï¼Œä¹Ÿå°±æ˜¯æœ€å`state.age = 40`å¯¹åº”çš„ç»“æœã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œçš„ä¸€äº›ä»£ç æ”¹è‰¯ï¼ŒæˆåŠŸçš„è§£å†³äº†è¯·æ±‚ç»“æœé¡ºåºé”™ä¹±çš„é—®é¢˜ã€‚é‚£ä¹ˆåœ¨`Vue3`ï¼Œ`watch`ä¸­æä¾›äº†æ–°çš„å‚æ•°ï¼Œå¯ä»¥æŠŠä¸€äº›é€»è¾‘æ”¾åœ¨`watch`çš„å†…éƒ¨ï¼Œä»è€Œè¾¾åˆ°å’Œä¸Šè¿°ä»£ç ç›¸åŒçš„æ•ˆæœï¼ŒåŒæ ·ï¼Œæˆ‘ä»¬å…ˆçœ‹ç”¨æ³•ï¼Œè¿›è€Œæ¨å¯¼ä¸‹åœ¨`watch`æºç ä¸­æ˜¯å¦‚ä½•å®ç°çš„ã€‚

```html
<script>
	const state = reactive({ name: "å¼ ä¸‰", age: 18 });
	let timmer = 4000;
	function getData(data) {
		return new Promise((resolve, reject) => {
			setTimeout(() => {
				resolve(data);
			}, (timmer -= 1000));
		});
	}
	// ç¬¬ä¸‰ä¸ªå‚æ•°æä¾›äº†onCleanupï¼Œç”¨æˆ·å¯ä»¥ä¼ å…¥å›è°ƒ
	watch(
		() => state.age,
		async (newV, oldV, onCleanup) => {
			let flag = true;
			onCleanup(() => {
				flag = false;
			});
			const result = await getData(newV);
			console.log(result);
			flag && (app.innerHTML = result);
		}
	);
	// æˆ‘ä»¬è¿™é‡Œç›´æ¥æ”¹å˜å“åº”å¼å¯¹è±¡å±æ€§ï¼Œæ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥
	state.age = 20;
	state.age = 30;
	state.age = 40;
</script>
```

æ˜¯ä¸æ˜¯å‘ç°ï¼Œä»£ç ç²¾ç®€äº†å¾ˆå¤šï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥å®ç°ä¸€ä¸‹å§ï¼

```typescript
// /reactivity/src/apiWatch.ts æ–‡ä»¶
import { isReactive } from "./reactive";
import { isFunction, isObject } from "@vue/shared";
import { ReactiveEffect } from "./effect";

function traverse(value, seen = new Set()) {
	if (!isObject(value)) {
		return value;
	}
	if (seen.has(value)) {
		return value;
	}
	seen.add(value);
	for (const key in value) {
		if (value.hasOwnProperty(key)) {
			// å°±æ˜¯å•çº¯çš„å–äº†ä¸‹å€¼ï¼Œæ¯”å¦‚state.nameï¼Œä¸ºäº†è§¦å‘reactiveå¯¹è±¡ä¸­å±æ€§çš„getter
			traverse(value[key], seen);
		}
	}
	return value;
}
// 1. é¦–å…ˆå¯¼å‡ºwatchæ–¹æ³•
export function watch(source, cb, { immediate } = {} as any) {
	// 2. åˆ†ä¸¤ç§æƒ…å†µåˆ¤æ–­ï¼Œsourceæ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡å’Œsourceæ˜¯ä¸€ä¸ªå‡½æ•°
	// è¿™ä¸ªgetterå°±ç›¸å½“äºæ˜¯effectä¸­çš„å›è°ƒå‡½æ•°
	let getter;
	if (isReactive(source)) {
		// 3. å¦‚æœsourceæ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œåº”è¯¥å¯¹sourceé€’å½’è¿›è¡Œå–å€¼
		getter = () => traverse(source);
	} else if (isFunction(source)) {
		getter = source;
	}
	let oldValue;
	// 8. åˆ›å»ºcleanupå˜é‡ï¼Œå’ŒonCleanupæ–¹æ³•
	let cleanup;
	const onCleanup = (fn) => {
		cleanup = fn;
	};
	// 6. å½“è§¦å‘æ›´æ–°çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å±æ€§æ”¹å˜çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œè¿™ä¸ªjobæ–¹æ³•
	const job = () => {
		// 9. å½“cleanupå­˜åœ¨ï¼Œå°±è°ƒç”¨æˆ‘ä»¬onCleanupä¸­ä¼ å…¥çš„å›è°ƒæ–¹æ³•
		if (cleanup) cleanup();
		const newValue = effect.run();
		// 7. é¦–å…ˆåœ¨cbä¸­æ·»åŠ è¿™ä¸ªonCleanupå‚æ•°
		cb(newValue, oldValue, onCleanup);
		oldValue = newValue;
	};
	// 4. å½“newçš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œgetteræ–¹æ³•ï¼Œå¼€å§‹è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œæ•°æ®å˜åŒ–åï¼Œä¼šæ‰§è¡Œcbçš„å›è°ƒæ–¹æ³•
	const effect = new ReactiveEffect(getter, job);
	// éœ€è¦ç«‹å³æ‰§è¡Œï¼Œé‚£ä¹ˆå°±å…ˆæ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
	if (immediate) {
		job();
	}
	// 5. å°†ç«‹å³æ‰§è¡Œçš„effect.run()çš„ç»“æœä½œä¸ºoldValue
	oldValue = effect.run();
}
```

çœ‹ 7ã€8ã€9 ä¸‰ä¸ªæ­¥éª¤ï¼Œå…¶å®å°±æ˜¯ç±»ä¼¼äºåˆšæ‰æˆ‘ä»¬å†™åœ¨å¤–è¾¹çš„é€»è¾‘ï¼Œåªä¸è¿‡æˆ‘ä»¬ç°åœ¨æŠŠè¿™äº›é€»è¾‘å†™åœ¨äº†`watch`å†…éƒ¨ï¼Œå¤šè¯»å‡ éï¼Œéå¸¸å·§å¦™ã€‚

è‡³æ­¤ä¸ºæ­¢ï¼Œå…³äº`watch`çš„æ ¸å¿ƒé€»è¾‘ï¼Œæˆ‘ä»¬å°±å·²ç»å†™å®Œäº†ï¼Œæ˜¯ä¸æ˜¯çœ‹èµ·æ¥ï¼Œæ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆéš¾å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬è¿˜è¦å®ç°ä¸‹`watchEffect`ï¼Œè«æ…Œï¼Œåªéœ€è¦æ”¹åŠ¨å‡ è¡Œä»£ç ï¼Œä¾¿å¯è½»æ¾å®ç°ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆšæ‰å¯¼å‡ºçš„`watch`æ”¹ä¸ªåå­—æ¢ä¸º`doWatch`ï¼Œå˜æˆä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œå› ä¸ºå‰æ–‡è¯´è¿‡ï¼Œ`watch`å’Œ`watchEffect`éƒ½æ˜¯åŸºäº`effect`æ–¹æ³•è¿›è¡Œå°è£…çš„ï¼Œæ‰€ä»¥äºŒè€…çš„é€»è¾‘å¯ä»¥è¯´æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡å¿…è¦å†å†™ä¸€éï¼Œé‚£ä¹ˆåªè¦è°ƒç”¨é€šç”¨å‡½æ•°ï¼Œæ ¹æ®ä¼ å‚ä¸åŒï¼Œå³å¯å¿«é€Ÿå®ç°ï¼š

#### `watchEffect`çš„å®ç°

```typescript
// /reactivity/src/apiWatch.ts æ–‡ä»¶
import { isReactive } from "./reactive";
import { isFunction, isObject } from "@vue/shared";
import { ReactiveEffect } from "./effect";

function traverse(value, seen = new Set()) {
	if (!isObject(value)) {
		return value;
	}
	if (seen.has(value)) {
		return value;
	}
	seen.add(value);
	for (const key in value) {
		if (value.hasOwnProperty(key)) {
			// å°±æ˜¯å•çº¯çš„å–äº†ä¸‹å€¼ï¼Œæ¯”å¦‚state.nameï¼Œä¸ºäº†è§¦å‘reactiveå¯¹è±¡ä¸­å±æ€§çš„getter
			traverse(value[key], seen);
		}
	}
	return value;
}
// 1. é¦–å…ˆå¯¼å‡ºdoWatchæ–¹æ³•
export function doWatch(source, cb, { immediate } = {} as any) {
	// 2. åˆ†ä¸¤ç§æƒ…å†µåˆ¤æ–­ï¼Œsourceæ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡å’Œsourceæ˜¯ä¸€ä¸ªå‡½æ•°
	// è¿™ä¸ªgetterå°±ç›¸å½“äºæ˜¯effectä¸­çš„å›è°ƒå‡½æ•°
	let getter;
	if (isReactive(source)) {
		// 3. å¦‚æœsourceæ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œåº”è¯¥å¯¹sourceé€’å½’è¿›è¡Œå–å€¼
		getter = () => traverse(source);
	} else if (isFunction(source)) {
		getter = source;
	}
	let oldValue;
	// 8. åˆ›å»ºcleanupå˜é‡ï¼Œå’ŒonCleanupæ–¹æ³•
	let cleanup;
	const onCleanup = (fn) => {
		cleanup = fn;
	};
	// 6. å½“è§¦å‘æ›´æ–°çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å±æ€§æ”¹å˜çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œè¿™ä¸ªjobæ–¹æ³•
	const job = () => {
		// 10. æ ¹æ®ä¼ å‚ä¸åŒï¼Œåˆ¤æ–­å¦‚æœæœ‰å›è°ƒå‡½æ•°çš„è¯ï¼Œé‚£ä¹ˆå°±æ˜¯watchï¼Œå¦‚æœæ²¡æœ‰cbé‚£å°±æ˜¯watchEffect
		if (cb) {
			// 9. å½“cleanupå­˜åœ¨ï¼Œå°±è°ƒç”¨æˆ‘ä»¬onCleanupä¸­ä¼ å…¥çš„å›è°ƒæ–¹æ³•
			if (cleanup) cleanup();
			const newValue = effect.run();
			// 7. é¦–å…ˆåœ¨cbä¸­æ·»åŠ è¿™ä¸ªonCleanupå‚æ•°
			cb(newValue, oldValue, onCleanup);
			oldValue = newValue;
		} else {
			effect.run();
		}
	};
	// 4. å½“newçš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œgetteræ–¹æ³•ï¼Œå¼€å§‹è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œæ•°æ®å˜åŒ–åï¼Œä¼šæ‰§è¡Œcbçš„å›è°ƒæ–¹æ³•
	const effect = new ReactiveEffect(getter, job);
	// éœ€è¦ç«‹å³æ‰§è¡Œï¼Œé‚£ä¹ˆå°±å…ˆæ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
	if (immediate) {
		job();
	}
	// 5. å°†ç«‹å³æ‰§è¡Œçš„effect.run()çš„ç»“æœä½œä¸ºoldValue
	oldValue = effect.run();
}
// å¯¼å‡ºwatchå’ŒwatchEffectæ–¹æ³•
export function watch(source, cb, options) {
	return doWatch(source, cb, options);
}
export function watchEffect(source, options) {
	return doWatch(source, null, options);
}
```

æ”¹åŠ¨ç‚¹ä»…ä»…æ˜¯ç¬¬ 10 æ­¥éª¤ï¼ŒåŠ äº†ä¸€ä¸ªåˆ¤æ–­ï¼Œé‚£ä¹ˆè¿™æ ·`doWatch`å°±æ˜¯ä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œåªéœ€è¦æ ¹æ®ä¼ å‚ä¸åŒï¼Œåœ¨å¤–è¾¹å†åŒ…ä¸€å±‚ï¼Œå°±æ˜¯æˆ‘ä»¬å¹³æ—¶ä¸­é¡¹ç›®å¸¸ç”¨çš„`watch`å’Œ`watchEffect`äº†ï¼æ€æ ·ï¼Œæ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“ï¼Ÿé‚£æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹å§

#### `computed`çš„å®ç°

æˆ‘ä»¬è¿˜æ˜¯ç®€å•ç”¨ä¸€ä¸‹`computed`ï¼Œçœ‹çœ‹æœ‰å“ªå‡ ç§ç”¨æ³•ï¼š

```html
<script>
	const state = reactive({ name: 'å¼ ä¸‰', age: 18 })
	// 1. å¯ä»¥ä¼ å…¥å¯¹è±¡ï¼Œé‡Œè¾¹è‡ªå®šä¹‰getå’Œsetçš„é€»è¾‘
	const info = computed({
	  get() {
	    console.log('æˆ‘è§¦å‘å•¦ï¼')
	    return state.name + state.age
	  }
	  set(val){
	    console.log(val)
	  }
	})
	// è™½ç„¶å–äº†2æ¬¡å€¼ï¼Œä½†æ˜¯åªä¼šæ‰“å°ä¸€æ¬¡'æˆ‘è§¦å‘äº†'ï¼Œå› ä¸ºcomputedæœ‰ç¼“å­˜çš„æ•ˆæœï¼Œä¾èµ–çš„å€¼ä¸å˜åŒ–ï¼Œå°±ä¸ä¼šå¤šæ¬¡è§¦å‘getï¼Œè¦é€šè¿‡.valueæ¥å–å€¼
	console.log(info.value)
	console.log(info.value)
	// 2. ä¼ å…¥å‡½æ•°ï¼Œé»˜è®¤å°±ç›¸å½“äºè¿”å›äº†ä¸€ä¸ªgetï¼Œå–å€¼è¦é€šè¿‡.valueæ¥å–
	const info = computed(() => {
	  return state.name + state.age
	})
</script>
```

å›é¡¾äº†ä¸‹åŸºæœ¬ç”¨æ³•åï¼Œæˆ‘ä»¬è¿˜æ˜¯åœ¨`reactivity/src`ç›®å½•ä¸‹ï¼Œæ–°å»º`computed.ts`æ–‡ä»¶ï¼Œç„¶ååœ¨`reactivity/src/index.ts`ä¸­`export * from '.computed'`ï¼Œè¿›è¡Œå¯¼å‡ºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨`computed.ts`ä¸­æ¥å®ç°`computed`çš„é€»è¾‘äº†ã€‚

```javascript
// reactivity/src/computed.ts æ–‡ä»¶
import { isFunction } from '@vue/shared'
import { ReactiveEffect } from './effect'

class ComputedRefImpl {
  public effect
  public _value
  public __v_isRef = true
  constructor(getter, public setter) {
    // 3. è¿˜æ˜¯é€šè¿‡new ReactiveEffectæ–¹æ³•
    this.effect = new ReactiveEffect(getter, () => {

    })
  }
  // 4. ç»™valueå±æ€§ï¼Œåˆ›å»ºgetå’Œsetï¼Œå†å–å€¼å’Œèµ‹å€¼çš„æ—¶å€™ï¼Œè§¦å‘ç›¸åº”é€»è¾‘
  get value() {
    this._value = this.effect.run()
    return this._value
  }
  set value(newV){
    this.setter(newValue)
  }
}

export function computed(getterOrOptions) {
  // 1. å¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œåˆ†ç±»å¤„ç†ï¼Œå¯¹å‡½æ•°å’Œå¯¹è±¡è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚
  const isGetter = isFunction(getterOrOptions)
  let getter, setter
  if (isGetter) {
    getter = isGetter
    setter = () => ({})
  } else {
    getter = getterOrOptions.get
    setter = getterOrOptions.set
  }
  // 2. åˆ›å»ºè®¡ç®—å±æ€§ï¼Œè¿”å›ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œè®¿é—®çš„æ—¶å€™ï¼Œé€šè¿‡.valueçš„æ–¹å¼æ¥è®¿é—®
  return new ComputedRefImpl(getter, setter)
}
```

æˆ‘ä»¬æ¥æŒ‰æ­¥éª¤ä¸€ä¸€è®²è§£ä¸‹

- æ­¥éª¤ 1ï¼šæ²¡é”™ï¼Œéå¸¸ç†Ÿæ‚‰çš„å¥—è·¯ï¼Œå’Œ`watch`å¤„ç†å‚æ•°çš„æ–¹å¼å‡ ä¹æ˜¯ä¸€æ¨¡ä¸€æ ·ï¼›
- æ­¥éª¤ 2ï¼šè¿”å›ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œè·å–`computed`çš„å€¼ï¼Œéœ€è¦é€šè¿‡`.value`çš„æ–¹æ³•ï¼›
- æ­¥éª¤ 3ï¼šä¾æ—§æ˜¯é€šè¿‡`new ReactiveEffect`ï¼Œä¼ å…¥`getter`è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œç”Ÿæˆ`effect`å®ä¾‹å¯¹è±¡ï¼›
- æ­¥éª¤ 4ï¼šå› ä¸º`computed`è¿”å›çš„å¯¹è±¡ï¼Œæ˜¯é€šè¿‡`.value`æ¥è®¿é—®çš„ï¼Œæ‰€ä»¥è¦åˆ›å»º`get set`ï¼Œæ‰§è¡Œç›¸åº”é€»è¾‘ï¼›

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„`computed`å°±å¯ä»¥ç®€å•çš„ç”¨èµ·æ¥äº†ï¼Œæˆ‘ä»¬å…ˆè¿è¡Œä¸€ä¸‹ï¼Œå…¶ä»–çš„é—®é¢˜ï¼Œæˆ‘ä»¬åè¾¹å†æ¥è§£å†³ï¼Œæˆ‘ä»¬æ”¹å˜ä¸‹`index.html`çš„ä»£ç ï¼ŒæŸ¥çœ‹æ‰“å°ç»“æœï¼š

```html
<script>
	const state = reactive({ name: "å¼ ä¸‰", age: 18 });
	const info = computed({
		get() {
			console.log("æˆ‘è°ƒç”¨å•¦ï¼");
			return state.name + state.age;
		},
		set(val) {
			console.log(val);
		},
	});
	// å¯¹info.valueå–ä¸¤æ¬¡å€¼ï¼ŒæŸ¥çœ‹ç»“æœ
	console.log(info.value);
	console.log(info.value);
</script>
```

æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œæ§åˆ¶å°ä¸­æ‰“å°çš„ç»“æœæ˜¯ï¼š

```bash
æˆ‘è°ƒç”¨å•¦ï¼
å¼ ä¸‰18
æˆ‘è°ƒç”¨å•¦ï¼
å¼ ä¸‰18
```

è¿™å’Œæˆ‘ä»¬å¹³æ—¶ç”¨çš„`computed`å¥½åƒå“ªé‡Œæœ‰äº›ä¸åŒï¼Ÿæ²¡é”™ï¼Œ`info`ä¸­ä¾èµ–çš„å“åº”å¼å¯¹è±¡`state`ä¸­çš„å±æ€§ï¼Œå¹¶æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯å´è§¦å‘äº†ä¸¤æ¬¡`computed`ï¼Œå¹¶æ²¡æœ‰å®ç°ç¼“å­˜çš„æ•ˆæœï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥å°±æ¥å®ç°ä¸€ä¸‹å§ï¼

```javascript
// reactivity/src/computed.ts æ–‡ä»¶
import { isFunction } from '@vue/shared'
import { ReactiveEffect } from './effect'

class ComputedRefImpl {
  public effect
  public _value
  // 5. åˆ›å»ºä¸€ä¸ª_dirtyå˜é‡ï¼Œä¸ºtrueçš„æ—¶å€™å°±ä»£è¡¨å¯ä»¥é‡æ–°æ‰§è¡Œå–å€¼æ“ä½œ
  public _dirty = true
  constructor(getter, public setter) {
    // 3. è¿˜æ˜¯é€šè¿‡new ReactiveEffectæ–¹æ³•
    this.effect = new ReactiveEffect(getter, () => {
      // 7. ä¾èµ–çš„å€¼å˜äº†ï¼Œåˆ¤æ–­_dirtyæ˜¯å¦ä¸ºfalseï¼Œä¸ºfalseçš„è¯ï¼Œå°±æŠŠ_dirtyæ”¹ä¸ºtrue
      this_dirty = true
    })
  }
  // 4. ç»™valueå±æ€§ï¼Œåˆ›å»ºgetå’Œsetï¼Œå†å–å€¼å’Œèµ‹å€¼çš„æ—¶å€™ï¼Œè§¦å‘ç›¸åº”é€»è¾‘
  get value() {
    // 6. å¦‚æœ_dirtyæ˜¯trueçš„è¯ï¼Œæ‰ä¼šé‡æ–°æ‰§è¡Œ`run`æ–¹æ³•ï¼Œé‡æ–°å–å€¼ï¼Œå¦åˆ™ï¼Œç›´æ¥è¿”å›åŸå€¼
    if (this._dirty) {
      this._dirty = false
      this._value = this.effect.run()
    }
    return this._value
  }
  set value(newV){
    this.setter(newValue)
  }
}

export function computed(getterOrOptions) {
  // 1. å¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œåˆ†ç±»å¤„ç†ï¼Œå¯¹å‡½æ•°å’Œå¯¹è±¡è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚
  const isGetter = isFunction(getterOrOptions)
  let getter, setter
  if (isGetter) {
    getter = isGetter
    setter = () => ({})
  } else {
    getter = getterOrOptions.get
    setter = getterOrOptions.set
  }
  // 2. åˆ›å»ºè®¡ç®—å±æ€§ï¼Œè¿”å›ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œè®¿é—®çš„æ—¶å€™ï¼Œé€šè¿‡.valueçš„æ–¹å¼æ¥è®¿é—®
  return new ComputedRefImpl(getter, setter)
}
```

æˆ‘ä»¬çœ‹æ•æ‰ 5~7ï¼Œæ˜¯ä¸æ˜¯é€šè¿‡ä¸€ä¸ª`_dirty`å±æ€§ï¼Œå°±å®ç°äº†å¦‚æœä¾èµ–ä¸å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå¤šæ¬¡è§¦å‘`computed`å¯¹è±¡ä¸­çš„`get`äº†å‘¢ï¼Ÿè¿˜æ˜¯é‚£å¥è¯ï¼Œ`computed`çš„å®ç°ï¼Œä¾æ—§æ˜¯ä¾èµ–äº`effect`ï¼Œæ‰€ä»¥ç†è§£`effect`æ‰æ˜¯é‡ä¸­ä¹‹é‡ã€‚

çœ‹èµ·æ¥æ˜¯æ²¡å•¥é—®é¢˜äº†ï¼Œä½†æ˜¯åœ¨æœ‰ä¸€ç§åœºæ™¯ä¸‹ï¼Œå­˜åœ¨ç€é—®é¢˜ï¼Œæˆ‘ä»¬æ”¹ä¸€ä¸‹`index.html`ä»£ç ï¼Œæ¥çœ‹ä¸€ä¸‹ï¼š

```html
<script>
	const state = reactive({ name: "å¼ ä¸‰", age: 18 });
	const info = computed({
		get() {
			console.log("æˆ‘è°ƒç”¨å•¦ï¼");
			return state.name + state.age;
		},
		set(val) {
			console.log(val);
		},
	});
	effect(() => {
		app.innerHTML = info.value;
	});
	console.log(info.value);
	setTimeout(() => {
		state.age = 22;
		console.log(info.value);
	}, 2000);
</script>
```

æ²¡é”™ï¼Œå°±æ˜¯å½“æˆ‘ä»¬åœ¨`effect`æ–¹æ³•ä¸­ï¼Œä½¿ç”¨äº†`computed`è®¡ç®—å±æ€§ï¼Œé‚£ä¹ˆé¡µé¢å°±ä¸ä¼šæ›´æ–°ï¼Œå› ä¸º`effect`ä¸­å¹¶æ²¡æœ‰å¯¹è®¡ç®—å±æ€§è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œè€Œ`computed`è®¡ç®—å±æ€§ä¸­ä¹Ÿæ²¡æœ‰å¯¹åº”çš„`effect`æ–¹æ³•ã€‚é‚£æ€ä¹ˆå®ç°å‘¢ï¼Ÿæˆ‘ä»¬æƒ³ä¸€æƒ³ï¼Œæ˜¯ä¸æ˜¯å¾ˆç±»ä¼¼äºä¹‹å‰å†™çš„ä¾èµ–æ”¶é›†`track`å’Œè§¦å‘æ›´æ–°`trigger`æ–¹æ³•å‘¢ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨`computed`ä¸­å¢åŠ è¿›è¡Œä¾èµ–æ”¶é›†å’Œè§¦å‘æ›´æ–°çš„é€»è¾‘å°±å¥½äº†ï¼Œè€Œè¿™ä¸¤ä¸ªé€»è¾‘ï¼Œæˆ‘ä»¬ä¹‹å‰ä¹Ÿå†™è¿‡ï¼Œæ‰€ä»¥å¯ä»¥æŠŠé€šç”¨çš„ä»£ç ç›´æ¥`copy`è¿‡æ¥ï¼š

```javascript
// reactivity/src/computed.ts æ–‡ä»¶
import { isFunction } from '@vue/shared'
import { ReactiveEffect, activeEffect, trackEffects, triggerEffects } from './effect'

class ComputedRefImpl {
  public effect
  public _value
  public dep = new Set()
  // 5. åˆ›å»ºä¸€ä¸ª_dirtyå˜é‡ï¼Œä¸ºtrueçš„æ—¶å€™å°±ä»£è¡¨å¯ä»¥é‡æ–°æ‰§è¡Œå–å€¼æ“ä½œ
  public _dirty = true
  constructor(getter, public setter) {
    // 3. è¿˜æ˜¯é€šè¿‡new ReactiveEffectæ–¹æ³•
    this.effect = new ReactiveEffect(getter, () => {
      // 7. ä¾èµ–çš„å€¼å˜äº†ï¼Œåˆ¤æ–­_dirtyæ˜¯å¦ä¸ºfalseï¼Œä¸ºfalseçš„è¯ï¼Œå°±æŠŠ_dirtyæ”¹ä¸ºtrue
      this_dirty = true
      // 9. è§¦å‘æ›´æ–°
      triggerEffects(this.dep)
    })
  }
  // 4. ç»™valueå±æ€§ï¼Œåˆ›å»ºgetå’Œsetï¼Œå†å–å€¼å’Œèµ‹å€¼çš„æ—¶å€™ï¼Œè§¦å‘ç›¸åº”é€»è¾‘
  get value() {
    // 8. å¦‚æœè®¡ç®—å±æ€§åœ¨effectä¸­ä½¿ç”¨çš„è¯ï¼Œé‚£ä¹Ÿè¦åšä¾èµ–æ”¶é›†
    if (activeEffect) {
      trackEffects(this.dep)
    }
    // 6. å¦‚æœ_dirtyæ˜¯trueçš„è¯ï¼Œæ‰ä¼šé‡æ–°æ‰§è¡Œ`run`æ–¹æ³•ï¼Œé‡æ–°å–å€¼ï¼Œå¦åˆ™ï¼Œç›´æ¥è¿”å›åŸå€¼
    if (this._dirty) {
      this._dirty = false
      this._value = this.effect.run()
    }
    return this._value
  }
  set value(newV){
    this.setter(newValue)
  }
}

export function computed(getterOrOptions) {
  // 1. å¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œåˆ†ç±»å¤„ç†ï¼Œå¯¹å‡½æ•°å’Œå¯¹è±¡è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚
  const isGetter = isFunction(getterOrOptions)
  let getter, setter
  if (isGetter) {
    getter = isGetter
    setter = () => ({})
  } else {
    getter = getterOrOptions.get
    setter = getterOrOptions.set
  }
  // 2. åˆ›å»ºè®¡ç®—å±æ€§ï¼Œè¿”å›ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œè®¿é—®çš„æ—¶å€™ï¼Œé€šè¿‡.valueçš„æ–¹å¼æ¥è®¿é—®
  return new ComputedRefImpl(getter, setter)
}
// reactivity/src/effect.ts æ–‡ä»¶
export function triggerEffects(dep) {
  const effects = [...dep]
  effects && effects.forEach(effect => {
    // æ­£åœ¨æ‰§è¡Œçš„effectï¼Œä¸è¦å¤šæ¬¡æ‰§è¡Œï¼Œé˜²æ­¢æ­»å¾ªç¯
    if (effect !== activeEffect) {
      // å¦‚æœç”¨æˆ·ä¼ å…¥äº†schedulerï¼Œé‚£ä¹ˆå°±æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰é€»è¾‘ï¼Œå¦åˆ™è¿˜æ˜¯æ‰§è¡Œruné€»è¾‘
      if(effect.scheduler) {
        effect.scheduler()
      }else {
        effect.run()
      }
    }
  })
}
// computedä¸­æ”¶é›†effectçš„ä¾èµ–
export function trackEffects(dep) {
  let shouldTrack = !dep.has(activeEffect)
  if(shouldTrack) {
    // ä¾èµ–å’Œeffectå¤šå¯¹å¤šå…³ç³»ä¿å­˜
    dep.add(activeEffect)
    activeEffect.deps.push(dep)
  }
}
```

æˆ‘ä»¬çœ‹æ­¥éª¤ 8ï¼Œ9ï¼Œä¾èµ–æ”¶é›†å’Œè§¦å‘æ›´æ–°çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¾æ—§å†™åœ¨`effect.ts`æ–‡ä»¶ä¸­ï¼ˆå¯ä»¥å¯¹æ¯”ä¸‹`trigger`å’Œ`track`æ–¹æ³•ï¼Œé€»è¾‘å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼‰ã€‚æˆ‘ä»¬å†è¿è¡Œåˆšæ‰`index.html`ä¸­çš„ä»£ç ï¼Œå‘ç°é¡µé¢æˆåŠŸçš„æ›´æ–°äº†ï¼Œé‚£ä¹ˆè‡³æ­¤ï¼Œ`computed`çš„æ ¸å¿ƒé€»è¾‘æˆ‘ä»¬å°±å†™å®Œå•¦ï¼

#### `ref`çš„å®ç°

æˆ‘ä»¬åœ¨`reactivity/src`ç›®å½•ä¸‹åˆ›å»º`ref.ts`æ–‡ä»¶

```typescript
import { isObject } from "@vue/shared";
import { activeEffect, trackEffects, triggerEffects } from "./effect";
import { reactive } from "./reactive";

function toReactive(value) {
	return isObject(value) ? reactive(value) : value;
}

class RefImpl {
	public _value;
	public dep = new Set();
	public __v_isRef = true;
	constructor(public rawValue) {
		// 1. åˆ¤æ–­ä¼ å…¥çš„å€¼ï¼Œå¦‚æœæ˜¯å¯¹è±¡ç±»å‹ï¼Œé‚£ä¹ˆå°±å°†å…¶åŒ…è£…æˆå“åº”å¼å¯¹è±¡
		this._value = toReactive(rawValue);
	}
	get value() {
		if (activeEffect) {
			// 2. è¿›è¡Œä¾èµ–æ”¶é›†
			trackEffects(this.dep);
		}
		return this._value;
	}
	set value(newVal) {
		if (newVal !== this.rawValue) {
			this.rawValue = newVal;
			this._value = toReactive(newVal);
			// 3. è¿›è¡Œè§¦å‘æ›´æ–°
			triggerEffects(this.dep);
		}
	}
}
```

æœ‰äº†å‰è¾¹çš„åŸºç¡€ï¼Œå†™èµ·`ref`æ¥ï¼Œå°±æ˜¾å¾—éå¸¸å¾—å¿ƒåº”æ‰‹ï¼Œæ ¸å¿ƒå…¶å®å°±è¿™å‡ è¡Œä»£ç ï¼Œé€šè¿‡æ³¨é‡Šï¼Œæˆ‘ä»¬å°±ä¸éš¾å‘ç°ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆå°±æ˜¯åˆ©ç”¨äº†ä¹‹å‰å†™çš„`reactive`è¿›è¡ŒåŒ…è£…å¤„ç†ï¼Œå¦‚æœä¼ å…¥äº†å…¶ä»–ç±»å‹çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±å’Œ`computed`ä¸­çš„æ–¹æ³•ä¸€æ¨¡ä¸€æ ·ï¼Œéœ€è¦è¿›è¡Œä¾èµ–æ”¶é›†å’Œè§¦å‘æ›´æ–°ã€‚

#### å®ç°`toRef`å’Œ`toRefs`

è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶å®æˆ‘ä»¬å¼€å‘ä¸­ï¼Œç”¨çš„ä¼šæ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥è¿˜æ˜¯å…ˆç®€å•ä»‹ç»ä¸‹ç”¨æ³•ï¼Œç„¶åå†æ€è€ƒä¸‹å¦‚ä½•å®ç°ï¼Œæœ€åå†æ¥å†™ä¸€ä¸‹å®ƒä»¬çš„åŸç†ï¼š

```html
<script>
	const state = reactive({name: 'å¼ ä¸‰'}))
	// å•ç‹¬æŠŠnameå–å‡ºæ¥
	let name = state.name
	effect(() => {
	  app.innerHTML = name
	})
	setTimeout(() => {
	  state.name = 'æå››'
	}, 1000)
</script>
```

è¿™æ˜¯ä¸Šè¾¹çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬å°†`let name = state.name`å•ç‹¬å–å‡ºæ¥ä¹‹åï¼Œå†ä¿®æ”¹`state.name`çš„å€¼ä¹‹åï¼Œ`name`çš„å€¼å°±ä¸ä¼šå†å‘ç”Ÿå˜åŒ–äº†ï¼Œé¡µé¢ä¸Šçš„åå­—ä¹Ÿä¸ä¼šéšä¹‹å‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ä¸¢å¤±å“åº”å¼ï¼Œé‚£ä¹ˆåˆ©ç”¨`toRef`å°±å¯ä»¥è§£å†³è¿™ç§é—®é¢˜ï¼š

```html
<script>
	const state = reactive({name: 'å¼ ä¸‰'}))
	// å•ç‹¬æŠŠnameå–å‡ºæ¥
	let name = toRef(state, 'name')
	effect(() => {
	  app.innerHTML = name.value
	})
	setTimeout(() => {
	  state.name = 'æå››'
	}, 1000)
</script>
```

æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹å¦‚ä½•å®ç°å‘¢ï¼Ÿä¸ºäº†ä¸ä¸¢å¤±å“åº”å¼ï¼Œæ‰€ä»¥å°±éœ€è¦è”ç³»ï¼Œé‚£ä¹ˆè‚¯å®šå°±æ˜¯åœ¨`name`å’Œ`state.name`ä¹‹é—´å­˜åœ¨æŸç§è”ç³»ï¼Œå½“æ”¹å˜`state.name`å€¼çš„æ—¶å€™ï¼Œä»è€Œèƒ½ä½¿å¾—`name`åŒæ­¥è¿›è¡Œå˜åŠ¨ã€‚æ—¢ç„¶è¿™æ ·ï¼Œé‚£ä¸å°±å¯ä»¥åšä¸€å±‚ä»£ç†ï¼Œå½“è®¿é—®å’Œä¿®æ”¹`name`çš„æ—¶å€™ï¼Œå®é™…æ˜¯å»è®¿é—®å’Œä¿®æ”¹`state.name`çš„å€¼ä¹ˆï¼Ÿæ€è·¯æœ‰äº†ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ä»£ç æ¥å®ç°ï¼š

```typescript
// reactivity/src/ref.ts

import { isObject } from "@vue/shared";
import { activeEffect, trackEffects, triggerEffects } from "./effect";
import { reactive } from "./reactive";

function toReactive(value) {
	return isObject(value) ? reactive(value) : value;
}

class RefImpl {
	public _value;
	public dep = new Set();
	public __v_isRef = true;
	constructor(public rawValue) {
		// 1. åˆ¤æ–­ä¼ å…¥çš„å€¼ï¼Œå¦‚æœæ˜¯å¯¹è±¡ç±»å‹ï¼Œé‚£ä¹ˆå°±å°†å…¶åŒ…è£…æˆå“åº”å¼å¯¹è±¡
		this._value = toReactive(rawValue);
	}
	get value() {
		if (activeEffect) {
			// 2. è¿›è¡Œä¾èµ–æ”¶é›†
			trackEffects(this.dep);
		}
		return this._value;
	}
	set value(newVal) {
		if (newVal !== this.rawValue) {
			this.rawValue = newVal;
			this._value = toReactive(newVal);
			// 3. è¿›è¡Œè§¦å‘æ›´æ–°
			triggerEffects(this.dep);
		}
	}
}
// å¯¼å‡ºref
export function ref(value) {
	return new RefImpl(value);
}

class ObjectRefImpl {
	public __v_isRef = true;
	constructor(public _object, public _key) {}
	get value() {
		return this._object[this._key];
	}
	set value(newVal) {
		this._object[this._key] = newVal;
	}
}
// å¯¼å‡ºtoRef
export function toRef(object, key) {
	return new ObjectRefImpl(object, key);
}
// å¯¼å‡ºtoRefs
export function toRefs(object) {
	// å¦‚æœä¼ å…¥æ•°ç»„ï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ï¼Œå¦‚æœæ˜¯å¯¹è±¡ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡
	const ret = isArray(object) ? new Array(object.length) : {};
	for (const key in object) {
		ret[key] = toRef(object, key);
	}
	return ret;
}
```

ä»£ç éå¸¸ç®€å•ï¼Œå°±æ˜¯è¿›è¡Œäº†ä¸€æ¬¡ä»£ç†è½¬åŒ–ï¼Œè€Œæˆ‘ä»¬é¡¹ç›®ä¸­å¸¸ç”¨çš„æ˜¯`toRefs`ï¼Œä¹Ÿæ˜¯éå†æ¯ä¸ªå±æ€§ï¼Œå¹¶å€ŸåŠ©`toRef`æ¥å®ç°çš„ã€‚

#### `proxyRef`çš„å®ç°

è¿™ä¸ªæ–¹æ³•å¯èƒ½å¬èµ·æ¥å¾ˆé™Œç”Ÿï¼Œä½†æ˜¯åªè¦å†™è¿‡`Vue3`çš„é¡¹ç›®ï¼Œå°±ä¸€å®šä¼šç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œä¸¾ä¸ªä¾‹å­å°±æ˜ç™½äº†ï¼š

```html
<template>
	<div>{{ name }}</div>
</template>
<script>
	let name = ref("å¼ ä¸‰");
</script>
```

å½“æˆ‘ä»¬åœ¨ä»£ç ä¸­ï¼Œç”¨`ref`å£°æ˜äº†ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„æ•°æ®åï¼Œå¦‚æœåœ¨ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªå€¼ï¼Œæ˜¯ä¸æ˜¯éœ€è¦é€šè¿‡`name.value`çš„æ–¹å¼æ¥è°ƒç”¨å‘¢ï¼Ÿä½†æ˜¯å½“æˆ‘ä»¬åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨çš„æ—¶å€™ï¼Œå´å¯ä»¥ç›´æ¥æ¥ç”¨è¿™ä¸ª`name`è€Œå¹¶ä¸éœ€è¦å†`.value`æ¥å–å€¼ï¼Œè¯¶ï¼Œè¿™å°±æ˜¯`Vue3`åœ¨æ¨¡æ¿ç¼–è¯‘çš„æ—¶å€™ï¼Œå†…éƒ¨è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œå¸®åŠ©æˆ‘ä»¬å¯¹`ref`å£°æ˜å˜é‡ï¼Œè¿›è¡Œè‡ªåŠ¨è„±é’©ï¼Œé‚£ä¹ˆç»†å¿ƒçš„æœ‹å‹ä¹Ÿå‘ç°äº†ï¼Œä¸ç®¡æ˜¯åœ¨`computed`ï¼Œè¿˜æ˜¯`ref`ä»£ç ä¸­ï¼Œéƒ½æœ‰ä¸€æ ·`public __v_isRef = true`è¿™ä¸ªæ ‡è¯†ï¼Œæ²¡é”™ï¼Œæ¥ä¸‹æ¥å°±è¦ç”¨åˆ°è¿™ä¸ªæ ‡è¯†äº†ï¼Œè¿™ä¸ªæ ‡è¯†å°±æ˜¯ä¸ºäº†åœ¨è‡ªåŠ¨è„±é’©çš„æ—¶å€™ï¼Œæ¥è¿›è¡Œåˆ†è¾¨çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥å®ç°è¿™ä¸ª`proxyRef`æ–¹æ³•å§~

```typescript
// reactivity/src/ref.ts

import { isObject } from "@vue/shared";
import { activeEffect, trackEffects, triggerEffects } from "./effect";
import { reactive } from "./reactive";

function toReactive(value) {
	return isObject(value) ? reactive(value) : value;
}

class RefImpl {
	public _value;
	public dep = new Set();
	public __v_isRef = true;
	constructor(public rawValue) {
		// 1. åˆ¤æ–­ä¼ å…¥çš„å€¼ï¼Œå¦‚æœæ˜¯å¯¹è±¡ç±»å‹ï¼Œé‚£ä¹ˆå°±å°†å…¶åŒ…è£…æˆå“åº”å¼å¯¹è±¡
		this._value = toReactive(rawValue);
	}
	get value() {
		if (activeEffect) {
			// 2. è¿›è¡Œä¾èµ–æ”¶é›†
			trackEffects(this.dep);
		}
		return this._value;
	}
	set value(newVal) {
		if (newVal !== this.rawValue) {
			this.rawValue = newVal;
			this._value = toReactive(newVal);
			// 3. è¿›è¡Œè§¦å‘æ›´æ–°
			triggerEffects(this.dep);
		}
	}
}
// å¯¼å‡ºref
export function ref(value) {
	return new RefImpl(value);
}

class ObjectRefImpl {
	public __v_isRef = true;
	constructor(public _object, public _key) {}
	get value() {
		return this._object[this._key];
	}
	set value(newVal) {
		this._object[this._key] = newVal;
	}
}
// å¯¼å‡ºtoRef
export function toRef(object, key) {
	return new ObjectRefImpl(object, key);
}
// å¯¼å‡ºtoRefs
export function toRefs(object) {
	// å¦‚æœä¼ å…¥æ•°ç»„ï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ï¼Œå¦‚æœæ˜¯å¯¹è±¡ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡
	const ret = isArray(object) ? new Array(object.length) : {};
	for (const key in object) {
		ret[key] = toRef(object, key);
	}
	return ret;
}

export function isRef(value) {
	return !!(value && value.__v_isRef === true);
}
// å¦‚æœæ˜¯refåˆ™å–ref.value
export function proxyRefs(objectWithRefs) {
	return new Proxy(objectWithRefs, {
		get(target, key, receiver) {
			let v = Reflect.get(target, key, receiver);
			return isRef(v) ? v.value : v;
		},
		set(target, key, value, receiver) {
			const oldValue = target[key];
			// è€çš„å€¼å¦‚æœæ˜¯ä¸ªrefï¼Œé‚£ä¹ˆå®é™…ä¸Šèµ‹å€¼çš„æ—¶å€™åº”è¯¥ç»™ä»–çš„.valueè¿›è¡Œèµ‹å€¼
			if (oldValue.__v_isRef) {
				oldValue.value = value;
				return true;
			} else {
				// å…¶ä»–æƒ…å†µï¼Œæ­£å¸¸èµ‹å€¼
				return Reflect.set(target, key, value, receiver);
			}
		},
	});
}
```

è¿™ä¸ª`proxyRef`æ–¹æ³•ï¼Œåœ¨åç»­æ–‡ç« ä¸­ï¼Œä¼šç”¨åˆ°ï¼Œè¿™é‡Œåªæ˜¯æå‰ä»‹ç»ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚

### ç»“è¯­

é‚£ä¹ˆè‡³æ­¤ï¼Œæˆ‘ä»¬`reactivity`å“åº”å¼æ¨¡å—ä¸­çš„ä¸€äº›ä¸ªæ ¸å¿ƒçš„æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šå·²ç»å®ç°äº†æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å†å»é˜…è¯»æºç çš„æ—¶å€™ï¼Œå°±ä¸ä¼šå˜å¾—ä¸€å¤´é›¾æ°´äº†ï¼Œå¥½å¥½å†ç†Ÿæ‚‰ä¸€é`reactivity`æ¨¡å—çš„æ–¹æ³•å§ï¼Œç„¶åå†å»çœ‹ä¸‹`Vue3`æºç ä¸­çš„`reactivity`é€»è¾‘ï¼›æˆ‘ä»¬æ¥ä¸‹æ¥ä¼šç»§ç»­åˆ†æ`Vue3`ï¼Œå…¶ä»–æ¨¡å—çš„æ ¸å¿ƒä»£ç ã€‚

## Vue3 æ¸²æŸ“åŸç†

`Vue3`çš„ç»„æˆï¼Œæ˜¯æœ‰**ç¼–è¯‘æ—¶**å’Œ**è¿è¡Œæ—¶**çš„æ¦‚å¿µã€‚

- ç¼–è¯‘æ—¶ï¼šå…¶å®å°±æ˜¯å°†æ¨¡æ¿è½¬åŒ–ä¸ºå‡½æ•°çš„è¿‡ç¨‹ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå°±æ˜¯å°†æˆ‘ä»¬å†™çš„æ¨¡æ¿ä»£ç ï¼Œå¦‚`<template>{{ msg }}</template>`è½¬åŒ–ä¸ºå‡½æ•°ã€‚ä¹‹æ‰€ä»¥ç”¨æ¨¡æ¿çš„æ–¹å¼æ¥å†™ï¼Œçº¯ç²¹æ˜¯ä¸ºäº†å‡å°‘å¼€å‘çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œèƒ½å¤Ÿæ ¹æ®è¯­ä¹‰åŒ–è¿›è¡Œä»£ç ä¹¦å†™ï¼Œè€Œä¸å¿…ç”¨å„ç§å‡½æ•°è°ƒç”¨çš„æ–¹å¼æ¥ç”Ÿæˆã€‚
- è¿è¡Œæ—¶ï¼šè¿è¡Œæ—¶åˆåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œé‚£ä¹ˆè¿è¡Œæ—¶çš„æ ¸å¿ƒï¼Œä¹Ÿå°±æ˜¯`runtime-core`æ˜¯ä¸ä¾èµ–ä»»ä½•å¹³å°çš„ï¼Œ

é‚£ä¹ˆæ¨¡å—ä¹‹é—´çš„ä¾èµ–å°±æ˜¯`runtime-dom`æä¾›äº†æµè§ˆå™¨è¿è¡Œç¯å¢ƒä¸­çš„`DOM API`ï¼Œè€Œ`runtime-core`æä¾›äº†è™šæ‹Ÿ`dom`çš„æ ¸å¿ƒé€»è¾‘ï¼Œé€šè¿‡`runtime-dom`æä¾›çš„`API`ï¼Œä»è€Œç”ŸæˆçœŸå®`DOM`ï¼Œè€Œ`runtime-core`ä¸­åˆä¼šå¼•å…¥`reactivity`åŒ…ä¸­çš„å†…å®¹ï¼Œæ‰€ä»¥æ•´ä½“çš„æµç¨‹æ˜¯`Vue -> runtime-dom -> runtime-core -> reactivity`åè€…å‡æ˜¯å‰è€…çš„å­çº§ï¼Œç”±å‰è€…å¯¼å…¥ä½¿ç”¨ã€‚æˆ‘ä»¬æœ¬ç¯‡æ–‡ç« ä¸»è¦è®²è¿è¡Œæ—¶ç›¸å…³çš„å†…å®¹ã€‚

åœ¨`runtime-core`åŒ…ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªæ–¹æ³•`createRenderer`ï¼Œçœ‹ç€è™½ç„¶é™Œç”Ÿï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„`createApp`(åœ¨`runtime-dom`åŒ…ä¸­å®ç°)ï¼Œå…¶å®åº•å±‚è°ƒç”¨çš„å°±æ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿ä»è¿™ä¸ªæ–¹æ³•å¼€å§‹ï¼Œä¸€æ­¥æ­¥å­¦ä¹ `runtime-dom`å’Œ`runtime-core`è¿™ä¸¤ä¸ªåŒ…å§ï¼

### `runtime-dom`çš„å®ç°

é¦–å…ˆï¼Œæˆ‘ä»¬ä¾æ—§æ˜¯è¦åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå’Œä¹‹å‰çš„å¥—è·¯ä¸€æ ·ï¼Œå…ˆçœ‹ä¸‹ç¤ºä¾‹æ•ˆæœï¼Œå†è¿›è¡Œä»£ç ä¹¦å†™ã€‚å’Œ`reactivity`åŒ…ä½ç½®ç›¸åŒï¼Œæˆ‘ä»¬åˆ›å»º`runtime-dom`æ–‡ä»¶å¤¹å’Œ`package.json`æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨`runtime-dom`æ–‡ä»¶å¤¹ä¸‹è¾¹åˆ›å»º`src/index.ts`ä½œä¸ºå…¥å£ï¼›

åˆ›å»º`dist/index.html`ä½œä¸ºæ•ˆæœå±•ç¤ºç¤ºä¾‹é¡µé¢ã€‚åŒæ ·ï¼Œæˆ‘ä»¬æŠŠ`node_modules`æ–‡ä»¶å¤¹ä¸­ï¼Œ`Vue`å®˜æ–¹æ‰“åŒ…å¥½çš„`compiler-dom.esm-browser.js`æ–‡ä»¶ï¼Œå¤åˆ¶è¿›`dist`ç›®å½•ä¸‹ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰`reactivity`çš„æ“ä½œä¸€æ¨¡ä¸€æ ·ï¼Œå…ˆçœ‹çœ‹äººå®¶å®˜æ–¹çš„æ–¹æ³•å®ç°æ•ˆæœï¼Œå†è‡ªå·±å®ç°ä¸€éã€‚

æœ€åï¼Œåˆ«å¿˜äº†å°†`script/dev.js`ä¸­çš„`target`æ”¹ä¸º`runtime-dom`ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±æ˜¯ä»`runtime-dom/src/index.ts`ä½œä¸ºå…¥å£è¿›è¡Œæ‰“åŒ…äº†ã€‚ä¸‡äº‹å…·å¤‡ï¼Œæˆ‘ä»¬å†™ä¸€ä¸‹æµ‹è¯•ä»£ç ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è·‘é€šå§ï¼š

```js
// runtime-dom/src/index.ts
export const testName = "æµ‹è¯•runtime-dom";
```

ç„¶åæ‰§è¡Œ`npm run dev`ï¼Œå¯¹æˆ‘ä»¬`runtime-dom`æ¨¡å—çš„ä»£ç è¿›è¡Œæ‰“åŒ…ï¼Œä¹‹åä¿®æ”¹`dist/index.html`æ–‡ä»¶å†…å®¹ï¼Œæ‰§è¡Œ`npx serve dist`ï¼Œåœ¨æµè§ˆå™¨æ§åˆ¶å°è§‚æµ‹ç»“æœï¼ŒæˆåŠŸæ‰“å°äº†`testName`ï¼Œä¾¿è¯´æ˜æˆ‘ä»¬å·²ç»è°ƒé€šäº†ã€‚

runtime-dom/dist/index.htmlï¼š

```html
<script type="module">
	import { testName } from "./runtime-dom.js";
	console.log(testName);
</script>
```

æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š`createRenderer`å’Œ`h`çš„ç”¨æ³•ã€‚

```html
<script type="module">
	// runtime-dom/dist/index.html æ–‡ä»¶
	// å¼•å…¥çš„æ–‡ä»¶æ˜¯æˆ‘ä»¬åˆšæ‰å¤åˆ¶è¿›æ¥å®˜æ–¹æ‰“æŠ¥å¥½çš„runtime-domæ–‡ä»¶
	import { createRenderer, h } from "./runtime-dom.esm-browser.js";
</script>
```

é‚£ä¹ˆè¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶å®æ˜¯`runtime-core`ä¸­æä¾›çš„ï¼Œå‰æ–‡ä¹Ÿè¯´è¿‡ï¼Œå…¶å®`runtime-dom`æä¾›çš„ä¸»è¦æ˜¯æµè§ˆå™¨ç›¸å…³çš„`API`ï¼Œä½œä¸ºå‚æ•°ä¼ å…¥`createRenderer`ä¸­ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥çœ‹ã€‚

ç›¸ä¿¡`h`æ–¹æ³•ï¼Œå¤§å®¶éƒ½æœ‰æ‰€è€³é—»ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿ`DOM`ï¼Œé‚£ä¹ˆè°ƒç”¨`createRenderer`å°±å¯ä»¥å°†è™šæ‹Ÿ`DOM`ï¼Œé€šè¿‡æˆ‘ä»¬ä¼ å…¥çš„`API`ï¼Œåœ¨é¡µé¢ä¸­ç”ŸæˆçœŸå®çš„`DOM`ï¼Œæˆ‘ä»¬å†æ¬¡ä¿®æ”¹ç¤ºä¾‹ä»£ç ï¼Œç„¶åæŸ¥çœ‹æ§åˆ¶å°ç»“æœã€‚

```html
<script type="module">
	// runtime-dom/dist/index.html æ–‡ä»¶
	// å¼•å…¥çš„æ–‡ä»¶æ˜¯æˆ‘ä»¬åˆšæ‰å¤åˆ¶è¿›æ¥å®˜æ–¹æ‰“æŠ¥å¥½çš„runtime-domæ–‡ä»¶
	import { createRenderer, h } from "./runtime-dom.esm-browser.js";
	const renderer = createRenderer();
	// å°†h1æ¸²æŸ“åˆ°é¡µé¢ä¸Š
	renderer.render(h("h1", "hello world"), document.getElementById("app"));
</script>
```

å‘ç°æ§åˆ¶å°ç«Ÿç„¶æŠ¥é”™äº†ï¼š

![image.png](./Vue3æºç è§£æ.assets/78aee4b64e9543568f6dc425d9471823tplv-k3u1fbpfcp-zoom-in-crop-mark1512000.webp)

ä»£ç éå¸¸ç®€å•ï¼Œå°±æ˜¯æƒ³è¦å°†`h1`æ ‡ç­¾æ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œä½†æ˜¯ä¸ºå•¥æŠ¥é”™äº†å‘¢ï¼Ÿæˆ‘ä»¬æŸ¥çœ‹æŠ¥é”™çš„å†…å®¹ï¼Œå¯ä»¥å‘ç°ï¼Œæç¤ºæˆ‘ä»¬ç¼ºå°‘`insert`æ–¹æ³•ï¼Œè¿™æ˜¯å•¥æ„æ€å‘¢ï¼Ÿæ²¡é”™ï¼Œå‰æ–‡æåˆ°äº†`runtime-dom`è¿™ä¸ªåŒ…ä¸­ï¼Œæä¾›äº†`DOM`æ“ä½œçš„`API`ï¼Œå°†è¿™äº›`API`é…ç½®é¡¹ç­‰ä¼ å…¥`createRenderer`ï¼Œæ‰èƒ½å¤Ÿæ­£å¸¸çš„æ‰§è¡Œä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶è¦ä¼ å…¥ä¸€ä¸ª`insert`æ–¹æ³•ï¼Œå‘Šè¯‰`runtime-core`åœ¨å°†è™šæ‹Ÿ`DOM`è½¬åŒ–ä¸ºçœŸå®`DOM`ï¼Œè¿›è¡Œæ’å…¥æ“ä½œï¼Œè¦ç”¨æˆ‘ä»¬ä¼ å…¥çš„è¿™ä¸ª`insert`æ–¹æ³•ï¼š

```html
<script type="module">
	// runtime-dom/dist/index.html æ–‡ä»¶
	// å¼•å…¥çš„æ–‡ä»¶æ˜¯æˆ‘ä»¬åˆšæ‰å¤åˆ¶è¿›æ¥å®˜æ–¹æ‰“æŠ¥å¥½çš„runtime-domæ–‡ä»¶
	import { createRenderer, h } from "./runtime-dom.esm-browser.js";

	const renderOptions = {
		// æˆ‘ä»¬è‡ªå·±æä¾›ä¸€ä¸ªinsertæ–¹æ³•ï¼Œå½“åšapiæ¥è°ƒç”¨
		insert(el, container, anchor = null) {
			container.insertBefore(el, anchor);
		},
	};
	// ä¼ å…¥é…ç½®é¡¹ï¼Œé‡Œè¾¹åŒ…å«å„ç§æ“ä½œçš„api
	const renderer = createRenderer(renderOptions);
	// å°†h1æ¸²æŸ“åˆ°é¡µé¢ä¸Š
	renderer.render(h("h1", "hello world"), document.getElementById("app"));
</script>
```

æ­¤æ—¶æˆ‘ä»¬å†åˆ·æ–°é¡µé¢ï¼Œå‘ç°åˆæœ‰äº†æ–°çš„æŠ¥é”™ï¼Œå¾ˆæ˜æ˜¾ï¼Œæœ‰äº†å‰è¾¹çš„ç»éªŒï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½æ˜ç™½ï¼ŒåŸæ¥è¿˜ç¼ºå°‘ä¸€ä¸ªåˆ›å»ºå…ƒç´ çš„æ–¹æ³•ï¼Œ`runtime-core`ä¸çŸ¥é“ç”¨å“ªä¸ª`API`æ¥è¿›è¡Œå…ƒç´ çš„åˆ›å»ºï¼Œäºæ˜¯æˆ‘ä»¬åˆè¡¥å……äº†ä¸€ä¸‹ä»£ç ï¼š

![image.png](./Vue3æºç è§£æ.assets/61d2de8806754aae8853ac076c1e55d2tplv-k3u1fbpfcp-zoom-in-crop-mark1512000.webp)

```html
<script type="module">
	// runtime-dom/dist/index.html æ–‡ä»¶
	// å¼•å…¥çš„æ–‡ä»¶æ˜¯æˆ‘ä»¬åˆšæ‰å¤åˆ¶è¿›æ¥å®˜æ–¹æ‰“æŠ¥å¥½çš„runtime-domæ–‡ä»¶
	import { createRenderer, h } from "./runtime-dom.esm-browser.js";

	const renderOptions = {
		// æˆ‘ä»¬è‡ªå·±æä¾›ä¸€ä¸ªinsertæ–¹æ³•ï¼Œå½“åšapiæ¥è°ƒç”¨
		insert(el, container, anchor = null) {
			container.insertBefore(el, anchor);
		},
		// æ³¨æ„ï¼ŒæŠ¥é”™ä¸­çš„hostCreateElementæ˜¯å¯¹æˆ‘ä»¬é…ç½®ä¸­çš„å‘½ååšäº†ä¸ªæ˜ å°„ï¼Œæ‰€ä»¥æˆ‘ä»¬é…ç½®è¿™é‡Œå‘½åä¸ºcreateElement
		createElement(element) {
			return document.createElement(element);
		},
	};
	// ä¼ å…¥é…ç½®é¡¹ï¼Œé‡Œè¾¹åŒ…å«å„ç§æ“ä½œçš„api
	const renderer = createRenderer(renderOptions);
	// å°†h1æ¸²æŸ“åˆ°é¡µé¢ä¸Š
	renderer.render(h("h1", "hello world"), document.getElementById("app"));
</script>
```

æˆ‘ä»¬å†è¿è¡Œä»£ç ï¼Œå‘ç°åˆæœ‰äº†ä¸€ä¸ªæŠ¥é”™ï¼Œè¿˜çœŸæ˜¯æ²¡å®Œæ²¡äº†- -ï¼Œæˆ‘ä»¬ä¸éš¾åˆ†æå‡ºæ¥ï¼Œè¿˜éœ€è¦æä¾›ä¸€ä¸ªè®¾ç½®å…ƒç´ å€¼çš„æ–¹æ³•ï¼Œäºæ˜¯æˆ‘ä»¬å†æ¬¡ä¿®æ”¹äº†é…ç½®é¡¹

![image.png](./Vue3æºç è§£æ.assets/ec042855880748d1a08d35c922c34b57tplv-k3u1fbpfcp-zoom-in-crop-mark1512000.webp)

```html
<script type="module">
	// runtime-dom/dist/index.html æ–‡ä»¶
	// å¼•å…¥çš„æ–‡ä»¶æ˜¯æˆ‘ä»¬åˆšæ‰å¤åˆ¶è¿›æ¥å®˜æ–¹æ‰“æŠ¥å¥½çš„runtime-domæ–‡ä»¶
	import { createRenderer, h } from "./runtime-dom.esm-browser.js";

	const renderOptions = {
		// æˆ‘ä»¬è‡ªå·±æä¾›ä¸€ä¸ªinsertæ–¹æ³•ï¼Œå½“åšapiæ¥è°ƒç”¨
		insert(el, container, anchor = null) {
			container.insertBefore(el, anchor);
		},
		// æ³¨æ„ï¼ŒæŠ¥é”™ä¸­çš„hostCreateElementæ˜¯å¯¹æˆ‘ä»¬é…ç½®ä¸­çš„å‘½ååšäº†ä¸ªæ˜ å°„ï¼Œæ‰€ä»¥æˆ‘ä»¬é…ç½®è¿™é‡Œå‘½åä¸ºcreateElement
		createElement(element) {
			return document.createElement(element);
		},
		// å°†æ–‡å­—å†…å®¹èµ‹å€¼ç»™å…ƒç´ 
		setElementText(el, text) {
			el.innerHTML = text;
		},
	};
	// ä¼ å…¥é…ç½®é¡¹ï¼Œé‡Œè¾¹åŒ…å«å„ç§æ“ä½œçš„api
	const renderer = createRenderer(renderOptions);
	// å°†h1æ¸²æŸ“åˆ°é¡µé¢ä¸Š
	renderer.render(h("h1", "hello world"), document.getElementById("app"));
</script>
```

è¿™æ¬¡æˆ‘ä»¬å†åˆ·æ–°é¡µé¢ï¼Œå¯ä»¥å‘ç°ï¼Œé¡µé¢ä¸Šç»ˆäºæ‰“å°å‡ºäº†`hello world`ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè‡³å°‘è¦æä¾›åˆ›å»ºå…ƒç´ ã€æ’å…¥å…ƒç´ ã€è®¾ç½®å…ƒç´ å†…å®¹è¿™ 3 ä¸ª`API`ï¼Œæ‰èƒ½å¤Ÿåœ¨é¡µé¢ä¸Šæ­£å¸¸æ˜¾ç¤ºä¸€ä¸ªåŸºæœ¬çš„å…ƒç´ ã€‚

è¯´äº†è¿™ä¹ˆå¤šï¼Œå¤§å®¶åº”è¯¥çŸ¥é“`runtime-dom`çš„å¤§è‡´ä½œç”¨äº†å§ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯æä¾›äº†ä¸Šè¿°çš„è¿™äº›ä¸ª`renderOptions`ä¸­`DOM`ç›¸å…³çš„`API`ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ‰äº†å¤§è‡´çš„æ€è·¯ï¼Œä¾¿å¼€å§‹å®ç°ä¸€ä¸‹å§ï¼

ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```js
runtime - dom;
src;
module; // å­˜æ”¾æ¨¡å—æ–‡ä»¶
index.ts; // å…¥å£æ–‡ä»¶
nodeOps.ts; // æ“ä½œèŠ‚ç‚¹ç›¸å…³çš„api
patchProp.ts; // å±æ€§ç›¸å…³çš„api
// src/index.ts
import { nodeOps } from "./nodeOps";
import { patchProp } from "./patchProp";

// å°†æ¸²æŸ“æ—¶æ‰€éœ€è¦çš„å±æ€§åšæ•´ç†
export const renderOptions = Object.assign({ patchProp }, nodeOps);
```

`nodeOps.ts`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å­˜æ”¾äº†å’ŒèŠ‚ç‚¹ç›¸å…³çš„æ“ä½œï¼Œä¸æ­¢ä¸Šæ–‡ä¸­æåˆ°çš„ä¸‰ä¸ªï¼Œå¸¸è§çš„è¿˜æœ‰å¦‚ä¸‹ä¸€äº›`API`ï¼š

```javascript
// src/nodeOps.tsæ–‡ä»¶
export const nodeOps = {
	insert: (child, parent, anchor) => {
		// æ·»åŠ èŠ‚ç‚¹
		parent.insertBefore(child, anchor || null);
	},
	remove: (child) => {
		// èŠ‚ç‚¹åˆ é™¤
		const parent = child.parentNode;
		if (parent) {
			parent.removeChild(child);
		}
	},
	createElement: (tag) => document.createElement(tag), // åˆ›å»ºèŠ‚ç‚¹
	createText: (text) => document.createTextNode(text), // åˆ›å»ºæ–‡æœ¬
	setText: (node, text) => (node.nodeValue = text), //  è®¾ç½®æ–‡æœ¬èŠ‚ç‚¹å†…å®¹
	setElementText: (el, text) => (el.textContent = text), // è®¾ç½®æ–‡æœ¬å…ƒç´ ä¸­çš„å†…å®¹
	parentNode: (node) => node.parentNode, // çˆ¶èŠ‚ç‚¹
	nextSibling: (node) => node.nextSibling, // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
	querySelector: (selector) => document.querySelector(selector), // æŸ¥æ‰¾å…ƒç´ 
};
```

é™¤äº†èŠ‚ç‚¹æ“ä½œï¼Œè¿˜æ¶‰åŠåˆ°äº†å¯¹æ¯”å±æ€§çš„æ–¹æ³•ï¼Œæ¯”å¦‚å¤„ç†ç±»ï¼Œæ ·å¼çš„æ›¿æ¢ï¼Œäº‹ä»¶çš„ç»‘å®šè§£ç»‘ï¼Œè¿™äº›éƒ½å†™åœ¨`src/patchProp.ts`æ–‡ä»¶ä¸­ï¼š

```javascript
// src/patchProp.tsæ–‡ä»¶

import { patchClass } from "./module/class";
import { patchStyle } from "./module/style";
import { patchEvent } from "./module/event";
import { patchAttr } from "./module/attr";

// æ¯”å¯¹å±æ€§çš„æ–¹æ³•
export const patchProp = (el, key, prevValue, nextValue) => {
	if (key === "class") {
		patchClass(el, nextValue);
	} else if (key === "style") {
		patchStyle(el, prevValue, nextValue);
	} else if (/^on[^a-z]/.test(key)) {
		patchEvent(el, key, nextValue);
	} else {
		patchAttr(el, key, nextValue);
	}
};
```

é’ˆå¯¹ä¸åŒæƒ…å†µçš„å¤„ç†ï¼ŒæŠŠè¿™äº›æ–‡ä»¶å•ç‹¬æ”¾åœ¨`module`æ–‡ä»¶å¤¹ä¸‹

```javascript
// src/module/attr.ts æ–‡ä»¶
export function patchAttr(el, key, value) {
	// æ›´æ–°å±æ€§
	if (value == null) {
		el.removeAttribute(key);
	} else {
		el.setAttribute(key, value);
	}
}
// src/module/class.ts æ–‡ä»¶
export function patchClass(el, value) {
	// æ ¹æ®æœ€æ–°å€¼è®¾ç½®ç±»å
	if (value == null) {
		el.removeAttribute("class");
	} else {
		el.className = value;
	}
}
// src/module/event.ts æ–‡ä»¶

function createInvoker(initialValue) {
	const invoker = (e) => invoker.value(e);
	// çœŸå®çš„æ–¹æ³•ï¼Œæ˜¯ç»‘å®šåœ¨.valueä¸Šçš„
	invoker.value = initialValue;
	return invoker;
}
export function patchEvent(el, rawName, nextValue) {
	const invokers = el._vei || (el._vei = {});
	const exisitingInvoker = invokers[rawName]; // æ˜¯å¦ç¼“å­˜è¿‡

	if (nextValue && exisitingInvoker) {
		// æœ‰æ–°å€¼å¹¶ä¸”ç»‘å®šè¿‡äº‹ä»¶ï¼Œéœ€è¦è¿›è¡Œæ¢ç»‘æ“ä½œ
		exisitingInvoker.value = nextValue;
	} else {
		// è·å–æ³¨å†Œäº‹ä»¶çš„åç§°
		const name = rawName.slice(2).toLowerCase();
		if (nextValue) {
			// ç¼“å­˜å‡½æ•°
			const invoker = (invokers[rawName] = createInvoker(nextValue));
			el.addEventListener(name, invoker);
		} else if (exisitingInvoker) {
			el.removeEventListener(name, exisitingInvoker);
			invokers[rawName] = undefined;
		}
	}
}
// src/module/style.ts æ–‡ä»¶
export function patchStyle(el, prev, next) {
	// æ›´æ–°style
	const style = el.style;
	for (const key in next) {
		// ç”¨æœ€æ–°çš„ç›´æ¥è¦†ç›–
		style[key] = next[key];
	}
	if (prev) {
		for (const key in prev) {
			// è€çš„æœ‰æ–°çš„æ²¡æœ‰åˆ é™¤
			if (next[key] == null) {
				style[key] = null;
			}
		}
	}
}
```

é‚£ä¹ˆæœ‰äº†è¿™äº›ä¸ª`API`ï¼Œ`runtime-core`å°±çŸ¥é“ï¼Œåº”è¯¥ç”¨å“ªäº›æ–¹æ³•å°†è™šæ‹Ÿ`DOM`è½¬åŒ–ä¸ºçœŸå®`DOM`äº†ã€‚ä¹‹åï¼Œæˆ‘ä»¬å¼•å…¥è‡ªå·±çš„`renderOptions`çœ‹çœ‹èƒ½ä¸èƒ½æ­£å¸¸æ¸²æŸ“ï¼š

```html
<script type="module">
	import { createRenderer, h } from "./runtime-dom.esm-browser.js";
	import { renderOptions } from "./runtime-dom.js";
	const renderer = createRenderer(renderOptions);
	renderer.render(h("h1", "hello"), app);
</script>
```

é¡µé¢æ­£å¸¸æ¸²æŸ“äº†ï¼é‚£ä¹ˆé’ˆå¯¹ä¸Šæ–‡è¿™ç§æ–¹å¼ï¼Œé€‚åˆé’ˆå¯¹æŸä¸ªå¹³å°ï¼ˆè·¨å¹³å°ï¼‰ï¼Œè‡ªå·±å®šä¹‰ä¸€å¥—æ¸²æŸ“`API`ï¼Œå¯ä»¥éšæ„è¿›è¡Œå®šåˆ¶åŒ–ï¼Œå¦‚æœåœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹ï¼Œå…¶å®æ­£å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œ`API`éƒ½å·²ç»åœ¨`runtime-dom`ä¸­äº†ï¼Œæ‰€ä»¥åœ¨å†…éƒ¨åˆæä¾›äº†ä¸€ä¸ªæ–¹æ³•(`render`)ï¼Œé»˜è®¤æŠŠè¿™ä¸€å¨`renderOptions`è‡ªåŠ¨ä¼ è¿›å»äº†ï¼Œä¸ç”¨æˆ‘ä»¬å†æ‰‹åŠ¨ä¼ å…¥ï¼š

```html
<script type="module">
	import { createRenderer, h, render } from "./runtime-dom.esm-browser.js";
	// import { renderOptions } from './runtime-dom.js'
	//const renderer = createRenderer(renderOptions)
	//renderer.render(h('h1', 'hello'), app)
	render(h("h1", "hello"), app);
</script>
```

å†æ¬¡è¿è¡Œä»£ç ï¼Œå‘ç°ç»“æœæ²¡å˜ï¼Œè¿˜æ˜¯èƒ½æ­£å¸¸è¿è¡Œï¼Œè¯´æ˜è¿™ä¸¤ç§æ–¹å¼éƒ½å¯è¡Œï¼Œä½¿ç”¨`render`çš„è¯ï¼Œç›¸å½“äºé»˜è®¤ä¼ å…¥æµè§ˆå™¨ç¯å¢ƒä¸‹çš„`API`ï¼Œä½¿ç”¨`createRenderer`å¯ä»¥è‡ªå®šä¹‰ä¼ å…¥`API`ï¼Œæ¯”è¾ƒçµæ´»ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬æœ€åè¿˜éœ€è¦æ”¹ä¸€ä¸‹å…¥å£æ–‡ä»¶çš„å†…å®¹ï¼š

```javascript
// src/index.ts
import { nodeOps } from "./nodeOps";
import { patchProp } from "./patchProp";
import { createRenderer as renderer } from "@vue/runtime-core";

// å°†æ¸²æŸ“æ—¶æ‰€éœ€è¦çš„å±æ€§åšæ•´ç†
export const renderOptions = Object.assign({ patchProp }, nodeOps);

export function createRenderer(options) {
	// æä¾›äº†æ¸²æŸ“çš„apiï¼Œä½†å®é™…è°ƒç”¨çš„æ˜¯runtime-coreä¸­çš„æ–¹æ³•
	return renderer(options);
}

// ä¸“é—¨ç»™æµè§ˆå™¨ç¯å¢ƒä¸­ä½¿ç”¨
export function render(vnode, container) {
	const renderer = createRenderer(renderOptions);
	return renderer.render(vnode, container);
}
// å°†runtime-coreä¸­çš„æ–¹æ³•éƒ½è¿›è¡Œå¯¼å‡º
export * from "@vue/runtime-core";
```

æ—¢ç„¶ä»`runtime-core`åŒ…ä¸­å¼•å…¥äº†æ¸²æŸ“çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦çš„å°±æ˜¯æ¥å®ç°`runtime-core`çš„æ ¸å¿ƒé€»è¾‘äº†ã€‚

### `runtime-core`çš„å®ç°

è€è§„çŸ©ï¼Œé¦–å…ˆè¿˜æ˜¯åˆ›å»ºç›¸åº”æ–‡ä»¶å¤¹ï¼š

```bash
runtime-core
      src
        index.ts // å…¥å£æ–‡ä»¶
        createVNode.ts // åˆ›å»ºè™šæ‹ŸDOM
        renderer.ts // åˆ›å»ºçœŸå®DOMè¿›è¡Œæ¸²æŸ“
        h.ts // å°è£…createVNodeï¼Œå½¢æˆhæ–¹æ³•
```

å…ˆåœ¨å…¥å£æ–‡ä»¶è¿›è¡Œå¯¼å‡ºæ“ä½œï¼Œé˜²æ­¢åè¾¹å¿˜è®°æ‰ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œæ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€è¯´ï¼Œ`runtime-dom`å°†`DOM`ç›¸å…³`API`ä¼ ç»™`runtime-core`ï¼Œ`runtime-core`ä¸­åˆä½¿ç”¨äº†`reactivity`æ¨¡å—ï¼Œè‡³æ­¤ï¼Œä¸‰ä¸ªæ¨¡å—ä¾¿äº’ç›¸ä¸²é€šäº†èµ·æ¥ã€‚

```javascript
// index.ts å…¥å£æ–‡ä»¶
export * from "./renderer";
export * from "./createVNode";
export * from "./h";
export * from "@vue/reactivity";
```

æˆ‘ä»¬è¿˜æ˜¯å…ˆç´§è·Ÿç€`runtime-dom`çš„é€»è¾‘ï¼Œå…ˆå†™ä¸‹`renderer.ts`çš„å¤§æ¦‚é€»è¾‘ï¼Œé‚£ä¹ˆè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬`runtime-dom`ä¸­ä½¿ç”¨çš„`createRenderer`æ–¹æ³•ï¼Œå®é™…ä¸Šè°ƒç”¨çš„è¿˜æ˜¯`runtime-core`ä¸­çš„æ–¹æ³•ã€‚

```javascript
// renderer.tsæ–‡ä»¶
export function createRenderer(renderOptions) {
	// ä»renderOptionsä¸­è§£æ„apiï¼Œå¹¶é‡å‘½å
	const {
		insert: hostInsert,
		remove: hostRemove,
		patchProp: hostPatchProp,
		createElement: hostCreateElement,
		createText: hostCreateText,
		setText: hostSetText,
		setElementText: hostSetElementText,
		parentNode: hostParentNode,
		nextSibling: hostNextSibling,
		querySelector: hostQuerySelector,
	} = renderOptions;
	const render = (vnode, container) => {
		console.log("render");
	};
	return {
		render,
	};
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬å†™ä¸€ä¸‹`createVNode.ts`ä¸­çš„é€»è¾‘ã€‚æ‰€è°“è™šæ‹Ÿ`DOM`ï¼Œå°±æ˜¯ç”¨å¯¹è±¡çš„å½¢å¼ï¼Œæ¥å½¢å®¹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ ‡æ³¨äº†å„ç§ä¿¡æ¯ï¼Œä¸ºäº†ä¹‹åè½¬åŒ–æˆçœŸå®`DOM`ã€‚

```javascript
import { ShapeFlags } from "@vue/shared";
// åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹
export function isVNode(value) {
	return value ? value.__v_isVNode === true : false;
}
export function createVNode(type, props, children = null) {
	const shapeFlag = typeof type === "string" ? ShapeFlags.ELEMENT : 0;
	// è™šæ‹ŸèŠ‚ç‚¹åŒ…å«çš„ä¿¡æ¯
	const vnode = {
		__v_isVNode: true, // åˆ¤æ–­å¯¹è±¡æ˜¯ä¸æ˜¯è™šæ‹ŸèŠ‚ç‚¹
		type,
		props,
		key: props && props["key"], // è™šæ‹ŸèŠ‚ç‚¹çš„keyï¼Œä¸»è¦ç”¨äºdiffç®—æ³•
		el: null, // è™šæ‹ŸèŠ‚ç‚¹å¯¹åº”çš„çœŸå®èŠ‚ç‚¹
		children,
		shapeFlag,
	};
	if (children) {
		let type = 0;
		if (Array.isArray(children)) {
			type = ShapeFlags.ARRAY_CHILDREN;
		} else {
			children = String(children);
			type = ShapeFlags.TEXT_CHILDREN;
		}
		vnode.shapeFlag |= type;
		// å¦‚æœshapeFlagç»“æœä¸º9 è¯´æ˜å…ƒç´ ä¸­åŒ…å«ä¸€ä¸ªæ–‡æœ¬
		// å¦‚æœshapeFlagç»“æœä¸º17 è¯´æ˜å…ƒç´ ä¸­æœ‰å¤šä¸ªå­èŠ‚ç‚¹
	}
	// è¿”å›çš„è™šæ‹ŸèŠ‚ç‚¹å¹¶ä¸”æ ‡æ³¨äº†è™šæ‹ŸèŠ‚ç‚¹çš„ç±»å‹ï¼Œä¹‹åç”ŸæˆçœŸå®DOMæ—¶ï¼Œæ ¹æ®shapFlagè°ƒç”¨ä¸åŒçš„æ–¹æ³•ã€‚
	return vnode;
}
```

æˆ‘ä»¬åœ¨`@vue/shared`åŒ…ä¸­è¡¥å……ä¸‹`ShapFlags`ï¼Œå¹¶ä¸”æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼Œè¿™åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚

```javascript
// shared/src/index.ts
export const enum ShapeFlags { // Vue3æä¾›çš„æ ‡è¯†
  ELEMENT = 1, // å…ƒç´ 
  FUNCTIONAL_COMPONENT = 1 << 1, // å‡½æ•°å¼ç»„ä»¶
  STATEFUL_COMPONENT = 1 << 2, // æ™®é€šçŠ¶æ€ç»„ä»¶
  TEXT_CHILDREN = 1 << 3, // ç»„ä»¶å„¿å­ä¸ºæ–‡æœ¬
  ARRAY_CHILDREN = 1 << 4, // ç»„ä»¶çš„å„¿å­ä¸ºæ•°ç»„
  SLOTS_CHILDREN = 1 << 5, // ç»„ä»¶çš„æ’æ§½
  TELEPORT = 1 << 6, // ä¼ é€é—¨ç»„ä»¶
  SUSPENSE = 1 << 7, // å¼‚æ­¥åŠ è½½ç»„ä»¶
  COMPONENT_SHOULD_KEEP_ALIVE = 1 << 8, // keep-aliveç›¸å…³
  COMPONENT_KEPT_ALIVE = 1 << 9, // keep-aliveç›¸å…³
  COMPONENT = ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT // æŒ‰ä½æˆ–æ“ä½œï¼Œç›¸å½“äºåŒ…å«ä¸¤ç§ç±»å‹
}
```

å¾ˆå¤šæœ‹å‹å¯èƒ½å¯¹`<< | &`ç§»ä½ã€æŒ‰ä½æˆ–ã€æŒ‰ä½ä¸å¾ˆé™Œç”Ÿï¼Œå°±ç®—çŸ¥é“å…¶å®šä¹‰ï¼Œä¹Ÿä¸çŸ¥é“æœ‰å“ªäº›ä¸ªä½¿ç”¨åœºæ™¯ã€‚å…¶å®åœ¨`Vue3`ä¸­ï¼Œå°±æœ‰å¾ˆå¥½çš„ä¾‹å­ã€‚æ¯”å¦‚è¿™ä¸ª`ShapFlags`é€šè¿‡åç§°æˆ‘ä»¬ä¾¿èƒ½å¤§è‡´çŒœå‡ºæ¥ï¼Œæ˜¯æè¿°å½¢çŠ¶çš„æ ‡å¿—ï¼Œæ¯”å¦‚ä¸€ä¸ªæ™®é€šçš„å…ƒç´ ï¼Œå°±ç”¨ 1 æ¥ä»£è¡¨ï¼Œå‡½æ•°å¼ç»„ä»¶å°±ç”¨ 1 å‘å·¦ç§» 1 ä½æ¥è¡¨ç¤ºï¼Œæ™®é€šçš„çŠ¶æ€ç»„ä»¶ï¼Œå°±ç”¨ 1 å‘å·¦ç§» 2 ä½æ¥è¡¨ç¤ºã€‚ä¸ºå•¥è¦ç”¨ç§»ä½æ“ä½œå‘¢ï¼Ÿæå‡ ä¸ªæ™®é€šçš„æšä¸¾å€¼ä¸è¡Œä¹ˆï¼Œå…¶å®ï¼Œä¹‹æ‰€ä»¥ç”¨ç§»ä½æ¥è¿›è¡Œæ ‡è¯†ï¼Œæ˜¯ä¸ºäº†åç»­è¿›è¡ŒæŒ‰ä½ä¸ï¼ŒæŒ‰ä½æˆ–æ“ä½œæä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹çš„ 3 ç§æƒé™ï¼š

```bash
æµ‹è¯•ï¼š1ï¼ŒäºŒè¿›åˆ¶ä¸º001
å¼€å‘è€…ï¼š1 << 1ï¼ŒäºŒè¿›åˆ¶ä¸º010
è¶…çº§ç®¡ç†å‘˜ï¼š1 << 2ï¼ŒäºŒè¿›åˆ¶ä¸º100
```

é‚£ä¹ˆå½“`A`ï¼Œæ—¢æ˜¯`å¼€å‘è€…`ï¼Œåˆæ˜¯`è¶…çº§ç®¡ç†å‘˜`çš„æ—¶å€™ï¼Œé‚£ä¹ˆåªéœ€è¦å°†`å¼€å‘è€…`å’Œ`è¶…çº§ç®¡ç†å‘˜`çš„æƒé™è¿›è¡ŒæŒ‰ä½æˆ–æ“ä½œï¼Œä¹Ÿå°±æ˜¯`010`å’Œ`100`è¿›è¡ŒæŒ‰ä½æˆ–æ“ä½œï¼Œå¾—åˆ°çš„ç»“æœä¸º`110`ï¼Œå¤§äº`0`ã€‚é‚£ä¹ˆåˆ¤æ–­`A`æœ‰æ²¡æœ‰`æµ‹è¯•`æƒé™ï¼Œåªéœ€è¦å°†åˆšæ‰çš„ç»“æœå’Œ`æµ‹è¯•`çš„æƒé™è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œå³`110`å’Œ`001`è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œå¾—åˆ°çš„ç»“æœä¸º`000`ï¼Œç­‰äº`0`ã€‚ä»è€Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨ä½¿ç”¨ç§»ä½ç¬¦æ“ä½œçš„æšä¸¾å€¼ï¼Œè¿›è¡Œ`|`æ“ä½œåï¼Œç›¸å½“äºæƒé™ç›¸åŠ çš„æ“ä½œï¼Œè¿›è¡Œ`&`æ“ä½œåï¼Œå¦‚æœç»“æœå¤§äº`0`ï¼Œè¯´æ˜åŒ…å«ç›¸å…³æƒé™ï¼Œå¦‚æœç»“æœç­‰äº`0`ï¼Œåˆ™è¯´æ˜ä¸åŒ…æ‹¬ç›¸å…³æƒé™ã€‚

é‚£ä¹ˆå†å›åˆ°æˆ‘ä»¬ä¹‹å‰çš„å®ä¾‹ï¼Œæˆ‘ä»¬æ”¹åŠ¨ä¸‹`index.html`ä¸­çš„ä»£ç ï¼Œæ¥è°ƒè¯•ä¸‹ä»£ç æœ‰æ²¡æœ‰ç”Ÿæ•ˆï¼Œå…ˆè°ƒè¯•ä¸‹`createVNode`æ–¹æ³•ï¼š

```html
<script>
	import { createVNode } from "./runtime-dom.js";
	console.log(createVNode("div", null, ["hello", "world"]));
</script>
```

æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œè™šæ‹ŸèŠ‚ç‚¹æˆåŠŸçš„è¢«åˆ›å»ºäº†ï¼š

![image.png](./Vue3æºç è§£æ.assets/c7bd11bb6e6846a38169f6f7606d006ftplv-k3u1fbpfcp-zoom-in-crop-mark1512000.webp)

ä½†æ˜¯`createVNode`è¿™ä¸ªæ–¹æ³•ï¼Œå†™æ³•æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚ä¼ å‚çš„é¡ºåºå’Œç±»å‹ï¼Œéƒ½ä¸èƒ½å˜ï¼Œå¹¶ä¸çµæ´»ï¼Œï¼ˆç‰¹åˆ«æ³¨æ„ï¼Œ`createVNode`çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œåªèƒ½ä¼ å­—ç¬¦ä¸²å’Œæ•°ç»„ç±»å‹çš„æ•°æ®ï¼‰ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäº`createVNode`è¿›è¡Œå°è£…ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„`h`æ–¹æ³•äº†ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸‹`h`æ–¹æ³•èƒ½æ€ä¹ˆä¼ å‚ï¼š

- åªä¼  1 ä¸ªå‚æ•°ï¼Œå°±æ˜¯æ ‡ç­¾ï¼›
- ä¼  2 ä¸ªå‚æ•°ï¼Œå¯èƒ½æ˜¯ä¼ æ ‡ç­¾å’Œå±æ€§ï¼š`h('div', { style: { color: 'red' } })`ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¼ æ ‡ç­¾å’Œå­å…ƒç´ ï¼š`h('div', h('span', null, 'hello'))  h('div', [h('span', null, 'hello')])`ï¼Œè¿˜å¯èƒ½æ˜¯ä¼ æ ‡ç­¾å’Œå†…å®¹ï¼š`h('div', 'hello')`
- ä¼  3 ä¸ªå‚æ•°ï¼Œé‚£å°±æ˜¯å’Œ`createVNode`çš„ä¼ å‚ä¸€æ ·äº†ï¼Œå³`h('div', { style: {color: 'red'} }, 'hello')`
- ä¼  3 ä¸ªä»¥ä¸Šçš„å‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯å±æ€§ï¼Œä¹‹åçš„å‚æ•°éƒ½ä½œä¸ºå†…å®¹ï¼š`h('div', null, 'hello', 'world', '!')`

é‚£ä¹ˆçŸ¥é“äº†ä»¥ä¸Šçš„ç”¨æ³•ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æŒ‰ç…§ä¼ å‚æ•°é‡çš„ä¸åŒï¼Œåˆ†åˆ«å¤„ç†ç›¸åº”é€»è¾‘ï¼Œæ¥ç¼–å†™`h`æ–¹æ³•äº†ï¼š

```javascript
// h.ts æ–‡ä»¶
import { isArray, isObject } from "@vue/shared";
import { createVNode, isVNode } from "./createVNode";

export function h(type, propsOrChildren?, children?) {
	const l = arguments.length;
	if (l === 2) {
		// åªæœ‰å±æ€§ï¼Œæˆ–è€…åªæœ‰ä¸€ä¸ªç”Ÿæˆçš„è™šæ‹Ÿå…ƒç´ çš„æ—¶å€™
		if (isObject(propsOrChildren) && !isArray(propsOrChildren)) {
			// åŒºåˆ†ç¬¬äºŒä¸ªå‚æ•°æ˜¯å±æ€§è¿˜æ˜¯ç”Ÿæˆçš„è™šæ‹Ÿå…ƒç´ ï¼Œæ¯”å¦‚h('div',h('span'))
			if (isVNode(propsOrChildren)) {
				// å¦‚æœæ˜¯è™šæ‹Ÿå…ƒç´ ï¼Œæ ¹æ®createVNodeçš„ä¼ å‚è¦æ±‚ï¼Œå°±è¦ç”¨æ•°ç»„åŒ…èµ·æ¥
				return createVNode(type, null, [propsOrChildren]);
			}
			// å¦‚æœæ˜¯h('div',{style:{color:'red'}})ï¼Œåˆ™è¿›è¡Œå¦‚ä¸‹ä¼ å‚
			return createVNode(type, propsOrChildren);
		} else {
			// ä¼ é€’å„¿å­åˆ—è¡¨h('div',null,[h('span'),h('span')])æˆ–è€…h('div', 'hello')çš„æƒ…å†µ
			return createVNode(type, null, propsOrChildren);
		}
	} else {
		// é™¤äº†å‰2ä¸ªï¼Œåè¾¹çš„éƒ½æ˜¯å­å…ƒç´ 
		if (l > 3) {
			children = Array.prototype.slice.call(arguments, 2);
		} else if (l === 3 && isVNode(children)) {
			// ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯ç”Ÿæˆçš„è™šæ‹Ÿå…ƒç´ 
			children = [children];
		}
		return createVNode(type, propsOrChildren, children);
	}
}
```

åˆ°æ­¤ï¼Œæˆ‘ä»¬`h`æ–¹æ³•ä¾¿å†™å¥½äº†ï¼Œæ˜¯ä¸æ˜¯æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆå›°éš¾å‘¢ï¼Ÿ

æ¥ä¸‹æ¥ï¼Œå°±è¯¥å®Œå–„`createRenderer`æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ¸²æŸ“æ–¹æ³•äº†ï¼Œä¹‹åäºŒè€…ä¸€ç»“åˆï¼Œå°±èƒ½å¤Ÿåœ¨é¡µé¢ä¸­ï¼Œå°†è™šæ‹Ÿ`DOM`æ¸²æŸ“æˆçœŸå®`DOM`äº†ï¼Œåˆšæ‰æˆ‘ä»¬å†™åˆ°äº†`render`æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬ç»§ç»­å®Œå–„å§ï¼

```javascript
// renderer.ts æ–‡ä»¶
export function createRenderer(renderOptions) {
	// ä»renderOptionsä¸­è§£æ„apiï¼Œå¹¶é‡å‘½å
	const {
		insert: hostInsert,
		remove: hostRemove,
		patchProp: hostPatchProp,
		createElement: hostCreateElement,
		createText: hostCreateText,
		setText: hostSetText,
		setElementText: hostSetElementText,
		parentNode: hostParentNode,
		nextSibling: hostNextSibling,
		querySelector: hostQuerySelector,
	} = renderOptions;
	const render = (vnode, container) => {
		// è™šæ‹ŸèŠ‚ç‚¹æ¸²æŸ“æˆçœŸå®DOMï¼ŒæŒ‚è½½åˆ°é¡µé¢ä¸Š
		// å¸è½½æ“ä½œ render(null, container)
		// åˆå§‹åŒ–å’Œæ›´æ–°è™šæ‹ŸDOM
		if (vnode == null) {
			// å¸è½½é€»è¾‘
		} else {
			// åˆå§‹ä¼ å…¥ä¸€ä¸ªnullä½œä¸ºè€çš„è™šæ‹ŸDOMå€¼ï¼›ä¿ç•™ä¹‹å‰çš„vnodeï¼Œä¸ºä¹‹åçš„diffç®—æ³•åšå‡†å¤‡
			patch(container._vnode || null, vnode, container);
		}
		container._vnode = vnode;
	};
	return {
		render,
	};
}
const mountElement = (vnode, container) => {
	// å°†è™šæ‹ŸèŠ‚ç‚¹è½¬åŒ–ä¸ºçœŸå®DOM
};

// è™šæ‹ŸèŠ‚ç‚¹å¯¹æ¯”é€»è¾‘
const patch = (n1, n2, container) => {
	if (n1 == n2) {
		return;
	}
	if (n1 == null) {
		// åˆå§‹åŒ–æƒ…å†µ
		mountElement(n2, container);
	} else {
		// n1, n2ä¸ç›¸ç­‰ï¼Œdiffç®—æ³•é€»è¾‘
	}
};
```

é‚£ä¹ˆæ•´ä¸ªæµç¨‹çš„æ¶å­æˆ‘ä»¬å·²ç»æ­å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±ä¸€ä¸ªä¸ªæ¥å®ç°å…·ä½“çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆå®ç°å°†è™šæ‹Ÿ`DOM`è½¬åŒ–ä¸ºçœŸå®`DOM`çš„`mountElement`æ–¹æ³•ï¼š

```javascript
// renderer.ts æ–‡ä»¶
export function createRenderer(renderOptions) {
	// ä»renderOptionsä¸­è§£æ„apiï¼Œå¹¶é‡å‘½å
	const {
		insert: hostInsert,
		remove: hostRemove,
		patchProp: hostPatchProp,
		createElement: hostCreateElement,
		createText: hostCreateText,
		setText: hostSetText,
		setElementText: hostSetElementText,
		parentNode: hostParentNode,
		nextSibling: hostNextSibling,
		querySelector: hostQuerySelector,
	} = renderOptions;
	const mountChildren = (children, container) => {
		for (let i = 0; i < children.length; i++) {
			// é€’å½’è°ƒç”¨patchæ–¹æ³•
			patch(null, children[i], container);
		}
	};
	const mountElement = (vnode, container) => {
		// å°†è™šæ‹ŸèŠ‚ç‚¹è½¬åŒ–ä¸ºçœŸå®DOM
		const { type, props, shapeFlag, children } = vnode;
		// åˆ›å»ºçœŸå®å…ƒç´ ï¼ŒæŒ‚è½½åˆ°è™šæ‹ŸèŠ‚ç‚¹ä¸Š
		let el = (vnode.el = hostCreateElement(type));
		// å¦‚æœæœ‰propsï¼Œåˆ™å¤„ç†å±æ€§
		if (props) {
			for (const key in props) {
				hostPatchProp(el, key, null, props[key]);
			}
		}
		if (children) {
			if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
				// è¯´æ˜æ˜¯æ–‡æœ¬
				hostSetElementText(el, vnode.children);
			} else if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
				// è¯´æ˜æœ‰å¤šä¸ªå„¿å­
				mountChildren(vnode.children, el);
			}
		}
		hostInsert(el, container); // æ’å…¥åˆ°å®¹å™¨ä¸­
	};
	// è™šæ‹ŸèŠ‚ç‚¹å¯¹æ¯”é€»è¾‘
	const patch = (n1, n2, container) => {
		if (n1 == n2) {
			return;
		}
		if (n1 == null) {
			// åˆå§‹åŒ–æƒ…å†µ
			mountElement(n2, container);
		} else {
			// n1, n2ä¸ç›¸ç­‰ï¼Œdiffç®—æ³•é€»è¾‘
		}
	};
	const render = (vnode, container) => {
		// è™šæ‹ŸèŠ‚ç‚¹æ¸²æŸ“æˆçœŸå®DOMï¼ŒæŒ‚è½½åˆ°é¡µé¢ä¸Š
		// å¸è½½æ“ä½œ render(null, container)
		// åˆå§‹åŒ–å’Œæ›´æ–°è™šæ‹ŸDOM
		if (vnode == null) {
			// å¸è½½é€»è¾‘
		} else {
			// åˆå§‹ä¼ å…¥ä¸€ä¸ªnullä½œä¸ºè€çš„è™šæ‹ŸDOMå€¼ï¼›ä¿ç•™ä¹‹å‰çš„vnodeï¼Œä¸ºä¹‹åçš„diffç®—æ³•åšå‡†å¤‡
			patch(container._vnode || null, vnode, container);
		}
		container._vnode = vnode;
	};
	return {
		render,
	};
}
```

æˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œå°±æ˜¯ç”¨äº†`runtime-dom`ä¸­çš„`API`ï¼Œæ¥é€’å½’ç”ŸæˆçœŸå®çš„`DOM`å…ƒç´ ï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼Œä»£ç æ˜¯å¦æœ‰é—®é¢˜å§ï¼š

```html
<script type="module">
	import { h, render } from "./runtime-dom.js";
	render(h("h1", { style: { color: "red" } }, "hello"), app);
</script>
```

åœ¨æµè§ˆå™¨ä¸­è¿è¡Œå®Œä»£ç ï¼Œå‘ç°ï¼Œ`hello`å·²ç»æˆåŠŸè¢«æ¸²æŸ“åˆ°é¡µé¢ä¸Šäº†ã€‚é‚£ä¹ˆåˆå§‹åŒ–é˜¶æ®µçš„æ¸²æŸ“çš„é€»è¾‘ï¼Œä¾¿å†™å®Œäº†ï¼é‚£ä¹ˆåˆå§‹åŒ–é€»è¾‘å†™å®Œåï¼Œæˆ‘ä»¬å†å†™ä¸€ä¸‹å¸è½½çš„é€»è¾‘ï¼Œä»€ä¹ˆæ˜¯å¸è½½çš„é€»è¾‘å‘¢ï¼Ÿå¯ä»¥ç†è§£ä¸º`render(null, app)`ï¼Œä¹Ÿå°±æ˜¯ä¼ å…¥äº†`null`çš„æ—¶å€™ï¼Œè¦æŠŠé¡µé¢ä¸­å…ƒç´ æ¸…é™¤æ‰ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»é¢„ç•™å‡ºæ¥å¸è½½é€»è¾‘çš„ä½ç½®ï¼Œé‚£æˆ‘ä»¬ç°åœ¨ä¾¿å¯ä»¥æ¥å®Œå–„äº†ï¼š

```javascript
// renderer.ts æ–‡ä»¶
export function createRenderer(renderOptions) {
	// ä»renderOptionsä¸­è§£æ„apiï¼Œå¹¶é‡å‘½å
	const {
		insert: hostInsert,
		remove: hostRemove,
		patchProp: hostPatchProp,
		createElement: hostCreateElement,
		createText: hostCreateText,
		setText: hostSetText,
		setElementText: hostSetElementText,
		parentNode: hostParentNode,
		nextSibling: hostNextSibling,
		querySelector: hostQuerySelector,
	} = renderOptions;
	const mountChildren = (children, container) => {
		for (let i = 0; i < children.length; i++) {
			// é€’å½’è°ƒç”¨patchæ–¹æ³•
			patch(null, children[i], container);
		}
	};
	const mountElement = (vnode, container) => {
		// å°†è™šæ‹ŸèŠ‚ç‚¹è½¬åŒ–ä¸ºçœŸå®DOM
		const { type, props, shapeFlag, children } = vnode;
		// åˆ›å»ºçœŸå®å…ƒç´ ï¼ŒæŒ‚è½½åˆ°è™šæ‹ŸèŠ‚ç‚¹ä¸Š
		let el = (vnode.el = hostCreateElement(type));
		// å¦‚æœæœ‰propsï¼Œåˆ™å¤„ç†å±æ€§
		if (props) {
			for (const key in props) {
				hostPatchProp(el, key, null, props[key]);
			}
		}
		if (children) {
			if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
				// è¯´æ˜æ˜¯æ–‡æœ¬
				hostSetElementText(el, vnode.children);
			} else if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
				// è¯´æ˜æœ‰å¤šä¸ªå„¿å­
				mountChildren(vnode.children, el);
			}
		}
		hostInsert(el, container); // æ’å…¥åˆ°å®¹å™¨ä¸­
	};
	// è™šæ‹ŸèŠ‚ç‚¹å¯¹æ¯”é€»è¾‘
	const patch = (n1, n2, container) => {
		if (n1 == n2) {
			return;
		}
		if (n1 == null) {
			// åˆå§‹åŒ–æƒ…å†µ
			mountElement(n2, container);
		} else {
			// n1, n2ä¸ç›¸ç­‰ï¼Œdiffç®—æ³•é€»è¾‘
		}
	};
	// å¸è½½å…ƒç´ çš„æ–¹æ³•
	const unmount = (vnode) => {
		const { shapeFlag } = vnode;
		if (shapeFlag & ShapeFlags.ELEMENT) {
			// å¦‚æœæ˜¯ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆç›´æ¥åˆ é™¤DOMå³å¯
			hostRemove(vnode.el);
		}
	};
	const render = (vnode, container) => {
		// è™šæ‹ŸèŠ‚ç‚¹æ¸²æŸ“æˆçœŸå®DOMï¼ŒæŒ‚è½½åˆ°é¡µé¢ä¸Š
		// å¸è½½æ“ä½œ render(null, container)
		// åˆå§‹åŒ–å’Œæ›´æ–°è™šæ‹ŸDOM
		if (vnode == null) {
			// å¸è½½é€»è¾‘
			if (container._vnode) {
				// æ‰¾åˆ°å¯¹åº”çš„çœŸå®èŠ‚ç‚¹ï¼Œå°†å…¶å¸è½½
				unmount(container._vnode);
			}
		} else {
			// åˆå§‹ä¼ å…¥ä¸€ä¸ªnullä½œä¸ºè€çš„è™šæ‹ŸDOMå€¼ï¼›ä¿ç•™ä¹‹å‰çš„vnodeï¼Œä¸ºä¹‹åçš„diffç®—æ³•åšå‡†å¤‡
			patch(container._vnode || null, vnode, container);
		}
		container._vnode = vnode;
	};
	return {
		render,
	};
}
```

åˆ°è¿™é‡Œï¼Œå°±åªå‰©ä¸‹å…ƒç´ æ›´æ–°çš„é€»è¾‘äº†ï¼Œé‚£ä¹ˆå…ƒç´ æ›´æ–°çš„é€»è¾‘ï¼Œæ¶‰åŠçš„å†…å®¹åˆéå¸¸å¤šï¼Œæˆ‘ä»¬å…ˆè®²ä¸€äº›å…³é”®æ€§çš„ç‚¹ï¼Œä»è€Œä¸ºåç»­æ–‡ç« åšå¥½é“ºå«ã€‚æˆ‘ä»¬ç”¨å‡ ä¸ªä¸åŒçš„ä¾‹å­ï¼Œæ¥è¡¨æ˜ä»€ä¹ˆæ—¶å€™è§¦å‘æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ€ä¹ˆåˆ¤æ–­ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹ç›¸åŒï¼Œå¯ä»¥å¤ç”¨ï¼š

```html
<script type="module">
	import { h, render } from "./runtime-dom.js";
	// 1ã€å¯ä»¥çœ‹åˆ°ï¼Œæ ‡ç­¾åä¸ç›¸åŒï¼Œæ‰€ä»¥å°±ä¸èƒ½å¤Ÿè¿›è¡ŒDOMå¤ç”¨
	render(h("h1", { style: { color: "red" } }, "hello"), app);
	render(h("div", { style: { color: "blue" } }, "world"), app);
	// 2ã€é‚£ä¹ˆå¦‚æœæ ‡ç­¾åç›¸åŒï¼Œåˆä¸æƒ³å¤ç”¨DOMï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±éœ€è¦æä¾›keyï¼Œæ¥è¿›è¡ŒåŒºåˆ†äº†
	render(h("div", { style: { color: "blue" }, key: 1 }, "world"), app);
	render(h("div", { style: { color: "blue" }, key: 2 }, "world"), app);
	// 3ã€å¦‚æœæ ‡ç­¾åç›¸åŒï¼Œä¹Ÿæ²¡æœ‰keyï¼Œé‚£ä¹ˆå°±è¿›è¡Œå¤ç”¨
	render(h("h1", { style: { color: "red" } }, "hello"), app);
	render(h("h1", { style: { color: "red" } }, "hello"), app);
</script>
```

> æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°ç»“è®ºï¼Œå½“ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„æ ‡ç­¾ç±»å‹ä¸åŒæ—¶å€™ï¼Œæˆ–è€…ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹æ ‡ç­¾ç±»å‹ç›¸åŒï¼Œä½†æ˜¯ key ä¸åŒï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¿›è¡Œå¤ç”¨ï¼›å¦‚æœä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„æ ‡ç­¾ç±»å‹ç›¸åŒï¼Œå¹¶ä¸”ä¸ä¼ å…¥ keyï¼Œæˆ–è€… key ç›¸åŒï¼Œé‚£ä¹ˆå°±è¿›è¡Œå¤ç”¨ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ç»§ç»­æ”¹è¿›ä¸‹æ›´æ–°ä¸‹`patch`æ–¹æ³•ä¸­çš„ä»£ç ï¼š

```javascript
// renderer.ts æ–‡ä»¶
export function createRenderer(renderOptions) {
	// ä»renderOptionsä¸­è§£æ„apiï¼Œå¹¶é‡å‘½å
	const {
		insert: hostInsert,
		remove: hostRemove,
		patchProp: hostPatchProp,
		createElement: hostCreateElement,
		createText: hostCreateText,
		setText: hostSetText,
		setElementText: hostSetElementText,
		parentNode: hostParentNode,
		nextSibling: hostNextSibling,
		querySelector: hostQuerySelector,
	} = renderOptions;
	const mountChildren = (children, container) => {
		for (let i = 0; i < children.length; i++) {
			// é€’å½’è°ƒç”¨patchæ–¹æ³•
			patch(null, children[i], container);
		}
	};
	const mountElement = (vnode, container) => {
		// å°†è™šæ‹ŸèŠ‚ç‚¹è½¬åŒ–ä¸ºçœŸå®DOM
		const { type, props, shapeFlag, children } = vnode;
		// åˆ›å»ºçœŸå®å…ƒç´ ï¼ŒæŒ‚è½½åˆ°è™šæ‹ŸèŠ‚ç‚¹ä¸Š
		let el = (vnode.el = hostCreateElement(type));
		// å¦‚æœæœ‰propsï¼Œåˆ™å¤„ç†å±æ€§
		if (props) {
			for (const key in props) {
				hostPatchProp(el, key, null, props[key]);
			}
		}
		if (children) {
			if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
				// è¯´æ˜æ˜¯æ–‡æœ¬
				hostSetElementText(el, vnode.children);
			} else if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
				// è¯´æ˜æœ‰å¤šä¸ªå„¿å­
				mountChildren(vnode.children, el);
			}
		}
		hostInsert(el, container); // æ’å…¥åˆ°å®¹å™¨ä¸­
	};

	// åˆ¤æ–­æ˜¯ä¸æ˜¯ç›¸åŒçš„è™šæ‹ŸèŠ‚ç‚¹
	const isSameVNode = (n1, n2) => {
		return n1.type === n2.type && n1.key === n2.key;
	};
	// å¤„ç†å…ƒç´ 
	const processElement = (n1, n2, container) => {
		if (n1 == null) {
			// åˆå§‹åŒ–æƒ…å†µ
			mountElement(n2, container);
		} else {
			// å…ƒç´ ç›¸åŒï¼Œå±æ€§æ›´æ–°äº†ï¼Œå¯ä»¥è¿›è¡Œå¤ç”¨ï¼Œè¿›è¡Œdiffçš„é€»è¾‘
			console.log(n1, n2);
		}
	};
	// è™šæ‹ŸèŠ‚ç‚¹å¯¹æ¯”é€»è¾‘
	const patch = (n1, n2, container) => {
		if (n1 == n2) {
			return;
		}
		if (n1 && !isSameVNode(n1, n2)) {
			unmount(n1);
			n1 = null;
		}
		// å¤„ç†å…ƒç´ 
		processElement(n1, n2, container);
	};
	// å¸è½½å…ƒç´ çš„æ–¹æ³•
	const unmount = (vnode) => {
		const { shapeFlag } = vnode;
		if (shapeFlag & ShapeFlags.ELEMENT) {
			// å¦‚æœæ˜¯ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆç›´æ¥åˆ é™¤DOMå³å¯
			hostRemove(vnode.el);
		}
	};
	const render = (vnode, container) => {
		// è™šæ‹ŸèŠ‚ç‚¹æ¸²æŸ“æˆçœŸå®DOMï¼ŒæŒ‚è½½åˆ°é¡µé¢ä¸Š
		// å¸è½½æ“ä½œ render(null, container)
		// åˆå§‹åŒ–å’Œæ›´æ–°è™šæ‹ŸDOM
		if (vnode == null) {
			// å¸è½½é€»è¾‘
			if (container._vnode) {
				// æ‰¾åˆ°å¯¹åº”çš„çœŸå®èŠ‚ç‚¹ï¼Œå°†å…¶å¸è½½
				unmount(container._vnode);
			}
		} else {
			// åˆå§‹ä¼ å…¥ä¸€ä¸ªnullä½œä¸ºè€çš„è™šæ‹ŸDOMå€¼ï¼›ä¿ç•™ä¹‹å‰çš„vnodeï¼Œä¸ºä¹‹åçš„diffç®—æ³•åšå‡†å¤‡
			patch(container._vnode || null, vnode, container);
		}
		container._vnode = vnode;
	};
	return {
		render,
	};
}
```

æˆ‘ä»¬åˆå°†å½“ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹ä¸ç›¸åŒæ—¶çš„æ›´æ–°é€»è¾‘å†™å®Œäº†ï¼Œæˆ‘ä»¬æ”¹ä¸‹è°ƒè¯•ä»£ç ï¼Œåœ¨é¡µé¢ä¸Šçœ‹æ•ˆæœï¼Œå‘ç°ï¼Œè¿‡äº† 1 ç§’é’Ÿåï¼ŒæˆåŠŸçš„æ¸²æŸ“äº†æ–°çš„è™šæ‹ŸèŠ‚ç‚¹ï¼š

```html
<script type="module">
	import { h, render } from "./runtime-dom.js";
	render(h("h1", { style: { color: "red" } }, "hello"), app);
	setTimeout(() => {
		render(h("div", { style: { color: "blue" } }, "world"), app);
	}, 2000);
</script>
```

æ‰€ä»¥ï¼Œå½“ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹å¯ä»¥å¤ç”¨æ—¶çš„é€»è¾‘ï¼Œæˆ‘ä»¬å°±æ”¾åˆ°åç»­æ–‡ç« ä¸­ï¼Œè¿›è¡Œè¯¦ç»†çš„è®²è§£ï¼Œå› ä¸ºä¼šæ¶‰åŠåˆ°æˆ‘ä»¬è€³ç†Ÿèƒ½è¯¦çš„`diff`ç®—æ³•ã€‚

å…¶å®`watch`å’Œ`watchEffect`å¹¶ä¸åœ¨`reactivity`å“åº”å¼æ¨¡å—é‡Œï¼Œè€Œæ˜¯åœ¨`runtime-dom`æ¨¡å—é‡Œï¼Œé‚£ä¸ºå•¥è¿˜è¦åœ¨`reactivity`è¿™ä¸ªå“åº”å¼æ¨¡å—ä¸­ï¼Œæ¥ä»‹ç»è¿™ä¸¤ä¸ª`API`å‘¢ï¼Ÿä¸€æ˜¯å› ä¸ºè¿™ä¸¤ä¸ª`API`æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¤ªå¸¸è§ï¼ŒäºŒæ‰æ˜¯æœ€ä¸»è¦çš„ï¼Œæ˜¯å› ä¸º`watch`å’Œ`watchEffect`éƒ½æ˜¯åŸºäºä¸Šç¯‡æ–‡ç« è¯´çš„`effect`è¿›è¡Œäº†å°è£…ï¼Œä»è€Œå¾—åˆ°çš„ã€‚æ‰€ä»¥è¯´ä¹ˆï¼Œ`effect`æ˜¯æœ€åº•å±‚çš„æ–¹æ³•ï¼Œå¼„æ‡‚äº†ä¸Šç¯‡æ–‡ç« çš„å†…å®¹ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±æ˜¾å¾—ç›¸å¯¹å¥½ç†è§£å¾ˆå¤šã€‚

## æ–‡ç« 

Vue3 æºç è§£è¯»å¼€æºï¼š<https://github.com/cuixiaorui/mini-vue>

æ˜é‡‘æ–‡ç« è¯´æ˜ï¼š<https://juejin.cn/post/6925668019884523534>

è¿™ä¸ªåº“æŠŠ Vue3 æºç ä¸­æœ€æ ¸å¿ƒçš„é€»è¾‘å‰¥ç¦»å‡ºæ¥ï¼Œåªç•™ä¸‹æ ¸å¿ƒé€»è¾‘ï¼Œä»¥ä¾›å¤§å®¶å­¦ä¹ ã€‚å¸¦æœ‰è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼Œä»¥åŠå®Œå–„çš„è¾“å‡ºï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£è¿è¡Œæ—¶æµç¨‹ã€‚

è§†é¢‘è„‘å›¾ï¼š<https://github.com/lgd8981289/book_read_quickly>

è§†é¢‘æ–‡æ¡£ï¼š<https://juejin.cn/post/7197980894363156540>

ã€ŠVue3 æºç è§£æï¼Œæ‰“é€ è‡ªå·±çš„ Vue3 æ¡†æ¶ã€‹ï¼š<https://coding.imooc.com/class/608.html>

DSL ç¼–è¯‘å™¨ã€ŠVue ç¼–è¯‘å™¨çš„æ ¸å¿ƒé€»è¾‘ã€‹ï¼š<https://juejin.cn/post/7197977396603256890>

æœ‰ç‚¹éš¾çš„ã€Šæœ€æ–° diff ç®—æ³•è¯¦è§£ã€‹ï¼š<https://juejin.cn/post/7190726242042118200>

çœ‹å‘†é¢è¯•å®˜çš„ã€Šæ‰‹å†™å“åº”å¼æ¨¡å—ã€‹ï¼š<https://juejin.cn/post/7189161043552108599>

## Vue3 å“åº”å¼åŸç†
