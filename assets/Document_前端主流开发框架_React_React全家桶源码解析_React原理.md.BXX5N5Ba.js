import{_ as a,c as p,o as e,ah as l}from"./chunks/framework.DqD713j2.js";const r="/FrontEndLearnNotes/assets/640-74941959.BScFAnhC.gif",i="/FrontEndLearnNotes/assets/640-1715592349788-1.BSm47HPQ.webp",c="/FrontEndLearnNotes/assets/640-1715592349788-2.BmFsxfF5.webp",s="/FrontEndLearnNotes/assets/640-1715592349788-3.DXkHwpPX.webp",b="/FrontEndLearnNotes/assets/640-1715592349789-4.Bu34O1Df.webp",t="/FrontEndLearnNotes/assets/640-1715592349789-5.Bh5o3gwc.webp",u="/FrontEndLearnNotes/assets/640-1715592349789-6.BxadLeNK.webp",m="/FrontEndLearnNotes/assets/640-1715592349789-7.BWVwL_JT.webp",o="/FrontEndLearnNotes/assets/640-1715592349789-8.BQf-AhQs.webp",d="data:image/webp;base64,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",S=JSON.parse('{"title":"React原理","description":"","frontmatter":{},"headers":[],"relativePath":"Document/前端主流开发框架/React/React全家桶源码解析/React原理.md","filePath":"Document/前端主流开发框架/React/React全家桶源码解析/React原理.md","lastUpdated":1750954157000}'),f={name:"Document/前端主流开发框架/React/React全家桶源码解析/React原理.md"};function h(g,n,q,N,k,v){return e(),p("div",null,n[0]||(n[0]=[l('<h1 id="react原理" tabindex="-1">React原理 <a class="header-anchor" href="#react原理" aria-label="Permalink to &quot;React原理&quot;">​</a></h1><h1 id="深入了解-react-原理-如何用-400-行代码-构建你自己的-react-js" tabindex="-1">深入了解 React 原理，如何用 400 行代码 构建你自己的 React.js <a class="header-anchor" href="#深入了解-react-原理-如何用-400-行代码-构建你自己的-react-js" aria-label="Permalink to &quot;深入了解 React 原理，如何用 400 行代码 构建你自己的 React.js&quot;">​</a></h1><p>React v19 beta 已经发布。与 React 18 相比，它提供了许多用户友好的 API，尽管其核心原理基本保持不变。你可能已经使用 React 一段时间了，但你了解它的内部工作原理吗？</p><p>本文将帮助你构建一个大约 400 行代码的 React 版本，它支持异步更新并且可以被中断——这是 React 的一个核心特性，许多更高级的 API 都依赖于它。这是最终效果的 GIF：</p><p><img src="'+r+'" alt="图片"></p><p>我使用了 React 官方网站提供的井字棋教程示例，可以看到它运行得很好。</p><p>它目前托管在我的 GitHub 上，你也可以访问在线版本亲自尝试。</p><p><img src="'+i+'" alt="图片"></p><p>GitHub - ZacharyL2/mini-react: 用 400 行代码实现 Mini-React，一个具有异步可中断更新的最小模型。</p><p>用 400 行代码实现 Mini-React，一个具有异步可中断更新的最小模型。 - ZacharyL2/mini-react</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>github.com/ZacharyL2/mini-react</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="「jsx-和-createelement」" tabindex="-1"><strong>「JSX 和 createElement」</strong> <a class="header-anchor" href="#「jsx-和-createelement」" aria-label="Permalink to &quot;**「JSX 和 createElement」**&quot;">​</a></h2><p>在深入探讨 mini-react.ts 的原理之前，理解 JSX 代表什么非常重要。我们可以使用 JSX 来描述 DOM，并轻松应用 JavaScript 逻辑。然而，浏览器并不原生理解 JSX，所以我们编写的 JSX 被编译成浏览器能理解的 JavaScript。</p><p><img src="'+c+'" alt="图片"></p><p>你可以看到它调用了 <code>React.createElement</code>，它提供了以下选项：</p><p><code>type</code>：表示当前节点的类型，如 <code>div</code>。</p><p><code>props</code>：表示当前元素节点的属性，例如 <code>{id: &quot;test&quot;}</code>。</p><p><code>children</code>：子元素，可以是多个元素、简单文本或由 <code>React.createElemen</code> 创建的更多节点。</p><p>如果你是经验丰富的 React 用户，你可能会记得，在 React 18 之前，你需要导入 React 才能正确编写 JSX。自 React 18 以来，这不再必要，这增强了开发者体验，但在底层 <code>React.createElement</code> 仍然被调用。</p><p><img src="'+s+'" alt="图片"></p><p><img src="'+s+'" alt="图片"></p><p>对于我们的简化 React 实现，我们需要在配置 Vite 时设置 react({ jsxRuntime: &#39;classic&#39; })。</p><p>然后我们可以实现我们自己的：</p><p><img src="'+b+'" alt="图片"></p><h2 id="「渲染」" tabindex="-1"><strong>「渲染」</strong> <a class="header-anchor" href="#「渲染」" aria-label="Permalink to &quot;**「渲染」**&quot;">​</a></h2><p>接下来，我们基于之前创建的数据结构实现一个简化版的渲染函数，将 JSX 渲染到真实的 DOM。</p><p><img src="'+t+'" alt="图片"></p><p>这是在线实现链接。它目前只渲染一次 JSX，因此不处理交互。</p><h2 id="「fiber-架构和并发模式」" tabindex="-1"><strong>「Fiber 架构和并发模式」</strong> <a class="header-anchor" href="#「fiber-架构和并发模式」" aria-label="Permalink to &quot;**「Fiber 架构和并发模式」**&quot;">​</a></h2><p><code>Fiber</code> 架构和并发模式主要是为了解决一旦递归遍历完整个元素树，它就不能被中断，可能会长时间阻塞主线程的问题。高优先级任务，如用户输入或动画，可能无法及时处理。</p><p>在 <code>React</code> 的源代码中，工作被分解成小单元。每当浏览器空闲时，它处理这些小工作单元，将主线程的控制权交还给浏览器，以便浏览器能够及时响应高优先级任务。一旦一个工作的所有必要小单元都完成，结果就会被映射到真实的 <code>DOM</code>。</p><p>两个关键点是如何放弃主线程的控制权，以及如何将工作分解成可管理的单元。</p><h2 id="「requestidlecallback」" tabindex="-1"><strong>「requestIdleCallback」</strong> <a class="header-anchor" href="#「requestidlecallback」" aria-label="Permalink to &quot;**「requestIdleCallback」**&quot;">​</a></h2><p>requestIdleCallback 是一个实验性 API，它在浏览器空闲时执行回调。它尚未被所有浏览器支持。在 React 中，它在调度程序包中使用，该包具有比 requestIdleCallback 更复杂的调度逻辑，包括更新任务优先级。</p><p><img src="'+u+'" alt="图片"></p><p>但我们在这里只考虑异步可中断性，所以这是模仿 React 的基本实现：</p><h2 id="「以下是一些关键点的简要说明-」" tabindex="-1"><strong>「以下是一些关键点的简要说明：」</strong> <a class="header-anchor" href="#「以下是一些关键点的简要说明-」" aria-label="Permalink to &quot;**「以下是一些关键点的简要说明：」**&quot;">​</a></h2><h3 id="为什么使用-messagechannel" tabindex="-1">为什么使用 <code>MessageChannel</code>？ <a class="header-anchor" href="#为什么使用-messagechannel" aria-label="Permalink to &quot;为什么使用 `MessageChannel`？&quot;">​</a></h3><p>主要是，它使用宏任务来处理每一轮的单元任务。但为什么是宏任务？</p><p>这是因为我们需要使用宏任务来放弃主线程的控制权，允许浏览器在这个空闲期间更新 DOM 或接收事件。由于浏览器将 DOM 更新作为一个单独的任务，此时不执行 <code>JavaScript</code>。</p><p>主线程一次只能运行一个任务——要么执行 JavaScript，要么处理 DOM 计算、样式计算、输入事件等。然而，微任务并不放弃主线程的控制权。</p><h3 id="为什么不用-settimeout" tabindex="-1">为什么不用 setTimeout？ <a class="header-anchor" href="#为什么不用-settimeout" aria-label="Permalink to &quot;为什么不用 setTimeout？&quot;">​</a></h3><p>这是因为现代浏览器认为超过五次的嵌套 <code>setTimeout</code> 调用是阻塞的，并将它们的最小延迟设置为 4 毫秒，所以它不够精确。</p><h2 id="「算法」" tabindex="-1"><strong>「算法」</strong> <a class="header-anchor" href="#「算法」" aria-label="Permalink to &quot;**「算法」**&quot;">​</a></h2><p>请注意，React 不断发展，我描述的算法可能不是最新的，但它们足以理解其基本原理。</p><p>这是显示工作单元之间联系的图表：</p><p><img src="'+m+'" alt="图片"></p><p>在 <code>React</code> 中，每个工作单元被称为一个 <code>Fiber</code> 节点。它们使用类似链表的结构相互链接：</p><p><code>child</code>：从父节点指向第一个子元素的指针。</p><p><code>return/parent</code>：所有子元素都有一个指针回到父元素。</p><p><code>sibling</code>：从第一个子元素指向下一个兄弟元素。</p><p>有了这个数据结构，让我们看看具体的实现。</p><p>我们只是扩展了渲染逻辑，重新构建了调用序列，以 <code>workLoop -&gt; performUnitOfWork -&gt; reconcileChildren -&gt; commitRoot</code> 的顺序工作。</p><p><code>workLoop</code>：通过连续调用 requestIdleCallback 来获取空闲时间。如果当前处于空闲状态并且有单元任务要执行，那么执行每个单元任务。</p><p><code>performUnitOfWork</code>：执行的具体单元任务。这是链表思想的体现。具体来说，一次只处理一个 fiber 节点，并返回下一个要处理的节点。</p><p><code>reconcileChildren</code>：协调当前 fiber 节点，实际上是虚拟 DOM 的比较，并记录要进行的更改。你可以看到我们直接修改并保存在每个 fiber 节点上，因为现在它只是 JavaScript 对象的修改，并没有触及真实的 DOM。</p><p><code>commitRoot</code>：如果当前需要更新（根据 wipRoot）并且没有下一个单元任务要处理（根据 !nextUnitOfWork），这意味着虚拟更改需要映射到真实的 DOM。commitRoot 是根据 fiber 节点的变化修改真实的 DOM。</p><p>有了这些，我们才能真正使用 fiber 架构进行可中断的 DOM 更新，但我们仍然缺少一个触发器。</p><h3 id="「触发更新」" tabindex="-1"><strong>「触发更新」</strong> <a class="header-anchor" href="#「触发更新」" aria-label="Permalink to &quot;**「触发更新」**&quot;">​</a></h3><p>在 React 中，最常见的触发器是 <code>useState</code>，这是最基本的更新机制。让我们实现它来点燃我们的 Fiber 引擎。</p><p>这是具体的实现，简化成一个函数：</p><p><img src="'+o+'" alt="图片"></p><p>它巧妙地将钩子的状态保持在 fiber 节点上，并通过队列修改状态。从这里，你还可以看到为什么 React 钩子调用的顺序不能改变。</p><h2 id="源码部分" tabindex="-1">源码部分 <a class="header-anchor" href="#源码部分" aria-label="Permalink to &quot;源码部分&quot;">​</a></h2><p><img src="'+d+`" alt="图片"></p><ul><li>src/App.jsx</li></ul><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>// Forked from https://reactjs.org/tutorial/tutorial.html#what-are-we-building</span></span>
<span class="line"><span>import React from &#39;./mini-react&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const { useState } = React;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>function Square({ value, onSquareClick }) {</span></span>
<span class="line"><span>  return (</span></span>
<span class="line"><span>    &lt;button className=&quot;square&quot; onClick={onSquareClick}&gt;</span></span>
<span class="line"><span>      {value}</span></span>
<span class="line"><span>    &lt;/button&gt;</span></span>
<span class="line"><span>  );</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>function Board({ xIsNext, squares, onPlay }) {</span></span>
<span class="line"><span>  function handleClick(i) {</span></span>
<span class="line"><span>    if (calculateWinner(squares) || squares[i]) {</span></span>
<span class="line"><span>      return;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    const nextSquares = squares.slice();</span></span>
<span class="line"><span>    if (xIsNext) {</span></span>
<span class="line"><span>      nextSquares[i] = &#39;X&#39;;</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>      nextSquares[i] = &#39;O&#39;;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    onPlay(nextSquares);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  const winner = calculateWinner(squares);</span></span>
<span class="line"><span>  let status;</span></span>
<span class="line"><span>  if (winner) {</span></span>
<span class="line"><span>    status = &#39;Winner: &#39; + winner;</span></span>
<span class="line"><span>  } else {</span></span>
<span class="line"><span>    status = &#39;Next player: &#39; + (xIsNext ? &#39;X&#39; : &#39;O&#39;);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return (</span></span>
<span class="line"><span>    &lt;&gt;</span></span>
<span class="line"><span>      &lt;div className=&quot;status&quot;&gt;{status}&lt;/div&gt;</span></span>
<span class="line"><span>      &lt;div className=&quot;board-row&quot;&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[0]} onSquareClick={() =&gt; handleClick(0)} /&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[1]} onSquareClick={() =&gt; handleClick(1)} /&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[2]} onSquareClick={() =&gt; handleClick(2)} /&gt;</span></span>
<span class="line"><span>      &lt;/div&gt;</span></span>
<span class="line"><span>      &lt;div className=&quot;board-row&quot;&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[3]} onSquareClick={() =&gt; handleClick(3)} /&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[4]} onSquareClick={() =&gt; handleClick(4)} /&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[5]} onSquareClick={() =&gt; handleClick(5)} /&gt;</span></span>
<span class="line"><span>      &lt;/div&gt;</span></span>
<span class="line"><span>      &lt;div className=&quot;board-row&quot;&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[6]} onSquareClick={() =&gt; handleClick(6)} /&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[7]} onSquareClick={() =&gt; handleClick(7)} /&gt;</span></span>
<span class="line"><span>        &lt;Square value={squares[8]} onSquareClick={() =&gt; handleClick(8)} /&gt;</span></span>
<span class="line"><span>      &lt;/div&gt;</span></span>
<span class="line"><span>    &lt;/&gt;</span></span>
<span class="line"><span>  );</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>export default function Game() {</span></span>
<span class="line"><span>  const [history, setHistory] = useState([Array(9).fill(null)]);</span></span>
<span class="line"><span>  const [currentMove, setCurrentMove] = useState(0);</span></span>
<span class="line"><span>  const xIsNext = currentMove % 2 === 0;</span></span>
<span class="line"><span>  const currentSquares = history[currentMove];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  function handlePlay(nextSquares) {</span></span>
<span class="line"><span>    const nextHistory = [...history.slice(0, currentMove + 1), nextSquares];</span></span>
<span class="line"><span>    setHistory(nextHistory);</span></span>
<span class="line"><span>    setCurrentMove(nextHistory.length - 1);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  function jumpTo(nextMove) {</span></span>
<span class="line"><span>    setCurrentMove(nextMove);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  const moves = history.map((squares, move) =&gt; {</span></span>
<span class="line"><span>    let description;</span></span>
<span class="line"><span>    if (move &gt; 0) {</span></span>
<span class="line"><span>      description = &#39;Go to move #&#39; + move;</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>      description = &#39;Go to game start&#39;;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return (</span></span>
<span class="line"><span>      &lt;li key={move}&gt;</span></span>
<span class="line"><span>        &lt;button onClick={() =&gt; jumpTo(move)}&gt;{description}&lt;/button&gt;</span></span>
<span class="line"><span>      &lt;/li&gt;</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span>  });</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return (</span></span>
<span class="line"><span>    &lt;div className=&quot;game&quot;&gt;</span></span>
<span class="line"><span>      &lt;div className=&quot;game-board&quot;&gt;</span></span>
<span class="line"><span>        &lt;Board xIsNext={xIsNext} squares={currentSquares} onPlay={handlePlay} /&gt;</span></span>
<span class="line"><span>      &lt;/div&gt;</span></span>
<span class="line"><span>      &lt;div className=&quot;game-info&quot;&gt;</span></span>
<span class="line"><span>        &lt;ol&gt;{moves}&lt;/ol&gt;</span></span>
<span class="line"><span>      &lt;/div&gt;</span></span>
<span class="line"><span>    &lt;/div&gt;</span></span>
<span class="line"><span>  );</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>function calculateWinner(squares) {</span></span>
<span class="line"><span>  const lines = [</span></span>
<span class="line"><span>    [0, 1, 2],</span></span>
<span class="line"><span>    [3, 4, 5],</span></span>
<span class="line"><span>    [6, 7, 8],</span></span>
<span class="line"><span>    [0, 3, 6],</span></span>
<span class="line"><span>    [1, 4, 7],</span></span>
<span class="line"><span>    [2, 5, 8],</span></span>
<span class="line"><span>    [0, 4, 8],</span></span>
<span class="line"><span>    [2, 4, 6],</span></span>
<span class="line"><span>  ];</span></span>
<span class="line"><span>  for (let i = 0; i &lt; lines.length; i++) {</span></span>
<span class="line"><span>    const [a, b, c] = lines[i];</span></span>
<span class="line"><span>    if (squares[a] &amp;&amp; squares[a] === squares[b] &amp;&amp; squares[a] === squares[c]) {</span></span>
<span class="line"><span>      return squares[a];</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return null;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br></div></div><ul><li>src/LegacyClassApp.jsx</li></ul><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>import React from &#39;./mini-react&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>function calculateWinner(squares) {</span></span>
<span class="line"><span>  const lines = [</span></span>
<span class="line"><span>    [0, 1, 2],</span></span>
<span class="line"><span>    [3, 4, 5],</span></span>
<span class="line"><span>    [6, 7, 8],</span></span>
<span class="line"><span>    [0, 3, 6],</span></span>
<span class="line"><span>    [1, 4, 7],</span></span>
<span class="line"><span>    [2, 5, 8],</span></span>
<span class="line"><span>    [0, 4, 8],</span></span>
<span class="line"><span>    [2, 4, 6],</span></span>
<span class="line"><span>  ];</span></span>
<span class="line"><span>  for (let i = 0; i &lt; lines.length; i += 1) {</span></span>
<span class="line"><span>    const [a, b, c] = lines[i];</span></span>
<span class="line"><span>    if (squares[a] &amp;&amp; squares[a] === squares[b] &amp;&amp; squares[a] === squares[c]) {</span></span>
<span class="line"><span>      return squares[a];</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return null;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>class Square extends React.Component {</span></span>
<span class="line"><span>  render() {</span></span>
<span class="line"><span>    return (</span></span>
<span class="line"><span>      &lt;button onClick={this.props.onClick} className=&quot;square&quot;&gt;</span></span>
<span class="line"><span>        {this.props.value}</span></span>
<span class="line"><span>      &lt;/button&gt;</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>class Board extends React.Component {</span></span>
<span class="line"><span>  renderSquare(i) {</span></span>
<span class="line"><span>    return (</span></span>
<span class="line"><span>      &lt;Square</span></span>
<span class="line"><span>        value={this.props.squares[i]}</span></span>
<span class="line"><span>        onClick={() =&gt; {</span></span>
<span class="line"><span>          this.props.onClick(i);</span></span>
<span class="line"><span>        }}</span></span>
<span class="line"><span>      /&gt;</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  render() {</span></span>
<span class="line"><span>    return (</span></span>
<span class="line"><span>      &lt;div&gt;</span></span>
<span class="line"><span>        &lt;div className=&quot;board-row&quot;&gt;</span></span>
<span class="line"><span>          {this.renderSquare(0)}</span></span>
<span class="line"><span>          {this.renderSquare(1)}</span></span>
<span class="line"><span>          {this.renderSquare(2)}</span></span>
<span class="line"><span>        &lt;/div&gt;</span></span>
<span class="line"><span>        &lt;div className=&quot;board-row&quot;&gt;</span></span>
<span class="line"><span>          {this.renderSquare(3)}</span></span>
<span class="line"><span>          {this.renderSquare(4)}</span></span>
<span class="line"><span>          {this.renderSquare(5)}</span></span>
<span class="line"><span>        &lt;/div&gt;</span></span>
<span class="line"><span>        &lt;div className=&quot;board-row&quot;&gt;</span></span>
<span class="line"><span>          {this.renderSquare(6)}</span></span>
<span class="line"><span>          {this.renderSquare(7)}</span></span>
<span class="line"><span>          {this.renderSquare(8)}</span></span>
<span class="line"><span>        &lt;/div&gt;</span></span>
<span class="line"><span>      &lt;/div&gt;</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>class App extends React.Component {</span></span>
<span class="line"><span>  constructor(props) {</span></span>
<span class="line"><span>    super(props);</span></span>
<span class="line"><span>    this.state = {</span></span>
<span class="line"><span>      history: [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          squares: Array(9).fill(null),</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>      ],</span></span>
<span class="line"><span>      stepNumber: 0,</span></span>
<span class="line"><span>      xIsNext: true,</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  handleClick(i) {</span></span>
<span class="line"><span>    const history = this.state.history.slice(0, this.state.stepNumber + 1);</span></span>
<span class="line"><span>    const current = history[history.length - 1];</span></span>
<span class="line"><span>    const squares = current.squares.slice();</span></span>
<span class="line"><span>    if (calculateWinner(squares) || squares[i]) {</span></span>
<span class="line"><span>      return;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    squares[i] = this.state.xIsNext ? &#39;X&#39; : &#39;O&#39;;</span></span>
<span class="line"><span>    this.setState({</span></span>
<span class="line"><span>      history: history.concat([</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>          squares,</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>      ]),</span></span>
<span class="line"><span>      stepNumber: history.length,</span></span>
<span class="line"><span>      xIsNext: !this.state.xIsNext,</span></span>
<span class="line"><span>    });</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  jumpTo(step) {</span></span>
<span class="line"><span>    this.setState({</span></span>
<span class="line"><span>      stepNumber: step,</span></span>
<span class="line"><span>      xIsNext: step % 2 === 0,</span></span>
<span class="line"><span>    });</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  render() {</span></span>
<span class="line"><span>    const { history } = this.state;</span></span>
<span class="line"><span>    const current = history[this.state.stepNumber];</span></span>
<span class="line"><span>    const winner = calculateWinner(current.squares);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    const moves = history.map((step, move) =&gt; {</span></span>
<span class="line"><span>      const desc = move ? \`Go to move #\${move}\` : &#39;Go to game start&#39;;</span></span>
<span class="line"><span>      return (</span></span>
<span class="line"><span>        &lt;li key={move}&gt;</span></span>
<span class="line"><span>          &lt;button onClick={() =&gt; this.jumpTo(move)}&gt;{desc}&lt;/button&gt;</span></span>
<span class="line"><span>        &lt;/li&gt;</span></span>
<span class="line"><span>      );</span></span>
<span class="line"><span>    });</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    let status;</span></span>
<span class="line"><span>    if (winner) {</span></span>
<span class="line"><span>      status = \`Winner: \${winner}\`;</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>      status = \`Next player: \${this.state.xIsNext ? &#39;X&#39; : &#39;O&#39;}\`;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return (</span></span>
<span class="line"><span>      &lt;div className=&quot;game&quot;&gt;</span></span>
<span class="line"><span>        &lt;div className=&quot;game-board&quot;&gt;</span></span>
<span class="line"><span>          &lt;Board</span></span>
<span class="line"><span>            squares={current.squares}</span></span>
<span class="line"><span>            onClick={(i) =&gt; {</span></span>
<span class="line"><span>              this.handleClick(i);</span></span>
<span class="line"><span>            }}</span></span>
<span class="line"><span>          /&gt;</span></span>
<span class="line"><span>        &lt;/div&gt;</span></span>
<span class="line"><span>        &lt;div className=&quot;game-info&quot;&gt;</span></span>
<span class="line"><span>          &lt;div&gt;{status}&lt;/div&gt;</span></span>
<span class="line"><span>          &lt;ol&gt;{moves}&lt;/ol&gt;</span></span>
<span class="line"><span>        &lt;/div&gt;</span></span>
<span class="line"><span>      &lt;/div&gt;</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>export default App;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br></div></div><ul><li>src/index.jsx</li></ul><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>// Forked from https://reactjs.org/tutorial/tutorial.html#what-are-we-building</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import React from &#39;./mini-react&#39;;</span></span>
<span class="line"><span>import App from &#39;./App&#39;; // OR \`LegacyClassApp\`</span></span>
<span class="line"><span>import &#39;./styles.css&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>React.render(&lt;App /&gt;, document.getElementById(&#39;root&#39;));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>src/mini-react.ts</li></ul><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>// TODO Optimization Type Description</span></span>
<span class="line"><span></span></span>
<span class="line"><span>interface ComponentFunction {</span></span>
<span class="line"><span>  new (props: Record&lt;string, unknown&gt;): Component;</span></span>
<span class="line"><span>  (props: Record&lt;string, unknown&gt;): VirtualElement | string;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>type VirtualElementType = ComponentFunction | string;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>interface VirtualElementProps {</span></span>
<span class="line"><span>  children?: VirtualElement[];</span></span>
<span class="line"><span>  [propName: string]: unknown;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>interface VirtualElement {</span></span>
<span class="line"><span>  type: VirtualElementType;</span></span>
<span class="line"><span>  props: VirtualElementProps;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>type FiberNodeDOM = Element | Text | null | undefined;</span></span>
<span class="line"><span>interface FiberNode&lt;S = any&gt; extends VirtualElement {</span></span>
<span class="line"><span>  alternate: FiberNode&lt;S&gt; | null;</span></span>
<span class="line"><span>  dom?: FiberNodeDOM;</span></span>
<span class="line"><span>  effectTag?: string;</span></span>
<span class="line"><span>  child?: FiberNode;</span></span>
<span class="line"><span>  return?: FiberNode;</span></span>
<span class="line"><span>  sibling?: FiberNode;</span></span>
<span class="line"><span>  hooks?: {</span></span>
<span class="line"><span>    state: S;</span></span>
<span class="line"><span>    queue: S[];</span></span>
<span class="line"><span>  }[];</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>let wipRoot: FiberNode | null = null;</span></span>
<span class="line"><span>let nextUnitOfWork: FiberNode | null = null;</span></span>
<span class="line"><span>let currentRoot: FiberNode | null = null;</span></span>
<span class="line"><span>let deletions: FiberNode[] = [];</span></span>
<span class="line"><span>let wipFiber: FiberNode;</span></span>
<span class="line"><span>let hookIndex = 0;</span></span>
<span class="line"><span>// Support React.Fragment syntax.</span></span>
<span class="line"><span>const Fragment = Symbol.for(&#39;react.fragment&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Enhanced requestIdleCallback.</span></span>
<span class="line"><span>((global: Window) =&gt; {</span></span>
<span class="line"><span>  const id = 1;</span></span>
<span class="line"><span>  const fps = 1e3 / 60;</span></span>
<span class="line"><span>  let frameDeadline: number;</span></span>
<span class="line"><span>  let pendingCallback: IdleRequestCallback;</span></span>
<span class="line"><span>  const channel = new MessageChannel();</span></span>
<span class="line"><span>  const timeRemaining = () =&gt; frameDeadline - window.performance.now();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  const deadline = {</span></span>
<span class="line"><span>    didTimeout: false,</span></span>
<span class="line"><span>    timeRemaining,</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  channel.port2.onmessage = () =&gt; {</span></span>
<span class="line"><span>    if (typeof pendingCallback === &#39;function&#39;) {</span></span>
<span class="line"><span>      pendingCallback(deadline);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  global.requestIdleCallback = (callback: IdleRequestCallback) =&gt; {</span></span>
<span class="line"><span>    global.requestAnimationFrame((frameTime) =&gt; {</span></span>
<span class="line"><span>      frameDeadline = frameTime + fps;</span></span>
<span class="line"><span>      pendingCallback = callback;</span></span>
<span class="line"><span>      channel.port1.postMessage(null);</span></span>
<span class="line"><span>    });</span></span>
<span class="line"><span>    return id;</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span>})(window);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const isDef = &lt;T&gt;(param: T): param is NonNullable&lt;T&gt; =&gt;</span></span>
<span class="line"><span>  param !== void 0 &amp;&amp; param !== null;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const isPlainObject = (val: unknown): val is Record&lt;string, unknown&gt; =&gt;</span></span>
<span class="line"><span>  Object.prototype.toString.call(val) === &#39;[object Object]&#39; &amp;&amp;</span></span>
<span class="line"><span>  [Object.prototype, null].includes(Object.getPrototypeOf(val));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Simple judgment of virtual elements.</span></span>
<span class="line"><span>const isVirtualElement = (e: unknown): e is VirtualElement =&gt;</span></span>
<span class="line"><span>  typeof e === &#39;object&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Text elements require special handling.</span></span>
<span class="line"><span>const createTextElement = (text: string): VirtualElement =&gt; ({</span></span>
<span class="line"><span>  type: &#39;TEXT&#39;,</span></span>
<span class="line"><span>  props: {</span></span>
<span class="line"><span>    nodeValue: text,</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Create custom JavaScript data structures.</span></span>
<span class="line"><span>const createElement = (</span></span>
<span class="line"><span>  type: VirtualElementType,</span></span>
<span class="line"><span>  props: Record&lt;string, unknown&gt; = {},</span></span>
<span class="line"><span>  ...child: (unknown | VirtualElement)[]</span></span>
<span class="line"><span>): VirtualElement =&gt; {</span></span>
<span class="line"><span>  const children = child.map((c) =&gt;</span></span>
<span class="line"><span>    isVirtualElement(c) ? c : createTextElement(String(c)),</span></span>
<span class="line"><span>  );</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return {</span></span>
<span class="line"><span>    type,</span></span>
<span class="line"><span>    props: {</span></span>
<span class="line"><span>      ...props,</span></span>
<span class="line"><span>      children,</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Update DOM properties.</span></span>
<span class="line"><span>// For simplicity, we remove all the previous properties and add next properties.</span></span>
<span class="line"><span>const updateDOM = (</span></span>
<span class="line"><span>  DOM: NonNullable&lt;FiberNodeDOM&gt;,</span></span>
<span class="line"><span>  prevProps: VirtualElementProps,</span></span>
<span class="line"><span>  nextProps: VirtualElementProps,</span></span>
<span class="line"><span>) =&gt; {</span></span>
<span class="line"><span>  const defaultPropKeys = &#39;children&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  for (const [removePropKey, removePropValue] of Object.entries(prevProps)) {</span></span>
<span class="line"><span>    if (removePropKey.startsWith(&#39;on&#39;)) {</span></span>
<span class="line"><span>      DOM.removeEventListener(</span></span>
<span class="line"><span>        removePropKey.slice(2).toLowerCase(),</span></span>
<span class="line"><span>        removePropValue as EventListener,</span></span>
<span class="line"><span>      );</span></span>
<span class="line"><span>    } else if (removePropKey !== defaultPropKeys) {</span></span>
<span class="line"><span>      // @ts-expect-error: Unreachable code error</span></span>
<span class="line"><span>      DOM[removePropKey] = &#39;&#39;;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  for (const [addPropKey, addPropValue] of Object.entries(nextProps)) {</span></span>
<span class="line"><span>    if (addPropKey.startsWith(&#39;on&#39;)) {</span></span>
<span class="line"><span>      DOM.addEventListener(</span></span>
<span class="line"><span>        addPropKey.slice(2).toLowerCase(),</span></span>
<span class="line"><span>        addPropValue as EventListener,</span></span>
<span class="line"><span>      );</span></span>
<span class="line"><span>    } else if (addPropKey !== defaultPropKeys) {</span></span>
<span class="line"><span>      // @ts-expect-error: Unreachable code error</span></span>
<span class="line"><span>      DOM[addPropKey] = addPropValue;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Create DOM based on node type.</span></span>
<span class="line"><span>const createDOM = (fiberNode: FiberNode): FiberNodeDOM =&gt; {</span></span>
<span class="line"><span>  const { type, props } = fiberNode;</span></span>
<span class="line"><span>  let DOM: FiberNodeDOM = null;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (type === &#39;TEXT&#39;) {</span></span>
<span class="line"><span>    DOM = document.createTextNode(&#39;&#39;);</span></span>
<span class="line"><span>  } else if (typeof type === &#39;string&#39;) {</span></span>
<span class="line"><span>    DOM = document.createElement(type);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // Update properties based on props after creation.</span></span>
<span class="line"><span>  if (DOM !== null) {</span></span>
<span class="line"><span>    updateDOM(DOM, {}, props);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return DOM;</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Change the DOM based on fiber node changes.</span></span>
<span class="line"><span>// Note that we must complete the comparison of all fiber nodes before commitRoot.</span></span>
<span class="line"><span>// The comparison of fiber nodes can be interrupted, but the commitRoot cannot be interrupted.</span></span>
<span class="line"><span>const commitRoot = () =&gt; {</span></span>
<span class="line"><span>  const findParentFiber = (fiberNode?: FiberNode) =&gt; {</span></span>
<span class="line"><span>    if (fiberNode) {</span></span>
<span class="line"><span>      let parentFiber = fiberNode.return;</span></span>
<span class="line"><span>      while (parentFiber &amp;&amp; !parentFiber.dom) {</span></span>
<span class="line"><span>        parentFiber = parentFiber.return;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      return parentFiber;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return null;</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  const commitDeletion = (</span></span>
<span class="line"><span>    parentDOM: FiberNodeDOM,</span></span>
<span class="line"><span>    DOM: NonNullable&lt;FiberNodeDOM&gt;,</span></span>
<span class="line"><span>  ) =&gt; {</span></span>
<span class="line"><span>    if (isDef(parentDOM)) {</span></span>
<span class="line"><span>      parentDOM.removeChild(DOM);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  const commitReplacement = (</span></span>
<span class="line"><span>    parentDOM: FiberNodeDOM,</span></span>
<span class="line"><span>    DOM: NonNullable&lt;FiberNodeDOM&gt;,</span></span>
<span class="line"><span>  ) =&gt; {</span></span>
<span class="line"><span>    if (isDef(parentDOM)) {</span></span>
<span class="line"><span>      parentDOM.appendChild(DOM);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  const commitWork = (fiberNode?: FiberNode) =&gt; {</span></span>
<span class="line"><span>    if (fiberNode) {</span></span>
<span class="line"><span>      if (fiberNode.dom) {</span></span>
<span class="line"><span>        const parentFiber = findParentFiber(fiberNode);</span></span>
<span class="line"><span>        const parentDOM = parentFiber?.dom;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        switch (fiberNode.effectTag) {</span></span>
<span class="line"><span>          case &#39;REPLACEMENT&#39;:</span></span>
<span class="line"><span>            commitReplacement(parentDOM, fiberNode.dom);</span></span>
<span class="line"><span>            break;</span></span>
<span class="line"><span>          case &#39;UPDATE&#39;:</span></span>
<span class="line"><span>            updateDOM(</span></span>
<span class="line"><span>              fiberNode.dom,</span></span>
<span class="line"><span>              fiberNode.alternate ? fiberNode.alternate.props : {},</span></span>
<span class="line"><span>              fiberNode.props,</span></span>
<span class="line"><span>            );</span></span>
<span class="line"><span>            break;</span></span>
<span class="line"><span>          default:</span></span>
<span class="line"><span>            break;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      commitWork(fiberNode.child);</span></span>
<span class="line"><span>      commitWork(fiberNode.sibling);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  for (const deletion of deletions) {</span></span>
<span class="line"><span>    if (deletion.dom) {</span></span>
<span class="line"><span>      const parentFiber = findParentFiber(deletion);</span></span>
<span class="line"><span>      commitDeletion(parentFiber?.dom, deletion.dom);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (wipRoot !== null) {</span></span>
<span class="line"><span>    commitWork(wipRoot.child);</span></span>
<span class="line"><span>    currentRoot = wipRoot;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  wipRoot = null;</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Reconcile the fiber nodes before and after, compare and record the differences.</span></span>
<span class="line"><span>const reconcileChildren = (</span></span>
<span class="line"><span>  fiberNode: FiberNode,</span></span>
<span class="line"><span>  elements: VirtualElement[] = [],</span></span>
<span class="line"><span>) =&gt; {</span></span>
<span class="line"><span>  let index = 0;</span></span>
<span class="line"><span>  let oldFiberNode: FiberNode | undefined = void 0;</span></span>
<span class="line"><span>  let prevSibling: FiberNode | undefined = void 0;</span></span>
<span class="line"><span>  const virtualElements = elements.flat(Infinity);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (fiberNode.alternate?.child) {</span></span>
<span class="line"><span>    oldFiberNode = fiberNode.alternate.child;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  while (</span></span>
<span class="line"><span>    index &lt; virtualElements.length ||</span></span>
<span class="line"><span>    typeof oldFiberNode !== &#39;undefined&#39;</span></span>
<span class="line"><span>  ) {</span></span>
<span class="line"><span>    const virtualElement = virtualElements[index];</span></span>
<span class="line"><span>    let newFiber: FiberNode | undefined = void 0;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    const isSameType = Boolean(</span></span>
<span class="line"><span>      oldFiberNode &amp;&amp;</span></span>
<span class="line"><span>        virtualElement &amp;&amp;</span></span>
<span class="line"><span>        oldFiberNode.type === virtualElement.type,</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (isSameType &amp;&amp; oldFiberNode) {</span></span>
<span class="line"><span>      newFiber = {</span></span>
<span class="line"><span>        type: oldFiberNode.type,</span></span>
<span class="line"><span>        dom: oldFiberNode.dom,</span></span>
<span class="line"><span>        alternate: oldFiberNode,</span></span>
<span class="line"><span>        props: virtualElement.props,</span></span>
<span class="line"><span>        return: fiberNode,</span></span>
<span class="line"><span>        effectTag: &#39;UPDATE&#39;,</span></span>
<span class="line"><span>      };</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    if (!isSameType &amp;&amp; Boolean(virtualElement)) {</span></span>
<span class="line"><span>      newFiber = {</span></span>
<span class="line"><span>        type: virtualElement.type,</span></span>
<span class="line"><span>        dom: null,</span></span>
<span class="line"><span>        alternate: null,</span></span>
<span class="line"><span>        props: virtualElement.props,</span></span>
<span class="line"><span>        return: fiberNode,</span></span>
<span class="line"><span>        effectTag: &#39;REPLACEMENT&#39;,</span></span>
<span class="line"><span>      };</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    if (!isSameType &amp;&amp; oldFiberNode) {</span></span>
<span class="line"><span>      deletions.push(oldFiberNode);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (oldFiberNode) {</span></span>
<span class="line"><span>      oldFiberNode = oldFiberNode.sibling;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (index === 0) {</span></span>
<span class="line"><span>      fiberNode.child = newFiber;</span></span>
<span class="line"><span>    } else if (typeof prevSibling !== &#39;undefined&#39;) {</span></span>
<span class="line"><span>      prevSibling.sibling = newFiber;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    prevSibling = newFiber;</span></span>
<span class="line"><span>    index += 1;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Execute each unit task and return to the next unit task.</span></span>
<span class="line"><span>// Different processing according to the type of fiber node.</span></span>
<span class="line"><span>const performUnitOfWork = (fiberNode: FiberNode): FiberNode | null =&gt; {</span></span>
<span class="line"><span>  const { type } = fiberNode;</span></span>
<span class="line"><span>  switch (typeof type) {</span></span>
<span class="line"><span>    case &#39;function&#39;: {</span></span>
<span class="line"><span>      wipFiber = fiberNode;</span></span>
<span class="line"><span>      wipFiber.hooks = [];</span></span>
<span class="line"><span>      hookIndex = 0;</span></span>
<span class="line"><span>      let children: ReturnType&lt;ComponentFunction&gt;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      if (Object.getPrototypeOf(type).REACT_COMPONENT) {</span></span>
<span class="line"><span>        const C = type;</span></span>
<span class="line"><span>        const component = new C(fiberNode.props);</span></span>
<span class="line"><span>        const [state, setState] = useState(component.state);</span></span>
<span class="line"><span>        component.props = fiberNode.props;</span></span>
<span class="line"><span>        component.state = state;</span></span>
<span class="line"><span>        component.setState = setState;</span></span>
<span class="line"><span>        children = component.render.bind(component)();</span></span>
<span class="line"><span>      } else {</span></span>
<span class="line"><span>        children = type(fiberNode.props);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      reconcileChildren(fiberNode, [</span></span>
<span class="line"><span>        isVirtualElement(children)</span></span>
<span class="line"><span>          ? children</span></span>
<span class="line"><span>          : createTextElement(String(children)),</span></span>
<span class="line"><span>      ]);</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    case &#39;number&#39;:</span></span>
<span class="line"><span>    case &#39;string&#39;:</span></span>
<span class="line"><span>      if (!fiberNode.dom) {</span></span>
<span class="line"><span>        fiberNode.dom = createDOM(fiberNode);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      reconcileChildren(fiberNode, fiberNode.props.children);</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case &#39;symbol&#39;:</span></span>
<span class="line"><span>      if (type === Fragment) {</span></span>
<span class="line"><span>        reconcileChildren(fiberNode, fiberNode.props.children);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    default:</span></span>
<span class="line"><span>      if (typeof fiberNode.props !== &#39;undefined&#39;) {</span></span>
<span class="line"><span>        reconcileChildren(fiberNode, fiberNode.props.children);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (fiberNode.child) {</span></span>
<span class="line"><span>    return fiberNode.child;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  let nextFiberNode: FiberNode | undefined = fiberNode;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  while (typeof nextFiberNode !== &#39;undefined&#39;) {</span></span>
<span class="line"><span>    if (nextFiberNode.sibling) {</span></span>
<span class="line"><span>      return nextFiberNode.sibling;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    nextFiberNode = nextFiberNode.return;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return null;</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Use requestIdleCallback to query whether there is currently a unit task</span></span>
<span class="line"><span>// and determine whether the DOM needs to be updated.</span></span>
<span class="line"><span>const workLoop: IdleRequestCallback = (deadline) =&gt; {</span></span>
<span class="line"><span>  while (nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; 1) {</span></span>
<span class="line"><span>    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (!nextUnitOfWork &amp;&amp; wipRoot) {</span></span>
<span class="line"><span>    commitRoot();</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  window.requestIdleCallback(workLoop);</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Initial or reset.</span></span>
<span class="line"><span>const render = (element: VirtualElement, container: Element) =&gt; {</span></span>
<span class="line"><span>  currentRoot = null;</span></span>
<span class="line"><span>  wipRoot = {</span></span>
<span class="line"><span>    type: &#39;div&#39;,</span></span>
<span class="line"><span>    dom: container,</span></span>
<span class="line"><span>    props: {</span></span>
<span class="line"><span>      children: [{ ...element }],</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    alternate: currentRoot,</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span>  nextUnitOfWork = wipRoot;</span></span>
<span class="line"><span>  deletions = [];</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>abstract class Component {</span></span>
<span class="line"><span>  props: Record&lt;string, unknown&gt;;</span></span>
<span class="line"><span>  abstract state: unknown;</span></span>
<span class="line"><span>  abstract setState: (value: unknown) =&gt; void;</span></span>
<span class="line"><span>  abstract render: () =&gt; VirtualElement;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  constructor(props: Record&lt;string, unknown&gt;) {</span></span>
<span class="line"><span>    this.props = props;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // Identify Component.</span></span>
<span class="line"><span>  static REACT_COMPONENT = true;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Associate the hook with the fiber node.</span></span>
<span class="line"><span>function useState&lt;S&gt;(initState: S): [S, (value: S) =&gt; void] {</span></span>
<span class="line"><span>  const fiberNode: FiberNode&lt;S&gt; = wipFiber;</span></span>
<span class="line"><span>  const hook: {</span></span>
<span class="line"><span>    state: S;</span></span>
<span class="line"><span>    queue: S[];</span></span>
<span class="line"><span>  } = fiberNode?.alternate?.hooks</span></span>
<span class="line"><span>    ? fiberNode.alternate.hooks[hookIndex]</span></span>
<span class="line"><span>    : {</span></span>
<span class="line"><span>        state: initState,</span></span>
<span class="line"><span>        queue: [],</span></span>
<span class="line"><span>      };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  while (hook.queue.length) {</span></span>
<span class="line"><span>    let newState = hook.queue.shift();</span></span>
<span class="line"><span>    if (isPlainObject(hook.state) &amp;&amp; isPlainObject(newState)) {</span></span>
<span class="line"><span>      newState = { ...hook.state, ...newState };</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    if (isDef(newState)) {</span></span>
<span class="line"><span>      hook.state = newState;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (typeof fiberNode.hooks === &#39;undefined&#39;) {</span></span>
<span class="line"><span>    fiberNode.hooks = [];</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  fiberNode.hooks.push(hook);</span></span>
<span class="line"><span>  hookIndex += 1;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  const setState = (value: S) =&gt; {</span></span>
<span class="line"><span>    hook.queue.push(value);</span></span>
<span class="line"><span>    if (currentRoot) {</span></span>
<span class="line"><span>      wipRoot = {</span></span>
<span class="line"><span>        type: currentRoot.type,</span></span>
<span class="line"><span>        dom: currentRoot.dom,</span></span>
<span class="line"><span>        props: currentRoot.props,</span></span>
<span class="line"><span>        alternate: currentRoot,</span></span>
<span class="line"><span>      };</span></span>
<span class="line"><span>      nextUnitOfWork = wipRoot;</span></span>
<span class="line"><span>      deletions = [];</span></span>
<span class="line"><span>      currentRoot = null;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return [hook.state, setState];</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Start the engine!</span></span>
<span class="line"><span>void (function main() {</span></span>
<span class="line"><span>  window.requestIdleCallback(workLoop);</span></span>
<span class="line"><span>})();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>export default {</span></span>
<span class="line"><span>  createElement,</span></span>
<span class="line"><span>  render,</span></span>
<span class="line"><span>  useState,</span></span>
<span class="line"><span>  Component,</span></span>
<span class="line"><span>  Fragment,</span></span>
<span class="line"><span>};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br></div></div><h2 id="「结论」" tabindex="-1"><strong>「结论」</strong> <a class="header-anchor" href="#「结论」" aria-label="Permalink to &quot;**「结论」**&quot;">​</a></h2><p>我们已经实现了一个支持异步和可中断更新的最小 React 模型，没有依赖项，并且不包括注释和类型，它可能少于 400 行代码。我希望这对你有所帮助。</p>`,75)]))}const F=a(f,[["render",h]]);export{S as __pageData,F as default};
