import{_ as n,c as a,o as l,ah as p}from"./chunks/framework.DqD713j2.js";const e="/FrontEndLearnNotes/assets/%E5%B8%AE%E5%8A%A9%E7%94%9F%E6%88%90%E6%96%87%E4%BB%B6%E5%91%BD%E4%BB%A4%E5%9B%BE%E4%BE%8B.CMtc_QWv.jpg",o="/FrontEndLearnNotes/assets/image-20240229175722750.D18b4pYM.png",r="/FrontEndLearnNotes/assets/94ffe4f1c441413499126c3cece14f22.B-bb7RuA.png",d=JSON.parse('{"title":"Nest æ¡†æ¶å…¥é—¨","description":"","frontmatter":{},"headers":[],"relativePath":"Document/Nodeåç«¯æ¡†æ¶å¼€å‘/Nestæ¡†æ¶/Nestæ¡†æ¶å…¥é—¨.md","filePath":"Document/Nodeåç«¯æ¡†æ¶å¼€å‘/Nestæ¡†æ¶/Nestæ¡†æ¶å…¥é—¨.md","lastUpdated":1750954157000}'),t={name:"Document/Nodeåç«¯æ¡†æ¶å¼€å‘/Nestæ¡†æ¶/Nestæ¡†æ¶å…¥é—¨.md"};function c(i,s,B,y,u,b){return l(),a("div",null,s[0]||(s[0]=[p(`<h1 id="nest-æ¡†æ¶å…¥é—¨" tabindex="-1">Nest æ¡†æ¶å…¥é—¨ <a class="header-anchor" href="#nest-æ¡†æ¶å…¥é—¨" aria-label="Permalink to &quot;Nest æ¡†æ¶å…¥é—¨&quot;">â€‹</a></h1><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://www.nestjs.com.cn/" target="_blank" rel="noreferrer">NestJS ç®€ä»‹ | NestJS ä¸­æ–‡æ–‡æ¡£ | NestJS ä¸­æ–‡ç½‘</a></p><h2 id="ç¯å¢ƒå®‰è£…å’Œé¡¹ç›®åˆ›å»ºè¿è¡Œ" tabindex="-1">ç¯å¢ƒå®‰è£…å’Œé¡¹ç›®åˆ›å»ºè¿è¡Œ <a class="header-anchor" href="#ç¯å¢ƒå®‰è£…å’Œé¡¹ç›®åˆ›å»ºè¿è¡Œ" aria-label="Permalink to &quot;ç¯å¢ƒå®‰è£…å’Œé¡¹ç›®åˆ›å»ºè¿è¡Œ&quot;">â€‹</a></h2><h3 id="_1-node-ç¯å¢ƒä¸‹å®‰è£…-10-13-0-v13-ç‰ˆæœ¬é™¤å¤–" tabindex="-1">1.Node ç¯å¢ƒä¸‹å®‰è£…(&gt;= 10.13.0, v13 ç‰ˆæœ¬é™¤å¤–) <a class="header-anchor" href="#_1-node-ç¯å¢ƒä¸‹å®‰è£…-10-13-0-v13-ç‰ˆæœ¬é™¤å¤–" aria-label="Permalink to &quot;1.Node ç¯å¢ƒä¸‹å®‰è£…(&gt;= 10.13.0, v13 ç‰ˆæœ¬é™¤å¤–)&quot;">â€‹</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> i</span><span style="color:#D19A66;"> -g</span><span style="color:#98C379;"> @nestjs/cli</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_2-åˆ›å»ºé¡¹ç›®" tabindex="-1">2.åˆ›å»ºé¡¹ç›® <a class="header-anchor" href="#_2-åˆ›å»ºé¡¹ç›®" aria-label="Permalink to &quot;2.åˆ›å»ºé¡¹ç›®&quot;">â€‹</a></h3><h4 id="_2-1-å‘½ä»¤è¡Œåˆ›å»º" tabindex="-1">2.1 å‘½ä»¤è¡Œåˆ›å»º <a class="header-anchor" href="#_2-1-å‘½ä»¤è¡Œåˆ›å»º" aria-label="Permalink to &quot;2.1 å‘½ä»¤è¡Œåˆ›å»º&quot;">â€‹</a></h4><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">nest</span><span style="color:#C678DD;"> new</span><span style="color:#ABB2BF;"> [</span><span style="color:#E06C75;">project</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">name</span><span style="color:#ABB2BF;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_2-2-å…¶ä»–ä¸‰ç§é¡¹ç›®å®‰è£…åˆ›å»ºæ–¹å¼" tabindex="-1">2.2 å…¶ä»–ä¸‰ç§é¡¹ç›®å®‰è£…åˆ›å»ºæ–¹å¼ <a class="header-anchor" href="#_2-2-å…¶ä»–ä¸‰ç§é¡¹ç›®å®‰è£…åˆ›å»ºæ–¹å¼" aria-label="Permalink to &quot;2.2 å…¶ä»–ä¸‰ç§é¡¹ç›®å®‰è£…åˆ›å»ºæ–¹å¼&quot;">â€‹</a></h4><h5 id="_1-ä½¿ç”¨-git-å®‰è£…" tabindex="-1">1.ä½¿ç”¨ Git å®‰è£… <a class="header-anchor" href="#_1-ä½¿ç”¨-git-å®‰è£…" aria-label="Permalink to &quot;1.ä½¿ç”¨ Git å®‰è£…&quot;">â€‹</a></h5><p>é‡‡ç”¨ TypeScript å¼€å‘çš„ starter é¡¹ç›®ï¼š</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">git</span><span style="color:#98C379;"> clone</span><span style="color:#98C379;"> https://github.com/nestjs/typescript-starter.git</span><span style="color:#98C379;"> project</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56B6C2;">cd</span><span style="color:#98C379;"> project</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="_2-å®‰è£…åŸºäº-javascript-çš„-starter-project" tabindex="-1">2.å®‰è£…åŸºäº JavaScript çš„ starter project <a class="header-anchor" href="#_2-å®‰è£…åŸºäº-javascript-çš„-starter-project" aria-label="Permalink to &quot;2.å®‰è£…åŸºäº JavaScript çš„ starter project&quot;">â€‹</a></h5><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">git</span><span style="color:#98C379;"> clone</span><span style="color:#98C379;"> javascript-starter.git</span><span style="color:#98C379;"> project</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56B6C2;">cd</span><span style="color:#98C379;"> project</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="_3-è¿˜å¯ä»¥é€šè¿‡-npm-æˆ–-yarn-æ¥å®‰è£…çš„æ ¸å¿ƒå’Œæ”¯æ’‘æ–‡ä»¶-ä»å¤´å¼€å§‹æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®" tabindex="-1">3.è¿˜å¯ä»¥é€šè¿‡ npm ï¼ˆæˆ– yarnï¼‰æ¥å®‰è£…çš„æ ¸å¿ƒå’Œæ”¯æ’‘æ–‡ä»¶ï¼Œä»å¤´å¼€å§‹æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›® <a class="header-anchor" href="#_3-è¿˜å¯ä»¥é€šè¿‡-npm-æˆ–-yarn-æ¥å®‰è£…çš„æ ¸å¿ƒå’Œæ”¯æ’‘æ–‡ä»¶-ä»å¤´å¼€å§‹æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®" aria-label="Permalink to &quot;3.è¿˜å¯ä»¥é€šè¿‡ npm ï¼ˆæˆ– yarnï¼‰æ¥å®‰è£…çš„æ ¸å¿ƒå’Œæ”¯æ’‘æ–‡ä»¶ï¼Œä»å¤´å¼€å§‹æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®&quot;">â€‹</a></h5><p>å½“ç„¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å°†è‡ªå·±æ‹…è´Ÿèµ·åˆ›å»ºé¡¹ç›®æ ·æ¿æ–‡ä»¶çš„å·¥ä½œã€‚</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> i</span><span style="color:#D19A66;"> --save</span><span style="color:#98C379;"> @nestjs/core</span><span style="color:#98C379;"> @nestjs/common</span><span style="color:#98C379;"> rxjs</span><span style="color:#98C379;"> reflect-metadata</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_3-è¿è¡Œé¡¹ç›®" tabindex="-1">3.è¿è¡Œé¡¹ç›® <a class="header-anchor" href="#_3-è¿è¡Œé¡¹ç›®" aria-label="Permalink to &quot;3.è¿è¡Œé¡¹ç›®&quot;">â€‹</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> run</span><span style="color:#98C379;"> start</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># æˆ–</span></span>
<span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> run</span><span style="color:#98C379;"> start:dev</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>å¯åŠ¨çš„æ—¶å€™åº”è¯¥ä»¥ dev æ¨¡å¼å¯åŠ¨ï¼Œè¿™æ · Nest ä¼šã€Œè‡ªåŠ¨æ£€æµ‹æˆ‘ä»¬çš„æ–‡ä»¶å˜åŒ–ã€ï¼Œç„¶åã€Œè‡ªåŠ¨é‡å¯æœåŠ¡ã€</p><h4 id="_4-æµè§ˆå™¨æ‰“å¼€åœ°å€" tabindex="-1">4.æµè§ˆå™¨æ‰“å¼€åœ°å€ <a class="header-anchor" href="#_4-æµè§ˆå™¨æ‰“å¼€åœ°å€" aria-label="Permalink to &quot;4.æµè§ˆå™¨æ‰“å¼€åœ°å€&quot;">â€‹</a></h4><p><a href="http://localhost:3000/" target="_blank" rel="noreferrer">http://localhost:3000/</a></p><h3 id="_4-ç›®å½•ä»‹ç»" tabindex="-1">4.ç›®å½•ä»‹ç» <a class="header-anchor" href="#_4-ç›®å½•ä»‹ç»" aria-label="Permalink to &quot;4.ç›®å½•ä»‹ç»&quot;">â€‹</a></h3><p>1.main.ts å…¥å£æ–‡ä»¶ä¸»æ–‡ä»¶ ç±»ä¼¼äº vue çš„ main.ts</p><p>é€šè¿‡ NestFactory.create(AppModule) åˆ›å»ºä¸€ä¸ª app å°±æ˜¯ç±»ä¼¼äºç»‘å®šä¸€ä¸ªæ ¹ç»„ä»¶ App.vue</p><p>app.listen(3000); ç›‘å¬ä¸€ä¸ªç«¯å£</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">NestFactory</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/core&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./app.module&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> bootstrap</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">	const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">	await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3000</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#61AFEF;">bootstrap</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>2.Controller.ts æ§åˆ¶å™¨</p><p>ä½ å¯ä»¥ç†è§£æˆ vue çš„è·¯ç”±</p><p>private readonly appService: AppService è¿™ä¸€è¡Œä»£ç å°±æ˜¯ä¾èµ–æ³¨å…¥ä¸éœ€è¦å®ä¾‹åŒ– appService å®ƒå†…éƒ¨ä¼šè‡ªå·±å®ä¾‹åŒ–çš„æˆ‘ä»¬ä¸»éœ€è¦æ”¾ä¸Šå»å°±å¯ä»¥äº†</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Controller</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Get</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">AppService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./app.service&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Controller</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppController</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">	constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> readonly</span><span style="color:#E06C75;font-style:italic;"> appService</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">AppService</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#61AFEF;">	getHello</span><span style="color:#ABB2BF;">(): </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">appService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getHello</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//-----------------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//ä¿®æ”¹åœ°å€ä¹‹å</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Controller</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Get</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">AppService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./app.service&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Controller</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/get&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppController</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">	constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> readonly</span><span style="color:#E06C75;font-style:italic;"> appService</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">AppService</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/hello&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;">	getHello</span><span style="color:#ABB2BF;">(): </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">appService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getHello</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>æ‰“å¼€åœ°å€ï¼š<a href="http://localhost:3000/hello" target="_blank" rel="noreferrer">http://localhost:3000/hello</a></p><p>3.app.service.ts</p><p>è¿™ä¸ªæ–‡ä»¶ä¸»è¦å®ç°ä¸šåŠ¡é€»è¾‘çš„ å½“ç„¶ Controller å¯ä»¥å®ç°é€»è¾‘ï¼Œä½†æ˜¯å°±æ˜¯å•ä¸€çš„æ— æ³•å¤ç”¨ï¼Œæ”¾åˆ° app.service æœ‰åˆ«çš„æ¨¡å—ä¹Ÿéœ€è¦å°±å¯ä»¥å®ç°å¤ç”¨</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Injectable</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppService</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	getHello</span><span style="color:#ABB2BF;">(): </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#98C379;"> &quot;Hello World!&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="nest-cli-ä½¿ç”¨-ä½¿ç”¨å‘½ä»¤-ç”Ÿæˆæ–‡ä»¶" tabindex="-1">ğŸ…°ï¸Nest CLI ä½¿ç”¨(ä½¿ç”¨å‘½ä»¤ ç”Ÿæˆæ–‡ä»¶) <a class="header-anchor" href="#nest-cli-ä½¿ç”¨-ä½¿ç”¨å‘½ä»¤-ç”Ÿæˆæ–‡ä»¶" aria-label="Permalink to &quot;:a:Nest CLI ä½¿ç”¨(ä½¿ç”¨å‘½ä»¤ ç”Ÿæˆæ–‡ä»¶)&quot;">â€‹</a></h2><p>æ–‡æ¡£ï¼š<a href="https://docs.nestjs.com/cli/overview" target="_blank" rel="noreferrer">Overview - CLI | NestJS - A progressive Node.js framework</a></p><h3 id="å¸®åŠ©ç”Ÿæˆæ–‡ä»¶å‘½ä»¤è¯¦è§£" tabindex="-1">å¸®åŠ©ç”Ÿæˆæ–‡ä»¶å‘½ä»¤è¯¦è§£ <a class="header-anchor" href="#å¸®åŠ©ç”Ÿæˆæ–‡ä»¶å‘½ä»¤è¯¦è§£" aria-label="Permalink to &quot;å¸®åŠ©ç”Ÿæˆæ–‡ä»¶å‘½ä»¤è¯¦è§£&quot;">â€‹</a></h3><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">nest</span><span style="color:#56B6C2;"> -</span><span style="color:#E06C75;"> h</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>å›¾ä¾‹</p><p><img src="`+e+`" alt="å¸®åŠ©ç”Ÿæˆæ–‡ä»¶å‘½ä»¤å›¾ä¾‹"></p><h4 id="å‘½ä»¤è¯¦è§£å’Œç®€å†™" tabindex="-1">å‘½ä»¤è¯¦è§£å’Œç®€å†™ <a class="header-anchor" href="#å‘½ä»¤è¯¦è§£å’Œç®€å†™" aria-label="Permalink to &quot;å‘½ä»¤è¯¦è§£å’Œç®€å†™&quot;">â€‹</a></h4><ul><li>class (ç®€å†™: cl) ç±»</li><li>controller (ç®€å†™: co) æ§åˆ¶å™¨</li><li>decorator (ç®€å†™: d) è£…é¥°å™¨</li><li>exception (ç®€å†™: e) å¼‚å¸¸æ•è·</li><li>filter (ç®€å†™: f) è¿‡æ»¤å™¨</li><li>gateway (ç®€å†™: ga) ç½‘å…³</li><li>guard (ç®€å†™: gu) å®ˆå«</li><li>interceptor (ç®€å†™: i) æ‹¦æˆªå™¨</li><li>middleware (ç®€å†™: mi) ä¸­é—´ä»¶</li><li>module (ç®€å†™: mo) æ¨¡å—</li><li>pipe (ç®€å†™: pi) ç®¡é“</li><li>provider (ç®€å†™: pr) ä¾›åº”å•†</li><li>service (ç®€å†™: s) æœåŠ¡</li></ul><h3 id="ç”Ÿæˆå‘½ä»¤çš„ä½¿ç”¨" tabindex="-1">ç”Ÿæˆå‘½ä»¤çš„ä½¿ç”¨ <a class="header-anchor" href="#ç”Ÿæˆå‘½ä»¤çš„ä½¿ç”¨" aria-label="Permalink to &quot;ç”Ÿæˆå‘½ä»¤çš„ä½¿ç”¨&quot;">â€‹</a></h3><h4 id="_1-æ„å»º-module-æœåŠ¡æ¨¡å—" tabindex="-1">1.æ„å»º module æœåŠ¡æ¨¡å— <a class="header-anchor" href="#_1-æ„å»º-module-æœåŠ¡æ¨¡å—" aria-label="Permalink to &quot;1.æ„å»º module æœåŠ¡æ¨¡å—&quot;">â€‹</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> module</span><span style="color:#98C379;"> video</span><span style="color:#98C379;"> server</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># ç®€å†™</span></span>
<span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> mo</span><span style="color:#98C379;"> video</span><span style="color:#98C379;"> server</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_2-åˆ›å»º-controller" tabindex="-1">2.åˆ›å»º Controller <a class="header-anchor" href="#_2-åˆ›å»º-controller" aria-label="Permalink to &quot;2.åˆ›å»º Controller&quot;">â€‹</a></h4><p>controller å°±ç±»ä¼¼å‰ç«¯çš„ã€Œè·¯ç”±ã€ï¼Œè´Ÿè´£å¤„ç†ã€Œå®¢æˆ·ç«¯ä¼ å…¥çš„è¯·æ±‚ã€å’Œã€ŒæœåŠ¡ç«¯è¿”å›çš„å“åº”ã€</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> controller</span><span style="color:#98C379;"> video</span><span style="color:#98C379;"> server</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># ç®€å†™</span></span>
<span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> co</span><span style="color:#98C379;"> video</span><span style="color:#98C379;"> server</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_3-åˆ›å»º-provider-æœåŠ¡çš„æä¾›è€…" tabindex="-1">3.åˆ›å»º Providerï¼šæœåŠ¡çš„æä¾›è€… <a class="header-anchor" href="#_3-åˆ›å»º-provider-æœåŠ¡çš„æä¾›è€…" aria-label="Permalink to &quot;3.åˆ›å»º Providerï¼šæœåŠ¡çš„æä¾›è€…&quot;">â€‹</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> service</span><span style="color:#98C379;"> video</span><span style="color:#98C379;"> server</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># ç®€å†™</span></span>
<span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> s</span><span style="color:#98C379;"> video</span><span style="color:#98C379;"> server</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_4-å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ç”Ÿæˆä¸Šé¢çš„-curd" tabindex="-1">4.å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ç”Ÿæˆä¸Šé¢çš„ CURD <a class="header-anchor" href="#_4-å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ç”Ÿæˆä¸Šé¢çš„-curd" aria-label="Permalink to &quot;4.å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ç”Ÿæˆä¸Šé¢çš„ CURD&quot;">â€‹</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">Â nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> resource</span><span style="color:#98C379;"> video</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>ç”Ÿæˆäº†ä¸€å¥—æ ‡å‡†çš„ CURD æ¨¡æ¿</p><p><img src="`+o+'" alt="image-20240229175722750"></p><p>ç¬¬ä¸€æ¬¡ä½¿ç”¨è¿™ä¸ªå‘½ä»¤çš„æ—¶å€™ï¼Œé™¤äº†ç”Ÿæˆæ–‡ä»¶ä¹‹å¤–è¿˜ä¼šè‡ªåŠ¨ä½¿ç”¨ <code>npm</code> å¸®æˆ‘ä»¬æ›´æ–°èµ„æºï¼Œå®‰è£…ä¸€äº›é¢å¤–çš„æ’ä»¶ï¼Œåç»­å†æ¬¡ä½¿ç”¨å°±ä¸ä¼šæ›´æ–°äº†ã€‚</p><h2 id="restful-é£æ ¼è®¾è®¡" tabindex="-1">RESTful é£æ ¼è®¾è®¡ <a class="header-anchor" href="#restful-é£æ ¼è®¾è®¡" aria-label="Permalink to &quot;RESTful é£æ ¼è®¾è®¡&quot;">â€‹</a></h2><p>RESTful æ˜¯ä¸€ç§é£æ ¼ï¼Œåœ¨ RESTful ä¸­ï¼Œä¸€åˆ‡éƒ½è¢«è®¤ä¸ºæ˜¯èµ„æºï¼Œæ¯ä¸ªèµ„æºæœ‰å¯¹åº”çš„ URL æ ‡è¯†ã€‚</p><p>ä¸æ˜¯æ ‡å‡†ä¹Ÿä¸æ˜¯åè®®ï¼Œåªæ˜¯ä¸€ç§é£æ ¼ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸æŒ‰ç…§ä»–çš„é£æ ¼å»å†™ã€‚</p><h3 id="_1-æ¥å£-url" tabindex="-1">1.æ¥å£ url <a class="header-anchor" href="#_1-æ¥å£-url" aria-label="Permalink to &quot;1.æ¥å£ url&quot;">â€‹</a></h3><h4 id="ä¼ ç»Ÿæ¥å£" tabindex="-1">ä¼ ç»Ÿæ¥å£ <a class="header-anchor" href="#ä¼ ç»Ÿæ¥å£" aria-label="Permalink to &quot;ä¼ ç»Ÿæ¥å£&quot;">â€‹</a></h4><p><a href="http://localhost:8080/api/get_list?id=1" target="_blank" rel="noreferrer">http://localhost:8080/api/get_list?id=1</a></p><p><a href="http://localhost:8080/api/delete_list?id=1" target="_blank" rel="noreferrer">http://localhost:8080/api/delete_list?id=1</a></p><p><a href="http://localhost:8080/api/update_list?id=1" target="_blank" rel="noreferrer">http://localhost:8080/api/update_list?id=1</a></p><h4 id="restful-æ¥å£" tabindex="-1">RESTful æ¥å£ <a class="header-anchor" href="#restful-æ¥å£" aria-label="Permalink to &quot;RESTful æ¥å£&quot;">â€‹</a></h4><p>å¢åŠ /æŸ¥è¯¢/åˆ é™¤/æ›´æ–°ï¼š<a href="http://localhost:8080/api/get_list/1" target="_blank" rel="noreferrer">http://localhost:8080/api/get_list/1</a></p><p>RESTful é£æ ¼ä¸€ä¸ªæ¥å£å°±ä¼šå®Œæˆ å¢åˆ æ”¹å·® ä»–æ˜¯é€šè¿‡ä¸åŒçš„è¯·æ±‚æ–¹å¼æ¥åŒºåˆ†çš„</p><ul><li><p>æŸ¥è¯¢ GET</p></li><li><p>æäº¤ POST</p></li><li><p>æ›´æ–° PUT PATCH</p></li><li><p>åˆ é™¤ DELETE</p></li></ul><p><img src="'+r+`" alt="img"></p><h3 id="_2-restful-ç‰ˆæœ¬æ§åˆ¶" tabindex="-1">2.RESTful ç‰ˆæœ¬æ§åˆ¶ <a class="header-anchor" href="#_2-restful-ç‰ˆæœ¬æ§åˆ¶" aria-label="Permalink to &quot;2.RESTful ç‰ˆæœ¬æ§åˆ¶&quot;">â€‹</a></h3><p>ä¸€å…±æœ‰ä¸‰ç§æˆ‘ä»¬ä¸€èˆ¬ç”¨ç¬¬ä¸€ç§ æ›´åŠ è¯­ä¹‰åŒ–</p><table tabindex="0"><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>URI Versioning</td><td>ç‰ˆæœ¬å°†åœ¨è¯·æ±‚çš„ URI ä¸­ä¼ é€’ï¼ˆé»˜è®¤ï¼‰</td></tr><tr><td>Header Versioning</td><td>è‡ªå®šä¹‰è¯·æ±‚æ ‡å¤´å°†æŒ‡å®šç‰ˆæœ¬</td></tr><tr><td>Media Type Versioning</td><td>è¯·æ±‚çš„ Accept æ ‡å¤´å°†æŒ‡å®šç‰ˆæœ¬</td></tr></tbody></table><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">NestFactory</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/core&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">VersioningType</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./app.module&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> bootstrap</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">	const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// ç‰ˆæœ¬æ§åˆ¶</span></span>
<span class="line"><span style="color:#E5C07B;">	app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">enableVersioning</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">		type</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">VersioningType</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">URI</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">	});</span></span>
<span class="line"><span style="color:#C678DD;">	await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3000</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#61AFEF;">bootstrap</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>ç„¶ååœ¨ user.controller é…ç½®ç‰ˆæœ¬</p><p>Controller å˜æˆä¸€ä¸ªå¯¹è±¡ é€šè¿‡ version é…ç½®ç‰ˆæœ¬</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Controller</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Get</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Post</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Body</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Patch</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Param</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Delete</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Version</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UserService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./user.service&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CreateUserDto</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./dto/create-user.dto&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UpdateUserDto</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./dto/update-user.dto&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Controller</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  path</span><span style="color:#ABB2BF;">:</span><span style="color:#98C379;">&quot;user&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  version</span><span style="color:#ABB2BF;">:</span><span style="color:#98C379;">&#39;1&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> UserController</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">  constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> readonly</span><span style="color:#E06C75;font-style:italic;"> userService</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">UserService</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#61AFEF;">  create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;font-style:italic;">createUserDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">CreateUserDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">userService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createUserDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // @Version(&#39;1&#39;)</span></span>
<span class="line"><span style="color:#61AFEF;">  findAll</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">userService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">findAll</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;:id&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;">  findOne</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Param</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;id&#39;</span><span style="color:#ABB2BF;">) </span><span style="color:#E06C75;font-style:italic;">id</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">userService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">findOne</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Patch</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;:id&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;">  update</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Param</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;id&#39;</span><span style="color:#ABB2BF;">) </span><span style="color:#E06C75;font-style:italic;">id</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">, @</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;font-style:italic;">updateUserDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">UpdateUserDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">userService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">update</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">updateUserDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>æ‰“å¼€åœ°å€ï¼š<a href="http://localhost:3000/v1/user" target="_blank" rel="noreferrer">http://localhost:3000/v1/user</a></p><h3 id="_3-code-ç è§„èŒƒ" tabindex="-1">3.Code ç è§„èŒƒ <a class="header-anchor" href="#_3-code-ç è§„èŒƒ" aria-label="Permalink to &quot;3.Code ç è§„èŒƒ&quot;">â€‹</a></h3><ul><li><p>200 OK</p></li><li><p>304 Not Modified åå•†ç¼“å­˜äº†</p></li><li><p>400 Bad Request å‚æ•°é”™è¯¯</p></li><li><p>401 Unauthorized token é”™è¯¯</p></li><li><p>403 Forbidden referer origin éªŒè¯å¤±è´¥</p></li><li><p>404 Not Found æ¥å£ä¸å­˜åœ¨</p></li><li><p>500 Internal Server Error æœåŠ¡ç«¯é”™è¯¯</p></li><li><p>502 Bad Gateway ä¸Šæ¸¸æ¥å£æœ‰é—®é¢˜æˆ–è€…æœåŠ¡å™¨é—®é¢˜</p></li></ul><h2 id="é¡¹ç›®å·¥ä½œç©ºé—´ä¸¤ç§æ¨¡å¼" tabindex="-1">é¡¹ç›®å·¥ä½œç©ºé—´ä¸¤ç§æ¨¡å¼ <a class="header-anchor" href="#é¡¹ç›®å·¥ä½œç©ºé—´ä¸¤ç§æ¨¡å¼" aria-label="Permalink to &quot;é¡¹ç›®å·¥ä½œç©ºé—´ä¸¤ç§æ¨¡å¼&quot;">â€‹</a></h2><h3 id="_1-æ ‡å‡†æ¨¡å¼" tabindex="-1">1.æ ‡å‡†æ¨¡å¼ <a class="header-anchor" href="#_1-æ ‡å‡†æ¨¡å¼" aria-label="Permalink to &quot;1.æ ‡å‡†æ¨¡å¼&quot;">â€‹</a></h3><p>ç”¨äºæ„å»ºå…·æœ‰è‡ªå·±çš„ä¾èµ–é¡¹å’Œè®¾ç½®ã€ä¸éœ€è¦ä¼˜åŒ–å…±äº«æ¨¡å—æˆ–ä¼˜åŒ–å¤æ‚ï¼Œæ„å»ºä»¥é¡¹ç›®ä¸ºä¸­å¿ƒçš„åº”ç”¨ç¨‹åºã€‚è¿™æ˜¯é»˜è®¤æ¨¡å¼ã€‚</p><h3 id="_2-monorepo-æ¨¡å¼" tabindex="-1">2.monorepo æ¨¡å¼ <a class="header-anchor" href="#_2-monorepo-æ¨¡å¼" aria-label="Permalink to &quot;2.monorepo æ¨¡å¼&quot;">â€‹</a></h3><p>è¯¥æ¨¡å¼å°†ä»£ç å·¥ä»¶ä½œä¸ºè½»é‡çº§ monorepo çš„ä¸€éƒ¨åˆ†ï¼Œå¯èƒ½æ›´é€‚åˆå¼€å‘å›¢é˜Ÿæˆ–å¤šé¡¹ç›®ç¯å¢ƒã€‚å®ƒè‡ªåŠ¨åŒ–äº†æ„å»ºè¿‡ç¨‹çš„å„ä¸ªéƒ¨åˆ†ï¼Œä½¿åˆ›å»ºå’Œç»„åˆæ¨¡å—åŒ–ç»„ä»¶å˜å¾—å®¹æ˜“ï¼Œä¿ƒè¿›äº†ä»£ç é‡ç”¨ï¼Œä½¿é›†æˆæµ‹è¯•å˜å¾—æ›´å®¹æ˜“ï¼Œä½¿å…±äº«é¡¹ç›®èŒƒå›´å†…çš„å·¥ä»¶(å¦‚ tslint è§„åˆ™å’Œå…¶ä»–é…ç½®ç­–ç•¥)å˜å¾—å®¹æ˜“ï¼Œå¹¶ä¸”æ¯” github å­æ¨¡å—ä¹‹ç±»çš„æ›¿ä»£æ–¹æ³•æ›´å®¹æ˜“ä½¿ç”¨ã€‚Monorepo æ¨¡å¼é‡‡ç”¨äº†åœ¨ nest-cli.json ä¸­è¡¨ç¤ºå·¥ä½œåŒºçš„æ¦‚å¿µï¼Œä»¥åè°ƒ monorepo ç»„ä»¶ä¹‹é—´çš„å…³ç³»ã€‚</p><h4 id="_1-åˆ›å»ºå­é¡¹ç›®-admin" tabindex="-1">1.åˆ›å»ºå­é¡¹ç›® admin <a class="header-anchor" href="#_1-åˆ›å»ºå­é¡¹ç›®-admin" aria-label="Permalink to &quot;1.åˆ›å»ºå­é¡¹ç›® admin&quot;">â€‹</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> app</span><span style="color:#98C379;"> admin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_2-å¯åŠ¨å­é¡¹ç›®-admin-å¹¶å®æ—¶ç›‘å¬" tabindex="-1">2.å¯åŠ¨å­é¡¹ç›® adminï¼Œå¹¶å®æ—¶ç›‘å¬ <a class="header-anchor" href="#_2-å¯åŠ¨å­é¡¹ç›®-admin-å¹¶å®æ—¶ç›‘å¬" aria-label="Permalink to &quot;2.å¯åŠ¨å­é¡¹ç›® adminï¼Œå¹¶å®æ—¶ç›‘å¬&quot;">â€‹</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> start</span><span style="color:#D19A66;"> -w</span><span style="color:#98C379;"> admin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_3-åˆ›å»ºæ•°æ®åº“æ¨¡å—-èµ‹äºˆåç§°-libs" tabindex="-1">3.åˆ›å»ºæ•°æ®åº“æ¨¡å—--èµ‹äºˆåç§°@libs <a class="header-anchor" href="#_3-åˆ›å»ºæ•°æ®åº“æ¨¡å—-èµ‹äºˆåç§°-libs" aria-label="Permalink to &quot;3.åˆ›å»ºæ•°æ®åº“æ¨¡å—--èµ‹äºˆåç§°@libs&quot;">â€‹</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> lib</span><span style="color:#98C379;"> db</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_4-å®‰è£…æ•°æ®åº“æ¨¡å—-äºŒé€‰ä¸€" tabindex="-1">4.å®‰è£…æ•°æ®åº“æ¨¡å—(äºŒé€‰ä¸€) <a class="header-anchor" href="#_4-å®‰è£…æ•°æ®åº“æ¨¡å—-äºŒé€‰ä¸€" aria-label="Permalink to &quot;4.å®‰è£…æ•°æ®åº“æ¨¡å—(äºŒé€‰ä¸€)&quot;">â€‹</a></h4><h5 id="typegoose" tabindex="-1">typegoose <a class="header-anchor" href="#typegoose" aria-label="Permalink to &quot;typegoose&quot;">â€‹</a></h5><p>å®˜ç½‘ï¼š<a href="https://typegoose.github.io/typegoose/" target="_blank" rel="noreferrer">https://typegoose.github.io/typegoose/</a></p><ul><li><p>æ›´é€‚åˆ typescript å¼€å‘</p></li><li><p>ä½¿ç”¨ TypeScript ç±»å®šä¹‰ Mongoose æ¨¡å‹</p><p>1.nest æ¡†æ¶ä¸“ç”¨å®‰è£…å‘½ä»¤</p></li></ul><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">yarn</span><span style="color:#98C379;"> add</span><span style="color:#98C379;"> nestjs-typegoose</span><span style="color:#98C379;"> @typegoose/typegoose</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>2.å®‰è£… mongoose @types/mongoose</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">yarn</span><span style="color:#98C379;"> add</span><span style="color:#98C379;"> mongoose</span><span style="color:#98C379;"> @types/mongoose</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h5 id="mongoose" tabindex="-1">mongoose <a class="header-anchor" href="#mongoose" aria-label="Permalink to &quot;mongoose&quot;">â€‹</a></h5><p>å®˜ç½‘ï¼š<a href="http://www.mongoosejs.net/" target="_blank" rel="noreferrer">http://www.mongoosejs.net/</a></p><p>1.nest æ¡†æ¶ä¸“ç”¨å®‰è£…å‘½ä»¤</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">yarn</span><span style="color:#98C379;"> add</span><span style="color:#98C379;"> @nestjs/mongoose</span><span style="color:#98C379;"> mongoose</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>2.é…ç½®ä½¿ç”¨ï¼š<a href="https://blog.csdn.net/webtext/article/details/122910230" target="_blank" rel="noreferrer">https://blog.csdn.net/webtext/article/details/122910230</a></p><h2 id="æ¦‚è¿°è¯­æ³•è¯¦æƒ…-å…·ä½“çœ‹å®˜ç½‘æ–‡æ¡£â€”æ¦‚è¿°" tabindex="-1">ğŸ…±ï¸æ¦‚è¿°è¯­æ³•è¯¦æƒ…ï¼ˆå…·ä½“çœ‹å®˜ç½‘æ–‡æ¡£â€”æ¦‚è¿°ï¼‰ <a class="header-anchor" href="#æ¦‚è¿°è¯­æ³•è¯¦æƒ…-å…·ä½“çœ‹å®˜ç½‘æ–‡æ¡£â€”æ¦‚è¿°" aria-label="Permalink to &quot;:b:æ¦‚è¿°è¯­æ³•è¯¦æƒ…ï¼ˆå…·ä½“çœ‹å®˜ç½‘æ–‡æ¡£â€”æ¦‚è¿°ï¼‰&quot;">â€‹</a></h2><p>æ–‡æ¡£ï¼š<a href="https://docs.nestjs.com/controllers" target="_blank" rel="noreferrer">Controllers | NestJS - A progressive Node.js framework</a></p><h3 id="æ§åˆ¶å™¨-controller" tabindex="-1">æ§åˆ¶å™¨ Controller <a class="header-anchor" href="#æ§åˆ¶å™¨-controller" aria-label="Permalink to &quot;æ§åˆ¶å™¨ Controller&quot;">â€‹</a></h3><p>æ§åˆ¶å™¨è´Ÿè´£å¤„ç†ä¼ å…¥çš„è¯·æ±‚å’Œå‘å®¢æˆ·ç«¯è¿”å›å“åº”ã€‚</p><p><strong>æ–‡æ¡£</strong>ï¼š<a href="https://docs.nestjs.cn/8/controllers" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/controllers</a></p><h3 id="æä¾›è€…-providers-service" tabindex="-1">æä¾›è€… Providers(Service) <a class="header-anchor" href="#æä¾›è€…-providers-service" aria-label="Permalink to &quot;æä¾›è€… Providers(Service)&quot;">â€‹</a></h3><p>è®¸å¤šåŸºæœ¬çš„ Nest ç±»å¯èƒ½è¢«è§†ä¸º provider - service, repository, factory, helper ç­‰ç­‰ã€‚ ä»–ä»¬éƒ½å¯ä»¥é€šè¿‡ constructor æ³¨å…¥ä¾èµ–å…³ç³»ã€‚</p><p>Providers æ˜¯ Nest çš„ä¸€ä¸ªåŸºæœ¬æ¦‚å¿µï¼šæ˜¯ä¸€ä¸ªç”¨ @Injectable() è£…é¥°å™¨æ³¨é‡Šçš„ç±»ã€‚</p><p>ç›¸å…³æ–‡ä»¶</p><ul><li>cat.service.ts</li><li>cat/interfaces/cat.interface.ts <ul><li>interfaceï¼šæ¥å£çº¦æŸ</li></ul></li><li>cat/dto/create-cat.dto <ul><li>dotï¼šå‰ç«¯ä¼ æ¥çš„æ•°æ®æ ¡éªŒ</li></ul></li></ul><h3 id="æ¨¡å—-modules" tabindex="-1">æ¨¡å— Modules <a class="header-anchor" href="#æ¨¡å—-modules" aria-label="Permalink to &quot;æ¨¡å— Modules&quot;">â€‹</a></h3><p>æ¨¡å—æ˜¯å…·æœ‰ @Module() è£…é¥°å™¨çš„ç±»</p><h4 id="module-è£…é¥°å™¨æä¾›äº†å…ƒæ•°æ®-nest-ç”¨å®ƒæ¥ç»„ç»‡åº”ç”¨ç¨‹åºç»“æ„" tabindex="-1">@Module({}) è£…é¥°å™¨æä¾›äº†å…ƒæ•°æ®ï¼ŒNest ç”¨å®ƒæ¥ç»„ç»‡åº”ç”¨ç¨‹åºç»“æ„ <a class="header-anchor" href="#module-è£…é¥°å™¨æä¾›äº†å…ƒæ•°æ®-nest-ç”¨å®ƒæ¥ç»„ç»‡åº”ç”¨ç¨‹åºç»“æ„" aria-label="Permalink to &quot;@Module({}) è£…é¥°å™¨æä¾›äº†å…ƒæ•°æ®ï¼ŒNest ç”¨å®ƒæ¥ç»„ç»‡åº”ç”¨ç¨‹åºç»“æ„&quot;">â€‹</a></h4><ul><li>providers <ul><li>ç”± Nest æ³¨å…¥å™¨å®ä¾‹åŒ–çš„æä¾›è€…ï¼Œå¹¶ä¸”å¯ä»¥è‡³å°‘åœ¨æ•´ä¸ªæ¨¡å—ä¸­å…±äº«</li></ul></li><li>controllers <ul><li>å¿…é¡»åˆ›å»ºçš„ä¸€ç»„æ§åˆ¶å™¨</li></ul></li><li>imports <ul><li>å¯¼å…¥æ¨¡å—çš„åˆ—è¡¨ï¼Œè¿™äº›æ¨¡å—å¯¼å‡ºäº†æ­¤æ¨¡å—ä¸­æ‰€éœ€æä¾›è€…</li></ul></li><li>exports <ul><li>ç”±æœ¬æ¨¡å—æä¾›å¹¶åº”åœ¨å…¶ä»–æ¨¡å—ä¸­å¯ç”¨çš„æä¾›è€…çš„å­é›†ã€‚</li></ul></li></ul><h4 id="æ¨¡å—ç« èŠ‚" tabindex="-1">æ¨¡å—ç« èŠ‚ <a class="header-anchor" href="#æ¨¡å—ç« èŠ‚" aria-label="Permalink to &quot;æ¨¡å—ç« èŠ‚&quot;">â€‹</a></h4><h5 id="åŠŸèƒ½æ¨¡å—" tabindex="-1">åŠŸèƒ½æ¨¡å— <a class="header-anchor" href="#åŠŸèƒ½æ¨¡å—" aria-label="Permalink to &quot;åŠŸèƒ½æ¨¡å—&quot;">â€‹</a></h5><p>CatsController å’Œ CatsService</p><p>å±äºåŒä¸€ä¸ªåº”ç”¨ç¨‹åºåŸŸ</p><h6 id="_1-nest-g-module-cats-å‘½ä»¤åˆ›å»ºæ¨¡å—" tabindex="-1">1.nest g module cats å‘½ä»¤åˆ›å»ºæ¨¡å— <a class="header-anchor" href="#_1-nest-g-module-cats-å‘½ä»¤åˆ›å»ºæ¨¡å—" aria-label="Permalink to &quot;1.nest g module cats å‘½ä»¤åˆ›å»ºæ¨¡å—&quot;">â€‹</a></h6><p>cats/cats.module.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats.controller&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats.service&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	controllers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CatsModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h6 id="_2-å°†è¿™ä¸ªæ¨¡å—å¯¼å…¥æ ¹æ¨¡å—-applicationmodule" tabindex="-1">2.å°†è¿™ä¸ªæ¨¡å—å¯¼å…¥æ ¹æ¨¡å— (ApplicationModule) <a class="header-anchor" href="#_2-å°†è¿™ä¸ªæ¨¡å—å¯¼å…¥æ ¹æ¨¡å—-applicationmodule" aria-label="Permalink to &quot;2.å°†è¿™ä¸ªæ¨¡å—å¯¼å…¥æ ¹æ¨¡å— (ApplicationModule)&quot;">â€‹</a></h6><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats/cats.module&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> ApplicationModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h6 id="_3-åŠŸèƒ½æ¨¡å—çš„ç›®å½•ç»“æ„" tabindex="-1">3.åŠŸèƒ½æ¨¡å—çš„ç›®å½•ç»“æ„ <a class="header-anchor" href="#_3-åŠŸèƒ½æ¨¡å—çš„ç›®å½•ç»“æ„" aria-label="Permalink to &quot;3.åŠŸèƒ½æ¨¡å—çš„ç›®å½•ç»“æ„&quot;">â€‹</a></h6><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">src</span></span>
<span class="line"><span style="color:#61AFEF;">â”œâ”€â”€cats</span></span>
<span class="line"><span style="color:#61AFEF;">â”‚</span><span style="color:#98C379;">    â”œâ”€â”€dto</span></span>
<span class="line"><span style="color:#61AFEF;">â”‚</span><span style="color:#98C379;">    â”‚</span><span style="color:#98C379;">   â””â”€â”€create-cat.dto.ts</span></span>
<span class="line"><span style="color:#61AFEF;">â”‚</span><span style="color:#98C379;">    â”œâ”€â”€interfaces</span></span>
<span class="line"><span style="color:#61AFEF;">â”‚</span><span style="color:#98C379;">    â”‚</span><span style="color:#98C379;">     â””â”€â”€cat.interface.ts</span></span>
<span class="line"><span style="color:#61AFEF;">â”‚</span><span style="color:#98C379;">    â”œâ”€cats.service.ts</span></span>
<span class="line"><span style="color:#61AFEF;">â”‚</span><span style="color:#98C379;">    â”œâ”€cats.controller.ts</span></span>
<span class="line"><span style="color:#61AFEF;">â”‚</span><span style="color:#98C379;">    â””â”€â”€cats.module.ts</span></span>
<span class="line"><span style="color:#61AFEF;">â”œâ”€â”€app.module.ts</span></span>
<span class="line"><span style="color:#61AFEF;">â””â”€â”€main.ts</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="å…±äº«æ¨¡å—" tabindex="-1">å…±äº«æ¨¡å— <a class="header-anchor" href="#å…±äº«æ¨¡å—" aria-label="Permalink to &quot;å…±äº«æ¨¡å—&quot;">â€‹</a></h5><p>åœ¨å‡ ä¸ªæ¨¡å—ä¹‹é—´å…±äº« CatsService å®ä¾‹ éœ€è¦æŠŠ CatsService æ”¾åˆ° exports æ•°ç»„ä¸­</p><p>cats.module.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats.controller&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats.service&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	controllers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// å…±äº«æ¨¡å—</span></span>
<span class="line"><span style="color:#E06C75;">	exports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CatsModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>æ¯ä¸ªå¯¼å…¥ CatsModule çš„æ¨¡å—éƒ½å¯ä»¥è®¿é—® CatsService ï¼Œå¹¶ä¸”å®ƒä»¬å°†å…±äº«ç›¸åŒçš„ CatsService å®ä¾‹ã€‚</p><h5 id="æ¨¡å—å¯¼å‡º" tabindex="-1">æ¨¡å—å¯¼å‡º <a class="header-anchor" href="#æ¨¡å—å¯¼å‡º" aria-label="Permalink to &quot;æ¨¡å—å¯¼å‡º&quot;">â€‹</a></h5><p>æ¨¡å—å¯ä»¥å¯¼å‡ºä»–ä»¬çš„å†…éƒ¨æä¾›è€…ã€‚ è€Œä¸”ï¼Œä»–ä»¬å¯ä»¥å†å¯¼å‡ºè‡ªå·±å¯¼å…¥çš„æ¨¡å—ã€‚</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CommonModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">	exports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CommonModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CoreModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="ä¾èµ–æ³¨å…¥" tabindex="-1">ä¾èµ–æ³¨å…¥ <a class="header-anchor" href="#ä¾èµ–æ³¨å…¥" aria-label="Permalink to &quot;ä¾èµ–æ³¨å…¥&quot;">â€‹</a></h5><p>æä¾›è€…ä¹Ÿå¯ä»¥æ³¨å…¥åˆ°æ¨¡å—(ç±»)ä¸­ï¼ˆä¾‹å¦‚ï¼Œç”¨äºé…ç½®ç›®çš„ï¼‰ï¼š</p><p>æ³¨å…¥ cats.module.ts æ¨¡å—</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats.controller&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats.service&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	controllers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CatsModule</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">	constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> readonly</span><span style="color:#E06C75;font-style:italic;"> catsService</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">CatsService</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ä½†æ˜¯ï¼Œç”±äºå¾ªç¯ä¾èµ–æ€§ï¼Œæ¨¡å—ç±»ä¸èƒ½æ³¨å…¥åˆ°æä¾›è€…ä¸­ã€‚</p><h5 id="å…¨å±€æ¨¡å—" tabindex="-1">å…¨å±€æ¨¡å— <a class="header-anchor" href="#å…¨å±€æ¨¡å—" aria-label="Permalink to &quot;å…¨å±€æ¨¡å—&quot;">â€‹</a></h5><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Global</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats.controller&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats.service&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//  @Global è£…é¥°å™¨ä½¿æ¨¡å—æˆä¸ºå…¨å±€ä½œç”¨åŸŸ</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Global</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	controllers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">	exports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CatsModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>å…¨å±€æ¨¡å—åº”è¯¥åªæ³¨å†Œä¸€æ¬¡ï¼Œæœ€å¥½ç”±æ ¹æˆ–æ ¸å¿ƒæ¨¡å—æ³¨å†Œã€‚</p><p>CatsService ç»„ä»¶å°†æ— å¤„ä¸åœ¨ï¼Œè€Œæƒ³è¦ä½¿ç”¨ CatsService çš„æ¨¡å—åˆ™ä¸éœ€è¦åœ¨ imports æ•°ç»„ä¸­å¯¼å…¥ CatsModuleã€‚</p><p>ä½¿ä¸€åˆ‡å…¨å±€åŒ–å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„è§£å†³æ–¹æ¡ˆã€‚ å…¨å±€æ¨¡å—å¯ç”¨äºå‡å°‘å¿…è¦æ¨¡æ¿æ–‡ä»¶çš„æ•°é‡ã€‚ imports æ•°ç»„ä»ç„¶æ˜¯ä½¿æ¨¡å— API é€æ˜çš„æœ€ä½³æ–¹å¼ã€‚</p><h5 id="åŠ¨æ€æ¨¡å—" tabindex="-1">åŠ¨æ€æ¨¡å— <a class="header-anchor" href="#åŠ¨æ€æ¨¡å—" aria-label="Permalink to &quot;åŠ¨æ€æ¨¡å—&quot;">â€‹</a></h5><p>Nest æ¨¡å—ç³»ç»ŸåŒ…æ‹¬ä¸€ä¸ªç§°ä¸ºåŠ¨æ€æ¨¡å—çš„å¼ºå¤§åŠŸèƒ½</p><h6 id="_1-åŠ¨æ€æ¨¡å—å®šä¹‰çš„ç¤ºä¾‹-databasemodule" tabindex="-1">1.åŠ¨æ€æ¨¡å—å®šä¹‰çš„ç¤ºä¾‹ DatabaseModule <a class="header-anchor" href="#_1-åŠ¨æ€æ¨¡å—å®šä¹‰çš„ç¤ºä¾‹-databasemodule" aria-label="Permalink to &quot;1.åŠ¨æ€æ¨¡å—å®šä¹‰çš„ç¤ºä¾‹ DatabaseModule&quot;">â€‹</a></h6><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">DynamicModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">createDatabaseProviders</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./database.providers&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Connection</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./connection.provider&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">Connection</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> DatabaseModule</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	//  forRoot() å¯ä»¥åŒæ­¥æˆ–å¼‚æ­¥ï¼ˆPromiseï¼‰è¿”å›åŠ¨æ€æ¨¡å—ã€‚</span></span>
<span class="line"><span style="color:#C678DD;">	static</span><span style="color:#61AFEF;"> forRoot</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">entities</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [], </span><span style="color:#E06C75;font-style:italic;">options</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">): </span><span style="color:#E5C07B;">DynamicModule</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> providers</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> createDatabaseProviders</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">options</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">entities</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">			global</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;">// å…¨å±€èŒƒå›´å†…æ³¨å†ŒåŠ¨æ€æ¨¡å—</span></span>
<span class="line"><span style="color:#E06C75;">			module</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">DatabaseModule</span><span style="color:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;">//  æ¨¡å—åå­—</span></span>
<span class="line"><span style="color:#E06C75;">			providers</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">providers</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			exports</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">providers</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		};</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h6 id="_2-ä½¿ç”¨-databasemodule-åŠ¨æ€æ¨¡å—" tabindex="-1">2.ä½¿ç”¨ DatabaseModule åŠ¨æ€æ¨¡å— <a class="header-anchor" href="#_2-ä½¿ç”¨-databasemodule-åŠ¨æ€æ¨¡å—" aria-label="Permalink to &quot;2.ä½¿ç”¨ DatabaseModule åŠ¨æ€æ¨¡å—&quot;">â€‹</a></h6><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">DatabaseModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./database/database.module&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./users/entities/user.entity&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E5C07B;">DatabaseModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">([</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">])],</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	//  ä¾æ¬¡é‡æ–°å¯¼å‡ºåŠ¨æ€æ¨¡å—</span></span>
<span class="line"><span style="color:#E06C75;">	exports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">DatabaseModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="ä¸­é—´ä»¶-middleware" tabindex="-1">ä¸­é—´ä»¶ Middleware <a class="header-anchor" href="#ä¸­é—´ä»¶-middleware" aria-label="Permalink to &quot;ä¸­é—´ä»¶ Middleware&quot;">â€‹</a></h3><h4 id="ç®€ä»‹" tabindex="-1">ç®€ä»‹ <a class="header-anchor" href="#ç®€ä»‹" aria-label="Permalink to &quot;ç®€ä»‹&quot;">â€‹</a></h4><ul><li>ä¸­é—´ä»¶æ˜¯åœ¨ è·¯ç”±å¤„ç†ç¨‹åº ä¹‹å‰ è°ƒç”¨çš„å‡½æ•°</li><li>ä¸­é—´ä»¶å‡½æ•°å¯ä»¥è®¿é—®è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼Œä»¥åŠåº”ç”¨ç¨‹åºè¯·æ±‚å“åº”å‘¨æœŸä¸­çš„ next() ä¸­é—´ä»¶å‡½æ•°</li><li>next() ä¸­é—´ä»¶å‡½æ•°é€šå¸¸ç”±åä¸º next çš„å˜é‡è¡¨ç¤º</li></ul><h4 id="ä¸­é—´ä»¶å‡½æ•°å¯ä»¥æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡" tabindex="-1">ä¸­é—´ä»¶å‡½æ•°å¯ä»¥æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ <a class="header-anchor" href="#ä¸­é—´ä»¶å‡½æ•°å¯ä»¥æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡" aria-label="Permalink to &quot;ä¸­é—´ä»¶å‡½æ•°å¯ä»¥æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡&quot;">â€‹</a></h4><ul><li>æ‰§è¡Œä»»ä½•ä»£ç ã€‚</li><li>å¯¹è¯·æ±‚å’Œå“åº”å¯¹è±¡è¿›è¡Œæ›´æ”¹ã€‚</li><li>ç»“æŸè¯·æ±‚-å“åº”å‘¨æœŸã€‚</li><li>è°ƒç”¨å †æ ˆä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ã€‚</li><li>å¦‚æœå½“å‰çš„ä¸­é—´ä»¶å‡½æ•°æ²¡æœ‰ç»“æŸè¯·æ±‚-å“åº”å‘¨æœŸ, å®ƒå¿…é¡»è°ƒç”¨ next() å°†æ§åˆ¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ã€‚å¦åˆ™, è¯·æ±‚å°†è¢«æŒ‚èµ·ã€‚</li></ul><h4 id="ä¸­é—´ä»¶ä½¿ç”¨" tabindex="-1">ä¸­é—´ä»¶ä½¿ç”¨ <a class="header-anchor" href="#ä¸­é—´ä»¶ä½¿ç”¨" aria-label="Permalink to &quot;ä¸­é—´ä»¶ä½¿ç”¨&quot;">â€‹</a></h4><h5 id="ä¾èµ–æ³¨å…¥ä¸­é—´ä»¶" tabindex="-1">ä¾èµ–æ³¨å…¥ä¸­é—´ä»¶ <a class="header-anchor" href="#ä¾èµ–æ³¨å…¥ä¸­é—´ä»¶" aria-label="Permalink to &quot;ä¾èµ–æ³¨å…¥ä¸­é—´ä»¶&quot;">â€‹</a></h5><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Injectable</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">NestMiddleware</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> LoggerMiddleware</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> NestMiddleware</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	use</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">, </span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">: () </span><span style="color:#C678DD;">=&gt;</span><span style="color:#E5C07B;"> void</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">		console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">\`Request...\`</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">		next</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h5 id="åº”ç”¨ä¸­é—´ä»¶" tabindex="-1">åº”ç”¨ä¸­é—´ä»¶ <a class="header-anchor" href="#åº”ç”¨ä¸­é—´ä»¶" aria-label="Permalink to &quot;åº”ç”¨ä¸­é—´ä»¶&quot;">â€‹</a></h5><p>åº”ç”¨ä¾‹å­</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">NestModule</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">MiddlewareConsumer</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">LoggerMiddleware</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./common/middleware/logger.middleware&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">CatsModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./cats/cats.module&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">CatsModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> NestModule</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	configure</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">consumer</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">MiddlewareConsumer</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">		consumer</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">apply</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">LoggerMiddleware</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;cats&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>ç»™è·¯ç”±æ·»åŠ </p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">consumer</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">apply</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">LoggerMiddleware</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;cats&quot;</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>ç»™è·¯ç”±æŒ‡å®š id å‚æ•°æ·»åŠ </p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">consumer</span></span>
<span class="line"><span style="color:#ABB2BF;">	.</span><span style="color:#61AFEF;">apply</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">LoggerMiddleware</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">	.</span><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">path</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;cats:id&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">method</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">RequestMethod</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">GET</span><span style="color:#ABB2BF;"> });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ç»™è·¯ç”±æŒ‡å®š url åœ°å€æ–¹æ³•æ·»åŠ </p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">consumer</span></span>
<span class="line"><span style="color:#ABB2BF;">	.</span><span style="color:#61AFEF;">apply</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">LoggerMiddleware</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">	.</span><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">path</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;cats/say&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">method</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">RequestMethod</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">GET</span><span style="color:#ABB2BF;"> });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="è·¯ç”±é€šé…ç¬¦" tabindex="-1">è·¯ç”±é€šé…ç¬¦ <a class="header-anchor" href="#è·¯ç”±é€šé…ç¬¦" aria-label="Permalink to &quot;è·¯ç”±é€šé…ç¬¦&quot;">â€‹</a></h5><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">path</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;ab*cd&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">method</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">RequestMethod</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">ALL</span><span style="color:#ABB2BF;"> });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h5 id="ä¸­é—´ä»¶æ¶ˆè´¹è€…" tabindex="-1">ä¸­é—´ä»¶æ¶ˆè´¹è€… <a class="header-anchor" href="#ä¸­é—´ä»¶æ¶ˆè´¹è€…" aria-label="Permalink to &quot;ä¸­é—´ä»¶æ¶ˆè´¹è€…&quot;">â€‹</a></h5><p>ç»™æ§åˆ¶å™¨æ·»åŠ ä¸­é—´ä»¶</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">consumer</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">apply</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">LoggerMiddleware</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>.exclude() æ–¹æ³•æ’é™¤è·¯ç”±</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">consumer</span></span>
<span class="line"><span style="color:#ABB2BF;">	.</span><span style="color:#61AFEF;">apply</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">LoggerMiddleware</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">	.</span><span style="color:#61AFEF;">exclude</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">		{ </span><span style="color:#E06C75;">path</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;cats&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">method</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">RequestMethod</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">GET</span><span style="color:#ABB2BF;"> },</span></span>
<span class="line"><span style="color:#ABB2BF;">		{ </span><span style="color:#E06C75;">path</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;cats&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">method</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">RequestMethod</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">POST</span><span style="color:#ABB2BF;"> },</span></span>
<span class="line"><span style="color:#98C379;">		&quot;cats/(.*)&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">	)</span></span>
<span class="line"><span style="color:#ABB2BF;">	.</span><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>å¯ä»¥é‡‡ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¤šä¸ªå­—ç¬¦ä¸²æˆ–ä¸€ä¸ª RouteInfo å¯¹è±¡æ¥æ ‡è¯†è¦æ’é™¤çš„è·¯ç”±</p><p>path-to-regexp åŒ…æ”¯æŒé€šé…ç¬¦å‚æ•°ã€‚</p><h5 id="å‡½æ•°å¼ä¸­é—´ä»¶" tabindex="-1">å‡½æ•°å¼ä¸­é—´ä»¶ <a class="header-anchor" href="#å‡½æ•°å¼ä¸­é—´ä»¶" aria-label="Permalink to &quot;å‡½æ•°å¼ä¸­é—´ä»¶&quot;">â€‹</a></h5><p>logger.middleware.ts æ–‡ä»¶</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  logger.middleware.ts æ–‡ä»¶</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> logger</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">next</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">	console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">\`Request...\`</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">	next</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>åœ¨ AppModule (app.module.ts)ä¸­ä½¿ç”¨å®ƒ</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">consumer</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">apply</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">logger</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h5 id="å¤šä¸ªä¸­é—´ä»¶" tabindex="-1">å¤šä¸ªä¸­é—´ä»¶ <a class="header-anchor" href="#å¤šä¸ªä¸­é—´ä»¶" aria-label="Permalink to &quot;å¤šä¸ªä¸­é—´ä»¶&quot;">â€‹</a></h5><p>åœ¨ apply() æ–¹æ³•å†…ç”¨é€—å·åˆ†éš”å¤šä¸ªä¸­é—´ä»¶</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">consumer</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">apply</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">cors</span><span style="color:#ABB2BF;">(), </span><span style="color:#61AFEF;">helmet</span><span style="color:#ABB2BF;">(), </span><span style="color:#E06C75;">logger</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">forRoutes</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">CatsController</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h5 id="å…¨å±€ä½¿ç”¨ä¸­é—´ä»¶" tabindex="-1">å…¨å±€ä½¿ç”¨ä¸­é—´ä»¶ <a class="header-anchor" href="#å…¨å±€ä½¿ç”¨ä¸­é—´ä»¶" aria-label="Permalink to &quot;å…¨å±€ä½¿ç”¨ä¸­é—´ä»¶&quot;">â€‹</a></h5><p>ä¸€æ¬¡æ€§å°†ä¸­é—´ä»¶ç»‘å®šåˆ°æ¯ä¸ªæ³¨å†Œè·¯ç”±</p><p>main.ts é‡Œä½¿ç”¨ INestApplication å®ä¾‹æä¾›çš„ use()æ–¹æ³•</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">logger</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3000</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="å¼‚å¸¸è¿‡æ»¤å™¨-exception-filters" tabindex="-1">å¼‚å¸¸è¿‡æ»¤å™¨ Exception filters <a class="header-anchor" href="#å¼‚å¸¸è¿‡æ»¤å™¨-exception-filters" aria-label="Permalink to &quot;å¼‚å¸¸è¿‡æ»¤å™¨ Exception filters&quot;">â€‹</a></h3><h4 id="æ¦‚å¿µ" tabindex="-1">æ¦‚å¿µ <a class="header-anchor" href="#æ¦‚å¿µ" aria-label="Permalink to &quot;æ¦‚å¿µ&quot;">â€‹</a></h4><ul><li>å†…ç½®çš„å¼‚å¸¸å±‚è´Ÿè´£å¤„ç†æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰æŠ›å‡ºçš„å¼‚å¸¸</li><li>å½“æ•è·åˆ°æœªå¤„ç†çš„å¼‚å¸¸æ—¶ï¼Œæœ€ç»ˆç”¨æˆ·å°†æ”¶åˆ°å‹å¥½çš„å“åº”</li></ul><h4 id="å¼‚å¸¸-json-å“åº”ä¾‹å­" tabindex="-1">å¼‚å¸¸ JSON å“åº”ä¾‹å­ <a class="header-anchor" href="#å¼‚å¸¸-json-å“åº”ä¾‹å­" aria-label="Permalink to &quot;å¼‚å¸¸ JSON å“åº”ä¾‹å­&quot;">â€‹</a></h4><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#98C379;">    &quot;statusCode&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">500</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;">    &quot;message&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;Internal server error&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="å¼‚å¸¸" tabindex="-1">å¼‚å¸¸ <a class="header-anchor" href="#å¼‚å¸¸" aria-label="Permalink to &quot;å¼‚å¸¸&quot;">â€‹</a></h4><h5 id="åŸºç¡€å¼‚å¸¸ç±»" tabindex="-1">åŸºç¡€å¼‚å¸¸ç±» <a class="header-anchor" href="#åŸºç¡€å¼‚å¸¸ç±»" aria-label="Permalink to &quot;åŸºç¡€å¼‚å¸¸ç±»&quot;">â€‹</a></h5><p>Nest æä¾›äº†ä¸€ä¸ªå†…ç½®çš„ HttpException ç±»ï¼Œå®ƒä» @nestjs/common åŒ…ä¸­å¯¼å…¥</p><p>æ§åˆ¶å™¨æŠ›å‡ºå¼‚å¸¸</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findAll</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> HttpException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;Forbidden&#39;</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">FORBIDDEN</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨äº† HttpStatus ã€‚å®ƒæ˜¯ä» @nestjs/common åŒ…å¯¼å…¥çš„è¾…åŠ©æšä¸¾å™¨ã€‚</p><p>å½“å®¢æˆ·ç«¯è°ƒç”¨è¿™ä¸ªç«¯ç‚¹æ—¶</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#98C379;">    &quot;statusCode&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">403</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;">    &quot;message&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;Forbidden&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>HttpException æ„é€ å‡½æ•°</strong>ï¼š</p><p>å‚æ•°</p><ul><li><strong>response å‚æ•°</strong>ï¼šå®šä¹‰ JSON å“åº”ä½“ã€‚å®ƒå¯ä»¥æ˜¯ string æˆ– object</li><li><strong>status å‚æ•°</strong>ï¼šå®šä¹‰ HTTP çŠ¶æ€ä»£ç ã€‚</li></ul><p>JSON å“åº”ä¸»ä½“åŒ…å«ä¸¤ä¸ªå±æ€§</p><ul><li><strong>statusCode</strong>ï¼šé»˜è®¤ä¸º status å‚æ•°ä¸­æä¾›çš„ HTTP çŠ¶æ€ä»£ç </li><li><strong>message</strong>ï¼šåŸºäºçŠ¶æ€çš„ HTTP é”™è¯¯çš„ç®€çŸ­æè¿°</li></ul><p>è¦†ç›– JSON å“åº”ä¸»ä½“çš„æ¶ˆæ¯éƒ¨åˆ†</p><p>åœ¨ response å‚æ•°ä¸­æä¾›ä¸€ä¸ª string</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findAll</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> HttpException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;æˆ‘æ˜¯å¼‚å¸¸æ¶ˆæ¯&#39;</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">FORBIDDEN</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¦†ç›–æ•´ä¸ª JSON å“åº”ä¸»ä½“</p><ul><li>åœ¨ response å‚æ•°ä¸­ä¼ é€’ä¸€ä¸ª objectï¼ŒNest å°†åºåˆ—åŒ–å¯¹è±¡ï¼Œå¹¶å°†å…¶ä½œä¸º JSON å“åº”è¿”å›ã€‚</li><li>ç¬¬äºŒä¸ªæ„é€ å‡½æ•°å‚æ•°-status-æ˜¯æœ‰æ•ˆçš„ HTTP çŠ¶æ€ä»£ç ã€‚ æœ€ä½³å®è·µæ˜¯ä½¿ç”¨ä»@nestjs/common å¯¼å…¥çš„ HttpStatus æšä¸¾</li></ul><p>ä¾‹å­</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findAll</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> HttpException</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">    status</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">FORBIDDEN</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    error</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;This is a custom message&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  }, </span><span style="color:#E5C07B;">HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">FORBIDDEN</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>å®¢æˆ·ç«¯å“åº”</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;status&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">403</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;error&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;This is a custom message&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="è‡ªå®šä¹‰å¼‚å¸¸" tabindex="-1">è‡ªå®šä¹‰å¼‚å¸¸ <a class="header-anchor" href="#è‡ªå®šä¹‰å¼‚å¸¸" aria-label="Permalink to &quot;è‡ªå®šä¹‰å¼‚å¸¸&quot;">â€‹</a></h5><p>åˆ›å»ºè‡ªå·±çš„å¼‚å¸¸å±‚æ¬¡ç»“æ„</p><p>å…¶ä¸­è‡ªå®šä¹‰å¼‚å¸¸ç»§æ‰¿è‡ª HttpException åŸºç±»ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•ï¼ŒNest å¯ä»¥è¯†åˆ«æ‚¨çš„å¼‚å¸¸ï¼Œå¹¶è‡ªåŠ¨å¤„ç†é”™è¯¯å“åº”ã€‚</p><p>è‡ªå®šä¹‰å¼‚å¸¸ä¾‹å­</p><p>forbidden.exception.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  forbidden.exception.ts</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> ForbiddenException</span><span style="color:#C678DD;"> extends</span><span style="color:#E5C07B;"> HttpException</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">	constructor</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#E5C07B;font-style:italic;">		super</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Forbidden&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">FORBIDDEN</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ä½¿ç”¨</p><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// cats.controller.ts</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findAll</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ForbiddenException</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="å†…ç½®-http-å¼‚å¸¸" tabindex="-1">å†…ç½® HTTP å¼‚å¸¸ <a class="header-anchor" href="#å†…ç½®-http-å¼‚å¸¸" aria-label="Permalink to &quot;å†…ç½® HTTP å¼‚å¸¸&quot;">â€‹</a></h5><p>@nestjs/common åŒ…ä¸­</p><ul><li>BadRequestException</li><li>UnauthorizedException</li><li>NotFoundException</li><li>ForbiddenException</li><li>NotAcceptableException</li><li>RequestTimeoutException</li><li>ConflictException</li><li>GoneException</li><li>PayloadTooLargeException</li><li>UnsupportedMediaTypeException</li><li>UnprocessableException</li><li>InternalServerErrorException</li><li>NotImplementedException</li><li>BadGatewayException</li><li>ServiceUnavailableException</li><li>GatewayTimeoutException</li></ul><h5 id="å¼‚å¸¸è¿‡æ»¤å™¨" tabindex="-1">å¼‚å¸¸è¿‡æ»¤å™¨ <a class="header-anchor" href="#å¼‚å¸¸è¿‡æ»¤å™¨" aria-label="Permalink to &quot;å¼‚å¸¸è¿‡æ»¤å™¨&quot;">â€‹</a></h5><h6 id="ç”¨å¤„" tabindex="-1">ç”¨å¤„ <a class="header-anchor" href="#ç”¨å¤„" aria-label="Permalink to &quot;ç”¨å¤„&quot;">â€‹</a></h6><ul><li>åŸºäºæŸäº›åŠ¨æ€å› ç´ æ·»åŠ æ—¥å¿—è®°å½•æˆ–ä½¿ç”¨ä¸åŒçš„ JSON æ¨¡å¼</li><li>æ§åˆ¶ç²¾ç¡®çš„æ§åˆ¶æµä»¥åŠå°†å“åº”çš„å†…å®¹å‘é€å›å®¢æˆ·ç«¯</li></ul><h6 id="åˆ›å»ºè¿‡æ»¤å¼‚å¸¸å¤„ç†å™¨" tabindex="-1">åˆ›å»ºè¿‡æ»¤å¼‚å¸¸å¤„ç†å™¨ <a class="header-anchor" href="#åˆ›å»ºè¿‡æ»¤å¼‚å¸¸å¤„ç†å™¨" aria-label="Permalink to &quot;åˆ›å»ºè¿‡æ»¤å¼‚å¸¸å¤„ç†å™¨&quot;">â€‹</a></h6><p>http-exception.filter.ts</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">nest</span><span style="color:#98C379;"> g</span><span style="color:#98C379;"> f</span><span style="color:#98C379;"> http-exception</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>å¼‚å¸¸è¿‡æ»¤å™¨åˆ›å»ºæ­¥éª¤</p><p>åˆ›å»ºä¸€ä¸ªå¼‚å¸¸è¿‡æ»¤å™¨ï¼Œå®ƒè´Ÿè´£æ•è·ä½œä¸º HttpException ç±»å®ä¾‹çš„å¼‚å¸¸ï¼Œå¹¶ä¸ºå®ƒä»¬è®¾ç½®è‡ªå®šä¹‰å“åº”é€»è¾‘ã€‚</p><p>æ­¥éª¤å’Œç”¨æ³•</p><ul><li>1.æˆ‘ä»¬éœ€è¦è®¿é—®åº•å±‚å¹³å° Request å’Œ Responseã€‚</li><li>2.æˆ‘ä»¬å°†è®¿é—® Request å¯¹è±¡ï¼Œä»¥ä¾¿æå–åŸå§‹ url å¹¶å°†å…¶åŒ…å«åœ¨æ—¥å¿—ä¿¡æ¯ä¸­ã€‚</li><li>3.æˆ‘ä»¬å°†ä½¿ç”¨ Response.json()æ–¹æ³•ï¼Œä½¿ç”¨ Response å¯¹è±¡ç›´æ¥æ§åˆ¶å‘é€çš„å“åº”ã€‚</li></ul><p>å¼‚å¸¸è¿‡æ»¤å™¨ä¾‹å­</p><p>http-exception.filter.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	ExceptionFilter</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Catch</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	ArgumentsHost</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	HttpException</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Request</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Response</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;express&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Catch</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">HttpException</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> HttpExceptionFilter</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> ExceptionFilter</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	catch</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">exception</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">HttpException</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">host</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ArgumentsHost</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> ctx</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> host</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">switchToHttp</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> response</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getResponse</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Response</span><span style="color:#ABB2BF;">&gt;();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> request</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getRequest</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Request</span><span style="color:#ABB2BF;">&gt;();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> status</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> exception</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getStatus</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">		response</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">status</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">status</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">json</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">			statusCode</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">status</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			timestamp</span><span style="color:#ABB2BF;">: </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> Date</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">toISOString</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#E06C75;">			path</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">request</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">url</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		});</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>æ‰€æœ‰å¼‚å¸¸è¿‡æ»¤å™¨éƒ½åº”è¯¥å®ç°é€šç”¨çš„ <code>ExceptionFilter&lt;T&gt;</code> æ¥å£ã€‚</p><p>å®ƒéœ€è¦ä½ ä½¿ç”¨æœ‰æ•ˆç­¾åæä¾› catch(exception: T, host: ArgumentsHost)æ–¹æ³•ã€‚T è¡¨ç¤ºå¼‚å¸¸çš„ç±»å‹ã€‚</p><p>@Catch() è£…é¥°å™¨ç»‘å®šæ‰€éœ€çš„å…ƒæ•°æ®åˆ°å¼‚å¸¸è¿‡æ»¤å™¨ä¸Šã€‚å®ƒå‘Šè¯‰ Nest è¿™ä¸ªç‰¹å®šçš„è¿‡æ»¤å™¨æ­£åœ¨å¯»æ‰¾ HttpException è€Œä¸æ˜¯å…¶ä»–çš„ã€‚</p><p>åœ¨å®è·µä¸­ï¼Œ@Catch() å¯ä»¥ä¼ é€’å¤šä¸ªå‚æ•°ï¼Œæ‰€ä»¥ä½ å¯ä»¥é€šè¿‡é€—å·åˆ†éš”æ¥ä¸ºå¤šä¸ªç±»å‹çš„å¼‚å¸¸è®¾ç½®è¿‡æ»¤å™¨ã€‚</p><h5 id="å‚æ•°ä¸»æœº" tabindex="-1">å‚æ•°ä¸»æœº <a class="header-anchor" href="#å‚æ•°ä¸»æœº" aria-label="Permalink to &quot;å‚æ•°ä¸»æœº&quot;">â€‹</a></h5><p>æ–‡æ¡£ï¼š<a href="https://docs.nestjs.cn/8/exceptionfilters?id=%e5%8f%82%e6%95%b0%e4%b8%bb%e6%9c%ba" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/exceptionfilters?id=å‚æ•°ä¸»æœº</a></p><p>catch(exception: T, host: ArgumentsHost) æ–¹æ³•</p><ul><li><strong>exception å‚æ•°</strong>ï¼šæ˜¯å½“å‰æ­£åœ¨å¤„ç†çš„å¼‚å¸¸å¯¹è±¡</li><li><strong>host å‚æ•°</strong><ul><li>æ˜¯ä¸€ä¸ª ArgumentsHost å¯¹è±¡ <ul><li>ArgumentsHost æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å®ç”¨ç¨‹åºå¯¹è±¡</li><li>åœ¨ä¸Šä¸‹æ–‡ç« èŠ‚ä¸­è¿›ä¸€æ­¥è¿›è¡Œç ”ç©¶</li><li>æ–‡æ¡£ï¼š<a href="https://docs.nestjs.cn/8/fundamentals?id=%e5%ba%94%e7%94%a8%e4%b8%8a%e4%b8%8b%e6%96%87" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/fundamentals?id=åº”ç”¨ä¸Šä¸‹æ–‡</a></li></ul></li><li>åœ¨å¼‚å¸¸è¿‡æ»¤çš„ä¾‹å­ä¸­ <ul><li>ä½¿ç”¨å®ƒæ¥è·å–å¯¹ Request å’Œ Response å¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™äº›å¯¹è±¡è¢«ä¼ é€’ç»™åŸå§‹è¯·æ±‚å¤„ç†ç¨‹åºï¼ˆåœ¨å¼‚å¸¸å‘ç”Ÿçš„æ§åˆ¶å™¨ä¸­ï¼‰</li><li>ä½¿ç”¨äº†ä¸€äº›è¾…åŠ©æ–¹æ³• ArgumentsHost æ¥è·å–æ‰€éœ€çš„ Request å’Œ Response å¯¹è±¡ã€‚</li></ul></li></ul></li></ul><h5 id="ç»‘å®šè¿‡æ»¤å™¨" tabindex="-1">ç»‘å®šè¿‡æ»¤å™¨ <a class="header-anchor" href="#ç»‘å®šè¿‡æ»¤å™¨" aria-label="Permalink to &quot;ç»‘å®šè¿‡æ»¤å™¨&quot;">â€‹</a></h5><h6 id="_1-å°†-httpexceptionfilter-ç»‘å®šåˆ°-catscontroller-çš„-create-æ–¹æ³•ä¸Š" tabindex="-1">1.å°† HttpExceptionFilter ç»‘å®šåˆ° CatsController çš„ create() æ–¹æ³•ä¸Š <a class="header-anchor" href="#_1-å°†-httpexceptionfilter-ç»‘å®šåˆ°-catscontroller-çš„-create-æ–¹æ³•ä¸Š" aria-label="Permalink to &quot;1.å°† HttpExceptionFilter ç»‘å®šåˆ° CatsController çš„ create() æ–¹æ³•ä¸Š&quot;">â€‹</a></h6><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  cats.controller.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UseFilters</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> HttpExceptionFilter</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">  throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ForbiddenException</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>åˆ›å»ºäº† HttpExceptionFilter çš„å®ä¾‹</p><ul><li>@UseFilters() è£…é¥°å™¨ï¼šéœ€è¦ä» @nestjs/common åŒ…å¯¼å…¥</li><li>@UseFilters() è£…é¥°å™¨ï¼šå’Œ @Catch()è£…é¥°å™¨ç±»ä¼¼ï¼Œå®ƒå¯ä»¥ä½¿ç”¨å•ä¸ªè¿‡æ»¤å™¨å®ä¾‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€—å·åˆ†éš”çš„è¿‡æ»¤å™¨å®ä¾‹åˆ—è¡¨</li></ul><h6 id="_2-ä¼ é€’ç±»-è®©æ¡†æ¶æ‰¿æ‹…å®ä¾‹åŒ–è´£ä»»å¹¶å¯ç”¨ä¾èµ–æ³¨å…¥" tabindex="-1">2.ä¼ é€’ç±»:è®©æ¡†æ¶æ‰¿æ‹…å®ä¾‹åŒ–è´£ä»»å¹¶å¯ç”¨ä¾èµ–æ³¨å…¥ <a class="header-anchor" href="#_2-ä¼ é€’ç±»-è®©æ¡†æ¶æ‰¿æ‹…å®ä¾‹åŒ–è´£ä»»å¹¶å¯ç”¨ä¾èµ–æ³¨å…¥" aria-label="Permalink to &quot;2.ä¼ é€’ç±»:è®©æ¡†æ¶æ‰¿æ‹…å®ä¾‹åŒ–è´£ä»»å¹¶å¯ç”¨ä¾èµ–æ³¨å…¥&quot;">â€‹</a></h6><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  cats.controller.ts</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UseFilters</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">HttpExceptionFilter</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">  throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ForbiddenException</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>å°½å¯èƒ½ä½¿ç”¨ç±»è€Œä¸æ˜¯å®ä¾‹ã€‚ç”±äº Nest å¯ä»¥è½»æ¾åœ°åœ¨æ•´ä¸ªæ¨¡å—ä¸­é‡å¤ä½¿ç”¨åŒä¸€ç±»çš„å®ä¾‹ï¼Œå› æ­¤å¯ä»¥å‡å°‘å†…å­˜ä½¿ç”¨ã€‚</p><p>HttpExceptionFilter ä»…åº”ç”¨äºå•ä¸ª create() è·¯ç”±å¤„ç†ç¨‹åºï¼Œä½¿å…¶æˆä¸ºæ–¹æ³•èŒƒå›´çš„</p><h6 id="å¼‚å¸¸è¿‡æ»¤å™¨çš„ä½œç”¨åŸŸå¯ä»¥åˆ’åˆ†ä¸ºä¸åŒçš„çº§åˆ«" tabindex="-1">å¼‚å¸¸è¿‡æ»¤å™¨çš„ä½œç”¨åŸŸå¯ä»¥åˆ’åˆ†ä¸ºä¸åŒçš„çº§åˆ« <a class="header-anchor" href="#å¼‚å¸¸è¿‡æ»¤å™¨çš„ä½œç”¨åŸŸå¯ä»¥åˆ’åˆ†ä¸ºä¸åŒçš„çº§åˆ«" aria-label="Permalink to &quot;å¼‚å¸¸è¿‡æ»¤å™¨çš„ä½œç”¨åŸŸå¯ä»¥åˆ’åˆ†ä¸ºä¸åŒçš„çº§åˆ«&quot;">â€‹</a></h6><ul><li>æ–¹æ³•èŒƒå›´</li><li>æ§åˆ¶å™¨èŒƒå›´æˆ–å…¨å±€èŒƒå›´</li></ul><h6 id="_3-å°†è¿‡æ»¤å™¨è®¾ç½®ä¸ºæ§åˆ¶å™¨ä½œç”¨åŸŸ" tabindex="-1">3.å°†è¿‡æ»¤å™¨è®¾ç½®ä¸ºæ§åˆ¶å™¨ä½œç”¨åŸŸ <a class="header-anchor" href="#_3-å°†è¿‡æ»¤å™¨è®¾ç½®ä¸ºæ§åˆ¶å™¨ä½œç”¨åŸŸ" aria-label="Permalink to &quot;3.å°†è¿‡æ»¤å™¨è®¾ç½®ä¸ºæ§åˆ¶å™¨ä½œç”¨åŸŸ&quot;">â€‹</a></h6><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  cats.controller.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UseFilters</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> HttpExceptionFilter</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CatsController</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æ­¤ç»“æ„ä¸º CatsController ä¸­çš„æ¯ä¸ªè·¯ç”±å¤„ç†ç¨‹åºè®¾ç½® HttpExceptionFilterã€‚</p><h6 id="_4-åˆ›å»ºä¸€ä¸ªå…¨å±€èŒƒå›´çš„è¿‡æ»¤å™¨" tabindex="-1">4.åˆ›å»ºä¸€ä¸ªå…¨å±€èŒƒå›´çš„è¿‡æ»¤å™¨ <a class="header-anchor" href="#_4-åˆ›å»ºä¸€ä¸ªå…¨å±€èŒƒå›´çš„è¿‡æ»¤å™¨" aria-label="Permalink to &quot;4.åˆ›å»ºä¸€ä¸ªå…¨å±€èŒƒå›´çš„è¿‡æ»¤å™¨&quot;">â€‹</a></h6><p>main.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  main.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> bootstrap</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">	const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">	app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">useGlobalFilters</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> HttpExceptionFilter</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#C678DD;">	await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3000</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#61AFEF;">bootstrap</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>è¯¥ useGlobalFilters() æ–¹æ³•ä¸ä¼šä¸ºç½‘å…³å’Œæ··åˆåº”ç”¨ç¨‹åºè®¾ç½®è¿‡æ»¤å™¨ã€‚</p><p>å…¨å±€è¿‡æ»¤å™¨ç”¨äºæ•´ä¸ªåº”ç”¨ç¨‹åºã€æ¯ä¸ªæ§åˆ¶å™¨å’Œæ¯ä¸ªè·¯ç”±å¤„ç†ç¨‹åº</p><p>ä»»ä½•æ¨¡å—å¤–éƒ¨æ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨ï¼ˆä½¿ç”¨ä¸Šé¢ç¤ºä¾‹ä¸­çš„ useGlobalFilters()ï¼‰ä¸èƒ½æ³¨å…¥ä¾èµ–</p><p><strong>è§£å†³æ–¹æ³•</strong>ï¼š</p><p>å¯ä»¥æ³¨å†Œä¸€ä¸ªå…¨å±€èŒƒå›´çš„è¿‡æ»¤å™¨ç›´æ¥ä¸ºä»»ä½•æ¨¡å—è®¾ç½®è¿‡æ»¤å™¨</p><p>app.module.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  app.module.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">APP_FILTER</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/core&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#ABB2BF;">		{</span></span>
<span class="line"><span style="color:#E06C75;">			provide</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">APP_FILTER</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			useClass</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">HttpExceptionFilter</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		},</span></span>
<span class="line"><span style="color:#ABB2BF;">	],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>å½“ä½¿ç”¨æ­¤æ–¹æ³•å¯¹è¿‡æ»¤å™¨æ‰§è¡Œä¾èµ–æ³¨å…¥æ—¶ï¼Œè¯·æ³¨æ„ï¼Œæ— è®ºé‡‡ç”¨å“ªç§ç»“æ„çš„æ¨¡å—ï¼Œè¿‡æ»¤å™¨å®é™…ä¸Šéƒ½æ˜¯å…¨å±€çš„</p><p><strong>åº”è¯¥åœ¨å“ªé‡Œåšï¼Ÿ</strong></p><p>é€‰æ‹©å®šä¹‰äº†è¿‡æ»¤å™¨ï¼ˆä»¥ä¸Šç¤ºä¾‹ä¸­ä¸º HttpExceptionFilterï¼‰çš„æ¨¡å—ã€‚ åŒæ ·ï¼ŒuseClass ä¸æ˜¯å¤„ç†è‡ªå®šä¹‰æä¾›ç¨‹åºæ³¨å†Œçš„å”¯ä¸€æ–¹æ³•ã€‚</p><p>äº†è§£æ›´å¤šï¼šè‡ªå®šä¹‰æä¾›è€…ï¼š<a href="https://docs.nestjs.cn/8/fundamentals?id=%e8%87%aa%e5%ae%9a%e4%b9%89%e6%8f%90%e4%be%9b%e8%80%85" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/fundamentals?id=è‡ªå®šä¹‰æä¾›è€…</a></p><p>æ‚¨å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ä»»æ„æ•°é‡çš„è¿‡æ»¤å™¨;åªéœ€å°†æ¯ä¸ªç»„ä»¶æ·»åŠ åˆ° providersï¼ˆæä¾›è€…ï¼‰æ•°ç»„ã€‚</p><h5 id="æ•è·å¼‚å¸¸" tabindex="-1">æ•è·å¼‚å¸¸ <a class="header-anchor" href="#æ•è·å¼‚å¸¸" aria-label="Permalink to &quot;æ•è·å¼‚å¸¸&quot;">â€‹</a></h5><p>æ•è·æ¯ä¸€ä¸ªæœªå¤„ç†çš„å¼‚å¸¸</p><p>any-exception.filter.ts</p><p>å°† @Catch() è£…é¥°å™¨çš„å‚æ•°åˆ—è¡¨è®¾ä¸ºç©º</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	ExceptionFilter</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Catch</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	ArgumentsHost</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	HttpException</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	HttpStatus</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Catch</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AllExceptionsFilter</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> ExceptionFilter</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	catch</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">exception</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">unknown</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">host</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ArgumentsHost</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> ctx</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> host</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">switchToHttp</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> response</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getResponse</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> request</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getRequest</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> status</span><span style="color:#56B6C2;"> =</span></span>
<span class="line"><span style="color:#E06C75;">			exception</span><span style="color:#C678DD;"> instanceof</span><span style="color:#E5C07B;"> HttpException</span></span>
<span class="line"><span style="color:#C678DD;">				?</span><span style="color:#E5C07B;"> exception</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getStatus</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">				:</span><span style="color:#E5C07B;"> HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">INTERNAL_SERVER_ERROR</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">		response</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">status</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">status</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">json</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">			statusCode</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">status</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			timestamp</span><span style="color:#ABB2BF;">: </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> Date</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">toISOString</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#E06C75;">			path</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">request</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">url</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		});</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œè¿‡æ»¤å™¨å°†æ•è·æŠ›å‡ºçš„æ¯ä¸ªå¼‚å¸¸ï¼Œè€Œä¸ç®¡å…¶ç±»å‹(ç±»)å¦‚ä½•ã€‚</p><h5 id="ç»§æ‰¿" tabindex="-1">ç»§æ‰¿ <a class="header-anchor" href="#ç»§æ‰¿" aria-label="Permalink to &quot;ç»§æ‰¿&quot;">â€‹</a></h5><p>é‡ç”¨å·²ç»å®ç°çš„æ ¸å¿ƒå¼‚å¸¸è¿‡æ»¤å™¨ï¼Œå¹¶åŸºäºæŸäº›å› ç´ é‡å†™è¡Œä¸º</p><h6 id="ç»§æ‰¿ä¾‹å­" tabindex="-1">ç»§æ‰¿ä¾‹å­ <a class="header-anchor" href="#ç»§æ‰¿ä¾‹å­" aria-label="Permalink to &quot;ç»§æ‰¿ä¾‹å­&quot;">â€‹</a></h6><p>ä¸ºäº†å°†å¼‚å¸¸å¤„ç†å§”æ‰˜ç»™åŸºç¡€è¿‡æ»¤å™¨ï¼Œéœ€è¦ç»§æ‰¿ BaseExceptionFilter å¹¶è°ƒç”¨ç»§æ‰¿çš„ catch() æ–¹æ³•ã€‚</p><p>all-exceptions.filter.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// all-exceptions.filter.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Catch</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ArgumentsHost</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">BaseExceptionFilter</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/core&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Catch</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AllExceptionsFilter</span><span style="color:#C678DD;"> extends</span><span style="color:#E5C07B;"> BaseExceptionFilter</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	catch</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">exception</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">unknown</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">host</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ArgumentsHost</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;font-style:italic;">		super</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">catch</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">exception</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">host</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>ç»§æ‰¿è‡ªåŸºç¡€ç±»çš„è¿‡æ»¤å™¨å¿…é¡»ç”±æ¡†æ¶æœ¬èº«å®ä¾‹åŒ–ï¼ˆä¸è¦ä½¿ç”¨ new å…³é”®å­—æ‰‹åŠ¨åˆ›å»ºå®ä¾‹ï¼‰</p></blockquote><h6 id="å…¨å±€è¿‡æ»¤å™¨" tabindex="-1">å…¨å±€è¿‡æ»¤å™¨ <a class="header-anchor" href="#å…¨å±€è¿‡æ»¤å™¨" aria-label="Permalink to &quot;å…¨å±€è¿‡æ»¤å™¨&quot;">â€‹</a></h6><p>å…¨å±€è¿‡æ»¤å™¨å¯ä»¥æ‰©å±•åŸºæœ¬è¿‡æ»¤å™¨ï¼š2 ç§æ–¹æ³•</p><p><strong>1.é€šè¿‡æ³¨å…¥ HttpServer æ¥ä½¿ç”¨ç»§æ‰¿è‡ªåŸºç¡€ç±»</strong>ï¼š</p><p>main.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// main.ts</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> bootstrap</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">	const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">	const</span><span style="color:#ABB2BF;"> { </span><span style="color:#E5C07B;">httpAdapter</span><span style="color:#ABB2BF;"> } </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">HttpAdapterHost</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">	app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">useGlobalFilters</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> AllExceptionsFilter</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">httpAdapter</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">	await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3000</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#61AFEF;">bootstrap</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>2.ä½¿ç”¨ APP_FILTER token ç»‘å®šè¿‡æ»¤å™¨çš„æ–¹æ³•</strong>ï¼š</p><p>æ–‡æ¡£ï¼š<a href="https://docs.nestjs.cn/8/exceptionfilters?id=%e7%bb%91%e5%ae%9a%e8%bf%87%e6%bb%a4%e5%99%a8" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/exceptionfilters?id=ç»‘å®šè¿‡æ»¤å™¨</a></p><p>app.module.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// app.module.ts</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">APP_FILTER</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/core&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#ABB2BF;">		{</span></span>
<span class="line"><span style="color:#E06C75;">			provide</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">APP_FILTER</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			useClass</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">HttpExceptionFilter</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		},</span></span>
<span class="line"><span style="color:#ABB2BF;">	],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="è¿‡æ»¤å™¨çš„ä½¿ç”¨" tabindex="-1">è¿‡æ»¤å™¨çš„ä½¿ç”¨ <a class="header-anchor" href="#è¿‡æ»¤å™¨çš„ä½¿ç”¨" aria-label="Permalink to &quot;è¿‡æ»¤å™¨çš„ä½¿ç”¨&quot;">â€‹</a></h4><h5 id="common-filters-å¼‚å¸¸è¿‡æ»¤å™¨ç›®å½•" tabindex="-1"><code>common/filters</code> å¼‚å¸¸è¿‡æ»¤å™¨ç›®å½• <a class="header-anchor" href="#common-filters-å¼‚å¸¸è¿‡æ»¤å™¨ç›®å½•" aria-label="Permalink to &quot;\`common/filters\` å¼‚å¸¸è¿‡æ»¤å™¨ç›®å½•&quot;">â€‹</a></h5><p>http-exception.filter.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	ArgumentsHost</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Catch</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	ExceptionFilter</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	HttpException</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Catch</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">HttpException</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> HttpExceptionFilter</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> ExceptionFilter</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">HttpException</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#61AFEF;">	catch</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">exception</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">HttpException</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">host</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ArgumentsHost</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> ctx</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> host</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">switchToHttp</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> response</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getResponse</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> request</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getRequest</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> status</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> exception</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getStatus</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">		console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">exception</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> exceptionRes</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">any</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> exception</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getResponse</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#ABB2BF;"> { </span><span style="color:#E5C07B;">error</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">message</span><span style="color:#ABB2BF;"> } </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> exceptionRes</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">		response</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">status</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">status</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">json</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">			status</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			timestamp</span><span style="color:#ABB2BF;">: </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> Date</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">toISOString</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#E06C75;">			path</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">request</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">url</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			error</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			message</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		});</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h5 id="æ¨¡å—ä½¿ç”¨ä¾‹å­-å±€éƒ¨è¿‡æ»¤å™¨" tabindex="-1">æ¨¡å—ä½¿ç”¨ä¾‹å­-å±€éƒ¨è¿‡æ»¤å™¨ <a class="header-anchor" href="#æ¨¡å—ä½¿ç”¨ä¾‹å­-å±€éƒ¨è¿‡æ»¤å™¨" aria-label="Permalink to &quot;æ¨¡å—ä½¿ç”¨ä¾‹å­-å±€éƒ¨è¿‡æ»¤å™¨&quot;">â€‹</a></h5><p>exception/exception.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	Controller</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Get</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Post</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Patch</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Query</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Delete</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Body</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Param</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Headers</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	UseFilters</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	HttpException</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	HttpStatus</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	ParseIntPipe</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">ApiTags</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ApiBearerAuth</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ApiBody</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ApiParam</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/swagger&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">ExceptionService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;./exception.service&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">HttpExceptionFilter</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;../../common/filters/http-exception.filter&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">ApiBearerAuth</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">ApiTags</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;exception&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// @UseFilters(new HttpExceptionFilter())</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Controller</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/exception&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> ExceptionController</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">	constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> readonly</span><span style="color:#E06C75;font-style:italic;"> exceptionService</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ExceptionService</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// æŸ¥è¯¢</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#61AFEF;">	fetch</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Query</span><span style="color:#ABB2BF;">() { </span><span style="color:#E06C75;font-style:italic;">id</span><span style="color:#ABB2BF;"> }, @</span><span style="color:#61AFEF;">Headers</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;token&quot;</span><span style="color:#ABB2BF;">) </span><span style="color:#E06C75;font-style:italic;">token</span><span style="color:#ABB2BF;">): </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">			throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> HttpException</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">				{</span></span>
<span class="line"><span style="color:#E06C75;">					status</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">BAD_REQUEST</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">					message</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;è¯·æ±‚å‚æ•°id å¿…ä¼ &quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">					error</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;id is required&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">				},</span></span>
<span class="line"><span style="color:#E5C07B;">				HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">BAD_REQUEST</span></span>
<span class="line"><span style="color:#ABB2BF;">			);</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">exceptionService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fetch</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// åˆ›å»º</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">ApiBody</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">description</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;å¡«å†™æ›´æ–°å†…å®¹&quot;</span><span style="color:#ABB2BF;"> })</span></span>
<span class="line"><span style="color:#61AFEF;">	save</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() { </span><span style="color:#E06C75;font-style:italic;">message</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">id</span><span style="color:#ABB2BF;"> }): </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">exceptionService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">save</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">message</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// æ›´æ–°</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">Patch</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;:id&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">ApiParam</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">name</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;id&quot;</span><span style="color:#ABB2BF;"> })</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">ApiBody</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">description</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;è¯·è¾“å…¥message&quot;</span><span style="color:#ABB2BF;"> })</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// æœ‰æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å‚æ•°çš„ç±»å‹ä¸ºæ•°å­—ï¼Œåˆ™å¯ä»¥é€šè¿‡ç®¡é“è¿›è¡Œè½¬æ¢</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// !ç°nestè‡ªå¸¦éƒ¨åˆ†ç®¡é“</span></span>
<span class="line"><span style="color:#61AFEF;">	update</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Param</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;id&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ParseIntPipe</span><span style="color:#ABB2BF;">()) </span><span style="color:#E06C75;font-style:italic;">id</span><span style="color:#ABB2BF;">, @</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() { </span><span style="color:#E06C75;font-style:italic;">message</span><span style="color:#ABB2BF;"> }): </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">		console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">typeof</span><span style="color:#E06C75;"> id</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">exceptionService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">update</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">message</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// åˆ é™¤</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">Delete</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#61AFEF;">	remove</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Query</span><span style="color:#ABB2BF;">() { </span><span style="color:#E06C75;font-style:italic;">id</span><span style="color:#ABB2BF;"> }): </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">exceptionService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">remove</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// åˆ¤æ–­æŠ›å‡ºå¼‚å¸¸</span></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">	throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> HttpException</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">		{</span></span>
<span class="line"><span style="color:#E06C75;">			status</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">BAD_REQUEST</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			message</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;è¯·æ±‚å‚æ•°id å¿…ä¼ &quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			error</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;id is required&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		},</span></span>
<span class="line"><span style="color:#E5C07B;">		HttpStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">BAD_REQUEST</span></span>
<span class="line"><span style="color:#ABB2BF;">	);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>æ§åˆ¶å™¨ä¸Šæ–¹ä½¿ç”¨</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">HttpExceptionFilter</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;../../common/filters/http-exception.filter&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UseFilters</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> HttpExceptionFilter</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Controller</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;/exception&#39;</span><span style="color:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å…¨å±€è¿‡æ»¤å™¨ man.tsï¼šç«¯å£ç›‘å¬ä»£ç ä¸Šæ–¹</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">useGlobalFilters</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> HttpExceptionFilter</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">PORTS</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;0.0.0.0&quot;</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="ç®¡é“-pipes" tabindex="-1">ç®¡é“ Pipes <a class="header-anchor" href="#ç®¡é“-pipes" aria-label="Permalink to &quot;ç®¡é“ Pipes&quot;">â€‹</a></h3><h4 id="ä»‹ç»" tabindex="-1">ä»‹ç» <a class="header-anchor" href="#ä»‹ç»" aria-label="Permalink to &quot;ä»‹ç»&quot;">â€‹</a></h4><ul><li>ç®¡é“æ˜¯å…·æœ‰ @Injectable() è£…é¥°å™¨çš„ç±»ã€‚</li><li>ç®¡é“åº”å®ç° PipeTransform æ¥å£</li></ul><h4 id="ä¸¤ä¸ªç±»å‹" tabindex="-1">ä¸¤ä¸ªç±»å‹ <a class="header-anchor" href="#ä¸¤ä¸ªç±»å‹" aria-label="Permalink to &quot;ä¸¤ä¸ªç±»å‹&quot;">â€‹</a></h4><h5 id="ä¸¤ä¸ªä½œç”¨" tabindex="-1">ä¸¤ä¸ªä½œç”¨ <a class="header-anchor" href="#ä¸¤ä¸ªä½œç”¨" aria-label="Permalink to &quot;ä¸¤ä¸ªä½œç”¨&quot;">â€‹</a></h5><ul><li>è½¬æ¢ï¼šç®¡é“å°†è¾“å…¥æ•°æ®è½¬æ¢ä¸ºæ‰€éœ€çš„æ•°æ®è¾“å‡º</li><li>éªŒè¯ï¼šå¯¹è¾“å…¥æ•°æ®è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœéªŒè¯æˆåŠŸç»§ç»­ä¼ é€’; éªŒè¯å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸;</li></ul><h5 id="è§£é‡Š" tabindex="-1">è§£é‡Š <a class="header-anchor" href="#è§£é‡Š" aria-label="Permalink to &quot;è§£é‡Š&quot;">â€‹</a></h5><p>åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹, ç®¡é“ å‚æ•°(arguments) ä¼šç”± æ§åˆ¶å™¨(controllers)çš„è·¯ç”±å¤„ç†ç¨‹åº è¿›è¡Œå¤„ç†ã€‚</p><p>Nest ä¼šåœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹‹å‰æ’å…¥ä¸€ä¸ªç®¡é“ï¼Œç®¡é“ä¼šå…ˆæ‹¦æˆªæ–¹æ³•çš„è°ƒç”¨å‚æ•°,è¿›è¡Œè½¬æ¢æˆ–æ˜¯éªŒè¯å¤„ç†ï¼Œç„¶åç”¨è½¬æ¢å¥½æˆ–æ˜¯éªŒè¯å¥½çš„å‚æ•°è°ƒç”¨åŸæ–¹æ³•ã€‚</p><blockquote><p>ç®¡é“åœ¨å¼‚å¸¸åŒºåŸŸå†…è¿è¡Œã€‚è¿™æ„å‘³ç€å½“æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå®ƒä»¬ç”±æ ¸å¿ƒå¼‚å¸¸å¤„ç†ç¨‹åºå’Œåº”ç”¨äºå½“å‰ä¸Šä¸‹æ–‡çš„ å¼‚å¸¸è¿‡æ»¤å™¨ å¤„ç†ã€‚å½“åœ¨ Pipe ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œcontroller ä¸ä¼šç»§ç»­æ‰§è¡Œä»»ä½•æ–¹æ³•ã€‚</p></blockquote><h4 id="ç®¡é“" tabindex="-1">ç®¡é“ <a class="header-anchor" href="#ç®¡é“" aria-label="Permalink to &quot;ç®¡é“&quot;">â€‹</a></h4><h5 id="å†…ç½®ç®¡é“-nestjs-common-åŒ…ä¸­å¯¼å‡º" tabindex="-1">å†…ç½®ç®¡é“--@nestjs/common åŒ…ä¸­å¯¼å‡º <a class="header-anchor" href="#å†…ç½®ç®¡é“-nestjs-common-åŒ…ä¸­å¯¼å‡º" aria-label="Permalink to &quot;å†…ç½®ç®¡é“--@nestjs/common åŒ…ä¸­å¯¼å‡º&quot;">â€‹</a></h5><h6 id="validationpipe" tabindex="-1">ValidationPipe <a class="header-anchor" href="#validationpipe" aria-label="Permalink to &quot;ValidationPipe&quot;">â€‹</a></h6><p>åªæ¥å—ä¸€ä¸ªå€¼å¹¶ç«‹å³è¿”å›ç›¸åŒçš„å€¼ï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºä¸€ä¸ªæ ‡è¯†å‡½æ•°</p><p>validate.pipe.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  validate.pipe.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">PipeTransform</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Injectable</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ArgumentMetadata</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> ValidationPipe</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> PipeTransform</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	transform</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">value</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">metadata</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ArgumentMetadata</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong><code>PipeTransform&lt;T, R&gt;</code></strong>ï¼š</p><ul><li>æ˜¯ä¸€ä¸ªé€šç”¨æ¥å£</li><li>T è¡¨ç¤º value çš„ç±»å‹</li><li>R è¡¨ç¤º transform() æ–¹æ³•çš„è¿”å›ç±»å‹ã€‚</li></ul><p><strong>æ¯ä¸ªç®¡é“å¿…é¡»æä¾› transform() æ–¹æ³•</strong>ï¼š</p><p>è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li><p>valueï¼šå½“å‰å¤„ç†çš„å‚æ•°</p></li><li><p>metadataï¼šå…ƒæ•°æ®ã€‚å…ƒæ•°æ®å¯¹è±¡åŒ…å«ä¸€äº›å±æ€§ï¼š</p><ul><li><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> interface</span><span style="color:#E5C07B;"> ArgumentMetadata</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;body&quot;</span><span style="color:#ABB2BF;"> | </span><span style="color:#98C379;">&quot;query&quot;</span><span style="color:#ABB2BF;"> | </span><span style="color:#98C379;">&quot;param&quot;</span><span style="color:#ABB2BF;"> | </span><span style="color:#98C379;">&quot;custom&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">	metatype</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Type</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">unknown</span><span style="color:#ABB2BF;">&gt;;</span></span>
<span class="line"><span style="color:#E06C75;">	data</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p>å±æ€§å‚æ•°å’Œæè¿°ï¼š</p><ul><li>typeï¼šå‘Šè¯‰æˆ‘ä»¬è¯¥å±æ€§æ˜¯ä¸€ä¸ª body @Body()ï¼Œquery @Query()ï¼Œparam @Param() è¿˜æ˜¯è‡ªå®šä¹‰å‚æ•°ã€‚é˜…è¯»æ›´å¤šï¼š<a href="https://docs.nestjs.cn/customdecorators" target="_blank" rel="noreferrer">https://docs.nestjs.cn/customdecorators</a></li><li>metatypeï¼šå±æ€§çš„å…ƒç±»å‹ï¼Œä¾‹å¦‚ Stringã€‚ å¦‚æœåœ¨å‡½æ•°ç­¾åä¸­çœç•¥ç±»å‹å£°æ˜ï¼Œæˆ–è€…ä½¿ç”¨åŸç”Ÿ JavaScriptï¼Œåˆ™ä¸º undefinedã€‚</li><li>dataï¼šä¼ é€’ç»™è£…é¥°å™¨çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ @Body(&#39;string&#39;)ã€‚ å¦‚æœæ‚¨å°†æ‹¬å·ç•™ç©ºï¼Œåˆ™ä¸º undefinedã€‚</li></ul></li></ul></li></ul><p>ValidationPipe éœ€è¦åŒæ—¶å®‰è£… class-validator å’Œ class-transformer åŒ…</p><h6 id="parseintpipe" tabindex="-1">ParseIntPipe <a class="header-anchor" href="#parseintpipe" aria-label="Permalink to &quot;ParseIntPipe&quot;">â€‹</a></h6><h6 id="parseboolpipe" tabindex="-1">ParseBoolPipe <a class="header-anchor" href="#parseboolpipe" aria-label="Permalink to &quot;ParseBoolPipe&quot;">â€‹</a></h6><h6 id="parsearraypipe" tabindex="-1">ParseArrayPipe <a class="header-anchor" href="#parsearraypipe" aria-label="Permalink to &quot;ParseArrayPipe&quot;">â€‹</a></h6><h6 id="parseuuidpipe-åˆ†æéªŒè¯å­—ç¬¦ä¸²æ˜¯å¦æ˜¯-uuid" tabindex="-1">ParseUUIDPipeï¼šåˆ†æéªŒè¯å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ UUID <a class="header-anchor" href="#parseuuidpipe-åˆ†æéªŒè¯å­—ç¬¦ä¸²æ˜¯å¦æ˜¯-uuid" aria-label="Permalink to &quot;ParseUUIDPipeï¼šåˆ†æéªŒè¯å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ UUID&quot;">â€‹</a></h6><h6 id="defaultvaluepipe" tabindex="-1">DefaultValuePipe <a class="header-anchor" href="#defaultvaluepipe" aria-label="Permalink to &quot;DefaultValuePipe&quot;">â€‹</a></h6><h6 id="parseenumpipe" tabindex="-1">ParseEnumPipe <a class="header-anchor" href="#parseenumpipe" aria-label="Permalink to &quot;ParseEnumPipe&quot;">â€‹</a></h6><h6 id="parsefloatpipe" tabindex="-1">ParseFloatPipe <a class="header-anchor" href="#parsefloatpipe" aria-label="Permalink to &quot;ParseFloatPipe&quot;">â€‹</a></h6><h5 id="æµ‹è¯•ç”¨ä¾‹" tabindex="-1">æµ‹è¯•ç”¨ä¾‹ <a class="header-anchor" href="#æµ‹è¯•ç”¨ä¾‹" aria-label="Permalink to &quot;æµ‹è¯•ç”¨ä¾‹&quot;">â€‹</a></h5><p>CatsController çš„ create() æ–¹æ³•ï¼š</p><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  cats.controller.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>CreateCatDto å‚æ•°. ç±»å‹ä¸º CreateCatDto:</p><p>create-cat.dto.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  create-cat.dto.ts</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CreateCatDto</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	name</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">	age</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">number</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">	breed</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>è¦ç¡®ä¿ create æ–¹æ³•èƒ½æ­£ç¡®æ‰§è¡Œï¼Œæ‰€ä»¥å¿…é¡»éªŒè¯ CreateCatDto é‡Œçš„ä¸‰ä¸ªå±æ€§</p><h5 id="å¯¹è±¡ç»“æ„éªŒè¯" tabindex="-1">å¯¹è±¡ç»“æ„éªŒè¯ <a class="header-anchor" href="#å¯¹è±¡ç»“æ„éªŒè¯" aria-label="Permalink to &quot;å¯¹è±¡ç»“æ„éªŒè¯&quot;">â€‹</a></h5><p>ä½¿ç”¨åŸºäºç»“æ„çš„éªŒè¯ Joiï¼š<a href="https://github.com/sideway/joi" target="_blank" rel="noreferrer">https://github.com/sideway/joi</a></p><p>Joi åº“æ˜¯å…è®¸æ‚¨ä½¿ç”¨ä¸€ä¸ªå¯è¯»çš„ API ä»¥éå¸¸ç®€å•çš„æ–¹å¼åˆ›å»º schema</p><h6 id="_1-å®‰è£…ä¾èµ–" tabindex="-1">1.å®‰è£…ä¾èµ– <a class="header-anchor" href="#_1-å®‰è£…ä¾èµ–" aria-label="Permalink to &quot;1.å®‰è£…ä¾èµ–&quot;">â€‹</a></h6><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span><span style="color:#D19A66;"> --save</span><span style="color:#98C379;"> @hapi/joi</span></span>
<span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span><span style="color:#D19A66;"> --save-dev</span><span style="color:#98C379;"> @types/hapi__joi</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h6 id="_2-ä½¿ç”¨" tabindex="-1">2.ä½¿ç”¨ <a class="header-anchor" href="#_2-ä½¿ç”¨" aria-label="Permalink to &quot;2.ä½¿ç”¨&quot;">â€‹</a></h6><p>åˆ›å»ºä¸€ä¸ª classï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ä¼ é€’ schema å‚æ•°. ç„¶åæˆ‘ä»¬ä½¿ç”¨ schema.validate() æ–¹æ³•éªŒè¯</p><p>ä¾‹å­</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	PipeTransform</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Injectable</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	ArgumentMetadata</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	BadRequestException</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">ObjectSchema</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@hapi/joi&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> JoiValidationPipe</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> PipeTransform</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">	constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#E06C75;font-style:italic;"> schema</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ObjectSchema</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">	transform</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">value</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">metadata</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ArgumentMetadata</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#ABB2BF;"> { </span><span style="color:#E5C07B;">error</span><span style="color:#ABB2BF;"> } </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">schema</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">validate</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">value</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">		if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">			throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> BadRequestException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Validation failed&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h5 id="ç»‘å®šç®¡é“" tabindex="-1">ç»‘å®šç®¡é“ <a class="header-anchor" href="#ç»‘å®šç®¡é“" aria-label="Permalink to &quot;ç»‘å®šç®¡é“&quot;">â€‹</a></h5><p>ä½¿ç”¨ @UsePipes() è£…é¥°å™¨å¹¶åˆ›å»ºä¸€ä¸ªç®¡é“å®ä¾‹ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ Joi éªŒè¯</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UsePipes</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> JoiValidationPipe</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createCatSchema</span><span style="color:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="ç±»éªŒè¯å™¨" tabindex="-1">ç±»éªŒè¯å™¨ <a class="header-anchor" href="#ç±»éªŒè¯å™¨" aria-label="Permalink to &quot;ç±»éªŒè¯å™¨&quot;">â€‹</a></h5><p><strong>class-transformerTypeScript ç±»éªŒè¯å™¨</strong>ï¼š</p><p>Nest ä¸ class-validator é…åˆï¼š<a href="https://github.com/typestack/class-validator" target="_blank" rel="noreferrer">https://github.com/typestack/class-validator</a></p><p>Nest çš„ Pipe åŠŸèƒ½ç›¸ç»“åˆä½¿ç”¨æ—¶ï¼Œå¯ä»¥é€šè¿‡è®¿é—® metatype ä¿¡æ¯åšå¾ˆå¤šäº‹æƒ…</p><h6 id="_1-å®‰è£…ä¾èµ–-class-transformer" tabindex="-1">1.å®‰è£…ä¾èµ– class-transformer <a class="header-anchor" href="#_1-å®‰è£…ä¾èµ–-class-transformer" aria-label="Permalink to &quot;1.å®‰è£…ä¾èµ– class-transformer&quot;">â€‹</a></h6><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> i</span><span style="color:#D19A66;"> --save</span><span style="color:#98C379;"> class-validator</span><span style="color:#98C379;"> class-transformer</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h6 id="_2-å‘-createcatdto-ç±»æ·»åŠ ä¸€äº›è£…é¥°å™¨" tabindex="-1">2.å‘ CreateCatDto ç±»æ·»åŠ ä¸€äº›è£…é¥°å™¨ <a class="header-anchor" href="#_2-å‘-createcatdto-ç±»æ·»åŠ ä¸€äº›è£…é¥°å™¨" aria-label="Permalink to &quot;2.å‘ CreateCatDto ç±»æ·»åŠ ä¸€äº›è£…é¥°å™¨&quot;">â€‹</a></h6><p>create-cat.dto.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  create-cat.dto.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">IsString</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">IsInt</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;class-validator&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CreateCatDto</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">IsString</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">	name</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">IsInt</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">	age</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">number</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#61AFEF;">IsString</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">	breed</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>è£…é¥°å™¨ä½¿ç”¨ä¿¡æ¯ï¼š<a href="https://github.com/typestack/class-validator#usage" target="_blank" rel="noreferrer">https://github.com/typestack/class-validator#usage</a></p><h6 id="_3-åˆ›å»ºä¸€ä¸ª-validationpipe-ç±»" tabindex="-1">3.åˆ›å»ºä¸€ä¸ª ValidationPipe ç±» <a class="header-anchor" href="#_3-åˆ›å»ºä¸€ä¸ª-validationpipe-ç±»" aria-label="Permalink to &quot;3.åˆ›å»ºä¸€ä¸ª ValidationPipe ç±»&quot;">â€‹</a></h6><p>validate.pipe.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	PipeTransform</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Injectable</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	ArgumentMetadata</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	BadRequestException</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">validate</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;class-validator&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">plainToClass</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;class-transformer&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> ValidationPipe</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> PipeTransform</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	//  transform() å‡½æ•°æ˜¯ å¼‚æ­¥  Nest æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ç®¡é“</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	//  ç”¨è§£æ„èµ‹å€¼ï¼ˆä» ArgumentMetadata ä¸­æå–å‚æ•°ï¼‰</span></span>
<span class="line"><span style="color:#C678DD;">	async</span><span style="color:#61AFEF;"> transform</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">value</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">, { </span><span style="color:#E06C75;font-style:italic;">metatype</span><span style="color:#ABB2BF;"> }: </span><span style="color:#E5C07B;">ArgumentMetadata</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">		//  toValidate() æ–¹æ³•: å½“éªŒè¯ç±»å‹ä¸æ˜¯ JavaScript çš„æ•°æ®ç±»å‹æ—¶</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">		//  è·³è¿‡éªŒè¯</span></span>
<span class="line"><span style="color:#C678DD;">		if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">metatype</span><span style="color:#56B6C2;"> ||</span><span style="color:#56B6C2;"> !</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">toValidate</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">metatype</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#C678DD;">			return</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">		//  ä¸€ä¸ªè¯·æ±‚ä¸­çš„ body æ•°æ®æ˜¯ä¸åŒ…å«ç±»å‹ä¿¡æ¯çš„ï¼ŒClass-validator éœ€è¦ä½¿ç”¨å‰é¢å®šä¹‰è¿‡çš„ DTOï¼Œå°±éœ€è¦åšä¸€ä¸ªç±»å‹è½¬æ¢ã€‚</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">		//  plainToClass() æ–¹æ³•è½¬æ¢ JavaScript çš„å‚æ•°ä¸ºå¯éªŒè¯çš„ç±»å‹å¯¹è±¡</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> object</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> plainToClass</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">metatype</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">value</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">		//  è¦ä¹ˆè¿”å›å€¼ä¸å˜ï¼Œè¦ä¹ˆæŠ›å‡ºå¼‚å¸¸</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> errors</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#61AFEF;"> validate</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">object</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">		if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">errors</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">			throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> BadRequestException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Validation failed&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">	private</span><span style="color:#61AFEF;"> toValidate</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">metatype</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Function</span><span style="color:#ABB2BF;">): </span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#61AFEF;"> types</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Function</span><span style="color:#ABB2BF;">[] </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> [</span><span style="color:#E06C75;">String</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Boolean</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Number</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Array</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Object</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#56B6C2;"> !</span><span style="color:#E5C07B;">types</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">includes</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">metatype</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h6 id="_4-è®¾ç½®-validationpipe" tabindex="-1">4.è®¾ç½® ValidationPipe <a class="header-anchor" href="#_4-è®¾ç½®-validationpipe" aria-label="Permalink to &quot;4.è®¾ç½® ValidationPipe&quot;">â€‹</a></h6><p>ç®¡é“ï¼Œä¸å¼‚å¸¸è¿‡æ»¤å™¨ç›¸åŒï¼Œå®ƒä»¬å¯ä»¥æ˜¯æ–¹æ³•èŒƒå›´çš„ã€æ§åˆ¶å™¨èŒƒå›´çš„å’Œå…¨å±€èŒƒå›´çš„ã€‚</p><p>1.ç®¡é“å¯ä»¥æ˜¯å‚æ•°èŒƒå›´çš„ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ç®¡é“å®ä¾‹ç»‘å®šåˆ°è·¯ç”±å‚æ•°è£…é¥°å™¨ï¼Œä¾‹å¦‚@Body()ã€‚å½“éªŒè¯é€»è¾‘ä»…æ¶‰åŠä¸€ä¸ªæŒ‡å®šçš„å‚æ•°æ—¶ï¼Œå‚æ•°èŒƒå›´çš„ç®¡é“éå¸¸æœ‰ç”¨</p><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  cats.controller.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ValidationPipe</span><span style="color:#ABB2BF;">()) </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2.è¦åœ¨æ–¹æ³•çº§åˆ«è®¾ç½®ç®¡é“ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ UsePipes() è£…é¥°å™¨ã€‚</p><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  cats.controller.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UsePipes</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ValidationPipe</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>@UsePipes() ä¿®é¥°å™¨æ˜¯ä» @nestjs/common åŒ…ä¸­å¯¼å…¥çš„</p><p>3.ç›´æ¥ä¼ å…¥ç±»ï¼ˆè€Œä¸æ˜¯å®ä¾‹ï¼‰ï¼Œè®©æ¡†æ¶æ‰¿æ‹…å®ä¾‹åŒ–è´£ä»»ï¼Œå¹¶å¯ç”¨ä¾èµ–æ³¨å…¥ã€‚</p><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  cats.controller.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UsePipes</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">ValidationPipe</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>4.å°† ValidationPipe è®¾ç½®ä¸ºä¸€ä¸ªå…¨å±€ä½œç”¨åŸŸçš„ç®¡é“ï¼Œç”¨äºæ•´ä¸ªåº”ç”¨ç¨‹åºä¸­çš„æ¯ä¸ªè·¯ç”±å¤„ç†å™¨ã€‚</p><p>main.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  main.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> bootstrap</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">	const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">	app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">useGlobalPipes</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ValidationPipe</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#C678DD;">	await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3000</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#61AFEF;">bootstrap</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>åœ¨ æ··åˆåº”ç”¨ä¸­ useGlobalPipes() æ–¹æ³•ä¸ä¼šä¸ºç½‘å…³å’Œå¾®æœåŠ¡è®¾ç½®ç®¡é“, å¯¹äºæ ‡å‡†(éæ··åˆ) å¾®æœåŠ¡åº”ç”¨ä½¿ç”¨ useGlobalPipes() å…¨å±€è®¾ç½®ç®¡é“ã€‚</p><p>æ··åˆåº”ç”¨ï¼š<a href="https://docs.nestjs.cn/8/faq?id=%e6%b7%b7%e5%90%88%e5%ba%94%e7%94%a8" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/faq?id=æ··åˆåº”ç”¨</a></p><h6 id="_5-æ„é€ ç›´æ¥ä¸ºä»»ä½•æ¨¡å—è®¾ç½®ç®¡é“" tabindex="-1">5.æ„é€ ç›´æ¥ä¸ºä»»ä½•æ¨¡å—è®¾ç½®ç®¡é“ <a class="header-anchor" href="#_5-æ„é€ ç›´æ¥ä¸ºä»»ä½•æ¨¡å—è®¾ç½®ç®¡é“" aria-label="Permalink to &quot;5.æ„é€ ç›´æ¥ä¸ºä»»ä½•æ¨¡å—è®¾ç½®ç®¡é“&quot;">â€‹</a></h6><p>app.module.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  app.module.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">APP_PIPE</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/core&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#ABB2BF;">		{</span></span>
<span class="line"><span style="color:#E06C75;">			provide</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">APP_PIPE</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			useClass</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">ValidationPipe</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		},</span></span>
<span class="line"><span style="color:#ABB2BF;">	],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>è¯·æ³¨æ„ä½¿ç”¨ä¸Šè¿°æ–¹å¼ä¾èµ–æ³¨å…¥æ—¶ï¼Œè¯·ç‰¢è®°æ— è®ºä½ é‡‡ç”¨é‚£ç§ç»“æ„æ¨¡å—ç®¡é“éƒ½æ˜¯å…¨å±€çš„.</p><p>ä½¿ç”¨ ValidationPipe å®šä¹‰ç®¡é“ å¦å¤–ï¼ŒuseClass å¹¶ä¸æ˜¯å¤„ç†è‡ªå®šä¹‰æä¾›è€…æ³¨å†Œçš„å”¯ä¸€æ–¹æ³•</p><ul><li>å…¶ä»–æ–¹æ³•ï¼š<a href="https://docs.nestjs.cn/8/fundamentals?id=custom-providers" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/fundamentals?id=custom-providers</a></li></ul><h6 id="class-transformer-åº“-å®ƒå’Œ-class-validator-åº“ç”±åŒä¸€ä¸ªä½œè€…å¼€å‘-æ‰€ä»¥ä»–ä»¬é…åˆçš„å¾ˆå¥½" tabindex="-1">class-transformer åº“ï¼Œå®ƒå’Œ class-validator åº“ç”±åŒä¸€ä¸ªä½œè€…å¼€å‘ï¼Œæ‰€ä»¥ä»–ä»¬é…åˆçš„å¾ˆå¥½ <a class="header-anchor" href="#class-transformer-åº“-å®ƒå’Œ-class-validator-åº“ç”±åŒä¸€ä¸ªä½œè€…å¼€å‘-æ‰€ä»¥ä»–ä»¬é…åˆçš„å¾ˆå¥½" aria-label="Permalink to &quot;class-transformer åº“ï¼Œå®ƒå’Œ class-validator åº“ç”±åŒä¸€ä¸ªä½œè€…å¼€å‘ï¼Œæ‰€ä»¥ä»–ä»¬é…åˆçš„å¾ˆå¥½&quot;">â€‹</a></h6><ul><li>class-transformerï¼š<a href="https://github.com/typestack/class-transformer" target="_blank" rel="noreferrer">https://github.com/typestack/class-transformer</a></li><li>class-validatorï¼š<a href="https://github.com/typestack/class-validator" target="_blank" rel="noreferrer">https://github.com/typestack/class-validator</a></li></ul><h5 id="è½¬æ¢ç®¡é“" tabindex="-1">è½¬æ¢ç®¡é“ <a class="header-anchor" href="#è½¬æ¢ç®¡é“" aria-label="Permalink to &quot;è½¬æ¢ç®¡é“&quot;">â€‹</a></h5><h6 id="ä½œç”¨" tabindex="-1">ä½œç”¨ <a class="header-anchor" href="#ä½œç”¨" aria-label="Permalink to &quot;ä½œç”¨&quot;">â€‹</a></h6><ul><li>è½¬æ¢ç®¡é“è¢«æ’å…¥åœ¨å®¢æˆ·ç«¯è¯·æ±‚å’Œè¯·æ±‚å¤„ç†ç¨‹åºä¹‹é—´ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li><li>å°†è¾“å…¥æ•°æ®è½¬æ¢ä¸ºæ‰€éœ€çš„è¾“å‡º</li></ul><h6 id="åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨" tabindex="-1">åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Ÿ <a class="header-anchor" href="#åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨" aria-label="Permalink to &quot;åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Ÿ&quot;">â€‹</a></h6><ul><li>ä»å®¢æˆ·ç«¯ä¼ æ¥çš„æ•°æ®éœ€è¦ç»è¿‡ä¸€äº›ä¿®æ”¹ï¼ˆä¾‹å¦‚å­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•´æ•°ï¼‰ï¼Œç„¶åå¤„ç†å‡½æ•°æ‰èƒ½æ­£ç¡®çš„å¤„ç†</li><li>æœ‰äº›æ•°æ®å…·æœ‰é»˜è®¤å€¼ï¼Œç”¨æˆ·ä¸å¿…ä¼ é€’å¸¦é»˜è®¤å€¼å‚æ•°ï¼Œä¸€æ—¦ç”¨æˆ·ä¸ä¼ å°±ä½¿ç”¨é»˜è®¤å€¼ã€‚</li></ul><h6 id="ä¾‹å­" tabindex="-1">ä¾‹å­ <a class="header-anchor" href="#ä¾‹å­" aria-label="Permalink to &quot;ä¾‹å­&quot;">â€‹</a></h6><p>parse-int.pipe.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">	PipeTransform</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	Injectable</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	ArgumentMetadata</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	BadRequestException</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> ParseIntPipe</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> PipeTransform</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">number</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#61AFEF;">	transform</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">value</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">metadata</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ArgumentMetadata</span><span style="color:#ABB2BF;">): </span><span style="color:#E5C07B;">number</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> val</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> parseInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">value</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">		if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">isNaN</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">val</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#C678DD;">			throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> BadRequestException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Validation failed&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E06C75;"> val</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>ä½¿ç”¨é…ç½®ç®¡é“æ¥å¤„ç†æ‰€å‚æ•° id:</p><p>new ParseIntPipe()</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;:id&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findOne</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Param</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;id&#39;</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ParseIntPipe</span><span style="color:#ABB2BF;">()) </span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">findOne</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æŒ‰ ID ä»æ•°æ®åº“ä¸­é€‰æ‹©ä¸€ä¸ªç°æœ‰çš„ç”¨æˆ·å®ä½“ï¼šUserByIdPipe</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;:id&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;">findOne</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Param</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;id&#39;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">UserByIdPipe</span><span style="color:#ABB2BF;">) </span><span style="color:#E06C75;">userEntity</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">UserEntity</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#E06C75;"> userEntity</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ParseUUIDPipe ç®¡é“ï¼š</p><p>åˆ†æéªŒè¯å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ UUID</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;:id&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findOne</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Param</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;id&#39;</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ParseUUIDPipe</span><span style="color:#ABB2BF;">()) </span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">findOne</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ParseUUIDPipe ä¼šä½¿ç”¨ UUID 3,4,5 ç‰ˆæœ¬ æ¥è§£æå­—ç¬¦ä¸², ä½ ä¹Ÿå¯ä»¥å•ç‹¬è®¾ç½®éœ€è¦çš„ç‰ˆæœ¬.</p><h3 id="å®ˆå«-guards" tabindex="-1">å®ˆå« Guards <a class="header-anchor" href="#å®ˆå«-guards" aria-label="Permalink to &quot;å®ˆå« Guards&quot;">â€‹</a></h3><p>æ ¹æ®è¿è¡Œæ—¶å‡ºç°çš„æŸäº›æ¡ä»¶ï¼ˆä¾‹å¦‚æƒé™ï¼Œè§’è‰²ï¼Œè®¿é—®æ§åˆ¶åˆ—è¡¨ç­‰ï¼‰æ¥ç¡®å®šç»™å®šçš„è¯·æ±‚æ˜¯å¦ç”±è·¯ç”±å¤„ç†ç¨‹åºå¤„ç†ã€‚è¿™é€šå¸¸ç§°ä¸ºæˆæƒã€‚</p><h4 id="å®ˆå«-guards-ä»‹ç»" tabindex="-1">å®ˆå« Guards ä»‹ç» <a class="header-anchor" href="#å®ˆå«-guards-ä»‹ç»" aria-label="Permalink to &quot;å®ˆå« Guards ä»‹ç»&quot;">â€‹</a></h4><ul><li>å®ˆå«æ˜¯ä¸€ä¸ªä½¿ç”¨ @Injectable() è£…é¥°å™¨çš„ç±»ã€‚</li><li>å®ˆå«åº”è¯¥å®ç° CanActivate æ¥å£ã€‚</li><li>å®ˆå«åœ¨æ¯ä¸ªä¸­é—´ä»¶ä¹‹åæ‰§è¡Œï¼Œä½†åœ¨ä»»ä½•æ‹¦æˆªå™¨æˆ–ç®¡é“ä¹‹å‰æ‰§è¡Œã€‚</li></ul><h4 id="ç« èŠ‚" tabindex="-1">ç« èŠ‚ <a class="header-anchor" href="#ç« èŠ‚" aria-label="Permalink to &quot;ç« èŠ‚&quot;">â€‹</a></h4><h5 id="æˆæƒå®ˆå«" tabindex="-1">æˆæƒå®ˆå« <a class="header-anchor" href="#æˆæƒå®ˆå«" aria-label="Permalink to &quot;æˆæƒå®ˆå«&quot;">â€‹</a></h5><p>ç°åœ¨è¦æ„å»ºçš„ AuthGuard å‡è®¾ç”¨æˆ·æ˜¯ç»è¿‡èº«ä»½éªŒè¯çš„(å› æ­¤ï¼Œè¯·æ±‚å¤´é™„åŠ äº†ä¸€ä¸ª token)ã€‚å®ƒå°†æå–å’ŒéªŒè¯ tokenï¼Œå¹¶ä½¿ç”¨æå–çš„ä¿¡æ¯æ¥ç¡®å®šè¯·æ±‚æ˜¯å¦å¯ä»¥ç»§ç»­ã€‚</p><p>ä¾‹å­</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Injectable</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">CanActivate</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ExecutionContext</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Observable</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;rxjs&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//  ä¿æŠ¤å¦‚ä½•é€‚åº”è¯·æ±‚/å“åº”å‘¨æœŸã€‚</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AuthGuard</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> CanActivate</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	canActivate</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#E06C75;font-style:italic;">		context</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ExecutionContext</span></span>
<span class="line"><span style="color:#ABB2BF;">	): </span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;"> | </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;">&gt; | </span><span style="color:#E5C07B;">Observable</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> request</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">switchToHttp</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getRequest</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#61AFEF;"> validateRequest</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">request</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>æ¯ä¸ªå®ˆå«å¿…é¡»å®ç°ä¸€ä¸ª canActivate()å‡½æ•°ã€‚æ­¤å‡½æ•°åº”è¯¥è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦å…è®¸å½“å‰è¯·æ±‚ã€‚å®ƒå¯ä»¥åŒæ­¥æˆ–å¼‚æ­¥åœ°è¿”å›å“åº”(é€šè¿‡ Promise æˆ– Observable)ã€‚Nest ä½¿ç”¨è¿”å›å€¼æ¥æ§åˆ¶ä¸‹ä¸€ä¸ªè¡Œä¸º:</p><ul><li>å¦‚æœè¿”å› true, å°†å¤„ç†ç”¨æˆ·è°ƒç”¨ã€‚</li><li>å¦‚æœè¿”å› false, åˆ™ Nest å°†å¿½ç•¥å½“å‰å¤„ç†çš„è¯·æ±‚ã€‚</li></ul><h5 id="æ‰§è¡Œä¸Šä¸‹æ–‡" tabindex="-1">æ‰§è¡Œä¸Šä¸‹æ–‡ <a class="header-anchor" href="#æ‰§è¡Œä¸Šä¸‹æ–‡" aria-label="Permalink to &quot;æ‰§è¡Œä¸Šä¸‹æ–‡&quot;">â€‹</a></h5><p>ExecutionContext æ‰§è¡Œä¸Šä¸‹æ–‡ ç»§æ‰¿è‡ª ArgumentsHost ã€‚</p><p>ArgumentsHost æ˜¯ä¼ é€’ç»™åŸå§‹å¤„ç†ç¨‹åºçš„å‚æ•°çš„åŒ…è£…å™¨</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> interface</span><span style="color:#E5C07B;"> ExecutionContext</span><span style="color:#C678DD;"> extends</span><span style="color:#E5C07B;"> ArgumentsHost</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	getClass</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">T</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> any</span><span style="color:#ABB2BF;">&gt;(): </span><span style="color:#E5C07B;">Type</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">T</span><span style="color:#ABB2BF;">&gt;;</span></span>
<span class="line"><span style="color:#61AFEF;">	getHandler</span><span style="color:#ABB2BF;">(): </span><span style="color:#E5C07B;">Function</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>getHandler()æ–¹æ³•è¿”å›å¯¹å°†è¦è°ƒç”¨çš„å¤„ç†ç¨‹åºçš„å¼•ç”¨</p><p>etClass()æ–¹æ³•è¿”å›è¿™ä¸ªç‰¹å®šå¤„ç†ç¨‹åºæ‰€å±çš„ Controller ç±»çš„ç±»å‹</p><p>å¦‚æœå½“å‰å¤„ç†çš„è¯·æ±‚æ˜¯ POST è¯·æ±‚ï¼Œç›®æ ‡æ˜¯ CatsController ä¸Šçš„ create() æ–¹æ³•ï¼Œé‚£ä¹ˆ getHandler() å°†è¿”å›å¯¹ create() æ–¹æ³•çš„å¼•ç”¨ï¼Œè€Œ getClass()å°†è¿”å›ä¸€ä¸ª CatsControllertype(è€Œä¸æ˜¯å®ä¾‹)</p><h5 id="åŸºäºè§’è‰²è®¤è¯" tabindex="-1">åŸºäºè§’è‰²è®¤è¯ <a class="header-anchor" href="#åŸºäºè§’è‰²è®¤è¯" aria-label="Permalink to &quot;åŸºäºè§’è‰²è®¤è¯&quot;">â€‹</a></h5><p>åªå…è®¸å…·æœ‰ç‰¹å®šè§’è‰²çš„ç”¨æˆ·è®¿é—®</p><p>roles.guard.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Injectable</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">CanActivate</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ExecutionContext</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Observable</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;rxjs&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> RolesGuard</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> CanActivate</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	canActivate</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#E06C75;font-style:italic;">		context</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ExecutionContext</span></span>
<span class="line"><span style="color:#ABB2BF;">	): </span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;"> | </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;">&gt; | </span><span style="color:#E5C07B;">Observable</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="ç»‘å®šå®ˆå«" tabindex="-1">ç»‘å®šå®ˆå« <a class="header-anchor" href="#ç»‘å®šå®ˆå«" aria-label="Permalink to &quot;ç»‘å®šå®ˆå«&quot;">â€‹</a></h5><p>å®ˆå«å¯ä»¥æ˜¯æ§åˆ¶èŒƒå›´çš„ï¼šæ–¹æ³•èŒƒå›´æˆ–å…¨å±€èŒƒå›´çš„</p><h6 id="_1-ä½¿ç”¨-useguards-è£…é¥°å™¨è®¾ç½®ä¸€ä¸ªæ§åˆ¶å™¨èŒƒå›´çš„å®ˆå«" tabindex="-1">1.ä½¿ç”¨ @UseGuards()è£…é¥°å™¨è®¾ç½®ä¸€ä¸ªæ§åˆ¶å™¨èŒƒå›´çš„å®ˆå« <a class="header-anchor" href="#_1-ä½¿ç”¨-useguards-è£…é¥°å™¨è®¾ç½®ä¸€ä¸ªæ§åˆ¶å™¨èŒƒå›´çš„å®ˆå«" aria-label="Permalink to &quot;1.ä½¿ç”¨ @UseGuards()è£…é¥°å™¨è®¾ç½®ä¸€ä¸ªæ§åˆ¶å™¨èŒƒå›´çš„å®ˆå«&quot;">â€‹</a></h6><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 111</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Controller</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;cats&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//  ä¼ é€’äº† RolesGuard ç±»å‹</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UseGuards</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">RolesGuard</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CatsController</span><span style="color:#ABB2BF;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 222</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UseGuards</span><span style="color:#ABB2BF;">() </span><span style="color:#7F848E;font-style:italic;">// è£…é¥°å™¨éœ€è¦ä» @nestjs/common åŒ…å¯¼å…¥ã€‚</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 333</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Controller</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;cats&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//  ä¼ é€’äº† RolesGuard å®ä¾‹</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">UseGuards</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> RolesGuard</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> CatsController</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h6 id="_2-æ–¹æ³•çº§åˆ«è®¾ç½®å…¨å±€å®ˆå«" tabindex="-1">2.æ–¹æ³•çº§åˆ«è®¾ç½®å…¨å±€å®ˆå« <a class="header-anchor" href="#_2-æ–¹æ³•çº§åˆ«è®¾ç½®å…¨å±€å®ˆå«" aria-label="Permalink to &quot;2.æ–¹æ³•çº§åˆ«è®¾ç½®å…¨å±€å®ˆå«&quot;">â€‹</a></h6><p>ä¸ºäº†ç»‘å®šå…¨å±€å®ˆå«, æˆ‘ä»¬ä½¿ç”¨ Nest åº”ç”¨ç¨‹åºå®ä¾‹çš„ useGlobalGuards() æ–¹æ³•:</p><p>main.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  main.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">useGlobalGuards</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> RolesGuard</span><span style="color:#ABB2BF;">());</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å¯¹äºæ··åˆåº”ç”¨ç¨‹åºï¼ŒuseGlobalGuards() æ–¹æ³•ä¸ä¼šä¸ºç½‘å…³å’Œå¾®æœåŠ¡è®¾ç½®å®ˆå«ã€‚å¯¹äºâ€œæ ‡å‡†â€(éæ··åˆ)å¾®æœåŠ¡åº”ç”¨ç¨‹åºï¼ŒuseGlobalGuards()åœ¨å…¨å±€å®‰è£…å®ˆå«ã€‚</p><h6 id="_3-ä»ä»»ä½•æ¨¡å—è®¾ç½®ä¸€ä¸ªå®ˆå«" tabindex="-1">3.ä»ä»»ä½•æ¨¡å—è®¾ç½®ä¸€ä¸ªå®ˆå« <a class="header-anchor" href="#_3-ä»ä»»ä½•æ¨¡å—è®¾ç½®ä¸€ä¸ªå®ˆå«" aria-label="Permalink to &quot;3.ä»ä»»ä½•æ¨¡å—è®¾ç½®ä¸€ä¸ªå®ˆå«&quot;">â€‹</a></h6><p>app.module.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  app.module.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">APP_GUARD</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/core&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">	providers</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#ABB2BF;">		{</span></span>
<span class="line"><span style="color:#E06C75;">			provide</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">APP_GUARD</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			useClass</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">RolesGuard</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		},</span></span>
<span class="line"><span style="color:#ABB2BF;">	],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>å½“ä½¿ç”¨æ­¤æ–¹æ³•ä¸ºå®ˆå«ç¨‹åºæ‰§è¡Œä¾èµ–é¡¹æ³¨å…¥æ—¶ï¼Œè¯·æ³¨æ„ï¼Œæ— è®ºä½¿ç”¨æ­¤æ„é€ çš„æ¨¡å—æ˜¯ä»€ä¹ˆï¼Œå®ˆå«ç¨‹åºå®é™…ä¸Šæ˜¯å…¨å±€çš„ã€‚ é€‰æ‹©å®šä¹‰å®ˆå«çš„æ¨¡å—åœ¨â€œåŸºäºè§’è‰²è®¤è¯â€çš„ç« èŠ‚ RolesGuard æ¨¡å—çš„å®šä¹‰ã€‚</p><p>useClass ä¸æ˜¯å¤„ç†è‡ªå®šä¹‰ providers æ³¨å†Œçš„å”¯ä¸€æ–¹æ³•ã€‚äº†è§£æ›´å¤šï¼š<a href="https://docs.nestjs.cn/8/fundamentals?id=%e8%87%aa%e5%ae%9a%e4%b9%89providercustomer-provider" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/fundamentals?id=è‡ªå®šä¹‰providercustomer-provider</a></p><h5 id="åå°„å™¨-è£…é¥°å™¨" tabindex="-1">åå°„å™¨(è£…é¥°å™¨) <a class="header-anchor" href="#åå°„å™¨-è£…é¥°å™¨" aria-label="Permalink to &quot;åå°„å™¨(è£…é¥°å™¨)&quot;">â€‹</a></h5><h6 id="è‡ªå®šä¹‰å…ƒæ•°æ®" tabindex="-1">è‡ªå®šä¹‰å…ƒæ•°æ® <a class="header-anchor" href="#è‡ªå®šä¹‰å…ƒæ•°æ®" aria-label="Permalink to &quot;è‡ªå®šä¹‰å…ƒæ•°æ®&quot;">â€‹</a></h6><ul><li>çµæ´»å’Œå¯é‡ç”¨çš„æ–¹å¼å°†è§’è‰²ä¸è·¯ç”±åŒ¹é…</li><li>1.Nest æä¾›äº†é€šè¿‡ @SetMetadata() è£…é¥°å™¨å°†å®šåˆ¶å…ƒæ•°æ®é™„åŠ åˆ°è·¯ç”±å¤„ç†ç¨‹åºçš„èƒ½åŠ›ã€‚</li><li>2.è¿™äº›å…ƒæ•°æ®æä¾›äº†æˆ‘ä»¬æ‰€ç¼ºå°‘çš„è§’è‰²æ•°æ®ï¼Œè€Œå®ˆå«éœ€è¦è¿™äº›æ•°æ®æ¥åšå‡ºå†³ç­–</li></ul><h6 id="_1-æ§åˆ¶å™¨è‡ªå®šä¹‰å…ƒæ•°æ®-setmetadata" tabindex="-1">1.æ§åˆ¶å™¨è‡ªå®šä¹‰å…ƒæ•°æ®@SetMetadata() <a class="header-anchor" href="#_1-æ§åˆ¶å™¨è‡ªå®šä¹‰å…ƒæ•°æ®-setmetadata" aria-label="Permalink to &quot;1.æ§åˆ¶å™¨è‡ªå®šä¹‰å…ƒæ•°æ®@SetMetadata()&quot;">â€‹</a></h6><p>@SetMetadata() è£…é¥°å™¨éœ€è¦ä» @nestjs/common åŒ…å¯¼å…¥ã€‚</p><p>cats.controller.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  cats.controller.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">SetMetadata</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;roles&#39;</span><span style="color:#ABB2BF;">, [</span><span style="color:#98C379;">&#39;admin&#39;</span><span style="color:#ABB2BF;">])</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>å°† roles å…ƒæ•°æ®(roles æ˜¯ä¸€ä¸ªé”®ï¼Œè€Œ [&#39;admin&#39;] æ˜¯ä¸€ä¸ªç‰¹å®šçš„å€¼)é™„åŠ åˆ° create() æ–¹æ³•</p><h6 id="_2-åˆ›å»ºè‡ªå·±çš„è£…é¥°å™¨" tabindex="-1">2.åˆ›å»ºè‡ªå·±çš„è£…é¥°å™¨ <a class="header-anchor" href="#_2-åˆ›å»ºè‡ªå·±çš„è£…é¥°å™¨" aria-label="Permalink to &quot;2.åˆ›å»ºè‡ªå·±çš„è£…é¥°å™¨&quot;">â€‹</a></h6><p>roles.decorator.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  roles.decorator.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">SetMetadata</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> const</span><span style="color:#61AFEF;"> Roles</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> (...</span><span style="color:#E06C75;font-style:italic;">roles</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">[]) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#61AFEF;"> SetMetadata</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;roles&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">roles</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h6 id="_3-æ§åˆ¶å™¨å†…ä½¿ç”¨è£…é¥°å™¨" tabindex="-1">3.æ§åˆ¶å™¨å†…ä½¿ç”¨è£…é¥°å™¨ <a class="header-anchor" href="#_3-æ§åˆ¶å™¨å†…ä½¿ç”¨è£…é¥°å™¨" aria-label="Permalink to &quot;3.æ§åˆ¶å™¨å†…ä½¿ç”¨è£…é¥°å™¨&quot;">â€‹</a></h6><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Post</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Roles</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;admin&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> create</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">Body</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">CreateCatDto</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">catsService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">createCatDto</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h6 id="_4-rolesguard-å®ˆå«" tabindex="-1">4.RolesGuard å®ˆå« <a class="header-anchor" href="#_4-rolesguard-å®ˆå«" aria-label="Permalink to &quot;4.RolesGuard å®ˆå«&quot;">â€‹</a></h6><p>roles.guard.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Injectable</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">CanActivate</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ExecutionContext</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Reflector</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/core&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> RolesGuard</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> CanActivate</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">	constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#E06C75;font-style:italic;"> reflector</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Reflector</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">	canActivate</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">context</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ExecutionContext</span><span style="color:#ABB2BF;">): </span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> roles</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">reflector</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">[]&gt;(</span><span style="color:#98C379;">&quot;roles&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getHandler</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#C678DD;">		if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">roles</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">			return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> request</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">switchToHttp</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getRequest</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">		//  request.user åŒ…å«ç”¨æˆ·å®ä¾‹å’Œå…è®¸çš„è§’è‰²</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> user</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> request</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">user</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#61AFEF;"> matchRoles</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">roles</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">user</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">roles</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>å½“ç”¨æˆ·å°è¯•åœ¨æ²¡æœ‰è¶³å¤Ÿæƒé™çš„æƒ…å†µä¸‹è°ƒç”¨ /cats POST ç«¯ç‚¹æ—¶ï¼ŒNest ä¼šè‡ªåŠ¨è¿”å›ä»¥ä¸‹å“åº”ï¼š</p><p>å½“ç‰¹æƒä¸è¶³çš„ç”¨æˆ·è¯·æ±‚ç«¯ç‚¹æ—¶ï¼ŒNest è‡ªåŠ¨è¿”å›ä»¥ä¸‹å“åº”ï¼š</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;statusCode&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">403</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;message&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;Forbidden resource&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿”å› false çš„å®ˆå«ä¼šæŠ›å‡ºä¸€ä¸ª HttpException å¼‚å¸¸ã€‚å¦‚æœæ‚¨æƒ³è¦å‘æœ€ç»ˆç”¨æˆ·è¿”å›ä¸åŒçš„é”™è¯¯å“åº”ï¼Œä½ åº”è¯¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> UnauthorizedException</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>ç”±å®ˆå«å¼•å‘çš„ä»»ä½•å¼‚å¸¸éƒ½å°†ç”±å¼‚å¸¸å±‚(å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨å’Œåº”ç”¨äºå½“å‰ä¸Šä¸‹æ–‡çš„ä»»ä½•å¼‚å¸¸è¿‡æ»¤å™¨)å¤„ç†ã€‚</p><h3 id="æ‹¦æˆªå™¨-interceptors" tabindex="-1">æ‹¦æˆªå™¨ Interceptors <a class="header-anchor" href="#æ‹¦æˆªå™¨-interceptors" aria-label="Permalink to &quot;æ‹¦æˆªå™¨ Interceptors&quot;">â€‹</a></h3><h4 id="åŠŸèƒ½" tabindex="-1">åŠŸèƒ½ <a class="header-anchor" href="#åŠŸèƒ½" aria-label="Permalink to &quot;åŠŸèƒ½&quot;">â€‹</a></h4><ul><li>åœ¨å‡½æ•°æ‰§è¡Œä¹‹å‰/ä¹‹åç»‘å®šé¢å¤–çš„é€»è¾‘</li><li>è½¬æ¢ä»å‡½æ•°è¿”å›çš„ç»“æœ</li><li>è½¬æ¢ä»å‡½æ•°æŠ›å‡ºçš„å¼‚å¸¸</li><li>æ‰©å±•åŸºæœ¬å‡½æ•°è¡Œä¸º</li><li>æ ¹æ®æ‰€é€‰æ¡ä»¶å®Œå…¨é‡å†™å‡½æ•° (ä¾‹å¦‚, ç¼“å­˜ç›®çš„)</li></ul><h3 id="è‡ªå®šä¹‰è£…é¥°å™¨-custom-route-decorators" tabindex="-1">è‡ªå®šä¹‰è£…é¥°å™¨ Custom route decorators <a class="header-anchor" href="#è‡ªå®šä¹‰è£…é¥°å™¨-custom-route-decorators" aria-label="Permalink to &quot;è‡ªå®šä¹‰è£…é¥°å™¨ Custom route decorators&quot;">â€‹</a></h3><h4 id="æ¦‚å¿µ-1" tabindex="-1">æ¦‚å¿µ <a class="header-anchor" href="#æ¦‚å¿µ-1" aria-label="Permalink to &quot;æ¦‚å¿µ&quot;">â€‹</a></h4><ul><li>Nest æ˜¯åŸºäºè£…é¥°å™¨è¿™ç§è¯­è¨€ç‰¹æ€§è€Œåˆ›å»ºçš„</li><li>ES2016 è£…é¥°å™¨æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå®ƒè¿”å›ä¸€ä¸ªå¯ä»¥å°†ç›®æ ‡ã€åç§°å’Œå±æ€§æè¿°ç¬¦ä½œä¸ºå‚æ•°çš„å‡½æ•°</li><li>é€šè¿‡åœ¨è£…é¥°å™¨å‰é¢æ·»åŠ ä¸€ä¸ª @ å­—ç¬¦å¹¶å°†å…¶æ”¾ç½®åœ¨ä½ è¦è£…é¥°çš„å†…å®¹çš„æœ€é¡¶éƒ¨æ¥åº”ç”¨å®ƒã€‚å¯ä»¥ä¸ºç±»ã€æ–¹æ³•æˆ–å±æ€§å®šä¹‰è£…é¥°å™¨ã€‚</li></ul><h4 id="_1-è‡ªå®šä¹‰è£…é¥°å™¨" tabindex="-1">1.è‡ªå®šä¹‰è£…é¥°å™¨ <a class="header-anchor" href="#_1-è‡ªå®šä¹‰è£…é¥°å™¨" aria-label="Permalink to &quot;1.è‡ªå®šä¹‰è£…é¥°å™¨&quot;">â€‹</a></h4><p>åˆ›å»ºä¸€ä¸ª @User() è£…é¥°å™¨å¹¶åœ¨æ‰€æœ‰æ§åˆ¶å™¨ä¸­ä½¿ç”¨å®ƒ</p><h5 id="_1-åˆ›å»ºè£…é¥°å™¨" tabindex="-1">1.åˆ›å»ºè£…é¥°å™¨ <a class="header-anchor" href="#_1-åˆ›å»ºè£…é¥°å™¨" aria-label="Permalink to &quot;1.åˆ›å»ºè£…é¥°å™¨&quot;">â€‹</a></h5><p>user.decorator.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  user.decorator.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">createParamDecorator</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ExecutionContext</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> const</span><span style="color:#E5C07B;"> User</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> createParamDecorator</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">	(</span><span style="color:#E06C75;font-style:italic;">data</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">unknown</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">ctx</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ExecutionContext</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> request</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">switchToHttp</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getRequest</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E5C07B;"> request</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">user</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h5 id="_2-æ§åˆ¶å™¨å†…ä½¿ç”¨" tabindex="-1">2.æ§åˆ¶å™¨å†…ä½¿ç”¨ <a class="header-anchor" href="#_2-æ§åˆ¶å™¨å†…ä½¿ç”¨" aria-label="Permalink to &quot;2.æ§åˆ¶å™¨å†…ä½¿ç”¨&quot;">â€‹</a></h5><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findOne</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">User</span><span style="color:#ABB2BF;">() </span><span style="color:#E06C75;">user</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">UserEntity</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">user</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_2-ä¼ é€’æ•°æ®" tabindex="-1">2.ä¼ é€’æ•°æ® <a class="header-anchor" href="#_2-ä¼ é€’æ•°æ®" aria-label="Permalink to &quot;2.ä¼ é€’æ•°æ®&quot;">â€‹</a></h4><h5 id="ç±»ä¼¼æ•°æ®" tabindex="-1">ç±»ä¼¼æ•°æ® <a class="header-anchor" href="#ç±»ä¼¼æ•°æ®" aria-label="Permalink to &quot;ç±»ä¼¼æ•°æ®&quot;">â€‹</a></h5><p>ä½¿ç”¨ data å‚æ•°å°†å‚æ•°ä¼ é€’ç»™è£…é¥°å™¨çš„å·¥å‚å‡½æ•°</p><p>èº«ä»½éªŒè¯çš„è¯·æ±‚çš„ç”¨æˆ·å®ä½“å¯èƒ½ç±»ä¼¼äº</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;id&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">101</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;firstName&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;Alan&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;lastName&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;Turing&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;email&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;alan@email.com&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;roles&quot;</span><span style="color:#ABB2BF;">: [</span><span style="color:#98C379;">&quot;admin&quot;</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="_1-å®šä¹‰ä¸€ä¸ªå°†å±æ€§åä½œä¸ºé”®çš„è£…é¥°å™¨" tabindex="-1">1.å®šä¹‰ä¸€ä¸ªå°†å±æ€§åä½œä¸ºé”®çš„è£…é¥°å™¨ <a class="header-anchor" href="#_1-å®šä¹‰ä¸€ä¸ªå°†å±æ€§åä½œä¸ºé”®çš„è£…é¥°å™¨" aria-label="Permalink to &quot;1.å®šä¹‰ä¸€ä¸ªå°†å±æ€§åä½œä¸ºé”®çš„è£…é¥°å™¨&quot;">â€‹</a></h5><p>user.decorator.ts</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">createParamDecorator</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">ExecutionContext</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> const</span><span style="color:#E5C07B;"> User</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> createParamDecorator</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">	(</span><span style="color:#E06C75;font-style:italic;">data</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">ctx</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ExecutionContext</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> request</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">switchToHttp</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getRequest</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">		const</span><span style="color:#E5C07B;"> user</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> request</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">user</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E06C75;"> data</span><span style="color:#C678DD;"> ?</span><span style="color:#E06C75;"> user</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> user</span><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">data</span><span style="color:#ABB2BF;">] </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> user</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h5 id="_2-é€šè¿‡æ§åˆ¶å™¨ä¸­çš„-user-è£…é¥°å™¨è®¿é—®ç‰¹å®šå±æ€§" tabindex="-1">2.é€šè¿‡æ§åˆ¶å™¨ä¸­çš„ @User() è£…é¥°å™¨è®¿é—®ç‰¹å®šå±æ€§ <a class="header-anchor" href="#_2-é€šè¿‡æ§åˆ¶å™¨ä¸­çš„-user-è£…é¥°å™¨è®¿é—®ç‰¹å®šå±æ€§" aria-label="Permalink to &quot;2.é€šè¿‡æ§åˆ¶å™¨ä¸­çš„ @User() è£…é¥°å™¨è®¿é—®ç‰¹å®šå±æ€§&quot;">â€‹</a></h5><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findOne</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">User</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;firstName&#39;</span><span style="color:#ABB2BF;">) </span><span style="color:#E06C75;">firstName</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">string</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">\`Hello </span><span style="color:#C678DD;">\${</span><span style="color:#E06C75;">firstName</span><span style="color:#C678DD;">}</span><span style="color:#98C379;">\`</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æ‚¨å¯ä»¥ä½¿ç”¨å…·æœ‰ä¸åŒé”®çš„ç›¸åŒè£…é¥°å™¨æ¥è®¿é—®ä¸åŒçš„å±æ€§ã€‚å¦‚æœç”¨æˆ·å¯¹è±¡å¤æ‚ï¼Œä½¿ç”¨æ­¤æ–¹æ³•å¯ä»¥ä½¿è¯·æ±‚å¤„ç†ç¨‹åºç¼–å†™æ›´å®¹æ˜“ã€å¹¶ä¸”å¯è¯»æ€§æ›´é«˜ã€‚</p><h4 id="_3-å°†ç®¡é“åº”ç”¨åˆ°è‡ªå®šä¹‰è£…é¥°å™¨ä¸Š" tabindex="-1">3.å°†ç®¡é“åº”ç”¨åˆ°è‡ªå®šä¹‰è£…é¥°å™¨ä¸Š <a class="header-anchor" href="#_3-å°†ç®¡é“åº”ç”¨åˆ°è‡ªå®šä¹‰è£…é¥°å™¨ä¸Š" aria-label="Permalink to &quot;3.å°†ç®¡é“åº”ç”¨åˆ°è‡ªå®šä¹‰è£…é¥°å™¨ä¸Š&quot;">â€‹</a></h4><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> findOne</span><span style="color:#ABB2BF;">(@</span><span style="color:#61AFEF;">User</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ValidationPipe</span><span style="color:#ABB2BF;">()) </span><span style="color:#E06C75;">user</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">UserEntity</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">user</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>validateCustomDecorators é€‰é¡¹å¿…é¡»è®¾ç½®ä¸º true</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒValidationPipe ä¸éªŒè¯ä½¿ç”¨è‡ªå®šä¹‰è£…é¥°å™¨æ³¨é‡Šçš„å‚æ•°ã€‚</p><h4 id="_4-è£…é¥°å™¨èšåˆ" tabindex="-1">4.è£…é¥°å™¨èšåˆ <a class="header-anchor" href="#_4-è£…é¥°å™¨èšåˆ" aria-label="Permalink to &quot;4.è£…é¥°å™¨èšåˆ&quot;">â€‹</a></h4><h5 id="_1-applydecorators-èšåˆå¤šä¸ªè£…é¥°å™¨" tabindex="-1">1.applyDecorators èšåˆå¤šä¸ªè£…é¥°å™¨ <a class="header-anchor" href="#_1-applydecorators-èšåˆå¤šä¸ªè£…é¥°å™¨" aria-label="Permalink to &quot;1.applyDecorators èšåˆå¤šä¸ªè£…é¥°å™¨&quot;">â€‹</a></h5><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">applyDecorators</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &quot;@nestjs/common&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> Auth</span><span style="color:#ABB2BF;">(...</span><span style="color:#E06C75;font-style:italic;">roles</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Role</span><span style="color:#ABB2BF;">[]) {</span></span>
<span class="line"><span style="color:#C678DD;">	return</span><span style="color:#61AFEF;"> applyDecorators</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#61AFEF;">		SetMetadata</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;roles&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">roles</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#61AFEF;">		UseGuards</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AuthGuard</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">RolesGuard</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#61AFEF;">		ApiBearerAuth</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#61AFEF;">		ApiUnauthorizedResponse</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">description</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;Unauthorized&quot;&#39;</span><span style="color:#ABB2BF;"> })</span></span>
<span class="line"><span style="color:#ABB2BF;">	);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h5 id="_2-ä½¿ç”¨-auth-è‡ªå®šä¹‰è£…é¥°å™¨" tabindex="-1">2.ä½¿ç”¨ @Auth() è‡ªå®šä¹‰è£…é¥°å™¨ <a class="header-anchor" href="#_2-ä½¿ç”¨-auth-è‡ªå®šä¹‰è£…é¥°å™¨" aria-label="Permalink to &quot;2.ä½¿ç”¨ @Auth() è‡ªå®šä¹‰è£…é¥°å™¨&quot;">â€‹</a></h5><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;users&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Auth</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;admin&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;">findAllUsers</span><span style="color:#ABB2BF;">() {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>è¿™å…·æœ‰é€šè¿‡ä¸€ä¸ªå£°æ˜åº”ç”¨æ‰€æœ‰å››ä¸ªè£…é¥°å™¨çš„æ•ˆæœã€‚</p><blockquote><p>æ¥è‡ª @nestjs/swagger ä¾èµ–ä¸­çš„ @ApiHideProperty() è£…é¥°å™¨æ— æ³•èšåˆï¼Œå› æ­¤æ­¤è£…é¥°å™¨æ— æ³•æ­£å¸¸ä½¿ç”¨ applyDecorators æ–¹æ³•</p></blockquote><h3 id="å‚æ•°è£…é¥°å™¨" tabindex="-1">å‚æ•°è£…é¥°å™¨ <a class="header-anchor" href="#å‚æ•°è£…é¥°å™¨" aria-label="Permalink to &quot;å‚æ•°è£…é¥°å™¨&quot;">â€‹</a></h3><p>Nest è£…é¥°å™¨å’ŒåŸç”Ÿ Expressï¼ˆæˆ– Fastifyï¼‰ä¸­ç›¸åº”å¯¹è±¡çš„æ˜ å°„</p><ul><li>@Request() <ul><li>@Req()req</li></ul></li><li>@Response() <ul><li>@Res()res</li></ul></li><li>@Next() <ul><li>next</li></ul></li><li>@Session() <ul><li>req.session</li></ul></li><li>@Param(param?: string) <ul><li>req.params / req.params[param]</li></ul></li><li>@Body(param?: string) <ul><li>req.body / req.body[param]</li></ul></li><li>@Query(param?: string) <ul><li>req.query / req.query[param]</li></ul></li><li>@Headers(param?: string) <ul><li>req.headers / req.headers[param]</li></ul></li><li>@Ip() <ul><li>req.ip</li></ul></li><li>@HostParam() <ul><li>req.hosts</li></ul></li></ul><h2 id="é¡¹ç›®å¼€å‘æµç¨‹" tabindex="-1">é¡¹ç›®å¼€å‘æµç¨‹ <a class="header-anchor" href="#é¡¹ç›®å¼€å‘æµç¨‹" aria-label="Permalink to &quot;é¡¹ç›®å¼€å‘æµç¨‹&quot;">â€‹</a></h2><h3 id="æ‰§è¡Œé¡ºåº" tabindex="-1">æ‰§è¡Œé¡ºåº <a class="header-anchor" href="#æ‰§è¡Œé¡ºåº" aria-label="Permalink to &quot;æ‰§è¡Œé¡ºåº&quot;">â€‹</a></h3><ul><li>å®¢æˆ·ç«¯è¯·æ±‚ ---&gt; ä¸­é—´ä»¶ ---&gt; å®ˆå« ---&gt; æ‹¦æˆªå™¨ä¹‹å‰ ---&gt; ç®¡é“ ---&gt; æ§åˆ¶å™¨å¤„ç†å¹¶å“åº” ---&gt; æ‹¦æˆªå™¨ä¹‹å ---&gt; è¿‡æ»¤å™¨</li></ul><h3 id="nestè£…é¥°å™¨" tabindex="-1">nestè£…é¥°å™¨ <a class="header-anchor" href="#nestè£…é¥°å™¨" aria-label="Permalink to &quot;nestè£…é¥°å™¨&quot;">â€‹</a></h3><p>nestè£…é¥°å™¨ express å¯¹è±¡ï¼š</p><ul><li><p>@Request() req</p></li><li><p>@Response() res</p></li><li><p>@Next() next</p></li><li><p>@Session() req.session</p></li><li><p>@Param(param?: string) req.params / req.params[param]</p></li><li><p>@Body(param?: string) req.body / req.body[param]</p></li><li><p>@Query(param?: string) req.query / req.query[param]</p></li><li><p>@Headers(param?: string) req.headers / req.headers[param]</p></li></ul><h3 id="æ•°æ®åº“æ“ä½œ" tabindex="-1">æ•°æ®åº“æ“ä½œ <a class="header-anchor" href="#æ•°æ®åº“æ“ä½œ" aria-label="Permalink to &quot;æ•°æ®åº“æ“ä½œ&quot;">â€‹</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span><span style="color:#98C379;"> mongoose</span><span style="color:#98C379;"> @nestjs/mongoose</span><span style="color:#D19A66;"> --save</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span><span style="color:#D19A66;"> --save</span><span style="color:#98C379;"> @nestjs/typeorm</span><span style="color:#98C379;"> typeorm</span><span style="color:#98C379;"> mysql</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="é…ç½®fastify" tabindex="-1">é…ç½®Fastify <a class="header-anchor" href="#é…ç½®fastify" aria-label="Permalink to &quot;é…ç½®Fastify&quot;">â€‹</a></h3><p>é›†æˆæ­¥éª¤</p><p>1.å®‰è£…ä¾èµ–@nestjs/platform-fastify</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> i</span><span style="color:#D19A66;"> --save</span><span style="color:#98C379;"> @nestjs/platform-fastify</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>2.é…ç½®é€‚é…å™¨</p><ul><li>å®‰è£… fastify åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ FastifyAdapterï¼Œä¿®æ”¹src/main.tsæ–‡ä»¶</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">NestFactory</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/core&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">FastifyAdapter</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">NestFastifyApplication</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/platform-fastify&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">ApplicationModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./app.module&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> bootstrap</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">nestfastifyapplication</span><span style="color:#ABB2BF;">&gt;(</span><span style="color:#E06C75;">ApplicationModule</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> FastifyAdapter</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // é»˜è®¤æƒ…å†µä¸‹ï¼Œ\`Fastify\`ä»…åœ¨ \`localhost 127.0.0.1\` æ¥å£ä¸Šç›‘å¬</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // æ”¹æˆ 0.0.0.0 æ¥å—å…¶ä»–ä¸»æœºä¸Šçš„è¿æ¥</span></span>
<span class="line"><span style="color:#C678DD;">  await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3000</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&#39;0.0.0.0&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#61AFEF;">bootstrap</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="é…ç½®è·¯å¾„åˆ«åtsconfig-json" tabindex="-1">é…ç½®è·¯å¾„åˆ«åtsconfig.json <a class="header-anchor" href="#é…ç½®è·¯å¾„åˆ«åtsconfig-json" aria-label="Permalink to &quot;é…ç½®è·¯å¾„åˆ«åtsconfig.json&quot;">â€‹</a></h3><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">    // é…ç½®è·¯å¾„åˆ«å</span></span>
<span class="line"><span style="color:#98C379;">    &quot;paths&quot;</span><span style="color:#ABB2BF;">: {</span></span>
<span class="line"><span style="color:#98C379;">      &quot;@/*&quot;</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#98C379;">        &quot;src/*&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">      ],</span></span>
<span class="line"><span style="color:#ABB2BF;">    },</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="å¿«é€Ÿå¯åŠ¨-web-åº”ç”¨-create-t3-app" tabindex="-1">å¿«é€Ÿå¯åŠ¨ Web åº”ç”¨ï¼šcreate-t3-app <a class="header-anchor" href="#å¿«é€Ÿå¯åŠ¨-web-åº”ç”¨-create-t3-app" aria-label="Permalink to &quot;å¿«é€Ÿå¯åŠ¨ Web åº”ç”¨ï¼šcreate-t3-app&quot;">â€‹</a></h2><p>create-t3-app è®©ä½ ä»¥æœ€å¿«çš„æ–¹å¼å¯åŠ¨ä¸€ä¸ªç‹¬ç«‹ã€å…¨æ ˆã€ç±»å‹å®‰å…¨ NextJS åº”ç”¨ã€‚</p><p>ç½‘å€</p><ul><li><p><a href="https://github.com/t3-oss/create-t3-app" target="_blank" rel="noreferrer">https://github.com/t3-oss/create-t3-app</a></p></li><li><p><a href="https://create.t3.gg/" target="_blank" rel="noreferrer">https://create.t3.gg/</a></p></li></ul><h2 id="æ•°æ®åº“è¿æ¥" tabindex="-1">æ•°æ®åº“è¿æ¥ <a class="header-anchor" href="#æ•°æ®åº“è¿æ¥" aria-label="Permalink to &quot;æ•°æ®åº“è¿æ¥&quot;">â€‹</a></h2><h3 id="æ•°æ®åº“ç›¸å…³" tabindex="-1">æ•°æ®åº“ç›¸å…³ <a class="header-anchor" href="#æ•°æ®åº“ç›¸å…³" aria-label="Permalink to &quot;æ•°æ®åº“ç›¸å…³&quot;">â€‹</a></h3><ul><li><p>Nest ä¸æ•°æ®åº“æ— å…³ï¼Œå…è®¸æ‚¨è½»æ¾åœ°ä¸ä»»ä½• SQL æˆ– NoSQL æ•°æ®åº“é›†æˆã€‚</p></li><li><p>å¯ä»¥ç›´æ¥ä½¿ç”¨ä»»ä½•é€šç”¨çš„ Node.js æ•°æ®åº“é›†æˆåº“æˆ– ORM ï¼Œä¾‹å¦‚ Sequelize (recipe)ã€knexjs (tutorial)\`å’Œ TypeORM ï¼Œä»¥åœ¨æ›´é«˜çš„æŠ½è±¡çº§åˆ«ä¸Šè¿›è¡Œæ“ä½œã€‚</p></li></ul><h3 id="æ•°æ®åº“" tabindex="-1">æ•°æ®åº“ <a class="header-anchor" href="#æ•°æ®åº“" aria-label="Permalink to &quot;æ•°æ®åº“&quot;">â€‹</a></h3><ul><li><p>1.sequelize</p><ul><li><p><a href="https://sequelize.org/" target="_blank" rel="noreferrer">https://sequelize.org/</a></p></li><li><p><a href="https://www.npmjs.com/package/sequelize" target="_blank" rel="noreferrer">https://www.npmjs.com/package/sequelize</a></p></li><li><p><a href="https://github.com/sequelize/sequelize" target="_blank" rel="noreferrer">https://github.com/sequelize/sequelize</a></p></li></ul></li><li><p>2.knexjs</p><ul><li><a href="https://knexjs.org/" target="_blank" rel="noreferrer">https://knexjs.org/</a></li></ul></li><li><p>3.MongoDB</p><ul><li><p>Nestæ”¯æŒä¸¤ç§ä¸ MongoDB æ•°æ®åº“é›†æˆçš„æ–¹å¼</p><ul><li><p>1.ä½¿ç”¨å†…ç½®çš„TypeORM æä¾›çš„ MongoDB è¿æ¥å™¨</p><ul><li><a href="https://github.com/typeorm/typeorm" target="_blank" rel="noreferrer">https://github.com/typeorm/typeorm</a></li></ul></li><li><p>2.ä½¿ç”¨æœ€æµè¡Œçš„ MongoDB å¯¹è±¡å»ºæ¨¡å·¥å…· Mongoose</p><ul><li><a href="https://mongoosejs.com/" target="_blank" rel="noreferrer">https://mongoosejs.com/</a></li></ul></li></ul></li></ul></li></ul><h3 id="typeorm" tabindex="-1">TypeORM <a class="header-anchor" href="#typeorm" aria-label="Permalink to &quot;TypeORM&quot;">â€‹</a></h3><h4 id="typeorm-1" tabindex="-1">typeorm <a class="header-anchor" href="#typeorm-1" aria-label="Permalink to &quot;typeorm&quot;">â€‹</a></h4><ul><li><a href="https://github.com/typeorm/typeorm" target="_blank" rel="noreferrer">https://github.com/typeorm/typeorm</a></li></ul><h4 id="ä»‹ç»-1" tabindex="-1">ä»‹ç» <a class="header-anchor" href="#ä»‹ç»-1" aria-label="Permalink to &quot;ä»‹ç»&quot;">â€‹</a></h4><ul><li><p>Nest è¿˜æä¾›äº†ä¸ç°æˆçš„ TypeORM ä¸ @nestjs/typeorm çš„ç´§å¯†é›†æˆ</p></li><li><p>ä¸ºäº†ä¸ SQLå’Œ NoSQL æ•°æ®åº“é›†æˆï¼ŒNest æä¾›äº† @nestjs/typeorm åŒ…ã€‚Nest ä½¿ç”¨TypeORMæ˜¯å› ä¸ºå®ƒæ˜¯ TypeScript ä¸­æœ€æˆç†Ÿçš„å¯¹è±¡å…³ç³»æ˜ å°„å™¨( ORM )ã€‚å› ä¸ºå®ƒæ˜¯ç”¨ TypeScript ç¼–å†™çš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå¥½åœ°ä¸ Nest æ¡†æ¶é›†æˆã€‚</p></li><li><p>TypeORM æä¾›äº†å¯¹è®¸å¤šå…³ç³»æ•°æ®åº“çš„æ”¯æŒ</p><ul><li>PostgreSQL ã€Oracleã€Microsoft SQL Serverã€SQLiteï¼Œç”šè‡³åƒ MongoDBè¿™æ ·çš„ NoSQL æ•°æ®åº“</li></ul></li></ul><h4 id="åŸºæœ¬ä½¿ç”¨" tabindex="-1">åŸºæœ¬ä½¿ç”¨ <a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨" aria-label="Permalink to &quot;åŸºæœ¬ä½¿ç”¨&quot;">â€‹</a></h4><ul><li><p>1.ä¸ºæ‰€é€‰æ•°æ®åº“å®‰è£…ç›¸å…³çš„å®¢æˆ·ç«¯ API åº“ mysqlä¸ºä¾‹</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span><span style="color:#D19A66;"> --save</span><span style="color:#98C379;"> @nestjs/typeorm</span><span style="color:#98C379;"> typeorm</span><span style="color:#98C379;"> mysql2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>2.å°† TypeOrmModule å¯¼å…¥AppModule app.module.ts</p><ul><li><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  app.module.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#E5C07B;">    TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">      type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;mysql&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      host</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;localhost&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      port</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">3306</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      username</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      password</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      database</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;test&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      entities</span><span style="color:#ABB2BF;">: [],</span></span>
<span class="line"><span style="color:#E06C75;">      synchronize</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    }),</span></span>
<span class="line"><span style="color:#ABB2BF;">  ],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li><li><p>forRoot() æ–¹æ³•è¯´æ˜</p><ul><li><p>forRoot() æ–¹æ³•æ”¯æŒæ‰€æœ‰TypeORMåŒ…ä¸­createConnection()å‡½æ•°æš´éœ²å‡ºçš„é…ç½®å±æ€§</p></li><li><p>é¢å¤–å¯¹è±¡å±æ€§é…ç½®</p><ul><li><p>retryAttempts:</p><ul><li>é‡è¯•è¿æ¥æ•°æ®åº“çš„æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š10ï¼‰</li></ul></li><li><p>retryDelay:</p><ul><li>ä¸¤æ¬¡é‡è¯•è¿æ¥çš„é—´éš”(ms)ï¼ˆé»˜è®¤ï¼š3000ï¼‰</li></ul></li><li><p>autoLoadEntities:</p><ul><li>å¦‚æœä¸ºtrue,å°†è‡ªåŠ¨åŠ è½½å®ä½“(é»˜è®¤ï¼šfalse)</li></ul></li><li><p>keepConnectionAlive:</p><ul><li>å¦‚æœä¸ºtrueï¼Œåœ¨åº”ç”¨ç¨‹åºå…³é—­åè¿æ¥ä¸ä¼šå…³é—­ (é»˜è®¤ï¼šfalse)</li></ul></li></ul></li><li><p>æ›´å¤šè¿æ¥é€‰é¡¹</p><ul><li><a href="https://typeorm.io/#/connection-options" target="_blank" rel="noreferrer">https://typeorm.io/#/connection-options</a></li></ul></li></ul></li></ul></li><li><p>3.å¯ä»¥åˆ›å»º ormconfig.json (é€‰é¡¹æ¨¡å—åŒ–ï¼š2å’Œ3ä»»é€‰ä¸€é¡¹é…ç½®)</p><ul><li><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;">  &quot;type&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;mysql&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  &quot;host&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;localhost&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  &quot;port&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">3306</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  &quot;username&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;root&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  &quot;password&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;root&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  &quot;database&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;test&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  &quot;entities&quot;</span><span style="color:#ABB2BF;">: [</span><span style="color:#98C379;">&quot;dist/**/*.entity{.ts,.js}&quot;</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">  &quot;synchronize&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li><li><p>ç„¶åï¼Œå¯ä»¥ä¸å¸¦ä»»ä½•é€‰é¡¹åœ°è°ƒç”¨ forRoot() app.module.ts</p><ul><li><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  app.module.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">()],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul></li><li><p>é™æ€å…¨å±€è·¯å¾„(ä¾‹å¦‚ dist/**/*.entity{ .ts,.js} )ä¸é€‚ç”¨äº Webpack çƒ­é‡è½½ã€‚</p></li><li><p>æ³¨æ„ï¼Œormconfig.json æ–‡ä»¶ç”±typeormåº“è½½å…¥ï¼Œå› æ­¤ï¼Œä»»ä½•ä¸Šè¿°å‚æ•°ä¹‹å¤–çš„å±æ€§éƒ½ä¸ä¼šè¢«åº”ç”¨ï¼ˆä¾‹å¦‚ç”±forRoot()æ–¹æ³•å†…éƒ¨æ”¯æŒçš„å±æ€§â€“ä¾‹å¦‚autoLoadEntitieså’ŒretryDelay())</p></li></ul></li><li><p>4.å®Œæˆ2æˆ–3ï¼ŒTypeORM çš„Connectionå’Œ EntityManager å¯¹è±¡ å°±å¯ä»¥åœ¨æ•´ä¸ªé¡¹ç›®ä¸­æ³¨å…¥(ä¸éœ€è¦å¯¼å…¥ä»»ä½•æ¨¡å—)</p><ul><li><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  app.module.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Connection</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">(), </span><span style="color:#E06C75;">PhotoModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">  constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> readonly</span><span style="color:#E06C75;font-style:italic;"> connection</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Connection</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ul></li></ul><h4 id="typeormæ¨¡å¼ä»‹ç»å’Œä½¿ç”¨" tabindex="-1">TypeORMæ¨¡å¼ä»‹ç»å’Œä½¿ç”¨ <a class="header-anchor" href="#typeormæ¨¡å¼ä»‹ç»å’Œä½¿ç”¨" aria-label="Permalink to &quot;TypeORMæ¨¡å¼ä»‹ç»å’Œä½¿ç”¨&quot;">â€‹</a></h4><h5 id="å­˜å‚¨åº“æ¨¡å¼" tabindex="-1">å­˜å‚¨åº“æ¨¡å¼ <a class="header-anchor" href="#å­˜å‚¨åº“æ¨¡å¼" aria-label="Permalink to &quot;å­˜å‚¨åº“æ¨¡å¼&quot;">â€‹</a></h5><p>TypeORM æ”¯æŒå­˜å‚¨åº“è®¾è®¡æ¨¡å¼ï¼Œå› æ­¤æ¯ä¸ªå®ä½“éƒ½æœ‰è‡ªå·±çš„å­˜å‚¨åº“</p><p>ä»æ•°æ®åº“è¿æ¥è·å¾—è¿™äº›å­˜å‚¨åº“</p><p>1.å®šä¹‰User å®ä½“ user.entity.ts</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  user.entity.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Entity</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Column</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">PrimaryGeneratedColumn</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Entity</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> User</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">PrimaryGeneratedColumn</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">  id</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">number</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Column</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">  firstName</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Column</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">  lastName</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Column</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">default</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;"> })</span></span>
<span class="line"><span style="color:#E06C75;">  isActive</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li><p>è¯¥ User å®ä½“åœ¨ users ç›®å½•ä¸‹ã€‚è¿™ä¸ªç›®å½•åŒ…å«äº†å’Œ UsersModuleæ¨¡å—æœ‰å…³çš„æ‰€æœ‰æ–‡ä»¶ã€‚ä½ å¯ä»¥å†³å®šåœ¨å“ªé‡Œä¿å­˜æ¨¡å‹æ–‡ä»¶ï¼Œä½†æˆ‘ä»¬æ¨èåœ¨ä»–ä»¬çš„åŸŸä¸­å°±è¿‘åˆ›å»ºï¼Œå³åœ¨ç›¸åº”çš„æ¨¡å—ç›®å½•ä¸­ã€‚</p></li><li><p>å®ä½“çš„æ›´å¤šå†…å®¹ï¼š<a href="https://typeorm.io/#/entities" target="_blank" rel="noreferrer">https://typeorm.io/#/entities</a></p></li></ul><p>2.ä½¿ç”¨ user å®ä½“ app.module.ts</p><p>éœ€è¦åœ¨æ¨¡å—çš„forRoot()æ–¹æ³•çš„é€‰é¡¹ä¸­ï¼ˆé™¤éä½ ä½¿ç”¨ä¸€ä¸ªé™æ€çš„å…¨å±€è·¯å¾„ï¼‰å°†å®ƒæ’å…¥entitiesæ•°ç»„ä¸­æ¥è®© TypeORMçŸ¥é“å®ƒçš„å­˜åœ¨</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./users/user.entity&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#E5C07B;">    TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">      type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;mysql&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      host</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;localhost&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      port</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">3306</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      username</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      password</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      database</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;test&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">      //  å­˜å‚¨åº“</span></span>
<span class="line"><span style="color:#E06C75;">      entities</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">      synchronize</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    }),</span></span>
<span class="line"><span style="color:#ABB2BF;">  ],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>3.user.module.ts ä½¿ç”¨ forFeature() æ–¹æ³• å®šä¹‰æ³¨å†Œå­˜å‚¨åº“</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UsersService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./users.service&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UsersController</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./users.controller&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./user.entity&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forFeature</span><span style="color:#ABB2BF;">([</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">])],</span></span>
<span class="line"><span style="color:#E06C75;">  providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">UsersService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">  controllers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">UsersController</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> UsersModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>æ­¤æ¨¡å—ä½¿ç”¨ forFeature() æ–¹æ³•å®šä¹‰åœ¨å½“å‰èŒƒå›´ä¸­æ³¨å†Œå“ªäº›å­˜å‚¨åº“ã€‚</li></ul><p>4.æ³¨å…¥åˆ° UsersServiceæœåŠ¡æä¾›è€…ä¸­ users.service.ts</p><ul><li>ä½¿ç”¨ @InjectRepository()è£…é¥°å™¨å°† UsersRepository æ³¨å…¥åˆ° UsersService ä¸­:</li></ul><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  users.service.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Injectable</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">InjectRepository</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Repository</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./user.entity&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> UsersService</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">  constructor</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#61AFEF;">InjectRepository</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">    private</span><span style="color:#E06C75;font-style:italic;"> usersRepository</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Repository</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">user</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">  ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">  findAll</span><span style="color:#ABB2BF;">(): </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">user</span><span style="color:#ABB2BF;">[]&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">usersRepository</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">find</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">  findOne</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">id</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">): </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">user</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">usersRepository</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">findOne</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">  async</span><span style="color:#61AFEF;"> remove</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">id</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">): </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">void</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    await</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">usersRepository</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">delete</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>5.å°† UsersModule å¯¼å…¥æ ¹ AppModule app.module.ts</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./users/user.entity&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#E5C07B;">    TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">      type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;mysql&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      host</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;localhost&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      port</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">3306</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      username</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      password</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      database</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;test&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">      //  å­˜å‚¨åº“</span></span>
<span class="line"><span style="color:#E06C75;">      entities</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">      synchronize</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    }),</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //  å¯¼å…¥</span></span>
<span class="line"><span style="color:#E06C75;">    UserModule</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  ],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>6.è¦åœ¨å¯¼å…¥TypeOrmModule.forFeature çš„æ¨¡å—ä¹‹å¤–ä½¿ç”¨å­˜å‚¨åº“ï¼ˆusers.module.tsï¼‰</p><p>å¦‚æœè¦åœ¨å¯¼å…¥TypeOrmModule.forFeature çš„æ¨¡å—ä¹‹å¤–ä½¿ç”¨å­˜å‚¨åº“ï¼Œåˆ™éœ€è¦é‡æ–°å¯¼å‡ºç”±å…¶ç”Ÿæˆçš„æä¾›ç¨‹åºã€‚ å¯ä»¥é€šè¿‡å¯¼å‡ºæ•´ä¸ªæ¨¡å—æ¥åšåˆ°è¿™ä¸€ç‚¹</p><p>6.1.å¯¼å‡ºæ¨¡å— users.module.ts</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./user.entity&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forFeature</span><span style="color:#ABB2BF;">([</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">])],</span></span>
<span class="line"><span style="color:#E06C75;">  exports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> UsersModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>6.2.å…¶ä»–åœ°æ–¹å¯¼å…¥ä½¿ç”¨ users-http.module.ts</p><p>åœ¨ UserHttpModule ä¸­å¯¼å…¥ UsersModule ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åä¸€ä¸ªæ¨¡å—çš„æä¾›è€…ä¸­ä½¿ç”¨ @InjectRepository(User)</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  users-http.module.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UsersModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./user.module&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UsersService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./users.service&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UsersController</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./users.controller&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">UsersModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">  providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">UsersService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">  controllers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">UsersController</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> UserHttpModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="å…³ç³»" tabindex="-1">å…³ç³» <a class="header-anchor" href="#å…³ç³»" aria-label="Permalink to &quot;å…³ç³»&quot;">â€‹</a></h5><h6 id="ä»‹ç»-2" tabindex="-1">ä»‹ç» <a class="header-anchor" href="#ä»‹ç»-2" aria-label="Permalink to &quot;ä»‹ç»&quot;">â€‹</a></h6><ul><li><p>å…³ç³»æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªè¡¨ä¹‹é—´çš„è”ç³»</p></li><li><p>å…³ç³»åŸºäºæ¯ä¸ªè¡¨ä¸­çš„å¸¸è§„å­—æ®µï¼Œé€šå¸¸åŒ…å«ä¸»é”®å’Œå¤–é”®ã€‚</p></li></ul><h6 id="ä¸‰ç§å…³ç³»-å’Œè£…é¥°å™¨" tabindex="-1">ä¸‰ç§å…³ç³» å’Œè£…é¥°å™¨ <a class="header-anchor" href="#ä¸‰ç§å…³ç³»-å’Œè£…é¥°å™¨" aria-label="Permalink to &quot;ä¸‰ç§å…³ç³» å’Œè£…é¥°å™¨&quot;">â€‹</a></h6><ul><li><p>ä¸€å¯¹ä¸€</p><ul><li><p>ä¸»è¡¨ä¸­çš„æ¯ä¸€è¡Œåœ¨å¤–éƒ¨è¡¨ä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹åº”è¡Œ</p></li><li><p>ä½¿ç”¨ @OneToOne() è£…é¥°å™¨æ¥å®šä¹‰è¿™ç§ç±»å‹çš„å…³ç³»</p></li></ul></li><li><p>ä¸€å¯¹å¤š/å¤šå¯¹ä¸€</p><ul><li><p>ä¸»è¡¨ä¸­çš„æ¯ä¸€è¡Œåœ¨å¤–éƒ¨è¡¨ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šçš„å¯¹åº”è¡Œ</p></li><li><p>ä½¿ç”¨ @OneToMany() å’Œ @ManyToOne()è£…é¥°å™¨ æ¥å®šä¹‰è¿™ç§ç±»å‹çš„å…³ç³»</p></li></ul></li><li><p>å¤šå¯¹å¤š</p><ul><li><p>ä¸»è¡¨ä¸­çš„æ¯ä¸€è¡Œåœ¨å¤–éƒ¨è¡¨ä¸­æœ‰å¤šä¸ªå¯¹åº”è¡Œï¼Œå¤–éƒ¨è¡¨ä¸­çš„æ¯ä¸ªè®°å½•åœ¨ä¸»è¡¨ä¸­ä¹Ÿæœ‰å¤šä¸ªè¡Œ</p></li><li><p>ä½¿ç”¨ @ManyToMany()è£…é¥°å™¨ æ¥å®šä¹‰è¿™ç§ç±»å‹çš„å…³ç³»</p></li></ul></li></ul><h6 id="ä½¿ç”¨è£…é¥°å™¨ä¾‹å­" tabindex="-1">ä½¿ç”¨è£…é¥°å™¨ä¾‹å­ <a class="header-anchor" href="#ä½¿ç”¨è£…é¥°å™¨ä¾‹å­" aria-label="Permalink to &quot;ä½¿ç”¨è£…é¥°å™¨ä¾‹å­&quot;">â€‹</a></h6><p>@OneToMany()è£…é¥°å™¨ å®šä¹‰æ¯ä¸ªUserå¯ä»¥æœ‰å¤šä¸ªPhoto ï¼ˆuser.entity.tsï¼‰</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  user.entity.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Entity</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">Column</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">PrimaryGeneratedColumn</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">OneToMany</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Photo</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;../photos/photo.entity&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Entity</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> User</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">PrimaryGeneratedColumn</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">  id</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">number</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Column</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">  firstName</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Column</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#E06C75;">  lastName</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">Column</span><span style="color:#ABB2BF;">({ </span><span style="color:#E06C75;">default</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;"> })</span></span>
<span class="line"><span style="color:#E06C75;">  isActive</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">boolean</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  @</span><span style="color:#61AFEF;">OneToMany</span><span style="color:#ABB2BF;">((</span><span style="color:#E06C75;font-style:italic;">type</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#E06C75;"> Photo</span><span style="color:#ABB2BF;">, (</span><span style="color:#E06C75;font-style:italic;">photo</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#E5C07B;"> photo</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">user</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E06C75;">  photos</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Photo</span><span style="color:#ABB2BF;">[];</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>è¦äº†è§£ TypeORM ä¸­å…³ç³»çš„å†…å®¹ å¯ä»¥æŸ¥çœ‹TypeORM æ–‡æ¡£ï¼š<a href="https://typeorm.io/#/relations" target="_blank" rel="noreferrer">https://typeorm.io/#/relations</a></p><h5 id="è‡ªåŠ¨è½½å…¥å®ä½“" tabindex="-1">è‡ªåŠ¨è½½å…¥å®ä½“ <a class="header-anchor" href="#è‡ªåŠ¨è½½å…¥å®ä½“" aria-label="Permalink to &quot;è‡ªåŠ¨è½½å…¥å®ä½“&quot;">â€‹</a></h5><p>ä½¿ç”¨é™æ€å…¨å±€è·¯å¾„æ¥è‡ªåŠ¨è½½å…¥å®ä½“</p><ul><li>ä¾‹å¦‚, dist/*/.entity{.ts,.js}</li></ul><p>webpackä¸æ”¯æŒå…¨å±€è·¯å¾„ï¼Œå› æ­¤å¦‚æœä½ è¦åœ¨å•ä¸€ä»“åº“(Monorepo)ä¸­æ„å»ºåº”ç”¨ï¼Œå¯èƒ½ä¸èƒ½ä½¿ç”¨å…¨å±€è·¯å¾„ã€‚</p><ul><li><p>è§£å†³æ–¹æ¡ˆ</p><ul><li><p>åœ¨é…ç½®å¯¹è±¡çš„å±æ€§ä¸­(ä¼ é€’ç»™forRoot()æ–¹æ³•çš„)è®¾ç½®autoLoadEntitieså±æ€§ä¸ºtrueæ¥è‡ªåŠ¨è½½å…¥å®ä½“ app.module.ts</p></li><li><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// app.module.ts</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#E5C07B;">    TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#ABB2BF;">      ...</span></span>
<span class="line"><span style="color:#E06C75;">      autoLoadEntities</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    }),</span></span>
<span class="line"><span style="color:#ABB2BF;">  ],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li><li><p>é€šè¿‡é…ç½®è¿™ä¸€é€‰é¡¹ï¼Œæ¯ä¸ªé€šè¿‡forFeature()æ³¨å†Œçš„å®ä½“éƒ½ä¼šè‡ªåŠ¨æ·»åŠ åˆ°é…ç½®å¯¹è±¡çš„entitiesæ•°ç»„ä¸­</p></li><li><p>æ³¨æ„ï¼Œé‚£äº›æ²¡æœ‰é€šè¿‡forFeature()æ–¹æ³•æ³¨å†Œï¼Œè€Œä»…ä»…æ˜¯åœ¨å®ä½“ä¸­è¢«å¼•ç”¨ï¼ˆé€šè¿‡å…³ç³»ï¼‰çš„å®ä½“ä¸èƒ½é€šè¿‡autoLoadEntitiesé…ç½®è¢«åŒ…å«ã€‚</p></li></ul></li></ul><h5 id="äº‹åŠ¡" tabindex="-1">äº‹åŠ¡ <a class="header-anchor" href="#äº‹åŠ¡" aria-label="Permalink to &quot;äº‹åŠ¡&quot;">â€‹</a></h5><h6 id="ç®€ä»‹-1" tabindex="-1">ç®€ä»‹ <a class="header-anchor" href="#ç®€ä»‹-1" aria-label="Permalink to &quot;ç®€ä»‹&quot;">â€‹</a></h6><p>æ•°æ®åº“äº‹åŠ¡ä»£è¡¨åœ¨æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰ä¸­é’ˆå¯¹æ•°æ®åº“çš„ä¸€ç»„æ“ä½œï¼Œè¿™ç»„æ“ä½œæ˜¯æœ‰å…³çš„ã€å¯é çš„å¹¶ä¸”å’Œå…¶ä»–äº‹åŠ¡ç›¸äº’ç‹¬ç«‹çš„ã€‚</p><p>ä¸€ä¸ªäº‹åŠ¡é€šå¸¸å¯ä»¥ä»£è¡¨æ•°æ®åº“ä¸­çš„ä»»ä½•å˜æ›´ï¼š<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1" target="_blank" rel="noreferrer">https://zh.wikipedia.org/wiki/æ•°æ®åº“äº‹åŠ¡</a></p><h6 id="typeorm-äº‹åŠ¡" tabindex="-1">TypeORM äº‹åŠ¡ <a class="header-anchor" href="#typeorm-äº‹åŠ¡" aria-label="Permalink to &quot;TypeORM äº‹åŠ¡&quot;">â€‹</a></h6><ul><li><a href="https://typeorm.io/#/transactions" target="_blank" rel="noreferrer">https://typeorm.io/#/transactions</a></li></ul><h6 id="typeorm-äº‹åŠ¡ä½¿ç”¨queryrunnerç±»" tabindex="-1">TypeORM äº‹åŠ¡ä½¿ç”¨QueryRunnerç±» <a class="header-anchor" href="#typeorm-äº‹åŠ¡ä½¿ç”¨queryrunnerç±»" aria-label="Permalink to &quot;TypeORM äº‹åŠ¡ä½¿ç”¨QueryRunnerç±»&quot;">â€‹</a></h6><p>1.å°†Connectionå¯¹è±¡åœ¨æœåŠ¡æä¾›è€…æ³¨å…¥</p><ul><li><p>@Injectable() export class UsersService { constructor(private connection: Connection) {} }</p></li><li><p>Connectionç±»éœ€è¦ä»typeormåŒ…ä¸­å¯¼å…¥</p></li></ul><p>2.ä½¿ç”¨è¿™ä¸ªå¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªäº‹åŠ¡</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> createMany</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">users</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">[]) {</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#E5C07B;"> queryRunner</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">connection</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">createQueryRunner</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">  await</span><span style="color:#E5C07B;"> queryRunner</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">connect</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">  await</span><span style="color:#E5C07B;"> queryRunner</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">startTransaction</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">  try</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    await</span><span style="color:#E5C07B;"> queryRunner</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">manager</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">save</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">users</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#C678DD;">    await</span><span style="color:#E5C07B;"> queryRunner</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">manager</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">save</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">users</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    await</span><span style="color:#E5C07B;"> queryRunner</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">commitTransaction</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  } </span><span style="color:#C678DD;">catch</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">err</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //å¦‚æœé‡åˆ°é”™è¯¯ï¼Œå¯ä»¥å›æ»šäº‹åŠ¡</span></span>
<span class="line"><span style="color:#C678DD;">    await</span><span style="color:#E5C07B;"> queryRunner</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">rollbackTransaction</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  } </span><span style="color:#C678DD;">finally</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //ä½ éœ€è¦æ‰‹åŠ¨å®ä¾‹åŒ–å¹¶éƒ¨ç½²ä¸€ä¸ªqueryRunner</span></span>
<span class="line"><span style="color:#C678DD;">    await</span><span style="color:#E5C07B;"> queryRunner</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">release</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>æ³¨æ„connectionä»…ç”¨äºåˆ›å»ºQueryRunnerã€‚ ç„¶è€Œï¼Œè¦æµ‹è¯•è¿™ä¸ªç±»ï¼Œå°±éœ€è¦æ¨¡æ‹Ÿæ•´ä¸ªConnectionå¯¹è±¡ï¼ˆå®ƒæš´éœ²å‡ºæ¥çš„å‡ ä¸ªæ–¹æ³•ï¼‰ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æ¨èé‡‡ç”¨ä¸€ä¸ªå¸®åŠ©å·¥å‚ç±»ï¼ˆä¹Ÿå°±æ˜¯QueryRunnerFactory)å¹¶ä¸”å®šä¹‰ä¸€ä¸ªåŒ…å«ä»…é™äºç»´æŒäº‹åŠ¡éœ€è¦çš„æ–¹æ³•çš„æ¥å£ã€‚ è¿™ä¸€æŠ€æœ¯è®©æ¨¡æ‹Ÿè¿™äº›æ–¹æ³•å˜å¾—éå¸¸ç›´æ¥ã€‚</li></ul><p>3.å¯é€‰åœ°ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªConnectionå¯¹è±¡çš„å›è°ƒå‡½æ•°é£æ ¼çš„transactionæ–¹æ³•</p><ul><li>æ›´å¤šæ–¹æ³•ï¼š<a href="https://typeorm.io/#/transactions/creating-and-using-transactions" target="_blank" rel="noreferrer">https://typeorm.io/#/transactions/creating-and-using-transactions</a></li></ul><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">async</span><span style="color:#61AFEF;"> createMany</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">users</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">[]) {</span></span>
<span class="line"><span style="color:#C678DD;">  await</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">connection</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">transaction</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#E06C75;font-style:italic;"> manager</span><span style="color:#C678DD;"> =&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    await</span><span style="color:#E5C07B;"> manager</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">save</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">users</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#C678DD;">    await</span><span style="color:#E5C07B;"> manager</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">save</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">users</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#ABB2BF;">  });</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ä¸æ¨èä½¿ç”¨è£…é¥°å™¨æ¥æ§åˆ¶äº‹åŠ¡(@Transaction()å’Œ@TransactionManager())ã€‚</p><h5 id="è®¢é˜…è€…" tabindex="-1">è®¢é˜…è€… <a class="header-anchor" href="#è®¢é˜…è€…" aria-label="Permalink to &quot;è®¢é˜…è€…&quot;">â€‹</a></h5><ul><li>ä½¿ç”¨ TypeORMè®¢é˜…è€…ï¼Œä½ å¯ä»¥ç›‘å¬ç‰¹å®šçš„å®ä½“äº‹ä»¶ï¼š<a href="https://typeorm.io/#/listeners-and-subscribers/what-is-a-subscriber" target="_blank" rel="noreferrer">https://typeorm.io/#/listeners-and-subscribers/what-is-a-subscriber</a></li></ul><h6 id="ä½¿ç”¨ä¾‹å­" tabindex="-1">ä½¿ç”¨ä¾‹å­ <a class="header-anchor" href="#ä½¿ç”¨ä¾‹å­" aria-label="Permalink to &quot;ä½¿ç”¨ä¾‹å­&quot;">â€‹</a></h6><p>1.è®¢é˜…ä¾‹å­</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Connection</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">EntitySubscriberInterface</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">EventSubscriber</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">InsertEvent</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./user.entity&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">EventSubscriber</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> UserSubscriber</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> EntitySubscriberInterface</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">user</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">  constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">connection</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Connection</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">    connection</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">subscribers</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">  listenTo</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> User</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">  beforeInsert</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">event</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">InsertEvent</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">user</span><span style="color:#ABB2BF;">&gt;) {</span></span>
<span class="line"><span style="color:#E5C07B;">    console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">\`BEFORE USER INSERTED: \`</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">entity</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>äº‹ä»¶è®¢é˜…è€…ä¸èƒ½æ˜¯è¯·æ±‚èŒƒå›´çš„</p><ul><li><a href="https://docs.nestjs.com/fundamentals/injection-scopes" target="_blank" rel="noreferrer">https://docs.nestjs.com/fundamentals/injection-scopes</a></li></ul><p>2.å°†UserSubscriberç±»æ·»åŠ åˆ°providersæ•°ç»„</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">Module</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/common&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">TypeOrmModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/typeorm&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./user.entity&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UsersController</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./users.controller&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UsersService</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./users.service&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">UserSubscriber</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./user.subscriber&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forFeature</span><span style="color:#ABB2BF;">([</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">])],</span></span>
<span class="line"><span style="color:#E06C75;">  providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">UsersService</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">UserSubscriber</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">  controllers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">UsersController</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> UsersModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>æ›´å¤šå®ä½“è®¢é˜…è€…å†…å®¹ï¼š<a href="https://typeorm.io/#/listeners-and-subscribers/what-is-a-subscriber" target="_blank" rel="noreferrer">https://typeorm.io/#/listeners-and-subscribers/what-is-a-subscriber</a></p><h5 id="è¿ç§»" tabindex="-1">è¿ç§» <a class="header-anchor" href="#è¿ç§»" aria-label="Permalink to &quot;è¿ç§»&quot;">â€‹</a></h5><ul><li><p>è¿ç§»æä¾›äº†ä¸€ä¸ªåœ¨ä¿å­˜æ•°æ®åº“ä¸­ç°æœ‰æ•°æ®çš„åŒæ—¶å¢é‡å‡çº§æ•°æ®åº“ä½¿å…¶ä¸åº”ç”¨ä¸­çš„æ•°æ®æ¨¡å‹ä¿æŒåŒæ­¥çš„æ–¹æ³•ã€‚</p></li><li><p>TypeORM æä¾›äº†ä¸€ä¸ªä¸“ç”¨CLI å‘½ä»¤è¡Œå·¥å…·ç”¨äºç”Ÿæˆã€è¿è¡Œä»¥åŠå›æ»šè¿ç§»ã€‚</p></li><li><p>è¿ç§»ç±»å’ŒNeståº”ç”¨æºç æ˜¯åˆ†å¼€çš„ã€‚ä»–ä»¬çš„ç”Ÿå‘½å‘¨æœŸç”±TypeORM CLIç®¡ç†ï¼Œå› æ­¤ï¼Œä½ ä¸èƒ½åœ¨è¿ç§»ä¸­ä½¿ç”¨ä¾èµ–æ³¨å…¥å’Œå…¶ä»–Nestä¸“æœ‰ç‰¹æ€§</p></li><li><p>è¯¦æƒ…æŸ¥çœ‹TypeORM æ–‡æ¡£ï¼š<a href="https://typeorm.io/migrations" target="_blank" rel="noreferrer">https://typeorm.io/migrations</a></p></li></ul><h5 id="å¤šä¸ªæ•°æ®åº“" tabindex="-1">å¤šä¸ªæ•°æ®åº“ <a class="header-anchor" href="#å¤šä¸ªæ•°æ®åº“" aria-label="Permalink to &quot;å¤šä¸ªæ•°æ®åº“&quot;">â€‹</a></h5><p>1.åˆ›å»ºå¤šä¸ªæ•°æ®åº“è¿æ¥</p><p>å‡è®¾æœ‰ä¸€ä¸ªAlbum å®ä½“å­˜å‚¨åœ¨æ•°æ®åº“ä¸­</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> defaultOptions</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">  type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;postgres&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  port</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">5432</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  username</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;user&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  password</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;password&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  database</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;db&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  synchronize</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#E5C07B;">    TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#ABB2BF;">      ...</span><span style="color:#E06C75;">defaultOptions</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      host</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;user_db_host&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      entities</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">    }),</span></span>
<span class="line"><span style="color:#E5C07B;">    TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRoot</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#ABB2BF;">      ...</span><span style="color:#E06C75;">defaultOptions</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      name</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;albumsConnection&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      host</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;album_db_host&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      entities</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">Album</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">    }),</span></span>
<span class="line"><span style="color:#ABB2BF;">  ],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>å¦‚æœæœªä¸ºè¿æ¥è®¾ç½®ä»»ä½• name ï¼Œåˆ™è¯¥è¿æ¥çš„åç§°å°†è®¾ç½®ä¸º defaultã€‚ è¯·æ³¨æ„ï¼Œä¸åº”è¯¥æœ‰å¤šä¸ªæ²¡æœ‰åç§°æˆ–åŒåçš„è¿æ¥ï¼Œå¦åˆ™å®ƒä»¬ä¼šè¢«è¦†ç›–ã€‚</p><p>2.å‘Šè¯‰ TypeOrmModule.forFeature() æ–¹æ³•å’Œ @InjectRepository() è£…é¥°å™¨åº”è¯¥ä½¿ç”¨å“ªç§è¿æ¥</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forFeature</span><span style="color:#ABB2BF;">([</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">]), </span><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forFeature</span><span style="color:#ABB2BF;">([</span><span style="color:#E06C75;">Album</span><span style="color:#ABB2BF;">], </span><span style="color:#98C379;">&#39;albumsConnection&#39;</span><span style="color:#ABB2BF;">)],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AppModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>å¦‚æœä¸ä¼ é€’ä»»ä½•è¿æ¥åç§°ï¼Œåˆ™ä½¿ç”¨ default è¿æ¥</li></ul><p>3.ä¸ºç»™å®šçš„è¿æ¥æ³¨å…¥ Connection æˆ– EntityManager</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AlbumsService</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">  constructor</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#61AFEF;">InjectConnection</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;albumsConnection&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">    private</span><span style="color:#E06C75;font-style:italic;"> connection</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Connection</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#61AFEF;">InjectEntityManager</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;albumsConnection&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">    private</span><span style="color:#E06C75;font-style:italic;"> entityManager</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">EntityManager</span></span>
<span class="line"><span style="color:#ABB2BF;">  ) {}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h5 id="æµ‹è¯•" tabindex="-1">æµ‹è¯• <a class="header-anchor" href="#æµ‹è¯•" aria-label="Permalink to &quot;æµ‹è¯•&quot;">â€‹</a></h5><p>åœ¨å•å…ƒæµ‹è¯•æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›é¿å…ä»»ä½•æ•°æ®åº“è¿æ¥ï¼Œä»è€Œä½¿æˆ‘ä»¬çš„æµ‹è¯•é€‚åˆäºç‹¬ç«‹ï¼Œå¹¶ä½¿å®ƒä»¬çš„æ‰§è¡Œè¿‡ç¨‹å°½å¯èƒ½å¿«ã€‚ä½†æ˜¯æˆ‘ä»¬çš„ç±»å¯èƒ½ä¾èµ–äºä»è¿æ¥å®ä¾‹ä¸­æå–çš„å­˜å‚¨åº“ã€‚é‚£æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li><p>è§£å†³æ–¹æ¡ˆ</p><ul><li><p>åˆ›å»ºå‡å­˜å‚¨åº“ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬è®¾ç½®äº†[è‡ªå®šä¹‰æä¾›è€…]</p></li><li><p>äº‹å®ä¸Šï¼Œæ¯ä¸ªæ³¨å†Œçš„å­˜å‚¨åº“éƒ½ç”± entitynamereposition æ ‡è®°è¡¨ç¤ºï¼Œå…¶ä¸­ EntityName æ˜¯å®ä½“ç±»çš„åç§°ã€‚</p></li></ul></li></ul><p>getRepositoryToken() å‡½æ•°</p><p>@nestjs/typeorm åŒ…æä¾›äº†åŸºäºç»™å®šå®ä½“è¿”å›å‡†å¤‡å¥½ token çš„ getRepositoryToken() å‡½æ•°</p><p>1.ä½¿ç”¨</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  providers</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#E06C75;">    UsersService</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    {</span></span>
<span class="line"><span style="color:#E06C75;">      provide</span><span style="color:#ABB2BF;">: </span><span style="color:#61AFEF;">getRepositoryToken</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">User</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">      // ä½¿ç”¨mockRepository ä½œä¸º UsersRepository</span></span>
<span class="line"><span style="color:#E06C75;">      useValue</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">mockRepository</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    },</span></span>
<span class="line"><span style="color:#ABB2BF;">  ],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> UsersModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>ä½¿ç”¨mockRepository ä½œä¸º UsersRepository æ¯å½“ä»»ä½•æä¾›ç¨‹åºä½¿ç”¨ @InjectRepository() è£…é¥°å™¨è¯·æ±‚ UsersRepository æ—¶, Nest ä¼šä½¿ç”¨æ³¨å†Œçš„ mockRepository å¯¹è±¡ã€‚</li></ul><h5 id="å®šåˆ¶å­˜å‚¨åº“" tabindex="-1">å®šåˆ¶å­˜å‚¨åº“ <a class="header-anchor" href="#å®šåˆ¶å­˜å‚¨åº“" aria-label="Permalink to &quot;å®šåˆ¶å­˜å‚¨åº“&quot;">â€‹</a></h5><p>TypeORM æä¾›ç§°ä¸ºè‡ªå®šä¹‰å­˜å‚¨åº“çš„åŠŸèƒ½ï¼š<a href="https://typeorm.io/custom-repository" target="_blank" rel="noreferrer">https://typeorm.io/custom-repository</a></p><p>è‡ªå®šä¹‰å­˜å‚¨åº“å…è®¸æ‚¨æ‰©å±•åŸºæœ¬å­˜å‚¨åº“ç±»ï¼Œå¹¶ä½¿ç”¨å‡ ç§ç‰¹æ®Šæ–¹æ³•å¯¹å…¶è¿›è¡Œä¸°å¯Œ</p><p>1.ä½¿ç”¨ @EntityRepository() è£…é¥°å™¨å’Œæ‰©å±• Repository ç±» åˆ›å»ºè‡ªå®šä¹‰å­˜å‚¨åº“</p><ul><li><p>@EntityRepository(Author) export class AuthorRepository extends Repository {}</p></li><li><p>@EntityRepository() å’Œ Repository æ¥è‡ª typeorm åŒ…</p></li></ul><p>2.å°†å®ä¾‹åŒ–è´£ä»»ç§»äº¤ç»™ Nest å°† AuthorRepository ç±»ä¼ é€’ç»™ TypeOrm.forFeature() å‡½æ•°</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Module</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forFeature</span><span style="color:#ABB2BF;">([</span><span style="color:#E06C75;">AuthorRepository</span><span style="color:#ABB2BF;">])],</span></span>
<span class="line"><span style="color:#E06C75;">  controller</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">AuthorController</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">  providers</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">AuthorService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">})</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AuthorModule</span><span style="color:#ABB2BF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>3.æ³¨å…¥å­˜å‚¨åº“</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> AuthorService</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">  constructor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> readonly</span><span style="color:#E06C75;font-style:italic;"> authorRepository</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">AuthorRepository</span><span style="color:#ABB2BF;">) {}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="å¼‚æ­¥é…ç½®" tabindex="-1">å¼‚æ­¥é…ç½® <a class="header-anchor" href="#å¼‚æ­¥é…ç½®" aria-label="Permalink to &quot;å¼‚æ­¥é…ç½®&quot;">â€‹</a></h5><p>å¼‚æ­¥ä¼ é€’æ¨¡å—é€‰é¡¹ï¼šforRootAsync() å‡½æ•°ï¼Œ æä¾›äº†å‡ ç§å¤„ç†å¼‚æ­¥æ•°æ®çš„æ–¹æ³•</p><h6 id="_1-ä½¿ç”¨å·¥å‚å‡½æ•°" tabindex="-1">1.ä½¿ç”¨å·¥å‚å‡½æ•° <a class="header-anchor" href="#_1-ä½¿ç”¨å·¥å‚å‡½æ•°" aria-label="Permalink to &quot;1.ä½¿ç”¨å·¥å‚å‡½æ•°&quot;">â€‹</a></h6><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRootAsync</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#61AFEF;">  useFactory</span><span style="color:#ABB2BF;">: () </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> ({</span></span>
<span class="line"><span style="color:#E06C75;">    type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;mysql&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    host</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;localhost&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    port</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">3306</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    username</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    password</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    database</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;test&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    entities</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">__dirname</span><span style="color:#56B6C2;"> +</span><span style="color:#98C379;"> &#39;/**/*.entity{.ts,.js}&#39;</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">    synchronize</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  }),</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>å·¥å‚çš„è¡Œä¸ºä¸ä»»ä½•å…¶ä»–å¼‚æ­¥æä¾›è€…ä¸€æ ·(ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œå¹¶ä¸”å®ƒèƒ½å¤Ÿé€šè¿‡injectæ³¨å…¥ä¾èµ–)ã€‚å¦‚ä¸‹</li></ul><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRootAsync</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  imports</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">ConfigModule</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#61AFEF;">  useFactory</span><span style="color:#ABB2BF;">: (</span><span style="color:#E06C75;font-style:italic;">configService</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">ConfigService</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> ({</span></span>
<span class="line"><span style="color:#E06C75;">    type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;mysql&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    host</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">configService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">&gt;(</span><span style="color:#98C379;">&#39;HOST&#39;</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#E06C75;">    port</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">configService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">&gt;(</span><span style="color:#98C379;">&#39;PORT&#39;</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#E06C75;">    username</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">configService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">&gt;(</span><span style="color:#98C379;">&#39;USERNAME&#39;</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#E06C75;">    password</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">configService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">&gt;(</span><span style="color:#98C379;">&#39;PASSWORD&#39;</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#E06C75;">    database</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">configService</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">&gt;(</span><span style="color:#98C379;">&#39;DATABASE&#39;</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#E06C75;">    entities</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">__dirname</span><span style="color:#56B6C2;"> +</span><span style="color:#98C379;"> &#39;/**/*.entity{.ts,.js}&#39;</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">    synchronize</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  }),</span></span>
<span class="line"><span style="color:#E06C75;">  inject</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">ConfigService</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h6 id="_2-ä½¿ç”¨useclassè¯­æ³•" tabindex="-1">2.ä½¿ç”¨useClassè¯­æ³• <a class="header-anchor" href="#_2-ä½¿ç”¨useclassè¯­æ³•" aria-label="Permalink to &quot;2.ä½¿ç”¨useClassè¯­æ³•&quot;">â€‹</a></h6><p>1.åœ¨ TypeOrmConfigService å®ç° TypeOrmOptionsFactory çš„æ¥å£</p><p>åœ¨TypeOrmModuleå†…éƒ¨å®ä¾‹åŒ–TypeOrmConfigServiceï¼Œå¹¶é€šè¿‡è°ƒç”¨createTypeOrmOptions()</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#61AFEF;">Injectable</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#C678DD;">class</span><span style="color:#E5C07B;"> TypeOrmConfigService</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> TypeOrmOptionsFactory</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">  createTypeOrmOptions</span><span style="color:#ABB2BF;">(): </span><span style="color:#E5C07B;">TypeOrmModuleOptions</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">      type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;mysql&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      host</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;localhost&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      port</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">3306</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      username</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      password</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      database</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;test&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">      entities</span><span style="color:#ABB2BF;">: [</span><span style="color:#E06C75;">__dirname</span><span style="color:#56B6C2;"> +</span><span style="color:#98C379;"> &#39;/**/*.entity{.ts,.js}&#39;</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">      synchronize</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    };</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>2.useClassè¯­æ³•è°ƒç”¨</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">TypeOrmModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forRootAsync</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">  useClass</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">TypeOrmConfigService</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>å°† TypeOrmConfigService åœ¨å†…éƒ¨è¿›è¡Œå®ä¾‹åŒ– TypeOrmModuleï¼Œå¹¶å°†åˆ©ç”¨å®ƒæ¥åˆ›å»ºé€‰é¡¹å¯¹è±¡ã€‚</li></ul><p>3.ä½¿ç”¨ useExisting è¯­æ³•è°ƒç”¨</p><ul><li><p>é˜²æ­¢åœ¨ TypeOrmModule ä¸­åˆ›å»º TypeOrmConfigService å¹¶ä½¿ç”¨ä»ä¸åŒæ¨¡å—å¯¼å…¥çš„æä¾›ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨ useExisting è¯­æ³•</p></li><li><p>TypeOrmModule.forRootAsync({ imports: [ConfigModule], useExisting: ConfigService, });</p></li><li><p>è¿™ä¸ªæ„é€ ä¸ useClass çš„å·¥ä½œåŸç†ç›¸åŒï¼Œä½†æœ‰ä¸€ä¸ªå…³é”®çš„åŒºåˆ« â€” TypeOrmModule å°†æŸ¥æ‰¾å¯¼å…¥çš„æ¨¡å—æ¥é‡ç”¨ç°æœ‰çš„ ConfigServiceï¼Œè€Œä¸æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„ ConfigService</p></li></ul><p>é›†æˆä¾‹å­ï¼š<a href="https://github.com/nestjs/nest/tree/master/sample/05-sql-typeorm" target="_blank" rel="noreferrer">https://github.com/nestjs/nest/tree/master/sample/05-sql-typeorm</a></p><h3 id="sequelizeé›†æˆ" tabindex="-1">Sequelizeé›†æˆ <a class="header-anchor" href="#sequelizeé›†æˆ" aria-label="Permalink to &quot;Sequelizeé›†æˆ&quot;">â€‹</a></h3><ul><li><p>Sequelize é›†æˆ</p><ul><li><a href="https://docs.nestjs.cn/8/techniques?id=sequelize-%e9%9b%86%e6%88%90" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/techniques?id=sequelize-é›†æˆ</a></li></ul></li><li><p>ä»‹ç»</p><ul><li><p>å¦ä¸€ä¸ªä½¿ç”¨TypeORMçš„é€‰æ‹©æ˜¯ä½¿ç”¨@nestjs/sequelizeåŒ…ä¸­çš„Sequelize ROM</p></li><li><p>æˆ‘ä»¬ä½¿ç”¨sequelize-typescriptåŒ…æ¥æä¾›ä¸€ç³»åˆ—é¢å¤–çš„è£…é¥°å™¨ä»¥å£°æ˜å®ä½“ã€‚</p></li><li><p>Sequelizeæ”¯æŒå¾ˆå¤šç§å…³ç³»æ•°æ®åº“ï¼Œä¾‹å¦‚PostgreSQL,MySQL,Microsoft SQL Server,SQLiteä»¥åŠMariaDB</p></li></ul></li><li><p>åŸºæœ¬ä½¿ç”¨</p><ul><li><p>1.å®‰è£…éœ€è¦çš„ä¾èµ– MySQLå…³ç³»æ•°æ®åº“ä¸ºä¾‹</p><ul><li><p>ä¹Ÿé€‚åˆå…¶ä»–ä»»ä½•Sequelizeæ”¯æŒçš„æ•°æ®åº“ï¼Œ æŒ‰éœ€å®‰è£…æ‰€é€‰æ•°æ®åº“ç›¸åº”çš„å®¢æˆ·ç«¯ API åº“å°±å¯ä»¥</p></li><li><p>å®‰è£…</p><ul><li><p>npm install --save @nestjs/sequelize sequelize sequelize-typescript mysql2</p></li><li><p>npm install --save-dev @types/sequelize</p></li></ul></li></ul></li><li><p>2.å°†SequelizeModuleå¯¼å…¥åˆ°æ ¹AppModuleä¸­</p><ul><li><p>// app.module.ts import { Module } from &#39;@nestjs/common&#39;; import { SequelizeModule } from &#39;@nestjs/sequelize&#39;; @Module({ imports: [ SequelizeModule.forRoot({ dialect: &#39;mysql&#39;, host: &#39;localhost&#39;, port: 3306, username: &#39;root&#39;, password: &#39;root&#39;, database: &#39;test&#39;, models: [], }), ], }) export class AppModule {}</p></li><li><p>forRoot()æ–¹æ³•æ”¯æŒæ‰€æœ‰Sequelizeæ„é€ å™¨æš´éœ²çš„é…ç½®å±æ€§</p><ul><li><p>(äº†è§£æ›´å¤š)</p></li><li><p><a href="https://sequelize.org/v5/manual/getting-started.html#setting-up-a-connection" target="_blank" rel="noreferrer">https://sequelize.org/v5/manual/getting-started.html#setting-up-a-connection</a></p></li></ul></li><li><p>é¢å¤–çš„é…ç½®å±æ€§</p><ul><li><p>retryAttempts</p><ul><li>å°è¯•è¿æ¥æ•°æ®åº“çš„æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š10ï¼‰</li></ul></li><li><p>retryDelay</p><ul><li>ä¸¤æ¬¡è¿æ¥ä¹‹é—´é—´éš”æ—¶é—´(ms)(é»˜è®¤ï¼š3000)</li></ul></li><li><p>autoLoadModels</p><ul><li>å¦‚æœä¸ºtrueï¼Œæ¨¡å‹å°†è‡ªåŠ¨è½½å…¥ï¼ˆé»˜è®¤:false)</li></ul></li><li><p>keepConnectionAlive</p><ul><li>å¦‚æœä¸ºtrueï¼Œåœ¨åº”ç”¨å…³é—­åè¿æ¥å°†ä¸ä¼šå…³é—­ï¼ˆé»˜è®¤:false)</li></ul></li><li><p>synchronize</p><ul><li>å¦‚æœä¸ºtrueï¼Œè‡ªåŠ¨è½½å…¥çš„æ¨¡å‹å°†åŒæ­¥ï¼ˆé»˜è®¤ï¼šfalseï¼‰</li></ul></li></ul></li></ul></li><li><p>3.Sequelizeå¯¹è±¡æ³¨å…¥åˆ°æ•´ä¸ªé¡¹ç›®ä¸­ app.service.ts</p><ul><li>import { Injectable } from &#39;@nestjs/common&#39;; import { Sequelize } from &#39;sequelize-typescript&#39;; @Injectable() export class AppService { constructor(private sequelize: Sequelize) {} }</li></ul></li></ul></li><li><p>Sequelizeæ¨¡å¼ä»‹ç»å’Œä½¿ç”¨</p><ul><li><p>æ¨¡å‹</p></li><li><p>å…³ç³»</p></li><li><p>è‡ªåŠ¨è½½å…¥æ¨¡å‹</p></li><li><p>äº‹åŠ¡</p></li><li><p>è¿ç§»</p></li><li><p>å¤šä¸ªæ•°æ®åº“</p></li><li><p>æµ‹è¯•</p></li><li><p>å¼‚æ­¥é…ç½®</p></li></ul></li></ul><h3 id="mongo" tabindex="-1">Mongo <a class="header-anchor" href="#mongo" aria-label="Permalink to &quot;Mongo&quot;">â€‹</a></h3><ul><li><p>Mongo</p><ul><li><a href="https://docs.nestjs.cn/8/techniques?id=mongo" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/techniques?id=mongo</a></li></ul></li><li><p>ä»‹ç»</p></li><li><p>åŸºæœ¬ä½¿ç”¨</p></li><li><p>Mongoæ¨¡å¼çš„ä»‹ç»å’Œä½¿ç”¨</p><ul><li><p>æ¨¡å‹æ³¨å…¥</p></li><li><p>è¿æ¥</p></li><li><p>é’©å­ï¼ˆä¸­é—´ä»¶ï¼‰</p></li><li><p>æ’ä»¶</p></li><li><p>æµ‹è¯•</p></li><li><p>å¼‚æ­¥é…ç½®</p></li><li><p>ä¾‹å­</p><ul><li><a href="https://github.com/nestjs/nest/tree/master/sample/06-mongoose" target="_blank" rel="noreferrer">https://github.com/nestjs/nest/tree/master/sample/06-mongoose</a></li></ul></li></ul></li></ul><h2 id="swaggerç”Ÿæˆapiæ–‡æ¡£-openapi" tabindex="-1">swaggerç”ŸæˆAPIæ–‡æ¡£ ï¼ˆOpenAPIï¼‰ <a class="header-anchor" href="#swaggerç”Ÿæˆapiæ–‡æ¡£-openapi" aria-label="Permalink to &quot;swaggerç”ŸæˆAPIæ–‡æ¡£ ï¼ˆOpenAPIï¼‰&quot;">â€‹</a></h2><h3 id="æ–‡æ¡£" tabindex="-1">æ–‡æ¡£ <a class="header-anchor" href="#æ–‡æ¡£" aria-label="Permalink to &quot;æ–‡æ¡£&quot;">â€‹</a></h3><p><a href="https://docs.nestjs.cn/8/openapi" target="_blank" rel="noreferrer">https://docs.nestjs.cn/8/openapi</a></p><h3 id="_1-å®‰è£…ä¾èµ–-1" tabindex="-1">1.å®‰è£…ä¾èµ– <a class="header-anchor" href="#_1-å®‰è£…ä¾èµ–-1" aria-label="Permalink to &quot;1.å®‰è£…ä¾èµ–&quot;">â€‹</a></h3><p>express</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span><span style="color:#D19A66;"> --save</span><span style="color:#98C379;"> @nestjs/swagger</span><span style="color:#98C379;"> swagger-ui-express</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>fastify</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span><span style="color:#D19A66;"> --save</span><span style="color:#98C379;"> @nestjs/swagger</span><span style="color:#98C379;"> fastify-swagger</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_2-ä½¿ç”¨-1" tabindex="-1">2.ä½¿ç”¨ <a class="header-anchor" href="#_2-ä½¿ç”¨-1" aria-label="Permalink to &quot;2.ä½¿ç”¨&quot;">â€‹</a></h3><p>1).main.tsé‡Œé¢æ·»åŠ </p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">NestFactory</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/core&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">DocumentBuilder</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">SwaggerModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;@nestjs/swagger&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./app.module&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">logger</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;./logger.middleware&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> bootstrap</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> await</span><span style="color:#E5C07B;"> NestFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">AppModule</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // ç”Ÿæˆswaggeræ–‡æ¡£</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#E5C07B;"> config</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> DocumentBuilder</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">setTitle</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;åšå®¢æ–‡æ¡£&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">setDescription</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;åšå®¢æ–‡æ¡£APIç¤ºä¾‹&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">setVersion</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;1.0&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">addTag</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;cats&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">build</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#E5C07B;"> document</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> SwaggerModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">createDocument</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">app</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">config</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">  SwaggerModule</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setup</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;api&#39;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">app</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // ä½¿ç”¨å…¨å±€ä¸­é—´ä»¶ï¼šåªèƒ½ä½¿ç”¨å‡½æ•°å½¢å¼</span></span>
<span class="line"><span style="color:#E5C07B;">  app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">logger</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // ç›‘å¬ç«¯å£</span></span>
<span class="line"><span style="color:#C678DD;">  await</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3000</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#61AFEF;">bootstrap</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>2).åˆ›å»ºæ–‡æ¡£ç›®å½•æ¨¡æ¿</p><ul><li><p>1.æ‰§è¡Œï¼šnest g res products å‘½ä»¤</p></li><li><p>2.é€‰æ‹©ç”Ÿæˆé€‰é¡¹</p></li><li><p>3.è¾“å…¥yç¡®å®š</p></li></ul><p>3).OpenAPIè£…é¥°å™¨</p><ul><li><p>class Product { @ApiProperty({ description: &#39;äº§å“åç§°&#39;, }) name: string; }</p><ul><li>è¯·æ±‚è¯´æ˜ï¼šå’Œ@ApiResponse çš„ type å±æ€§é…åˆä½¿ç”¨</li></ul></li><li><p>@ApiTags(&quot;&#39;äº§å“-product&#39;&quot;)</p><ul><li>è£…é¥°ç±»çš„åå­—</li></ul></li><li><p>@ApiResponse( { status: 200, type: [Product], } )</p><ul><li>è¯·æ±‚æ–¹æ³•è¿”å›</li></ul></li><li><p>@ApiQuery( { name: &#39;page&#39;, description: &#39;é¡µç &#39;, type: Number, } )</p><ul><li>æ¥å£è¯·æ±‚å‚æ•°Parametersæ </li></ul></li><li><p>@ApiOperation({ summary: &#39;æŸ¥è¯¢æ‰€æœ‰äº§å“&#39; })</p><ul><li>æ¥å£è¯´æ˜</li></ul></li><li><p>...</p></li></ul>`,676)]))}const A=n(t,[["render",c]]);export{d as __pageData,A as default};
