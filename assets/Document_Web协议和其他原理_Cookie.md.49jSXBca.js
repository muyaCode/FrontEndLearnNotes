import{_ as n,c as a,o as l,ah as p}from"./chunks/framework.DqD713j2.js";const F=JSON.parse('{"title":"Cookie","description":"","frontmatter":{},"headers":[],"relativePath":"Document/Web协议和其他原理/Cookie.md","filePath":"Document/Web协议和其他原理/Cookie.md","lastUpdated":1750954157000}'),o={name:"Document/Web协议和其他原理/Cookie.md"};function e(t,s,r,c,B,y){return l(),a("div",null,s[0]||(s[0]=[p(`<h1 id="cookie" tabindex="-1">Cookie <a class="header-anchor" href="#cookie" aria-label="Permalink to &quot;Cookie&quot;">​</a></h1><h2 id="_1-cookie-是什么" tabindex="-1">1. cookie 是什么 <a class="header-anchor" href="#_1-cookie-是什么" aria-label="Permalink to &quot;1. cookie 是什么&quot;">​</a></h2><ul><li>HTTP1.0 中协议是无状态的，但在 WEB 应用中，在多个请求之间共享会话是非常必要的，所以出现了 Cookie</li><li>cookie 是为了辩别用户身份，进行会话跟踪而<em>存储在客户端</em>上的数据</li></ul><h2 id="_2-cookie-的处理流程" tabindex="-1">2. Cookie 的处理流程 <a class="header-anchor" href="#_2-cookie-的处理流程" aria-label="Permalink to &quot;2. Cookie 的处理流程&quot;">​</a></h2><h2 id="_3-使用步骤" tabindex="-1">3. 使用步骤 <a class="header-anchor" href="#_3-使用步骤" aria-label="Permalink to &quot;3. 使用步骤&quot;">​</a></h2><h3 id="_3-1-服务器发送-cookie" tabindex="-1">3.1 服务器发送 cookie <a class="header-anchor" href="#_3-1-服务器发送-cookie" aria-label="Permalink to &quot;3.1 服务器发送 cookie&quot;">​</a></h3><p>客户端第一次访问服务器的时候服务器通过响应头向客户端发送 Cookie,属性之间用分号空格分隔</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">Set</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">Cookie</span><span style="color:#ABB2BF;">:</span><span style="color:#E06C75;">name</span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;">zfpx</span><span style="color:#ABB2BF;">; </span><span style="color:#E06C75;">Path</span><span style="color:#56B6C2;">=/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_3-2-客户端接收保存-cookie" tabindex="-1">3.2 客户端接收保存 cookie <a class="header-anchor" href="#_3-2-客户端接收保存-cookie" aria-label="Permalink to &quot;3.2 客户端接收保存 cookie&quot;">​</a></h3><p>客户端接收到 Cookie 之后保存在本地</p><h3 id="_3-3-客户端发送-cookie" tabindex="-1">3.3 客户端发送 cookie <a class="header-anchor" href="#_3-3-客户端发送-cookie" aria-label="Permalink to &quot;3.3 客户端发送 cookie&quot;">​</a></h3><p>以后客户端再请求服务器的时候会把此 Cookie 发送到服务器端</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">Cookie</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> zfpx</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="_4-cookie-重要属性" tabindex="-1">4. cookie 重要属性 <a class="header-anchor" href="#_4-cookie-重要属性" aria-label="Permalink to &quot;4. cookie 重要属性&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">属性</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">name=value</td><td style="text-align:left;">键值对，可以设置要保存的 Key/Value</td></tr><tr><td style="text-align:left;">Domain</td><td style="text-align:left;">域名，默认是当前域名</td></tr><tr><td style="text-align:left;">maxAge</td><td style="text-align:left;">最大失效时间(毫秒),设置在多少后失效</td></tr><tr><td style="text-align:left;">secure</td><td style="text-align:left;">当 secure 值为 true 时，cookie 在 HTTP 中是无效，在 HTTPS 中才有效</td></tr><tr><td style="text-align:left;">Path</td><td style="text-align:left;">表示 cookie 影响到的路，如 path=/。如果路径不能匹配时，浏览器则不发送这个 Cookie</td></tr><tr><td style="text-align:left;">Expires</td><td style="text-align:left;">过期时间(秒)，在设置的某个时间点后该 Cookie 就会失效，如 expires=Money, 05-Dec-11 11:11:11 GMT</td></tr><tr><td style="text-align:left;">httpOnly</td><td style="text-align:left;">如果在 COOKIE 中设置了<code>httpOnly</code>属性，则通过程序(JS 脚本)将无法读取到 COOKIE 信息，防止 XSS 攻击产生</td></tr></tbody></table><h2 id="_5-在-express-中向客户端发送-cookie" tabindex="-1">5. 在 express 中向客户端发送 cookie <a class="header-anchor" href="#_5-在-express-中向客户端发送-cookie" aria-label="Permalink to &quot;5. 在 express 中向客户端发送 cookie&quot;">​</a></h2><h3 id="_5-1-设置-cookie" tabindex="-1">5.1 设置 cookie <a class="header-anchor" href="#_5-1-设置-cookie" aria-label="Permalink to &quot;5.1 设置 cookie&quot;">​</a></h3><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">cookie</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">name</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">value</span><span style="color:#ABB2BF;">, [, </span><span style="color:#E06C75;">options</span><span style="color:#ABB2BF;">]);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><table tabindex="0"><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">chrome 对应属性</th><th style="text-align:left;">类型</th><th style="text-align:left;">说明</th><th style="text-align:left;">示例</th></tr></thead><tbody><tr><td style="text-align:left;">domain</td><td style="text-align:left;">Domain</td><td style="text-align:left;">String</td><td style="text-align:left;">域名，默认是当前域名</td><td style="text-align:left;"><code>{domain:&#39;a.zfpx.cn&#39;}</code></td></tr><tr><td style="text-align:left;">path</td><td style="text-align:left;">Path</td><td style="text-align:left;">String</td><td style="text-align:left;">路径，默认是/</td><td style="text-align:left;"><code>{path:&#39;/visit&#39;}</code></td></tr><tr><td style="text-align:left;">expires</td><td style="text-align:left;">Expires</td><td style="text-align:left;">Date</td><td style="text-align:left;">过期时间，如果没以有指定或为 0 表示当前会话有效</td><td style="text-align:left;"><code>{expires:new Date(Date.now()+20*1000)}</code></td></tr><tr><td style="text-align:left;">maxAge</td><td style="text-align:left;">Max-Age</td><td style="text-align:left;">Number</td><td style="text-align:left;">有效时间(单位是毫秒)</td><td style="text-align:left;"><code>{maxAge:20*1000}</code></td></tr><tr><td style="text-align:left;">httpOnly</td><td style="text-align:left;">HTTP</td><td style="text-align:left;">Boolean</td><td style="text-align:left;">不能通过浏览器 javascript 访问</td><td style="text-align:left;"><code>{httpOnly:true}</code></td></tr><tr><td style="text-align:left;">secure</td><td style="text-align:left;">Secure</td><td style="text-align:left;">String</td><td style="text-align:left;">只通过 https 协议访问</td><td style="text-align:left;"></td></tr></tbody></table><h3 id="_5-2-获取-cookie" tabindex="-1">5.2 获取 cookie <a class="header-anchor" href="#_5-2-获取-cookie" aria-label="Permalink to &quot;5.2 获取 cookie&quot;">​</a></h3><p>使用 cookie-parser 中间件</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">$</span><span style="color:#E06C75;"> npm</span><span style="color:#E06C75;"> install</span><span style="color:#E06C75;"> cookie</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">parser</span><span style="color:#56B6C2;"> --</span><span style="color:#E06C75;">save</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;cookie-parser&#39;</span><span style="color:#ABB2BF;">)());    </span><span style="color:#7F848E;font-style:italic;">//使用中间件</span></span>
<span class="line"><span style="color:#E5C07B;">response</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">cookie</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">key</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">value</span><span style="color:#ABB2BF;">)              </span><span style="color:#7F848E;font-style:italic;">//在响应中向客户端设置cookie</span></span>
<span class="line"><span style="color:#E5C07B;">request</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookies</span><span style="color:#7F848E;font-style:italic;">                         //获取请求中的cookie对象</span></span>
<span class="line"><span style="color:#E5C07B;">response</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clearCookie</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;username&#39;</span><span style="color:#ABB2BF;">)        </span><span style="color:#7F848E;font-style:italic;">//清除cookie</span></span>
<span class="line"><span style="color:#C678DD;">var</span><span style="color:#E06C75;"> express</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;express&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">var</span><span style="color:#E06C75;"> cookieParser</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;cookie-parser&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">var</span><span style="color:#E06C75;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> express</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"> * 如果要加密的话 cookieParser里要指定密码，而且signed要等于true res.cookie(&#39;name&#39;,&#39;zfpx&#39;,{signed:true});</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">cookieParser</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;zfpx&#39;</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;/write&#39;</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">function</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //1.普通设置</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //res.cookie(&#39;name&#39;,&#39;value&#39;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //2.设置域名</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //res.cookie(&#39;name&#39;,&#39;zfpx&#39;,{domain:&#39;a.zfpx.cn&#39;});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //3.设置路径</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //res.cookie(&#39;name&#39;,&#39;zfpx&#39;,{path:&#39;/visit&#39;});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //4.过期时间</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //res.cookie(&#39;name&#39;,&#39;zfpx&#39;,{expires:new Date(Date.now()+20*1000)});//毫秒</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //res.cookie(&#39;name&#39;,&#39;zfpx&#39;,{maxAge:20*1000});//过期时间 毫秒</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //httpOnly true还是false无意义 document.cookie取不到</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //res.cookie(&#39;name&#39;,&#39;zfpx&#39;,{httpOnly:true});</span></span>
<span class="line"><span style="color:#E5C07B;">    res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">cookie</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;age&#39;</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;">&#39;123&#39;</span><span style="color:#ABB2BF;">,{</span><span style="color:#E06C75;">signed</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">});</span></span>
<span class="line"><span style="color:#E5C07B;">    res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">end</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;ok&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;/read&#39;</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">function</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#E5C07B;">    console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">signedCookies</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">send</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookies</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//记录这是客户端的第几次访问</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;/visit&#39;</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">function</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#E5C07B;">    res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">cookie</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;count&#39;</span><span style="color:#ABB2BF;">,</span><span style="color:#61AFEF;">isNaN</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">cookies</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">count</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;">?</span><span style="color:#D19A66;">0</span><span style="color:#C678DD;">:</span><span style="color:#61AFEF;">parseInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">cookies</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">count</span><span style="color:#ABB2BF;">)</span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">send</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookies</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">9090</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="_5-3-cookie-原理解析" tabindex="-1">5.3 cookie 原理解析 <a class="header-anchor" href="#_5-3-cookie-原理解析" aria-label="Permalink to &quot;5.3 cookie 原理解析&quot;">​</a></h3><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">function</span><span style="color:#61AFEF;"> cookieParser</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">secret</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#C678DD;"> function</span><span style="color:#61AFEF;"> cookieParser</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">next</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#E5C07B;">    req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">secret</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> secret</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">headers</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookie</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#61AFEF;"> next</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#E5C07B;">    req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookies</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;">  require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;querystring&#39;</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">parse</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">headers</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookie</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;">&#39;; &#39;</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;">&#39;=&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">secret</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#E5C07B;">        req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">signedCookies</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> {};</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> attr</span><span style="color:#C678DD;"> in</span><span style="color:#E5C07B;"> req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookies</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#C678DD;">                let</span><span style="color:#E06C75;"> val</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookies</span><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">attr</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#E5C07B;">                req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">signedCookies</span><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">attr</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> unsign</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">val</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">secret</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#61AFEF;">    next</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">function</span><span style="color:#61AFEF;"> cookie</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">name</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">val</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">options</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">    var</span><span style="color:#E06C75;"> opt</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> options</span><span style="color:#56B6C2;"> ||</span><span style="color:#ABB2BF;"> {};</span></span>
<span class="line"><span style="color:#E06C75;">    val</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> encodeURIComponent</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">val</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">secret</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#C678DD;">        var</span><span style="color:#E06C75;"> secret</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">secret</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        val</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> sign</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">val</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">secret</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    var</span><span style="color:#E06C75;"> pairs</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#E06C75;">name</span><span style="color:#56B6C2;"> +</span><span style="color:#98C379;"> &#39;=&#39;</span><span style="color:#56B6C2;"> +</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">null</span><span style="color:#56B6C2;"> !=</span><span style="color:#E5C07B;"> opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">maxAge</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        var</span><span style="color:#E06C75;"> maxAge</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">maxAge</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">isNaN</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">maxAge</span><span style="color:#ABB2BF;">)) </span><span style="color:#C678DD;">throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Error</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;maxAge should be a Number&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        pairs</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;Max-Age=&#39;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> Math</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">floor</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">maxAge</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">domain</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        pairs</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;Domain=&#39;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">domain</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">path</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        pairs</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;Path=&#39;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">path</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">expires</span><span style="color:#ABB2BF;">) </span><span style="color:#E5C07B;">pairs</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;Expires=&#39;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">expires</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">toUTCString</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">httpOnly</span><span style="color:#ABB2BF;">) </span><span style="color:#E5C07B;">pairs</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;HttpOnly=true&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">opt</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">secure</span><span style="color:#ABB2BF;">) </span><span style="color:#E5C07B;">pairs</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;Secure=true&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> pairs</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;; &#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">var</span><span style="color:#E06C75;"> crypto</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;crypto&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">exports</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">sign</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> function</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">val</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">secret</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#E06C75;"> val</span><span style="color:#56B6C2;"> +</span><span style="color:#98C379;"> &#39;.&#39;</span><span style="color:#56B6C2;"> +</span><span style="color:#E06C75;"> crypto</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">createHmac</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;sha256&#39;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">secret</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">update</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">val</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">digest</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;base64&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">replace</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">/</span><span style="color:#56B6C2;">\\=</span><span style="color:#D19A66;">+</span><span style="color:#C678DD;">$</span><span style="color:#E06C75;">/</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&#39;&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">exports</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unsign</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> function</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">val</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">secret</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#C678DD;">  var</span><span style="color:#E06C75;"> str</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> val</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">slice</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">val</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">lastIndexOf</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;.&#39;</span><span style="color:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#ABB2BF;">    , </span><span style="color:#E06C75;">mac</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> exports</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">sign</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">str</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">secret</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#E06C75;"> mac</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> val</span><span style="color:#C678DD;"> ?</span><span style="color:#E06C75;"> str</span><span style="color:#C678DD;"> :</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><h2 id="_6-权限控制" tabindex="-1">6. 权限控制 <a class="header-anchor" href="#_6-权限控制" aria-label="Permalink to &quot;6. 权限控制&quot;">​</a></h2><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">var</span><span style="color:#E06C75;"> express</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;express&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">var</span><span style="color:#E06C75;"> cookieParser</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;cookie-parser&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">var</span><span style="color:#E06C75;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> express</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">set</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;view engine&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;html&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">engine</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;html&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#61AFEF;">require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;ejs&quot;</span><span style="color:#ABB2BF;">).</span><span style="color:#E06C75;">__express</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">set</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;views&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">__dirname</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">cookieParser</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">function</span><span style="color:#61AFEF;"> checkUser</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">next</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">cookies</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> req</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">cookies</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">username</span><span style="color:#ABB2BF;">) </span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">	else</span><span style="color:#E5C07B;"> res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">redirect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//进入登录页</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">function</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">	res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">render</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;index&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//登录</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/login&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">function</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">	res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">cookie</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;username&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">query</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">username</span><span style="color:#ABB2BF;">, { </span><span style="color:#E06C75;">httpOnly</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;"> });</span></span>
<span class="line"><span style="color:#E5C07B;">	res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">redirect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/user&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//用户页面</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/user&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">checkUser</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">function</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">	res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">render</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;user&quot;</span><span style="color:#ABB2BF;">, { </span><span style="color:#E06C75;">username</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">req</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">cookies</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">username</span><span style="color:#ABB2BF;"> });</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//用户退出</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/logout&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">function</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">req</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">res</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">	res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clearCookie</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;username&quot;</span><span style="color:#ABB2BF;">); </span><span style="color:#7F848E;font-style:italic;">//清除cookie</span></span>
<span class="line"><span style="color:#E5C07B;">	res</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">redirect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">8080</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="_7-cookie-使用注意事项" tabindex="-1">7.cookie 使用注意事项 <a class="header-anchor" href="#_7-cookie-使用注意事项" aria-label="Permalink to &quot;7.cookie 使用注意事项&quot;">​</a></h2><ul><li>可能被客户端篡改，使用前验证合法性</li><li>不要存储敏感数据，比如用户密码，账户余额</li><li>使用 httpOnly 保证安全</li><li>尽量减少 cookie 的体积</li><li>设置正确的 domain 和 path，减少数据传输</li></ul>`,28)]))}const A=n(o,[["render",e]]);export{F as __pageData,A as default};
