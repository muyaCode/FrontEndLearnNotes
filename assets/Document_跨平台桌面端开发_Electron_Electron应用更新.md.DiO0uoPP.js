import{_ as n,c as a,o as l,ah as p}from"./chunks/framework.DqD713j2.js";const e="/FrontEndLearnNotes/assets/electron%E6%9B%B4%E6%96%B0.AjHkEArX.jpg",o="/FrontEndLearnNotes/assets/electron%E6%9B%B4%E6%96%B0%E8%BF%9B%E5%BA%A6%E6%9D%A1%E6%96%B9%E6%A1%88.Br1Wbx5U.jpg",r="/FrontEndLearnNotes/assets/Electron%E6%9B%B4%E6%96%B0%E6%8F%90%E9%80%9F--%E5%A2%9E%E9%87%8F%E6%9B%B4%E6%96%B0.C9WcTy__.jpg",F=JSON.parse('{"title":"Electron 应用更新","description":"","frontmatter":{},"headers":[],"relativePath":"Document/跨平台桌面端开发/Electron/Electron应用更新.md","filePath":"Document/跨平台桌面端开发/Electron/Electron应用更新.md","lastUpdated":1750954157000}'),t={name:"Document/跨平台桌面端开发/Electron/Electron应用更新.md"};function c(i,s,B,y,u,b){return l(),a("div",null,s[0]||(s[0]=[p(`<h1 id="electron-应用更新" tabindex="-1">Electron 应用更新 <a class="header-anchor" href="#electron-应用更新" aria-label="Permalink to &quot;Electron 应用更新&quot;">​</a></h1><h2 id="体验问题" tabindex="-1">体验问题 <a class="header-anchor" href="#体验问题" aria-label="Permalink to &quot;体验问题&quot;">​</a></h2><h3 id="更新体验" tabindex="-1">更新体验 <a class="header-anchor" href="#更新体验" aria-label="Permalink to &quot;更新体验&quot;">​</a></h3><ul><li>快、影响小</li><li>流畅度、用户等待耗时</li></ul><h3 id="软件更新的难题-权限问题" tabindex="-1">软件更新的难题-权限问题 <a class="header-anchor" href="#软件更新的难题-权限问题" aria-label="Permalink to &quot;软件更新的难题-权限问题&quot;">​</a></h3><p>Windows 系统：UAC &amp; 权限问题</p><h3 id="软件更新的难题-解决方案" tabindex="-1">软件更新的难题-解决方案 <a class="header-anchor" href="#软件更新的难题-解决方案" aria-label="Permalink to &quot;软件更新的难题-解决方案&quot;">​</a></h3><h4 id="更新过程体验" tabindex="-1">更新过程体验 <a class="header-anchor" href="#更新过程体验" aria-label="Permalink to &quot;更新过程体验&quot;">​</a></h4><ul><li>增量更新 <ul><li>包括像 Bsdiff Xdelta 等等</li></ul></li><li>自动更新 <ul><li>用户重启之后就是最新版，如 Chrome 浏览器</li></ul></li></ul><h4 id="uac-问题" tabindex="-1">UAC 问题 <a class="header-anchor" href="#uac-问题" aria-label="Permalink to &quot;UAC 问题&quot;">​</a></h4><ul><li>Windows 计划任务</li><li>Windows Services</li><li>以上两者本质就是在安装的时候去提权，然后常驻在系统中，因此它们的更新过程就不会被限制</li><li>不同的是：就是 Windows 计划任务跟应用程序是没有办法交互的，而 Windows Services 是可以的</li><li>最有效的办法：不操作管理员权限文件、注册表</li></ul><h2 id="盘点桌面端软件更新" tabindex="-1">盘点桌面端软件更新 <a class="header-anchor" href="#盘点桌面端软件更新" aria-label="Permalink to &quot;盘点桌面端软件更新&quot;">​</a></h2><h3 id="一、手动更新" tabindex="-1">一、手动更新 <a class="header-anchor" href="#一、手动更新" aria-label="Permalink to &quot;一、手动更新&quot;">​</a></h3><ul><li>用户手动下载、安装新包</li><li>优点：简单、稳定</li><li>缺点：过程繁琐、慢、影响使用、更新率低</li><li>适合场景：低频更新、用户粘性高、作为各种升级技术的降级方案</li></ul><h4 id="手动更新流程" tabindex="-1">手动更新流程 <a class="header-anchor" href="#手动更新流程" aria-label="Permalink to &quot;手动更新流程&quot;">​</a></h4><p>更新服务 =&gt; 匹配 =&gt; 客户端版本|用户信息</p><p>检查更新器 =&gt; 返回 =&gt; 包地址|版本号|更新文案</p><p>更新引导 =&gt; 提示 =&gt; 新功能|是否升级</p><p>手动更新 =&gt; 手动操作 =&gt; 跳转浏览器|打开安装包覆盖</p><h3 id="二、文件覆盖" tabindex="-1">二、文件覆盖 <a class="header-anchor" href="#二、文件覆盖" aria-label="Permalink to &quot;二、文件覆盖&quot;">​</a></h3><ul><li>程序自动替换文件更新</li><li>优点：下载过程快</li><li>缺点：慢、实现比较复杂、稳定性差、写文件失败</li><li>适合场景：打补丁</li></ul><h4 id="文件覆盖流程" tabindex="-1">文件覆盖流程 <a class="header-anchor" href="#文件覆盖流程" aria-label="Permalink to &quot;文件覆盖流程&quot;">​</a></h4><p>更新服务 =&gt; 匹配 =&gt; 客户端版本|用户信息</p><p>检查更新器 =&gt; 返回 =&gt; 包地址|版本号|更新文案</p><p>更新引导 =&gt; 提示 =&gt; 新功能|是否升级</p><p>文件覆盖 =&gt; 程序操作 =&gt; 吊起子程序|关闭应用|将补丁复制到应用目录|重新启动</p><h3 id="三、自动更新" tabindex="-1">三、自动更新 <a class="header-anchor" href="#三、自动更新" aria-label="Permalink to &quot;三、自动更新&quot;">​</a></h3><ul><li>后台下载文件、重启即新版</li><li>优点：稳定、快、打扰少</li><li>缺点：实现复杂</li><li>适合场景：高频更新软件、体验要求高</li></ul><h4 id="自动更新流程" tabindex="-1">自动更新流程 <a class="header-anchor" href="#自动更新流程" aria-label="Permalink to &quot;自动更新流程&quot;">​</a></h4><p>更新服务 =&gt; 检查更新器 =&gt; 下载新包 =&gt; 重启应用加载新包</p><ul><li>boot：启动入口</li><li>versions：读取版本号 <ul><li>1.0.0</li><li>1.0.1</li></ul></li></ul><h3 id="四、操作系统应用商店更新" tabindex="-1">四、操作系统应用商店更新 <a class="header-anchor" href="#四、操作系统应用商店更新" aria-label="Permalink to &quot;四、操作系统应用商店更新&quot;">​</a></h3><h4 id="windows-app-store-和-mac-app-store" tabindex="-1">Windows App Store 和 Mac App Store <a class="header-anchor" href="#windows-app-store-和-mac-app-store" aria-label="Permalink to &quot;Windows App Store 和 Mac App Store&quot;">​</a></h4><ul><li>通过各平台应用商店发布</li><li>优点：统一、稳定</li><li>缺点：受应用商店局限</li><li>适合场景：操作系统应用商店上架的软件</li></ul><h3 id="软件更新对比" tabindex="-1">软件更新对比 <a class="header-anchor" href="#软件更新对比" aria-label="Permalink to &quot;软件更新对比&quot;">​</a></h3><table tabindex="0"><thead><tr><th>更新方式</th><th>手动更新</th><th>文件覆盖</th><th>自动更新</th><th>操作系统</th></tr></thead><tbody><tr><td>优点</td><td>简单、稳定</td><td>下载过程快</td><td>稳定、快、打扰少</td><td>统一、稳定</td></tr><tr><td>缺点</td><td>过程繁琐、慢、影响使用、更 慢、新率低</td><td>实现比较复杂、稳定性差、写文件失败</td><td>实现复杂</td><td>受应用商店局限</td></tr><tr><td>适用场景</td><td>低频更新、用户粘性高、作为各种升级技术的降级方案</td><td>打补丁</td><td>高频更新软件、体验要求高</td><td>操作系统应用商店上架的软件</td></tr></tbody></table><h2 id="盘点-electron-更新" tabindex="-1">盘点 Electron 更新 <a class="header-anchor" href="#盘点-electron-更新" aria-label="Permalink to &quot;盘点 Electron 更新&quot;">​</a></h2><h3 id="一、web-化" tabindex="-1">一、Web 化 <a class="header-anchor" href="#一、web-化" aria-label="Permalink to &quot;一、Web 化&quot;">​</a></h3><ul><li>将渲染进程(业务)放置在远程 HTTPS</li><li>优点：更新快、体验极好</li><li>缺点：无法离线使用、主进程更新复杂、多版本兼容问题</li><li>场景：重业务、壳子更新少</li></ul><h3 id="二、更新的文件覆盖" tabindex="-1">二、更新的文件覆盖 <a class="header-anchor" href="#二、更新的文件覆盖" aria-label="Permalink to &quot;二、更新的文件覆盖&quot;">​</a></h3><ul><li>属于文件覆盖思路</li><li>如：张鑫旭的更新方法：<a href="https://www.zhangxinxu.com/wordpress/2017/06/how-electron-online-update-hot-fix/?replytocom=361528" target="_blank" rel="noreferrer">https://www.zhangxinxu.com/wordpress/2017/06/how-electron-online-update-hot-fix/?replytocom=361528</a></li></ul><h3 id="三、electron-官方自动更新" tabindex="-1">三、Electron 官方自动更新 <a class="header-anchor" href="#三、electron-官方自动更新" aria-label="Permalink to &quot;三、Electron 官方自动更新&quot;">​</a></h3><p>自动更新文档：<a href="https://www.electronjs.org/zh/docs/latest/api/auto-updater" target="_blank" rel="noreferrer">autoUpdater | Electron (electronjs.org)</a></p><ul><li>基于 Squirrel 框架完成的自动更新：如 <code>electron-builder-squirrel-windows</code> 库</li></ul><h3 id="四、electron-updater" tabindex="-1">四、Electron-Updater <a class="header-anchor" href="#四、electron-updater" aria-label="Permalink to &quot;四、Electron-Updater&quot;">​</a></h3><p>官方文档：</p><ul><li><a href="https://www.electronjs.org/zh/docs/latest/tutorial/%E6%8E%A8%E9%80%81%E6%9B%B4%E6%96%B0%E6%95%99%E7%A8%8B" target="_blank" rel="noreferrer">发布和更新 | Electron (electronjs.org)</a></li><li><a href="https://www.electronjs.org/zh/docs/latest/tutorial/tutorial-publishing-updating" target="_blank" rel="noreferrer">发布和更新 | Electron (electronjs.org)</a></li><li><a href="https://www.electronjs.org/zh/docs/latest/tutorial/updates" target="_blank" rel="noreferrer">更新应用程序 | Electron (electronjs.org)</a></li></ul><p>Electron 官方 Updater 的改版，由 electron-builder 提出</p><ul><li>优点 <ul><li>接入简单</li><li>Windows 支持签名验证</li><li>支持进度条</li><li>基于 electron-builder 非常容易使用</li></ul></li><li>缺点 <ul><li>windows 更新体验没有内置的好</li><li>windows 存在权限问题</li><li>详见：<a href="https://www.electron.build/auto-update.html" target="_blank" rel="noreferrer">https://www.electron.build/auto-update.html</a></li></ul></li></ul><h2 id="更新相关技术" tabindex="-1">更新相关技术 <a class="header-anchor" href="#更新相关技术" aria-label="Permalink to &quot;更新相关技术&quot;">​</a></h2><h3 id="一、增量更新" tabindex="-1">一、增量更新 <a class="header-anchor" href="#一、增量更新" aria-label="Permalink to &quot;一、增量更新&quot;">​</a></h3><ul><li>增量更新：只更新需要更新的地方</li><li>增量包(差分包、补丁包)：新旧包的差异包</li><li>增量技术： <ul><li>bsdiff/bspatch:适用二进制文件、开源、免费、广泛使用 (尤其移动端)</li><li>Xdelta3:适用于二进制</li><li>Courgette: 谷歌提出的方案，是 bsdiff 的优化</li><li>RTPatch:商业付费</li><li>对比参考：<a href="https://www.shangyexin.com/2018/09/28/delta_algorithm/" target="_blank" rel="noreferrer">Xdelta3 bsdiff Courgette 三种差分算法比较 - 尚叶鑫的个人主页 (shangyexin.com)</a></li></ul></li></ul><h4 id="增量更新过程" tabindex="-1">增量更新过程 <a class="header-anchor" href="#增量更新过程" aria-label="Permalink to &quot;增量更新过程&quot;">​</a></h4><ul><li>新版本和旧版本对比：V1.0.0 和 V1.0.1 =&gt; diff =&gt; patch(1.0.0-1.0.1)</li><li>对比出不一样的地方，更新补丁 path：V1.0.0 和 patch(1.0.0-1.0.1) =&gt; patch =&gt; V1.0.1</li></ul><h3 id="二、灰度发布" tabindex="-1">二、灰度发布 <a class="header-anchor" href="#二、灰度发布" aria-label="Permalink to &quot;二、灰度发布&quot;">​</a></h3><ul><li>客户端无法“回滚”</li><li>按一定规则逐渐放量 <ul><li>用户特征</li><li>客户端特征</li><li>随机</li><li>...</li></ul></li></ul><h4 id="灰度发布流程" tabindex="-1">灰度发布流程 <a class="header-anchor" href="#灰度发布流程" aria-label="Permalink to &quot;灰度发布流程&quot;">​</a></h4><p>灰度平台 =&gt; 更新服务 =&gt; 客户端(1.0) | 客户端(1.0) | 客户端(1.1)</p><h2 id="实战-electron-更新" tabindex="-1">实战 Electron 更新 <a class="header-anchor" href="#实战-electron-更新" aria-label="Permalink to &quot;实战 Electron 更新&quot;">​</a></h2><p>官网文档：<a href="https://www.electronjs.org/zh/docs/latest/tutorial/updates#applying-updates" target="_blank" rel="noreferrer">更新应用程序 | Electron (electronjs.org)</a></p><p>自动更新文档：<a href="https://www.electronjs.org/zh/docs/latest/api/auto-updater" target="_blank" rel="noreferrer">autoUpdater | Electron (electronjs.org)</a></p><h3 id="mac-客户端更新-服务端" tabindex="-1">Mac 客户端更新-服务端 <a class="header-anchor" href="#mac-客户端更新-服务端" aria-label="Permalink to &quot;Mac 客户端更新-服务端&quot;">​</a></h3><p>有返回</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;url&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;https://mycompany.example.com/myapp/releases/myrelease&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;name&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;My Release Name&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;notes&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;Theses are some release notes innit&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">	&quot;pub date&quot;</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;2023-09-18T12:29:53+01:00&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>无返回</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">status=</span><span style="color:#D19A66;">204</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="mac-客户端更新-客户端需求" tabindex="-1">Mac 客户端更新-客户端需求 <a class="header-anchor" href="#mac-客户端更新-客户端需求" aria-label="Permalink to &quot;Mac 客户端更新-客户端需求&quot;">​</a></h3><ul><li>证书 <ul><li>一般 Developerld 证书就够用了</li><li>本机测试：自建证书流程 <ul><li>打开钥匙串 -&gt; 顶部菜单栏 “钥匙串访问” -&gt; 证书助理 -&gt; 创建证书</li><li>创建证书：填写名称、身份类型：自签名、证书类型：代码签名</li><li>信任证书：证书的钥匙串搜索出创建好的证书 -&gt; 双击证书 -&gt; 信任 -&gt; 始终信任证书</li></ul></li></ul></li></ul><h3 id="mac-客户端更新" tabindex="-1">Mac 客户端更新 <a class="header-anchor" href="#mac-客户端更新" aria-label="Permalink to &quot;Mac 客户端更新&quot;">​</a></h3><p>使用的 electron API 和 事件</p><ul><li>const { autoUpdater } = require(&#39;electron&#39;);</li><li>autoUpdater.setFeedUrl(更新服务 url);</li><li>autoUpdater.checkForUpdate();</li><li>autoUpdater.quitAndInstall();</li><li>监听事件：&#39;update-available&#39;、&#39;update-downloaded&#39;、&#39;error&#39;</li></ul><h4 id="流程示意" tabindex="-1">流程示意 <a class="header-anchor" href="#流程示意" aria-label="Permalink to &quot;流程示意&quot;">​</a></h4><p>检查更新( checkForUpdate) =&gt; 下载包 =&gt; 安装包 (quitAndInstall) =&gt; 替换文件</p><h4 id="使用-dialog-原生系统对话框模块-弹出更新提示对话框" tabindex="-1">使用 dialog 原生系统对话框模块 弹出更新提示对话框 <a class="header-anchor" href="#使用-dialog-原生系统对话框模块-弹出更新提示对话框" aria-label="Permalink to &quot;使用 dialog 原生系统对话框模块 弹出更新提示对话框&quot;">​</a></h4><ul><li>用于打开和保存文件、警报等的本机系统对话框</li><li>dialog.showMessageBox</li><li>dialog.showOpenDialog</li><li>dialog.showSaveDialog</li><li>Promise、也支持 Sync 方法</li></ul><h3 id="一、mac-系统软件客户端更新服务" tabindex="-1">一、Mac 系统软件客户端更新服务 <a class="header-anchor" href="#一、mac-系统软件客户端更新服务" aria-label="Permalink to &quot;一、Mac 系统软件客户端更新服务&quot;">​</a></h3><p>1.新建<code>updater-server</code>目录</p><p>2.npm init 初始化 Node</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> init</span><span style="color:#D19A66;"> -y</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>3.安装 koa 相关依赖和 compare-versions 版本检测库</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">yarn</span><span style="color:#98C379;"> add</span><span style="color:#98C379;"> koa</span><span style="color:#98C379;"> koa-router</span><span style="color:#98C379;"> koa-static-server</span><span style="color:#98C379;"> compare-versions</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 或</span></span>
<span class="line"><span style="color:#61AFEF;">npm</span><span style="color:#98C379;"> install</span><span style="color:#98C379;"> koa</span><span style="color:#98C379;"> koa-router</span><span style="color:#98C379;"> koa-static-server</span><span style="color:#98C379;"> compare-versions</span><span style="color:#D19A66;"> --save</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>4.根目录新建 index.js 文件，写入以下代码</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> Koa</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;koa&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Koa</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> Router</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;koa-router&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> router</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Router</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> server</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;koa-static-server&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> compareVersions</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;compare-versions&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 获取最新的版本</span></span>
<span class="line"><span style="color:#C678DD;">function</span><span style="color:#61AFEF;"> getNewVersion</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">versions</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">versions</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">	let</span><span style="color:#E06C75;"> maxVersion</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">		name</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;1.0.1&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">		pub_date</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;2023-02-01T12:26:53+1:00&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">		notes</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;新增功能&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">		url</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;http://127.0.0.1:3385/public/remote_control-1.0.1-mac.zip&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">	};</span></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">compareVersions</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compare</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">maxVersion</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">name</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">versions</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;&gt;&quot;</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E06C75;"> maxVersion</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#C678DD;">	return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Mac系统客户端更新</span></span>
<span class="line"><span style="color:#E5C07B;">router</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/darwin&quot;</span><span style="color:#ABB2BF;">, (</span><span style="color:#E06C75;font-style:italic;">ctx</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">next</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// 处理Mac更新，请求后缀：?version=1.0.0&amp;uid=123</span></span>
<span class="line"><span style="color:#C678DD;">	const</span><span style="color:#ABB2BF;"> { </span><span style="color:#E5C07B;">version</span><span style="color:#ABB2BF;"> } </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">query</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">	let</span><span style="color:#E06C75;"> newVersion</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> getNewVersion</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">version</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">newVersion</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">		ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">body</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> newVersion</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	} </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">		ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">status</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 204</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#61AFEF;">	server</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">		rootDir</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;public&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">		rootPath</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;/public&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">	})</span></span>
<span class="line"><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">router</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">routes</span><span style="color:#ABB2BF;">()).</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">router</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">allowedMethods</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> port</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 33855</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">port</span><span style="color:#ABB2BF;">, () </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">	console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">\`软件更新服务运行在：http://localhost: </span><span style="color:#C678DD;">\${</span><span style="color:#E06C75;">port</span><span style="color:#C678DD;">}</span><span style="color:#98C379;">\`</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>5.回到 electron 的 <code>main</code> 主进程中，新建 update.js 文件，写入以下代码</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> { </span><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">autoUpdater</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">dialog</span><span style="color:#ABB2BF;"> } </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;electron&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">process</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">platform</span><span style="color:#56B6C2;"> ==</span><span style="color:#98C379;"> &quot;darwin&quot;</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">	autoUpdater</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setFeedURL</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;">		&quot;http://127.0.0.1:33855/darwin?version=&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getVersion</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">	);</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">process</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">platform</span><span style="color:#56B6C2;"> ==</span><span style="color:#98C379;"> &quot;win32&quot;</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">	autoUpdater</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setFeedURL</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;">		&quot;http://127.0.0.1:33855/win32?version=&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getVersion</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">	);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 定时轮询，服务端推送</span></span>
<span class="line"><span style="color:#E5C07B;">autoUpdater</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">checkForUpdates</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">autoUpdater</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">on</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;update-available&quot;</span><span style="color:#ABB2BF;">, (</span><span style="color:#E06C75;font-style:italic;">e</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">notes</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">version</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// 配合main.js中的&#39;will-finish-launching&#39;的生命周期监听是在app.whenReady().then();之前</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// 提醒用户更新，dialog模块需要在app.whenReady().then();之后才能使用</span></span>
<span class="line"><span style="color:#E5C07B;">	app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">whenReady</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">then</span><span style="color:#ABB2BF;">(() </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		let</span><span style="color:#E06C75;"> clickId</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> dialog</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">showMessageBoxSync</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">			type</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;info&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			title</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;升级提示&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			message</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;已为你升级到最新版，是否立即体验&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">			buttons</span><span style="color:#ABB2BF;">: [</span><span style="color:#98C379;">&quot;马上升级&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;手动重启&quot;</span><span style="color:#ABB2BF;">],</span></span>
<span class="line"><span style="color:#E06C75;">			cancelId</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">		});</span></span>
<span class="line"><span style="color:#C678DD;">		if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">cancelId</span><span style="color:#56B6C2;"> ===</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">			autoUpdater</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">quitAndInstall</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">			app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">quit</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#ABB2BF;">	});</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">autoUpdater</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">on</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;error&quot;</span><span style="color:#ABB2BF;">, (</span><span style="color:#E06C75;font-style:italic;">err</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">	console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;update error：&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">err</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>6.在 main.js 主进程中，添加监听 <code>&#39;will-finish-launching&#39;</code> 生命周期，触发更新</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 监听软件启动完成，加载软件更新</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">on</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;will-finish-launching&quot;</span><span style="color:#ABB2BF;">, () </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">	require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;./update.js&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="二、windows-客户端更新—服务端" tabindex="-1">二、Windows 客户端更新—服务端 <a class="header-anchor" href="#二、windows-客户端更新—服务端" aria-label="Permalink to &quot;二、Windows 客户端更新—服务端&quot;">​</a></h3><ul><li>响应 feedURL/RELEASES</li><li>有更新返回 RELEASES 文件内容(打包时出现的)，如<code>BBC6F98A5CD32C675AAB6737A5F67176248B900C remote_control-1.0.1-fullnupkg 62177782</code></li><li>无更新返回 204</li><li>响应 <code>feedURL/*.nupkg</code>，返回更新安装包</li></ul><h4 id="前置准备" tabindex="-1">前置准备 <a class="header-anchor" href="#前置准备" aria-label="Permalink to &quot;前置准备&quot;">​</a></h4><ul><li>包准备 <ul><li>安装包不能使用 NSIS，需要使用 Squirrel</li><li>更新需要 Squirrel 配套的 nupkg 包</li></ul></li></ul><h4 id="服务端编码-windows-客户端的更新" tabindex="-1">服务端编码 windows 客户端的更新 <a class="header-anchor" href="#服务端编码-windows-客户端的更新" aria-label="Permalink to &quot;服务端编码 windows 客户端的更新&quot;">​</a></h4><p>update-server 服务端的 <code>index.js</code> 继续添加代码</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> Koa</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;koa&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> app</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Koa</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> Router</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;koa-router&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> router</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Router</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> server</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;koa-static-server&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> compareVersions</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> require</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;compare-versions&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 获取最新的版本</span></span>
<span class="line"><span style="color:#C678DD;">function</span><span style="color:#61AFEF;"> getNewVersion</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">versions</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">versions</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">	let</span><span style="color:#E06C75;"> maxVersion</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">		name</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;1.0.1&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">		pub_date</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;2023-02-01T12:26:53+1:00&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">		notes</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;新增功能&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">		url</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;http://127.0.0.1:3385/public/remote_control-1.0.1-mac.zip&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">	};</span></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">compareVersions</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compare</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">maxVersion</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">name</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">versions</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;&gt;&quot;</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#E06C75;"> maxVersion</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#C678DD;">	return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Windows系统客户端更新</span></span>
<span class="line"><span style="color:#E5C07B;">router</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/win32/RELEASES&quot;</span><span style="color:#ABB2BF;">, (</span><span style="color:#E06C75;font-style:italic;">ctx</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">next</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// 处理Windows系统客户端更新，请求后缀：?version=1.0.0&amp;uid=123</span></span>
<span class="line"><span style="color:#C678DD;">	let</span><span style="color:#E06C75;"> newVersion</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> getNewVersion</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">query</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">version</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">newVersion</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">		ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">body</span><span style="color:#56B6C2;"> =</span></span>
<span class="line"><span style="color:#98C379;">			&quot;08650F322824190BA203D64BF41728381B4D87F7 remote_control-1.0.1-full.nupkg 100716339&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	} </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">		ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">status</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 204</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// windows静态文件服务</span></span>
<span class="line"><span style="color:#E5C07B;">router</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/win32/(.*).nupkg&quot;</span><span style="color:#ABB2BF;">, (</span><span style="color:#E06C75;font-style:italic;">ctx</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">next</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// redirect s3 静态文件服务</span></span>
<span class="line"><span style="color:#E5C07B;">	ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">redirect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">\`/public/</span><span style="color:#C678DD;">\${</span><span style="color:#E5C07B;">ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">params</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]</span><span style="color:#C678DD;">}</span><span style="color:#98C379;">.nupkg\`</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Mac系统客户端更新</span></span>
<span class="line"><span style="color:#E5C07B;">router</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;/darwin&quot;</span><span style="color:#ABB2BF;">, (</span><span style="color:#E06C75;font-style:italic;">ctx</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">next</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	// 处理Mac更新，请求后缀：?version=1.0.0&amp;uid=123</span></span>
<span class="line"><span style="color:#C678DD;">	let</span><span style="color:#E06C75;"> newVersion</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> getNewVersion</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">query</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">version</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">newVersion</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">		ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">body</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> newVersion</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	} </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">		ctx</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">status</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 204</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#61AFEF;">	server</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;">		rootDir</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;public&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">		rootPath</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;/public&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">	})</span></span>
<span class="line"><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">router</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">routes</span><span style="color:#ABB2BF;">()).</span><span style="color:#61AFEF;">use</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">router</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">allowedMethods</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> port</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 33855</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">app</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">listen</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">port</span><span style="color:#ABB2BF;">, () </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">	console</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">log</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">\`软件更新服务运行在：http://localhost: </span><span style="color:#C678DD;">\${</span><span style="color:#E06C75;">port</span><span style="color:#C678DD;">}</span><span style="color:#98C379;">\`</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h4 id="回到-electron-的-客户端项目代码" tabindex="-1">回到 electron 的 客户端项目代码 <a class="header-anchor" href="#回到-electron-的-客户端项目代码" aria-label="Permalink to &quot;回到 electron 的 客户端项目代码&quot;">​</a></h4><ul><li>1.先安装库：<code>npm i electron-squirrel-startup --save</code><ul><li>npm 地址：<a href="https://www.npmjs.com/package/electron-squirrel-startup" target="_blank" rel="noreferrer">electron-squirrel-startup - npm (npmjs.com)</a></li></ul></li><li>2.在 main.js 主进程最上面加上：<code>if(require(&#39;electron-squirrel-startup&#39;)) return;</code></li></ul><h4 id="重新编译客户端再运行" tabindex="-1">重新编译客户端再运行 <a class="header-anchor" href="#重新编译客户端再运行" aria-label="Permalink to &quot;重新编译客户端再运行&quot;">​</a></h4><ul><li>3.重新编译 electron 的软件客户端</li><li>4.在打包后的文件夹：<code>squirrel-windows</code>的 <code>软件名 Setup 1.0.0.exe</code> 包，双击安装，安装后会在桌面生成快捷图标，然后会自动启动，需要把自动启动的软件进程退出，再重新启动，才会提示升级</li></ul><h4 id="更新流程" tabindex="-1">更新流程 <a class="header-anchor" href="#更新流程" aria-label="Permalink to &quot;更新流程&quot;">​</a></h4><p>检查更新( checkForUpdate ) =&gt; 下载包 =&gt; 安装包 (quitAndInstall) =&gt; 更新快捷方式 =&gt; 删除之前版本</p><h4 id="windows-更新的坑" tabindex="-1">Windows 更新的坑 <a class="header-anchor" href="#windows-更新的坑" aria-label="Permalink to &quot;Windows 更新的坑&quot;">​</a></h4><ul><li>第一次启动时候会报错：<a href="https://github.com/electron/electron/issues/7155#issuecomment-245993316" target="_blank" rel="noreferrer">https://github.com/electron/electron/issues/7155#issuecomment-245993316</a></li><li>替换过程如果被中断会报错</li></ul><h2 id="electron-应用工程化-更新过程-问题" tabindex="-1">Electron 应用工程化--更新过程&amp;问题 <a class="header-anchor" href="#electron-应用工程化-更新过程-问题" aria-label="Permalink to &quot;Electron 应用工程化--更新过程&amp;问题&quot;">​</a></h2><h3 id="更新服务" tabindex="-1">更新服务 <a class="header-anchor" href="#更新服务" aria-label="Permalink to &quot;更新服务&quot;">​</a></h3><ul><li>开源项目：<a href="https://github.com/electron/update.electronjs.org" target="_blank" rel="noreferrer">update.electronjs.org</a></li><li>私有项目：<a href="https://github.com/atlassian/nucleus" target="_blank" rel="noreferrer">nucleus</a>、<a href="https://github.com/ArekSredzki/electron-release-server" target="_blank" rel="noreferrer">release-server</a></li></ul><p><img src="`+e+'" alt="electron更新"></p><h3 id="electron-更新进度条方案" tabindex="-1">Electron 更新进度条方案 <a class="header-anchor" href="#electron-更新进度条方案" aria-label="Permalink to &quot;Electron 更新进度条方案&quot;">​</a></h3><p><img src="'+o+'" alt="electron更新进度条方案"></p><h3 id="electron-更新提速-增量更新" tabindex="-1">Electron 更新提速--增量更新 <a class="header-anchor" href="#electron-更新提速-增量更新" aria-label="Permalink to &quot;Electron 更新提速--增量更新&quot;">​</a></h3><p><img src="'+r+'" alt="Electron更新提速--增量更新"></p>',110)]))}const A=n(t,[["render",c]]);export{F as __pageData,A as default};
